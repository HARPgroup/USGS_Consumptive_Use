###############################################################################################################################################
#########################################################State Level Analysis##################################################################

#Primary Author: Morgan McCarthy, M.S. Biological Systems Engineering, Virginia Tech

#-----------------------------------------------------------Purpose---------------------------------------------------------------------------#

# The purpose of this script is to compare withdrawals, discharges, and consumption over time on a state-wide level for the Commonwealth of
# Virginia. Discharge data is withdrawn from the EPA's ECHO system, using the ECHO_Timeseries.R script. This data is then cleaned in the 
# ECHO_QAQC.R script. Withdrawal data is obtained from the VDEQ's VA Hydro system, which is only available through collaboration. Please 
# contact the Office of Water Supply if you are interested in collaboration. Withdrawal data is cleaned in the VWUDS_QAQC.R script. Water
# sectors for each facility in both datasets are classified in the ECHO_QAQC.R and VWUDS_QAQC.R scripts. 

# Consumption, in this analysis, is defined as water that is permanently removed from a water resource system and not replaced. It is 
# calculated as a water balance, with water in being discharges and water out being withdrawals. 

##################################################Library Initilization########################################################################
rm(list=ls())

library(foreign) #allows for easy manipulation of *.dbf file types
library(rgdal) #extract files from file geodatabases-like in ArcMap
library(dplyr)#data manipulation package that speeds up grouping, summarizing, ordering. 
library(XML) #downloads and reads XML file types-used to access ECHORest Services to download facilities
library(RCurl) #downloads and interacts with web-based content
library(readxl) #reads excel files
library(jsonlite)
library(httr)
library(proj4)
library(data.table)
library(stringr)
library(plotly)
library(shiny)
library(lubridate)
library(RColorBrewer)
library(tibble)
library(tidyr)
library(Hmisc)
library(gridExtra)
library(ggplot2)

# For using plotly 
Sys.setenv("plotly_username" = "mccartma")
Sys.setenv("plotly_api_key" = "r3SDikk9PJVh3dxt6F5q") # update api key each new day https://plot.ly/settings/api#/

options(scipen=999) #Disables scientific notation

################################################################Inputs########################################################################

#----------------------------------------------------Cleaned Discharge Data-----------------------------------------------------------------#
# This discharge data was generated by the ECHO_Timeseries.R script and cleaned in the ECHO_QAQC.R Script

#--Load Discharge Timeseries Data--#
ECHO_2010_2017<-read.table("G:/My Drive/ECHO NPDES/USGS_Consumptive_Use_Updated/ECHO_2010_2017_QAQC.txt", sep="\t", header=T)

#--Facilities with Matched Withdrawal Facility--#
Matched<-read.csv("G:/My Drive/USGS_ConsumptiveUse/Spring, 2019/Matched Facilities/Runninglist_Matches.csv")
Matched<-mutate_if(Matched,is.factor,as.character)

#--Remove Municipal Data because it has a noisy relationship--#
Matched<-subset(Matched,!Matched$Sector=="Municipal")

# This function looks at the list of matched facilities and pulls relevant attributes and DMR data for the discharging facilities
matched_discharge<- function(Matched){
  
Match_ECHO_2010_2017<-subset(ECHO_2010_2017,ECHO_2010_2017$Facility.ID%in%gsub("echo_","",Matched$VPDES.Hydrocode), select=c(1,3:9,12,19,33,43,44,45,46))

colnames(Match_ECHO_2010_2017)<-c("OutfallID","VPDES.Facility.ID","VPDES.Name","Fac.Lat","Fac.Long","Outfall_Type","VPDES.Outfall.Long",
                                  "VPDES.Outfall.Lat", "Discharges_MGD", "Date","County","Waterbody","Use.Type","Fuel_Type","Gen_Cap_MW")
Match_ECHO_2010_2017$MatchID<-Matched$MatchID[match(Match_ECHO_2010_2017$VPDES.Facility.ID,gsub("echo_","",Matched$VPDES.Hydrocode))]
Match_ECHO_2010_2017$Date<-as.Date(Match_ECHO_2010_2017$Date,format="%Y-%m-%d")

ECHO_2010_2017<-subset(ECHO_2010_2017,select=c(1:9,10,12,19,33,40,43,44,45,46,47))
colnames(ECHO_2010_2017)<-c("OutfallID","Year","VPDES.Facility.ID","VPDES.Name","Fac.Lat","Fac.Long","Outfall_Type",
                            "Outfall.Long","Outfall.Lat","Measured_Effluent","Discharges_MGD","Date","County",
                            "Permit_Type","Waterbody","Use.Type","Fuel_Type","Gen_Cap_MW","Mon_Reported")
ECHO_2010_2017$Date<-as.Date(ECHO_2010_2017$Date,format="%Y-%m-%d")

assign("ECHO_2010_2017",ECHO_2010_2017,envir=.GlobalEnv)
assign("Match_ECHO_2010_2017",Match_ECHO_2010_2017,envir=.GlobalEnv)
write.table(ECHO_2010_2017,file="G:/My Drive/ECHO NPDES/USGS_Consumptive_Use_Updated/ECHO_2010_2017_QAQC_statewide.txt",sep="\t")

}
matched_discharge(Matched)

#------------------------------------------------------------------------------------------------------------------------------------------#
#-----------------------------------------------Cleaned Withdrawal Data--------------------------------------------------------------------#
# Withdrawal data was obtained through VDEQ's VA Hydro site, which can only be obtained through collaboration.
# Data was analyzed, coordinates were corrected, and water sectors were classified in VWUDS_QAQC.R Script. 

#--Load Withdrawal Timeseries Data--#
load("G:/My Drive/ECHO NPDES/USGS_Consumptive_Use_Updated/Code/R Workspaces/VWUDS_2010_2017.RData")
VWUDS_2010_2017<-VWUDS_2010_2017[VWUDS_2010_2017$Date %within% interval("2010-01-01","2016-12-31"),]
# This function looks at the list of matched facilities and pulls relevant attributes and DMR data for the withdrawing facilities
matched_withdrawal<- function(Matched){

VWUDS_2010_2017<-as.data.table(VWUDS_2010_2017)
VWUDS_2010_2017<-VWUDS_2010_2017[order(VWUDS_2010_2017[,1],VWUDS_2010_2017[,8],decreasing=F),]
colnames(VWUDS_2010_2017)[3]<-"VWUDS.Facility.ID"
colnames(VWUDS_2010_2017)[10]<-"Old.Use.Type"
colnames(VWUDS_2010_2017)[20]<-"Use.Type"

#--Facilities with Matched Discharge Facility--#
Match_VWUDS_2010_2017<-subset(VWUDS_2010_2017,VWUDS_2010_2017$VWUDS.Facility.ID%in%Matched$VWUDS.HydroID)
Match_VWUDS_2010_2017<-Match_VWUDS_2010_2017%>%
  dplyr::group_by(VWUDS.Facility.ID,Date)%>%
  dplyr::summarise(VWUDS.Name=first(Facility),Withdrawal_mgd=sum(Withdrawals_MGD,na.rm=T),VWUDS.Lat=mean(Corrected_Latitude,na.rm=T),VWUDS.Long=mean(Corrected_Longitude,na.rm=T),
                   VWUDS.Use.Type=first(Use.Type))

colnames(Match_VWUDS_2010_2017)<-c("VWUDS.Facility.ID","Date","VWUDS.Name","Withdrawals_MGD","VWUDS.Lat",
                                   "VWUDS.Long","VWUDS.Use.Type")
Match_VWUDS_2010_2017$MatchID<-Matched$MatchID[match(Match_VWUDS_2010_2017$VWUDS.Facility.ID,Matched$VWUDS.HydroID)]

assign("VWUDS_2010_2017",VWUDS_2010_2017,envir=.GlobalEnv)
assign("Match_VWUDS_2010_2017",Match_VWUDS_2010_2017,envir=.GlobalEnv)

save(VWUDS_2010_2017,file="G:/My Drive/ECHO NPDES/USGS_Consumptive_Use_Updated/Code/R Workspaces/VWUDS_2010_2017_statewide.RData")

}
matched_withdrawal(Matched)

#-----------------------------Matched Data---------------------------------#
# Look for "fully" matched results for each month. This function merges DMR entries reported by both the withdrawing and discharging 
# facilities. This ensures that we aren't looking at incomplete data. i.e. facilities that report a discharge but not a withdrawal for that reporting period.

# We are also concerned with energy facilities that report a 0.0 MGD discharge or withdrawal. Is it becuase they didn't report, or because it was actually 0?

fully_matched<- function(Match_VWUDS_2010_2017,Match_ECHO_2010_2017){
full_match_2010_2017<-merge(Match_VWUDS_2010_2017,Match_ECHO_2010_2017,by=c("MatchID","Date"))
full_match_2010_2017<-full_match_2010_2017[,c("VPDES.Facility.ID","OutfallID","VWUDS.Facility.ID","VWUDS.Name","VPDES.Name","Use.Type",
                      "Fac.Lat","Fac.Long","VWUDS.Lat","VWUDS.Long","Date","Withdrawals_MGD","Discharges_MGD","County","Waterbody","Fuel_Type",
                      "Gen_Cap_MW")]


#---------------------Dissolve Flow from multiple outfalls into a single facility value----------#
full_match_2010_2017<-full_match_2010_2017%>%dplyr::group_by(VWUDS.Facility.ID,VPDES.Facility.ID,
                                       VWUDS.Name,VPDES.Name,Use.Type,Fac.Lat,Fac.Long,
                                       VWUDS.Lat,VWUDS.Long,Date,Withdrawals_MGD,
                                       County,Waterbody,Fuel_Type,Gen_Cap_MW)%>%dplyr::summarise(Discharges_MGD=sum(Discharges_MGD,na.rm=T),n_outfalls=n_distinct(OutfallID))
full_match_2010_2017<-full_match_2010_2017[c("VWUDS.Facility.ID","VPDES.Facility.ID","n_outfalls",
                                             "VWUDS.Name","VPDES.Name","Use.Type","Fac.Lat","Fac.Long",
                                             "VWUDS.Lat","VWUDS.Long","Date","Withdrawals_MGD", "Discharges_MGD",
                                             "County","Waterbody","Fuel_Type",
                                             "Gen_Cap_MW")]

full_match_2010_2017<-full_match_2010_2017%>%add_column(CU=(full_match_2010_2017$Withdrawals_MGD-full_match_2010_2017$Discharges_MGD)/full_match_2010_2017$Withdrawals_MGD, .after="Discharges_MGD")


full_match_2010_2017_summary<-full_match_2010_2017%>%dplyr::group_by(VPDES.Facility.ID)%>%
  dplyr::summarise(VWUDS.Facility.ID=first(VWUDS.Facility.ID),n_outfalls=first(n_outfalls),VWUDS.Name=first(VWUDS.Name),VPDES.Name=first(VPDES.Name),
                   Use.Type=first(Use.Type), VPDES.Fac.Lat=first(Fac.Lat),VPDES.Fac.Long=first(Fac.Long),VWUDS.Fac.Lat=first(VWUDS.Lat),VWUDS.Fac.Long=first(VWUDS.Long),
                   Ave_Withdrawal_mgd=mean(Withdrawals_MGD,na.rm=T),Ave_Discharge_mgd=mean(Discharges_MGD,na.rm=T),County=first(County),Waterbody=first(Waterbody),
                   Fuel_Type=first(Fuel_Type),Gen_Cap_MW=first(Gen_Cap_MW))

full_match_2010_2017_summary$Ave_CU<-(full_match_2010_2017_summary$Ave_Withdrawal_mgd-full_match_2010_2017_summary$Ave_Discharge_mgd)/full_match_2010_2017_summary$Ave_Withdrawal_mgd

full_match_2010_2017_summary$VPDES_perc<-Matched$VPDES...total[match(full_match_2010_2017_summary$VWUDS.Facility.ID,Matched$VWUDS.HydroID)]
full_match_2010_2017_summary$VWUDS_perc<-Matched$VWUDS...total[match(full_match_2010_2017_summary$VWUDS.Facility.ID,Matched$VWUDS.HydroID)]

                                 
# Not all facilities report 12 months out of the year. Therefore, if we want to aggregate monthly withdrawals into yearly estimates for each
# facility, we must divide by the number of reporting months.
W_Months<-
  full_match_2010_2017%>%
  dplyr::group_by(VWUDS.Facility.ID,Year=substring(Date,1,4))%>%
  dplyr::count(Month=substring(Date,6,7))%>%
  dplyr::summarise(Mon_Reported=sum(n))

full_match_2010_2017<-full_match_2010_2017%>%add_column(Year=substring(full_match_2010_2017$Date,1,4), .after="Date")
full_match_2010_2017<-merge(full_match_2010_2017,W_Months,by=c("VWUDS.Facility.ID","Year"),all.x=T)



# Saves into global environment
assign("full_match_2010_2017",full_match_2010_2017,envir=.GlobalEnv)
assign("full_match_2010_2017_summary",full_match_2010_2017_summary,envir=.GlobalEnv)

write.table(full_match_2010_2017,file="G:/My Drive/ECHO NPDES/USGS_Consumptive_Use_Updated/full_match_2010_2017.txt",sep="\t")
write.table(full_match_2010_2017_summary,file="G:/My Drive/USGS_ConsumptiveUse/Spring, 2019/Statewide Analysis/fully_matched_summary.txt",row.names=F,sep="|")


}
fully_matched(Match_VWUDS_2010_2017,Match_ECHO_2010_2017)

# How many facilities were excluded becasues they didn't have fully matched withdrawal and discharge entries?
# missing<-subset(Matched,! gsub('echo_',"",Matched$VPDES.Hydrocode)%in%full_match_2010_2017_summary$VPDES.Facility.ID)

#############################################################Analysis########################################################################

#-------------------------------------------------Statewide Withdrawals vs. Discharges------------------------------------------------------#

#--------------------------------Cumulative Percentage of Total Water Withdrawn by each Facility------------------------------------------#

#--------------------Withdrawals------------------#

# This function compiles withdrawals on a facility level, grouped by year
facility_level_withdrawal<- function(VWUDS_2010_2017,full_match_2010_2017){
  
  # the <<- is another way to save data created in a function to the global environment
Source_Withdrawals<-VWUDS_2010_2017%>%
    dplyr::group_by(DEQ.ID.of.Source,Year)%>%
    dplyr::summarise(VWUDS.Facility.ID=first(VWUDS.Facility.ID),
                     Facility_Name=first(Facility),
                     Sources=n_distinct(DEQ.ID.of.Source),
                     Ave_Mon_Reported=mean(Mon_Reported),
                     Withdrawals_MGal=sum(Million.Gallons.Month,na.rm=T),
                     Withdrawals_MGD=sum(Withdrawals_MGD,na.rm=T)/first(Mon_Reported),
                     Use.Type=first(Use.Type))%>%arrange(desc(Withdrawals_MGD))
  
Facility_Withdrawals<-Source_Withdrawals%>%
  dplyr::group_by(VWUDS.Facility.ID,Year)%>%
  dplyr::summarise(Facility_Name=first(Facility_Name),
                   Sources=n_distinct(DEQ.ID.of.Source),
                   Ave_Mon_Reported=mean(Ave_Mon_Reported),
                   Withdrawals_MGal=sum(Withdrawals_MGal,na.rm=T),
                   Withdrawals_MGD=sum(Withdrawals_MGD,na.rm=T),
                   Use.Type=first(Use.Type))%>%arrange(desc(Withdrawals_MGD))

Matched_Facility_Withdrawals<-full_match_2010_2017%>%
  dplyr::group_by(VWUDS.Facility.ID,Year=substr(Date,1,4))%>%
  dplyr::summarise(Facility_Name=first(VWUDS.Name),
                   Withdrawals_MGD=sum(Withdrawals_MGD,na.rm=T)/first(Mon_Reported),
                   Use.Type=first(Use.Type))%>%arrange(desc(Withdrawals_MGD))

assign("Facility_Withdrawals",Facility_Withdrawals,envir = .GlobalEnv)
assign("Matched_Facility_Withdrawals",Matched_Facility_Withdrawals,envir = .GlobalEnv)

}
facility_level_withdrawal(VWUDS_2010_2017,full_match_2010_2017)

#--Aggregated withdrawals and % of total water withdrawn per year (on average)--#

# This function takes all reported withdrawals and calculates the cumulative % of total water withdrawn for each facility.
# Major withdrawers are presented at the top, with higher total % water withdrawn.
Cum_Withdrawal<- function(Facility_Withdrawals,label,cutoff){
  
  #---------Total Reported Withdrawal from VWUDS------------#
  Withdrawal<-data.frame("VWUDS.Facility.ID"=unique(Facility_Withdrawals$VWUDS.Facility.ID))
  Withdrawal$Facility_Name<-ifelse(Withdrawal$VWUDS.Facility.ID%in%Facility_Withdrawals$VWUDS.Facility.ID,Facility_Withdrawals$Facility_Name[match(Withdrawal$VWUDS.Facility.ID,Facility_Withdrawals$VWUDS.Facility.ID)],NA)
 
  
  Withdrawal$MGD_2010<-ifelse(Withdrawal$VWUDS.Facility.ID%in%Facility_Withdrawals$VWUDS.Facility.ID[Facility_Withdrawals$Year=="2010"],Facility_Withdrawals$Withdrawals_MGD[Facility_Withdrawals$Year=="2010"][match(Withdrawal$VWUDS.Facility.ID,Facility_Withdrawals$VWUDS.Facility.ID[Facility_Withdrawals$Year=="2010"])],NA)
  Withdrawal$MGD_2011<-ifelse(Withdrawal$VWUDS.Facility.ID%in%Facility_Withdrawals$VWUDS.Facility.ID[Facility_Withdrawals$Year=="2011"],Facility_Withdrawals$Withdrawals_MGD[Facility_Withdrawals$Year=="2011"][match(Withdrawal$VWUDS.Facility.ID,Facility_Withdrawals$VWUDS.Facility.ID[Facility_Withdrawals$Year=="2011"])],NA)
  Withdrawal$MGD_2012<-ifelse(Withdrawal$VWUDS.Facility.ID%in%Facility_Withdrawals$VWUDS.Facility.ID[Facility_Withdrawals$Year=="2012"],Facility_Withdrawals$Withdrawals_MGD[Facility_Withdrawals$Year=="2012"][match(Withdrawal$VWUDS.Facility.ID,Facility_Withdrawals$VWUDS.Facility.ID[Facility_Withdrawals$Year=="2012"])],NA)
  Withdrawal$MGD_2013<-ifelse(Withdrawal$VWUDS.Facility.ID%in%Facility_Withdrawals$VWUDS.Facility.ID[Facility_Withdrawals$Year=="2013"],Facility_Withdrawals$Withdrawals_MGD[Facility_Withdrawals$Year=="2013"][match(Withdrawal$VWUDS.Facility.ID,Facility_Withdrawals$VWUDS.Facility.ID[Facility_Withdrawals$Year=="2013"])],NA)
  Withdrawal$MGD_2014<-ifelse(Withdrawal$VWUDS.Facility.ID%in%Facility_Withdrawals$VWUDS.Facility.ID[Facility_Withdrawals$Year=="2014"],Facility_Withdrawals$Withdrawals_MGD[Facility_Withdrawals$Year=="2014"][match(Withdrawal$VWUDS.Facility.ID,Facility_Withdrawals$VWUDS.Facility.ID[Facility_Withdrawals$Year=="2014"])],NA)
  Withdrawal$MGD_2015<-ifelse(Withdrawal$VWUDS.Facility.ID%in%Facility_Withdrawals$VWUDS.Facility.ID[Facility_Withdrawals$Year=="2015"],Facility_Withdrawals$Withdrawals_MGD[Facility_Withdrawals$Year=="2015"][match(Withdrawal$VWUDS.Facility.ID,Facility_Withdrawals$VWUDS.Facility.ID[Facility_Withdrawals$Year=="2015"])],NA)
  Withdrawal$MGD_2016<-ifelse(Withdrawal$VWUDS.Facility.ID%in%Facility_Withdrawals$VWUDS.Facility.ID[Facility_Withdrawals$Year=="2016"],Facility_Withdrawals$Withdrawals_MGD[Facility_Withdrawals$Year=="2016"][match(Withdrawal$VWUDS.Facility.ID,Facility_Withdrawals$VWUDS.Facility.ID[Facility_Withdrawals$Year=="2016"])],NA)
  #Withdrawal$MGD_2017<-ifelse(Withdrawal$VWUDS.Facility.ID%in%Facility_Withdrawals$VWUDS.Facility.ID[Facility_Withdrawals$Year=="2017"],Facility_Withdrawals$Withdrawals_MGD[Facility_Withdrawals$Year=="2017"][match(Withdrawal$VWUDS.Facility.ID,Facility_Withdrawals$VWUDS.Facility.ID[Facility_Withdrawals$Year=="2017"])],NA)
  
  for (i in 1:length(Withdrawal$VWUDS.Facility.ID)){
    Withdrawal$Sum_2010_2016[i]<-(ifelse(is.na(Withdrawal$MGD_2010[i]),0,Withdrawal$MGD_2010[i])+
                                    ifelse(is.na(Withdrawal$MGD_2011[i]),0,Withdrawal$MGD_2011[i])+
                                    ifelse(is.na(Withdrawal$MGD_2012[i]),0,Withdrawal$MGD_2012[i])+
                                    ifelse(is.na(Withdrawal$MGD_2013[i]),0,Withdrawal$MGD_2013[i])+
                                    ifelse(is.na(Withdrawal$MGD_2014[i]),0,Withdrawal$MGD_2014[i])+
                                    ifelse(is.na(Withdrawal$MGD_2015[i]),0,Withdrawal$MGD_2015[i])+
                                    ifelse(is.na(Withdrawal$MGD_2016[i]),0,Withdrawal$MGD_2016[i]))
  }
  Withdrawal$Ave_2010_2016<-apply(Withdrawal[,3:9],1,median,na.rm=T)

  
  Withdrawal_Sector<-Facility_Withdrawals%>%
    dplyr::group_by(VWUDS.Facility.ID)%>%
    dplyr::summarise(Sector=first(Use.Type))
  
  Withdrawal<-merge(Withdrawal,Withdrawal_Sector,by="VWUDS.Facility.ID",all.X=T)
  
  # Pecentage of total water withdrawn on average from 2010 to 2017 #
  Withdrawal$perc_total<-Withdrawal$Ave_2010_2016/sum(Withdrawal$Ave_2010_2016)
  Withdrawal<-Withdrawal%>%arrange(desc(perc_total))
  
  # cumulative percentage
  Withdrawal$cum_total<-cumsum(Withdrawal$perc_total)/sum(Withdrawal$perc_total)
  n<-count(Withdrawal,VWUDS.Facility.ID)
  Withdrawal$cum_fac<-cumsum(n$n)
  
  Withdrawal<-Withdrawal[Withdrawal$cum_fac<cutoff,]
  
  # Energy Sector
  Withdrawal_Energy<-subset(Withdrawal,subset=Withdrawal$Sector=="Energy")
  Withdrawal_Energy$cum_total<-cumsum(Withdrawal_Energy$perc_total)/sum(Withdrawal$perc_total) #total out of all withdrawals
  n<-count(Withdrawal_Energy,VWUDS.Facility.ID)
  Withdrawal_Energy$cum_fac<-cumsum(n$n)
  
  # Non-Energy Sectors
  Withdrawal_nonEnergy<-subset(Withdrawal,subset=!(Withdrawal$Sector=="Energy"))
  Withdrawal_nonEnergy$cum_total<-cumsum(Withdrawal_nonEnergy$perc_total)/sum(Withdrawal$perc_total) #total out of all withdrawals
  n<-count(Withdrawal_nonEnergy,VWUDS.Facility.ID)
  Withdrawal_nonEnergy$cum_fac<-cumsum(n$n)

  Yearly_Withdrawal<-Facility_Withdrawals%>%
    dplyr::group_by(Year)%>%
    dplyr::summarise(Withdrawals_MGD=sum(Withdrawals_MGD),
                     nFacilities=n_distinct(VWUDS.Facility.ID))
  
  Long_term_ave<-mean(Yearly_Withdrawal$Withdrawals_MGD)
  
  plot1<-Withdrawal%>%
    plot_ly(x= ~cum_fac)%>%
    add_trace(y = ~cum_total, name="VWUDS Facilities", type = 'scatter', mode = 'lines', line=list(color='red',width=6))%>%
    add_trace(x=Withdrawal_Energy$cum_fac,y=Withdrawal_Energy$cum_total,showlegend=F, name="Energy Facilities", type='scatter', mode='lines',line=list(color='black', width=6,dash='dash'))%>%
    add_trace(x=Withdrawal_nonEnergy$cum_fac,y=Withdrawal_nonEnergy$cum_total, showlegend=F,name="Non-Energy Facilities", type='scatter', mode='lines',line=list(color='black',width=6,dash='dot'))%>%
    layout(# title = "Cumulative Distribution of % Water Withdrawn in Virginia",
      xaxis=list(title="Number of Reporting Facilities"),
      yaxis=list(title="Cum % of Total Withdrawal",
                 range=c(0,1.1)),
      font = list(family= "helvetica", size= 16),
      legend=list(orientation='h',xanchor="center",x=0.50,yanchor="top", y=-0.15))
  
  
  assign(paste0("cumulative_with_plot",label),plot1,envir=.GlobalEnv)
  
  assign("Withdrawal",Withdrawal,envir = .GlobalEnv)
  
  save(Withdrawal,file="G:/My Drive/GRA/RCode for VWUDS and VPDES Analysis/cum_with.RData")
  
  path="G:/My Drive/USGS_ConsumptiveUse/Spring, 2019/Statewide Analysis/"
  file_name <- paste(path,"Cumulative_dist_with_",label, ".pdf", sep="")
  plotly_IMAGE(x=plot1,width=1000,height=500,format="pdf",out_file=file_name)
  
  return(list(Yearly_Withdrawal,Long_term_ave,plot1))
  
}
Cum_Withdrawal(Facility_Withdrawals,"All",1860)
Matched$VWUDS...total<-Withdrawal$perc_total[match(Matched$VWUDS.HydroID,Withdrawal$VWUDS.Facility.ID)]
Matched$Average.Withdrawal.MGD<-Withdrawal$Ave_2010_2016[match(Matched$VWUDS.HydroID,Withdrawal$VWUDS.Facility.ID)]

Cum_Withdrawal(Facility_Withdrawals,"All_200",100)

Cum_Withdrawal_compare<- function(Facility_Withdrawals){
  
  #---------Total Reported Withdrawal from VWUDS------------#
  Withdrawal<-data.frame("VWUDS.Facility.ID"=unique(Facility_Withdrawals$VWUDS.Facility.ID))
  Withdrawal$Facility_Name<-ifelse(Withdrawal$VWUDS.Facility.ID%in%Facility_Withdrawals$VWUDS.Facility.ID,Facility_Withdrawals$Facility_Name[match(Withdrawal$VWUDS.Facility.ID,Facility_Withdrawals$VWUDS.Facility.ID)],NA)
  
  Withdrawal$MGD_2010<-ifelse(Withdrawal$VWUDS.Facility.ID%in%Facility_Withdrawals$VWUDS.Facility.ID[Facility_Withdrawals$Year=="2010"],Facility_Withdrawals$Withdrawals_MGD[Facility_Withdrawals$Year=="2010"][match(Withdrawal$VWUDS.Facility.ID,Facility_Withdrawals$VWUDS.Facility.ID[Facility_Withdrawals$Year=="2010"])],NA)
  Withdrawal$MGD_2011<-ifelse(Withdrawal$VWUDS.Facility.ID%in%Facility_Withdrawals$VWUDS.Facility.ID[Facility_Withdrawals$Year=="2011"],Facility_Withdrawals$Withdrawals_MGD[Facility_Withdrawals$Year=="2011"][match(Withdrawal$VWUDS.Facility.ID,Facility_Withdrawals$VWUDS.Facility.ID[Facility_Withdrawals$Year=="2011"])],NA)
  Withdrawal$MGD_2012<-ifelse(Withdrawal$VWUDS.Facility.ID%in%Facility_Withdrawals$VWUDS.Facility.ID[Facility_Withdrawals$Year=="2012"],Facility_Withdrawals$Withdrawals_MGD[Facility_Withdrawals$Year=="2012"][match(Withdrawal$VWUDS.Facility.ID,Facility_Withdrawals$VWUDS.Facility.ID[Facility_Withdrawals$Year=="2012"])],NA)
  Withdrawal$MGD_2013<-ifelse(Withdrawal$VWUDS.Facility.ID%in%Facility_Withdrawals$VWUDS.Facility.ID[Facility_Withdrawals$Year=="2013"],Facility_Withdrawals$Withdrawals_MGD[Facility_Withdrawals$Year=="2013"][match(Withdrawal$VWUDS.Facility.ID,Facility_Withdrawals$VWUDS.Facility.ID[Facility_Withdrawals$Year=="2013"])],NA)
  Withdrawal$MGD_2014<-ifelse(Withdrawal$VWUDS.Facility.ID%in%Facility_Withdrawals$VWUDS.Facility.ID[Facility_Withdrawals$Year=="2014"],Facility_Withdrawals$Withdrawals_MGD[Facility_Withdrawals$Year=="2014"][match(Withdrawal$VWUDS.Facility.ID,Facility_Withdrawals$VWUDS.Facility.ID[Facility_Withdrawals$Year=="2014"])],NA)
  Withdrawal$MGD_2015<-ifelse(Withdrawal$VWUDS.Facility.ID%in%Facility_Withdrawals$VWUDS.Facility.ID[Facility_Withdrawals$Year=="2015"],Facility_Withdrawals$Withdrawals_MGD[Facility_Withdrawals$Year=="2015"][match(Withdrawal$VWUDS.Facility.ID,Facility_Withdrawals$VWUDS.Facility.ID[Facility_Withdrawals$Year=="2015"])],NA)
  Withdrawal$MGD_2016<-ifelse(Withdrawal$VWUDS.Facility.ID%in%Facility_Withdrawals$VWUDS.Facility.ID[Facility_Withdrawals$Year=="2016"],Facility_Withdrawals$Withdrawals_MGD[Facility_Withdrawals$Year=="2016"][match(Withdrawal$VWUDS.Facility.ID,Facility_Withdrawals$VWUDS.Facility.ID[Facility_Withdrawals$Year=="2016"])],NA)
  #Withdrawal$MGD_2017<-ifelse(Withdrawal$VWUDS.Facility.ID%in%Facility_Withdrawals$VWUDS.Facility.ID[Facility_Withdrawals$Year=="2017"],Facility_Withdrawals$Withdrawals_MGD[Facility_Withdrawals$Year=="2017"][match(Withdrawal$VWUDS.Facility.ID,Facility_Withdrawals$VWUDS.Facility.ID[Facility_Withdrawals$Year=="2017"])],NA)
  
  for (i in 1:length(Withdrawal$VWUDS.Facility.ID)){
    Withdrawal$Sum_2010_2016[i]<-(ifelse(is.na(Withdrawal$MGD_2010[i]),0,Withdrawal$MGD_2010[i])+
                                    ifelse(is.na(Withdrawal$MGD_2011[i]),0,Withdrawal$MGD_2011[i])+
                                    ifelse(is.na(Withdrawal$MGD_2012[i]),0,Withdrawal$MGD_2012[i])+
                                    ifelse(is.na(Withdrawal$MGD_2013[i]),0,Withdrawal$MGD_2013[i])+
                                    ifelse(is.na(Withdrawal$MGD_2014[i]),0,Withdrawal$MGD_2014[i])+
                                    ifelse(is.na(Withdrawal$MGD_2015[i]),0,Withdrawal$MGD_2015[i])+
                                    ifelse(is.na(Withdrawal$MGD_2016[i]),0,Withdrawal$MGD_2016[i]))
  }
  Withdrawal$Ave_2010_2016<-apply(Withdrawal[,3:9],1,median,na.rm=T)
  
  
  Withdrawal_Sector<-Facility_Withdrawals%>%
    dplyr::group_by(VWUDS.Facility.ID)%>%
    dplyr::summarise(Sector=first(Use.Type))
  
  Withdrawal<-merge(Withdrawal,Withdrawal_Sector,by="VWUDS.Facility.ID",all.X=T)
  
  # Pecentage of total water withdrawn on average from 2010 to 2017 #
  Withdrawal$perc_total<-Withdrawal$Ave_2010_2016/sum(Withdrawal$Ave_2010_2016)
  Withdrawal<-Withdrawal%>%arrange(desc(perc_total))
  
  # cumulative percentage
  Withdrawal$cum_total<-cumsum(Withdrawal$perc_total)/sum(Withdrawal$perc_total)
  n<-count(Withdrawal,VWUDS.Facility.ID)
  Withdrawal$cum_fac<-cumsum(n$n)
  
  # Matched Facilities
  Withdrawal_Matched<-subset(Withdrawal,subset=Withdrawal$VWUDS.Facility.ID %in% Matched$VWUDS.HydroID)
  Withdrawal_Matched$cum_total<-cumsum(Withdrawal_Matched$perc_total)/sum(Withdrawal$perc_total) #total out of all withdrawals
  n<-count(Withdrawal_Matched,VWUDS.Facility.ID)
  Withdrawal_Matched$cum_fac<-cumsum(n$n)

  
  Yearly_Withdrawal<-Facility_Withdrawals%>%
    dplyr::group_by(Year)%>%
    dplyr::summarise(Withdrawals_MGD=sum(Withdrawals_MGD),
                     nFacilities=n_distinct(VWUDS.Facility.ID))
  
  Long_term_ave<-mean(Yearly_Withdrawal$Withdrawals_MGD)
  
  plot1<-Withdrawal[Withdrawal$cum_fac<200,]%>%
    plot_ly(x= ~cum_fac)%>%
    add_trace(y = ~cum_total, name="All VWUDS Facilities", type = 'scatter', 
              mode = 'lines', line=list(color='red',width=6))%>%
    add_trace(x=Withdrawal_Matched$cum_fac,y=Withdrawal_Matched$cum_total,showlegend=F, 
              name="Matched Facilities", type='scatter', mode='lines',line=list(color='black', width=6,dash='dash'))%>%
    layout(# title = "Cumulative Distribution of % Water Withdrawn in Virginia",
      xaxis=list(title="Number of Reporting Facilities"),
      yaxis=list(title="Cum % of Total Withdrawal",
                 range=c(0,1.1)),
      font = list(family= "helvetica", size= 16),
      legend=list(orientation='h',xanchor="center",x=0.50,yanchor="top", y=-0.15))
  
  
  plot2<-Withdrawal%>%
    plot_ly(x= ~cum_fac)%>%
    add_trace(y = ~cum_total, name="All VWUDS Facilities", type = 'scatter', 
              mode = 'lines', line=list(color='red',width=6))%>%
    add_trace(x=Withdrawal_Matched$cum_fac,y=Withdrawal_Matched$cum_total,showlegend=F, 
              name="Matched Facilities", type='scatter', mode='lines',line=list(color='black', width=6,dash='dash'))%>%
    layout(# title = "Cumulative Distribution of % Water Withdrawn in Virginia",
      xaxis=list(title="Number of Reporting Facilities"),
      yaxis=list(title="Cum % of Total Withdrawal",
                 range=c(0,1.1)),
      font = list(family= "helvetica", size= 16),
      legend=list(orientation='h',xanchor="center",x=0.50,yanchor="top", y=-0.15))
  
  assign("cumulative_with_plot_compare_200",plot1,envir=.GlobalEnv)
  assign("cumulative_with_plot_compare",plot2,envir=.GlobalEnv)
  assign("Withdrawal",Withdrawal,envir = .GlobalEnv)
  
  
  path="G:/My Drive/USGS_ConsumptiveUse/Spring, 2019/Statewide Analysis/"
  file_name <- paste(path,"Cumulative_dist_with_compare_200", ".pdf", sep="")
  plotly_IMAGE(x=plot1,width=1000,height=500,format="pdf",out_file=file_name)
  
  file_name <- paste(path,"Cumulative_dist_with_compare", ".pdf", sep="")
  plotly_IMAGE(x=plot2,width=1000,height=500,format="pdf",out_file=file_name)
  
  return(list(Yearly_Withdrawal,Long_term_ave,plot1,plot2))
  
}
Cum_Withdrawal_compare(Facility_Withdrawals)

#----------------------Discharges-------------------------#

# This function compiles DMR data for discharges on a facility level, grouped by year
facility_level_discharge<- function(ECHO_2010_2017,full_match_2010_2017){

Outfall_Discharges<-ECHO_2010_2017%>%
    dplyr::group_by(OutfallID,Year)%>%
    dplyr::summarise(Facility_Name=first(VPDES.Name),
                     VPDES.Facility.ID=first(VPDES.Facility.ID),
                     Outfalls=n_distinct(OutfallID),
                     entries=n(),
                     Ave_Mon_Reported=mean(Mon_Reported),
                     Discharges_MGD=sum(Discharges_MGD,na.rm=T)/first(Mon_Reported),
                     Use.Type=first(Use.Type))%>%arrange(desc(Discharges_MGD))
  
# All reporting discharging facilities
Facility_Discharges<-Outfall_Discharges%>%
  dplyr::group_by(VPDES.Facility.ID,Year)%>%
  dplyr::summarise(Facility_Name=first(Facility_Name),
                   Outfalls=sum(Outfalls),
                   Ave_Mon_Reported=mean(Ave_Mon_Reported),
                   Discharges_MGD=sum(Discharges_MGD, na.rm=T),
                   Use.Type=first(Use.Type))%>%arrange(desc(Discharges_MGD))

Facility_Discharges$Facility_Name<-lapply(Facility_Discharges$Facility_Name,as.character)

# Fully matched discharging facilities
Matched_Facility_Discharges<-full_match_2010_2017%>%
  dplyr::group_by(VPDES.Facility.ID,Year)%>%
  dplyr::summarise(Facility_Name=first(VPDES.Name),
                   Discharges_MGD=sum(Discharges_MGD, na.rm=T)/first(Mon_Reported),
                   Use.Type=first(Use.Type))%>%arrange(desc(Discharges_MGD))

Matched_Facility_Discharges$Facility_Name<-lapply(Matched_Facility_Discharges$Facility_Name,as.character)

assign("Facility_Discharges",Facility_Discharges,envir=.GlobalEnv)
assign("Matched_Facility_Discharges",Matched_Facility_Discharges,envir=.GlobalEnv)

}
facility_level_discharge(ECHO_2010_2017,full_match_2010_2017)

#--Aggregated discharges and % of total water discharged per year (on average)--#

# This function takes all reported withdrawals and calculates the cumulative % of total water withdrawn for each facility.
# Major withdrawers are presented at the top, with higher total % water withdrawn.
Cum_Discharge<- function(Facility_Discharges,label,cutoff){
  Discharge<-data.frame("VPDES.Facility.ID"=unique(Facility_Discharges$VPDES.Facility.ID),stringsAsFactors = F)
  Discharge$Facility_Name<-ifelse(Discharge$VPDES.Facility.ID%in%Facility_Discharges$VPDES.Facility.ID,Facility_Discharges$Facility_Name[match(Discharge$VPDES.Facility.ID,Facility_Discharges$VPDES.Facility.ID)],NA)
  
  Discharge$MGD_2010<-ifelse(Discharge$VPDES.Facility.ID%in%Facility_Discharges$VPDES.Facility.ID[Facility_Discharges$Year=="2010"],Facility_Discharges$Discharges_MGD[Facility_Discharges$Year=="2010"][match(Discharge$VPDES.Facility.ID,Facility_Discharges$VPDES.Facility.ID[Facility_Discharges$Year=="2010"])],NA)
  Discharge$MGD_2011<-ifelse(Discharge$VPDES.Facility.ID%in%Facility_Discharges$VPDES.Facility.ID[Facility_Discharges$Year=="2011"],Facility_Discharges$Discharges_MGD[Facility_Discharges$Year=="2011"][match(Discharge$VPDES.Facility.ID,Facility_Discharges$VPDES.Facility.ID[Facility_Discharges$Year=="2011"])],NA)
  Discharge$MGD_2012<-ifelse(Discharge$VPDES.Facility.ID%in%Facility_Discharges$VPDES.Facility.ID[Facility_Discharges$Year=="2012"],Facility_Discharges$Discharges_MGD[Facility_Discharges$Year=="2012"][match(Discharge$VPDES.Facility.ID,Facility_Discharges$VPDES.Facility.ID[Facility_Discharges$Year=="2012"])],NA)
  Discharge$MGD_2013<-ifelse(Discharge$VPDES.Facility.ID%in%Facility_Discharges$VPDES.Facility.ID[Facility_Discharges$Year=="2013"],Facility_Discharges$Discharges_MGD[Facility_Discharges$Year=="2013"][match(Discharge$VPDES.Facility.ID,Facility_Discharges$VPDES.Facility.ID[Facility_Discharges$Year=="2013"])],NA)
  Discharge$MGD_2014<-ifelse(Discharge$VPDES.Facility.ID%in%Facility_Discharges$VPDES.Facility.ID[Facility_Discharges$Year=="2014"],Facility_Discharges$Discharges_MGD[Facility_Discharges$Year=="2014"][match(Discharge$VPDES.Facility.ID,Facility_Discharges$VPDES.Facility.ID[Facility_Discharges$Year=="2014"])],NA)
  Discharge$MGD_2015<-ifelse(Discharge$VPDES.Facility.ID%in%Facility_Discharges$VPDES.Facility.ID[Facility_Discharges$Year=="2015"],Facility_Discharges$Discharges_MGD[Facility_Discharges$Year=="2015"][match(Discharge$VPDES.Facility.ID,Facility_Discharges$VPDES.Facility.ID[Facility_Discharges$Year=="2015"])],NA)
  Discharge$MGD_2016<-ifelse(Discharge$VPDES.Facility.ID%in%Facility_Discharges$VPDES.Facility.ID[Facility_Discharges$Year=="2016"],Facility_Discharges$Discharges_MGD[Facility_Discharges$Year=="2016"][match(Discharge$VPDES.Facility.ID,Facility_Discharges$VPDES.Facility.ID[Facility_Discharges$Year=="2016"])],NA)
  # Discharge$MGD_2017<-ifelse(Discharge$VPDES.Facility.ID%in%Facility_Discharges$VPDES.Facility.ID[Facility_Discharges$Year=="2017"],Facility_Discharges$Discharges_MGD[Facility_Discharges$Year=="2017"][match(Discharge$VPDES.Facility.ID,Facility_Discharges$VPDES.Facility.ID[Facility_Discharges$Year=="2017"])],NA)
  
  for (i in 1:length(Discharge$VPDES.Facility.ID)){
    Discharge$Sum_2010_2017[i]<-(ifelse(is.na(Discharge$MGD_2010[i]),0,Discharge$MGD_2010[i])+
                                   ifelse(is.na(Discharge$MGD_2011[i]),0,Discharge$MGD_2011[i])+
                                   ifelse(is.na(Discharge$MGD_2012[i]),0,Discharge$MGD_2012[i])+
                                   ifelse(is.na(Discharge$MGD_2013[i]),0,Discharge$MGD_2013[i])+
                                   ifelse(is.na(Discharge$MGD_2014[i]),0,Discharge$MGD_2014[i])+
                                   ifelse(is.na(Discharge$MGD_2015[i]),0,Discharge$MGD_2015[i])+
                                   ifelse(is.na(Discharge$MGD_2016[i]),0,Discharge$MGD_2016[i]))
  }
  Discharge$Ave_2010_2017<-apply(Discharge[,3:9],1,median,na.rm=T)
  
  Discharge_Sector<-Facility_Discharges%>%
    dplyr::group_by(VPDES.Facility.ID)%>%
    dplyr::summarise(Sector=first(Use.Type))
  
  Discharge<-merge(Discharge,Discharge_Sector,by="VPDES.Facility.ID",all.X=T)
  
  # Pecentage of total water withdrawn on average from 2010 to 2017 #
  Discharge$perc_total<-Discharge$Ave_2010_2017/sum(Discharge$Ave_2010_2017)
  Discharge<-Discharge%>%arrange(desc(perc_total))
  
  # cumulative percentage
  Discharge$cum_total<-cumsum(Discharge$perc_total)/sum(Discharge$perc_total)
  n<-count(Discharge,VPDES.Facility.ID)
  Discharge$cum_fac<-cumsum(n$n)
  
  Discharge<-Discharge[Discharge$cum_fac<cutoff,]
  
  # Energy Sector
  Discharge_Energy<-subset(Discharge,subset=Discharge$Sector=="Energy")
  Discharge_Energy$cum_total<-cumsum(Discharge_Energy$perc_total)/sum(Discharge$perc_total) #total out of all Discharges
  n<-count(Discharge_Energy,VPDES.Facility.ID)
  Discharge_Energy$cum_fac<-cumsum(n$n)
  
  # Energy Sector
  Discharge_nonEnergy<-subset(Discharge,subset=!(Discharge$Sector=="Energy"))
  Discharge_nonEnergy$cum_total<-cumsum(Discharge_nonEnergy$perc_total)/sum(Discharge$perc_total) #total out of all Discharges
  n<-count(Discharge_nonEnergy,VPDES.Facility.ID)
  Discharge_nonEnergy$cum_fac<-cumsum(n$n)
  
  
  label1<-list(
    xref='x',
    yref='y',
    x=Discharge$cum_fac[1],
    y=Discharge$cum_total[1],
    xanchor='left',
    yanchor='middle',
    text= ~paste(round(Discharge$cum_total[1],digits=2)),
    font = list(family = 'helvetica', size = 12),
    showarrow = FALSE)
  
  label2<-list(
    xref='x',
    yref='y',
    x=Discharge_Energy$cum_fac[1],
    y=Discharge_Energy$cum_total[1],
    xanchor='left',
    yanchor='middle',
    text= ~paste(round(Discharge_Energy$cum_total[1],digits=2)),
    font = list(family = 'helvetica', size = 12),
    showarrow = FALSE)
  
  label3<-list(
    xref='x',
    yref='y',
    x=Discharge_nonEnergy$cum_fac[1],
    y=Discharge_nonEnergy$cum_total[1],
    xanchor='left',
    yanchor='middle',
    text= ~paste(round(Discharge_nonEnergy$cum_total[1],digits=2)),
    font = list(family = 'helvetica', size = 12),
    showarrow = FALSE)
  
  plot1<-Discharge%>%
    plot_ly(x= ~cum_fac)%>%
    add_trace(y = ~cum_total, name="VPDES Facilities", type = 'scatter', mode = 'lines', line=list(color='blue',width=6))%>%
    add_trace(x=Discharge_Energy$cum_fac,y=Discharge_Energy$cum_total, name="Energy Facilities", type='scatter', mode='lines',line=list(color='black', width=6,dash='dash'))%>%
    add_trace(x=Discharge_nonEnergy$cum_fac,y=Discharge_nonEnergy$cum_total, name="Non-Energy Facilities", type='scatter', mode='lines',line=list(color='black',width=6,dash='dot'))%>%
    layout(# title = "Cumulative Distribution of % Water Discharged in Virginia",
           xaxis=list(title="Number of Reporting Facilities"),
           yaxis=list(title="Cum % of Total Discharge",
                      range=c(0,1.1)),
           font = list(family= "helvetica", size= 16),
           legend=list(orientation='h',xanchor="center",x=0.50,yanchor="top", y=-0.15))
  
  Discharge<<-mutate_if(Discharge,is.factor,as.character)
  
  Yearly_Discharge<-Facility_Discharges%>%
    dplyr::group_by(Year)%>%
    dplyr::summarise(Discharges_MGD=sum(Discharges_MGD,na.rm=T),
                     nFacilities=n_distinct(VPDES.Facility.ID))
  
  
  Yearly_Discharge<-transform(Yearly_Discharge, Year=as.Date(as.character(Year),"%Y"))
  
  Long_term_ave<-mean(Yearly_Discharge$Discharges_MGD)
  
  assign(paste0("cumulative_disc_plot",label),plot1,envir = .GlobalEnv)
  
  save(Discharge,file="G:/My Drive/GRA/RCode for VWUDS and VPDES Analysis/cum_dis.RData")
  
  path="G:/My Drive/USGS_ConsumptiveUse/Spring, 2019/Statewide Analysis/"
  file_name <- paste(path,"Cumulative_dist_dis_",label, ".pdf", sep="")
  plotly_IMAGE(x=plot1,width=1000,height=500,format="pdf",out_file=file_name)
  
  return(list(Yearly_Discharge,Long_term_ave,plot1))
}
Cum_Discharge(Facility_Discharges,"All",726)
Matched$VPDES...total<-Discharge$perc_total[match(gsub("echo_","",Matched$VPDES.Hydrocode),Discharge$VPDES.Facility.ID)]
Matched$Average.Discharge.MGD<-Discharge$Ave_2010_2017[match(gsub("echo_","",Matched$VPDES.Hydrocode),Discharge$VPDES.Facility.ID)]
Matched$Ave.Consumption<-(Matched$Average.Withdrawal.MGD-Matched$Average.Discharge.MGD)/Matched$Average.Withdrawal.MGD
# write.csv(Matched,file="G:/My Drive/USGS_ConsumptiveUse/Spring, 2019/Matched Facilities/updated_matches.csv",row.names=F)

Cum_Discharge(Facility_Discharges,"All_200",100)

Cum_Discharge_compare<- function(Facility_Discharges){
  Discharge<-data.frame("VPDES.Facility.ID"=unique(Facility_Discharges$VPDES.Facility.ID),stringsAsFactors = F)
  Discharge$Facility_Name<-ifelse(Discharge$VPDES.Facility.ID%in%Facility_Discharges$VPDES.Facility.ID,Facility_Discharges$Facility_Name[match(Discharge$VPDES.Facility.ID,Facility_Discharges$VPDES.Facility.ID)],NA)
  
  Discharge$MGD_2010<-ifelse(Discharge$VPDES.Facility.ID%in%Facility_Discharges$VPDES.Facility.ID[Facility_Discharges$Year=="2010"],Facility_Discharges$Discharges_MGD[Facility_Discharges$Year=="2010"][match(Discharge$VPDES.Facility.ID,Facility_Discharges$VPDES.Facility.ID[Facility_Discharges$Year=="2010"])],NA)
  Discharge$MGD_2011<-ifelse(Discharge$VPDES.Facility.ID%in%Facility_Discharges$VPDES.Facility.ID[Facility_Discharges$Year=="2011"],Facility_Discharges$Discharges_MGD[Facility_Discharges$Year=="2011"][match(Discharge$VPDES.Facility.ID,Facility_Discharges$VPDES.Facility.ID[Facility_Discharges$Year=="2011"])],NA)
  Discharge$MGD_2012<-ifelse(Discharge$VPDES.Facility.ID%in%Facility_Discharges$VPDES.Facility.ID[Facility_Discharges$Year=="2012"],Facility_Discharges$Discharges_MGD[Facility_Discharges$Year=="2012"][match(Discharge$VPDES.Facility.ID,Facility_Discharges$VPDES.Facility.ID[Facility_Discharges$Year=="2012"])],NA)
  Discharge$MGD_2013<-ifelse(Discharge$VPDES.Facility.ID%in%Facility_Discharges$VPDES.Facility.ID[Facility_Discharges$Year=="2013"],Facility_Discharges$Discharges_MGD[Facility_Discharges$Year=="2013"][match(Discharge$VPDES.Facility.ID,Facility_Discharges$VPDES.Facility.ID[Facility_Discharges$Year=="2013"])],NA)
  Discharge$MGD_2014<-ifelse(Discharge$VPDES.Facility.ID%in%Facility_Discharges$VPDES.Facility.ID[Facility_Discharges$Year=="2014"],Facility_Discharges$Discharges_MGD[Facility_Discharges$Year=="2014"][match(Discharge$VPDES.Facility.ID,Facility_Discharges$VPDES.Facility.ID[Facility_Discharges$Year=="2014"])],NA)
  Discharge$MGD_2015<-ifelse(Discharge$VPDES.Facility.ID%in%Facility_Discharges$VPDES.Facility.ID[Facility_Discharges$Year=="2015"],Facility_Discharges$Discharges_MGD[Facility_Discharges$Year=="2015"][match(Discharge$VPDES.Facility.ID,Facility_Discharges$VPDES.Facility.ID[Facility_Discharges$Year=="2015"])],NA)
  Discharge$MGD_2016<-ifelse(Discharge$VPDES.Facility.ID%in%Facility_Discharges$VPDES.Facility.ID[Facility_Discharges$Year=="2016"],Facility_Discharges$Discharges_MGD[Facility_Discharges$Year=="2016"][match(Discharge$VPDES.Facility.ID,Facility_Discharges$VPDES.Facility.ID[Facility_Discharges$Year=="2016"])],NA)
  # Discharge$MGD_2017<-ifelse(Discharge$VPDES.Facility.ID%in%Facility_Discharges$VPDES.Facility.ID[Facility_Discharges$Year=="2017"],Facility_Discharges$Discharges_MGD[Facility_Discharges$Year=="2017"][match(Discharge$VPDES.Facility.ID,Facility_Discharges$VPDES.Facility.ID[Facility_Discharges$Year=="2017"])],NA)
  
  for (i in 1:length(Discharge$VPDES.Facility.ID)){
    Discharge$Sum_2010_2017[i]<-(ifelse(is.na(Discharge$MGD_2010[i]),0,Discharge$MGD_2010[i])+
                                   ifelse(is.na(Discharge$MGD_2011[i]),0,Discharge$MGD_2011[i])+
                                   ifelse(is.na(Discharge$MGD_2012[i]),0,Discharge$MGD_2012[i])+
                                   ifelse(is.na(Discharge$MGD_2013[i]),0,Discharge$MGD_2013[i])+
                                   ifelse(is.na(Discharge$MGD_2014[i]),0,Discharge$MGD_2014[i])+
                                   ifelse(is.na(Discharge$MGD_2015[i]),0,Discharge$MGD_2015[i])+
                                   ifelse(is.na(Discharge$MGD_2016[i]),0,Discharge$MGD_2016[i]))
  }
  Discharge$Ave_2010_2017<-apply(Discharge[,3:9],1,median,na.rm=T)
  
  Discharge_Sector<-Facility_Discharges%>%
    dplyr::group_by(VPDES.Facility.ID)%>%
    dplyr::summarise(Sector=first(Use.Type))
  
  Discharge<-merge(Discharge,Discharge_Sector,by="VPDES.Facility.ID",all.X=T)
  
  # Pecentage of total water withdrawn on average from 2010 to 2017 #
  Discharge$perc_total<-Discharge$Ave_2010_2017/sum(Discharge$Ave_2010_2017)
  Discharge<-Discharge%>%arrange(desc(perc_total))
  
  # cumulative percentage
  Discharge$cum_total<-cumsum(Discharge$perc_total)/sum(Discharge$perc_total)
  n<-count(Discharge,VPDES.Facility.ID)
  Discharge$cum_fac<-cumsum(n$n)
  
  
  # Matched Facilities
  Discharge_Matched<-subset(Discharge,subset=Discharge$VPDES.Facility.ID %in% gsub("echo_","",Matched$VPDES.Hydrocode))
  Discharge_Matched$cum_total<-cumsum(Discharge_Matched$perc_total)/sum(Discharge$perc_total) #total out of all withdrawals
  n<-count(Discharge_Matched,VPDES.Facility.ID)
  Discharge_Matched$cum_fac<-cumsum(n$n)
  
  Discharge<-mutate_if(Discharge,is.factor,as.character)
  Discharge_Matched<-mutate_if(Discharge_Matched,is.factor,as.character)
  
  
  plot1<-Discharge[Discharge$cum_fac<200,]%>%
    plot_ly(x= ~cum_fac)%>%
    add_trace(y = ~cum_total, name="All VPDES Facilities", type = 'scatter', mode = 'lines', line=list(color='blue',width=6))%>%
    add_trace(x=Discharge_Matched$cum_fac,y=Discharge_Matched$cum_total, name="Matched Facilities", type='scatter', 
              mode='lines',line=list(color='black', width=6,dash='dash'))%>%
    layout(# title = "Cumulative Distribution of % Water Discharged in Virginia",
      xaxis=list(title="Number of Reporting Facilities"),
      yaxis=list(title="Cum % of Total Discharge",
                 range=c(0,1.1)),
      font = list(family= "helvetica", size= 16),
      legend=list(orientation='h',xanchor="center",x=0.50,yanchor="top", y=-0.15))
  
  plot2<-Discharge%>%
    plot_ly(x= ~cum_fac)%>%
    add_trace(y = ~cum_total, name="All VPDES Facilities", type = 'scatter', mode = 'lines', line=list(color='blue',width=6))%>%
    add_trace(x=Discharge_Matched$cum_fac,y=Discharge_Matched$cum_total, name="Matched Facilities", type='scatter', 
              mode='lines',line=list(color='black', width=6,dash='dash'))%>%
    layout(# title = "Cumulative Distribution of % Water Discharged in Virginia",
      xaxis=list(title="Number of Reporting Facilities"),
      yaxis=list(title="Cum % of Total Discharge",
                 range=c(0,1.1)),
      font = list(family= "helvetica", size= 16),
      legend=list(orientation='h',xanchor="center",x=0.50,yanchor="top", y=-0.15))
  
  
  
  
  Yearly_Discharge<-Facility_Discharges%>%
    dplyr::group_by(Year)%>%
    dplyr::summarise(Discharges_MGD=sum(Discharges_MGD,na.rm=T),
                     nFacilities=n_distinct(VPDES.Facility.ID))
  
  
  Yearly_Discharge<-transform(Yearly_Discharge, Year=as.Date(as.character(Year),"%Y"))
  
  Long_term_ave<-mean(Yearly_Discharge$Discharges_MGD)
  
  assign("cumulative_disc_plot_compare_200",plot1,envir = .GlobalEnv)
  assign("cumulative_disc_plot_compare",plot2,envir = .GlobalEnv)
  assign("Discharge",Discharge,envir=.GlobalEnv)
  
  path="G:/My Drive/USGS_ConsumptiveUse/Spring, 2019/Statewide Analysis/"
  file_name <- paste(path,"Cumulative_dist_dis_compare_200.pdf", sep="")
  plotly_IMAGE(x=plot1,width=1000,height=500,format="pdf",out_file=file_name)
  
  file_name <- paste(path,"Cumulative_dist_dis_compare.pdf", sep="")
  plotly_IMAGE(x=plot2,width=1000,height=500,format="pdf",out_file=file_name)
  
  return(list(Yearly_Discharge,Long_term_ave,plot1))
}
Cum_Discharge_compare(Facility_Discharges)

Cumulative_plots<- function(){
  subplot1<-plotly::subplot(cumulative_with_plotAll,cumulative_disc_plotAll,shareX = T,nrows=2,
                           titleX= T,
                           titleY=T)%>%
    layout(annotations = list(
      list(x = 0.5 , y = 1.0,
           text = "<b>Withdrawing Facilities</b>",
           showarrow = F,
           xref='paper', yref='paper', xanchor='center',yanchor='bottom'),
      list(x = 0.5 , y = 0.50,
           text = "<b>Discharging Facilities</b>",
           showarrow = F, xref='paper', yref='paper',xanchor='center',yanchor='top')))
  
  path="G:/My Drive/USGS_ConsumptiveUse/Spring, 2019/Statewide Analysis/"
  file_name <- paste(path,"Cumulative_dist_all_compare", ".pdf", sep="")
  plotly_IMAGE(x=subplot1,width=1000,height=800,format="pdf",out_file=file_name)
  
  
  subplot2<-plotly::subplot(cumulative_with_plot_compare, style(cumulative_with_plot_compare_200,showlegend=F),
                            cumulative_disc_plot_compare, style(cumulative_disc_plot_compare_200,showlegend=F),shareX = T,nrows=2,
                            titleX= T,
                            titleY=T, margin=0.07)%>%
    layout(annotations = list(
      list(x = 0.225 , y = 1.0,
           text = "<b>(a) Withdrawing Facilities</b>",
           showarrow = F,
           xref='paper', yref='paper', xanchor='center',yanchor='bottom'),
      list(x = 0.775 , y = 1.0,
           text = "<b>(b) Top 200 Withdrawing Facilities</b>",
           showarrow = F, xref='paper', yref='paper',xanchor='center',yanchor='bottom'),
      list(x = 0.225 , y = 0.50,
           text = "<b>(c) Discharging Facilities</b>",
           showarrow = F, xref='paper', yref='paper',xanchor='center',yanchor='top'),
      list(x = 0.775 , y = 0.50,
           text = "<b>(d) Top 200 Discharging Facilities</b>",
           showarrow = F, xref='paper', yref='paper',xanchor='center',yanchor='top')))
  
  subplot3<-plotly::subplot(cumulative_with_plotAll_200,cumulative_disc_plotAll_200,shareX = T,nrows=2,
                            titleX= T,
                            titleY=T)%>%
    layout(annotations = list(
      list(x = 0.5 , y = 1.0,
           text = "<b>Withdrawing Facilities</b>",
           showarrow = F,
           xref='paper', yref='paper', xanchor='center',yanchor='bottom'),
      list(x = 0.5 , y = 0.50,
           text = "<b>Discharging Facilities</b>",
           showarrow = F, xref='paper', yref='paper',xanchor='center',yanchor='top')))
  
  path="G:/My Drive/USGS_ConsumptiveUse/Spring, 2019/Statewide Analysis/"
  file_name <- paste(path,"Cumulative_dist_all_compare", ".pdf", sep="")
  plotly_IMAGE(x=subplot1,width=1000,height=800,format="pdf",out_file=file_name)
  
  path="G:/My Drive/USGS_ConsumptiveUse/Spring, 2019/Statewide Analysis/"
  file_name <- paste(path,"Cumulative_dist_all_200", ".pdf", sep="")
  plotly_IMAGE(x=subplot2,width=1300,height=800,format="pdf",out_file=file_name)
  
  path="G:/My Drive/USGS_ConsumptiveUse/Spring, 2019/Statewide Analysis/"
  file_name <- paste(path,"Cum_200_subplot", ".pdf", sep="")
  plotly_IMAGE(x=subplot3,width=1000,height=800,format="pdf",out_file=file_name)
  
  return(list(subplot1,subplot2,subplot3))
}
Cumulative_plots()

#-------------------------------------------------------Timeseries of Withdrawals vs Discharges-------------------------------------------#

#----------------------------------------------------------Withdrawals--------------------------------------------------------------------#
#-------Mean Daily Withdrawal MGD----------#

Statewide_Withdrawals<- function(Fac_Withdrawals,timeseries,label){
  
  #--For all sectors--#
  Yearly_Withdrawal<-Fac_Withdrawals%>%
    dplyr::group_by(Year)%>% # you don't have to divide by 12 months here because the facility dataframe already does that
    dplyr::summarise(Withdrawals_MGD=sum(Withdrawals_MGD),
                     nFacilities=n_distinct(VWUDS.Facility.ID))
  
  
  #--Energy Production--#
  Fac_Withdrawals<-as.data.frame(Fac_Withdrawals)
  
  energy_Yearly_Withdrawal<-Fac_Withdrawals[Fac_Withdrawals$Use.Type=="Energy",]%>%
    dplyr::group_by(Year)%>%
    dplyr::summarise(Withdrawals_MGD=sum(Withdrawals_MGD),nFacilities=n_distinct(VWUDS.Facility.ID))
  
  label1 <- list(
    xref = 'x',yref = 'y',
    x = energy_Yearly_Withdrawal$Year[1],
    y = energy_Yearly_Withdrawal$Withdrawals_MGD[1],
    xanchor = 'right',
    yanchor = 'middle',
    text = ~paste(round(energy_Yearly_Withdrawal$Withdrawals_MGD[1],digits=0), 'MGD'),font = list(family = 'Arial', size = 12),showarrow = FALSE)
  
  label2<- list(
    xref = 'x', yref = 'y',
    x = energy_Yearly_Withdrawal$Year[8],
    y = energy_Yearly_Withdrawal$Withdrawals_MGD[8],
    xanchor = 'left',
    yanchor = 'bottom',
    text = ~paste(round(energy_Yearly_Withdrawal$Withdrawals_MGD[8],digits=0), 'MGD'),font = list(family = 'Arial', size = 12),showarrow = FALSE)
  
  energyMonthly<-timeseries[timeseries$Use.Type=='Energy',]%>%
    dplyr::group_by(Date)%>%
    dplyr::summarise(Withdrawals=sum(as.numeric(Withdrawals_MGD), na.rm = T))
  
  energy<-timeseries[timeseries$Use.Type=='Energy',]%>%
    dplyr::group_by(Date)%>%
    dplyr::summarise(Withdrawals=sum(as.numeric(Withdrawals_MGD), na.rm = T),nFacilities=n_distinct(as.character(VWUDS.Facility.ID)))%>%
    plot_ly(x = ~Date)%>%
    add_trace(y = ~Withdrawals, name="Monthly Withdrawal",type = 'scatter', mode = 'lines', 
              line=list(color='#cb181d'))%>%
    add_trace(x=energy_Yearly_Withdrawal$Year, y=energy_Yearly_Withdrawal$Withdrawals_MGD, 
              name="Yearly Withdrawal",type='scatter',
              mode = 'lines', line=list(color='black', dash="dash"))%>%
    layout( # title = paste0("Statewide Mean Daily Withdrawal in Virginia (MGD): ",label),
      yaxis = list(title="Withdrawal (MGD)",
                   tickfont=list(color="black"),
                   range=c(0,100+max(energyMonthly$Withdrawals))), 
      xaxis = list(title = "Date"),
      legend=list(orientation='h',xanchor="center",x=0.50,yanchor="top", y=-0.15))
  #annotations=label1)%>%
  #layout(annotations=label2)
  
  #--Non-Energy Sectors--#
  nonenergy_Yearly_Withdrawal<-Fac_Withdrawals[!Fac_Withdrawals$Use.Type=='Energy',]%>%
    dplyr::group_by(Year)%>%
    dplyr::summarise(Withdrawals_MGD=sum(Withdrawals_MGD),nFacilities=n_distinct(VWUDS.Facility.ID))
  
  label3 <- list(xref = 'x2',
                 yref = 'y2',
                 x = nonenergy_Yearly_Withdrawal$Year[1],
                 y = nonenergy_Yearly_Withdrawal$Withdrawals_MGD[1],
                 xanchor = 'right',
                 yanchor = 'middle',
                 text = ~paste(round(nonenergy_Yearly_Withdrawal$Withdrawals_MGD[1],digits=0), 'MGD'),font = list(family = 'Arial', size = 12),showarrow = FALSE)
  
  label4<- list(
    xref = 'x2',
    yref = 'y2',
    x = nonenergy_Yearly_Withdrawal$Year[8],
    y = nonenergy_Yearly_Withdrawal$Withdrawals_MGD[8],
    xanchor = 'left',
    yanchor = 'bottom',
    text = ~paste(round(nonenergy_Yearly_Withdrawal$Withdrawals_MGD[8],digits=0), 'MGD'),font = list(family = 'Arial', size = 12),showarrow = FALSE)
  
  
  nonenergyMonthly<-timeseries[!timeseries$Use.Type=='Energy',]%>%
    dplyr::group_by(Date)%>%
    dplyr::summarise(Withdrawals=sum(as.numeric(Withdrawals_MGD), na.rm = T))
  
  nonenergy<-timeseries[!timeseries$Use.Type=='Energy',]%>%
    dplyr::group_by(Date)%>%
    dplyr::summarise(Withdrawals=sum(as.numeric(Withdrawals_MGD), na.rm = T),nFacilities=n_distinct(as.character(VWUDS.Facility.ID)))%>%
    plot_ly(x = ~Date)%>%
    add_trace(y = ~Withdrawals, name="Monthly Withdrawal",type = 'scatter', mode = 'lines',
              line=list(color='#cb181d'))%>%
    add_trace(x=nonenergy_Yearly_Withdrawal$Year, y=nonenergy_Yearly_Withdrawal$Withdrawals_MGD, 
              name="Yearly Withdrawal",type='scatter',
              mode = 'lines', line=list(color='black',dash="dash"))%>%
    layout( # title = paste0("Statewide Mean Daily Withdrawal in Virginia (MGD): ",label),
      yaxis = list(title="Withdrawal (MGD)",
                   tickfont=list(color="black"),
                   range=c(0,50+max(nonenergyMonthly$Withdrawals))), 
      xaxis = list(title = "Date"),
      legend=list(orientation='h',xanchor="center",x=0.50,yanchor="top", y=-0.15))
  #annotations=label3)%>%layout(annotations=label4)
  
  subplot<-plotly::subplot(style(energy,showlegend=F),nonenergy,shareX = T,nrows=2,titleX= T, 
                   titleY=T)%>%
    layout(annotations = list(
      list(x = 0.5 , y = 1.0, 
           text = "<b>(a) Energy Facilities</b>",
           showarrow = F, 
           xref='paper', yref='paper', xanchor='center',yanchor='bottom'),
      list(x = 0.5 , y = 0.50, 
           text = "<b>(b) Non-Energy Facilities</b>", 
           showarrow = F, xref='paper', yref='paper',xanchor='center',yanchor='top')))
  
  
  path="G:/My Drive/USGS_ConsumptiveUse/Spring, 2019/Statewide Analysis/Withdrawals/"
  file_name <- paste(path,"Statewide_Withdrawals_Energy",label, ".pdf", sep="")
  plotly_IMAGE(x=energy,width=1000,height=500,format="pdf",out_file=file_name)
  
  path="G:/My Drive/USGS_ConsumptiveUse/Spring, 2019/Statewide Analysis/Withdrawals/"
  file_name <- paste(path,"Statewide_Withdrawals_NonEnergy",label, ".pdf", sep="")
  plotly_IMAGE(x=nonenergy,width=1000,height=500,format="pdf",out_file=file_name)
  
  path="G:/My Drive/USGS_ConsumptiveUse/Spring, 2019/Statewide Analysis/Withdrawals/"
  file_name <- paste(path,"Statewide_Withdrawals_",label, ".pdf", sep="")
  plotly_IMAGE(x=subplot,width=1000,height=800,format="pdf",out_file=file_name)
  
  return(list(Yearly_Withdrawal,energy_Yearly_Withdrawal,nonenergy_Yearly_Withdrawal,subplot))
  
  
}
Statewide_Withdrawals(Facility_Withdrawals,VWUDS_2010_2017,"All_Facilities_in_All_Sectors")
Statewide_Withdrawals(Matched_Facility_Withdrawals,full_match_2010_2017, "Matched_Facilities_in_All_Sectors")

Statewide_Withdrawals_matchvstotal<- function(roundup,roundup2){

  #--Energy Sector--#
  
  All_users<-VWUDS_2010_2017[VWUDS_2010_2017$Use.Type=="Energy",]%>%
    dplyr::group_by(Date)%>%
    dplyr::summarise(Withdrawals=sum(as.numeric(Withdrawals_MGD), na.rm = T),
                     nFacilities=n_distinct(VWUDS.Facility.ID))
  
  Matched_Yearly<-Matched_Facility_Withdrawals[Matched_Facility_Withdrawals$Use.Type=="Energy",]%>%
    dplyr::group_by(Year)%>%
    dplyr::summarise(Withdrawals=sum(as.numeric(Withdrawals_MGD), na.rm = T))
  
  energy<-full_match_2010_2017[full_match_2010_2017$Use.Type=="Energy",]%>%
    dplyr::group_by(Date)%>%
    dplyr::summarise(Withdrawals=sum(as.numeric(Withdrawals_MGD), na.rm = T), 
                     nFacilities=n_distinct(as.character(VWUDS.Facility.ID)))%>%
    plot_ly(x = ~Date)%>%
    add_trace(x=All_users$Date,y=All_users$Withdrawals, name="Total Withdrawal", 
              type='scatter',mode='lines', line=list(color='#cb181d'))%>%
    add_trace(y = ~Withdrawals, name="Matched Withdrawal",type = 'scatter', mode = 'lines', 
              line=list(color='#67000d', width=4 ,dash="dot"))%>%
    # add_trace(x=Matched_Yearly$Year,y=Matched_Yearly$Withdrawals,name="Yearly Matched Withdrawal (MGD)",type='scatter',
              # mode = 'lines', line=list(color='black',dash="dash"))%>%
    layout(# title = "Statewide Mean Daily Withdrawals in Virginia (MGD)",
      yaxis = list(title="Withdrawal (MGD)",
                   tickfont=list(color="black"), range=c(0,roundup+ceiling(max(All_users$Withdrawals)))), 
      xaxis = list(title = "Date"),
      margin=list(r=50),
      legend=list(orientation='h',xanchor="center",x=0.50,yanchor="top", y=-0.15))
  
  #--Non-Energy Sectors--#
  #--Energy Sector--#
  
  All_users_non<-VWUDS_2010_2017[!VWUDS_2010_2017$Use.Type=="Energy",]%>%
    dplyr::group_by(Date)%>%
    dplyr::summarise(Withdrawals=sum(as.numeric(Withdrawals_MGD), na.rm = T),nFacilities=n_distinct(VWUDS.Facility.ID))
  
  Matched_Yearly_nonenergy<-Matched_Facility_Withdrawals[!Matched_Facility_Withdrawals$Use.Type=="Energy",]%>%
    dplyr::group_by(Year)%>%
    dplyr::summarise(Withdrawals=sum(as.numeric(Withdrawals_MGD), na.rm = T))
  
  nonenergy<-full_match_2010_2017[!full_match_2010_2017$Use.Type=="Energy",]%>%
    dplyr::group_by(Date)%>%
    dplyr::summarise(Withdrawals=sum(as.numeric(Withdrawals_MGD), na.rm = T), nFacilities=n_distinct(as.character(VWUDS.Facility.ID)))%>%
    plot_ly(x = ~Date)%>%
    add_trace(y = ~Withdrawals, name="Matched Withdrawal",type = 'scatter', mode = 'lines',line=list(color='#67000d',width=4,dash="dot"))%>%
    add_trace(x=All_users_non$Date,y=All_users_non$Withdrawals, name="Total Withdrawal", 
              type='scatter',mode='lines', line=list(color='#cb181d'))%>%
    # add_trace(x=Matched_Yearly_nonenergy$Year,y=Matched_Yearly_nonenergy$Withdrawals,
              # name="Yearly Matched Withdrawal (MGD)",type='scatter',
              # mode = 'lines', line=list(color='black',dash="dash"))%>%
    layout(# title = "Statewide Ave Daily Withdrawals in Virginia (MGD)",
      yaxis = list(title="Withdrawal (MGD)",
                   tickfont=list(color="black"), range=c(0,roundup2+ceiling(max(All_users_non$Withdrawals)))), 
      xaxis = list(title = "Date"),
      margin=list(r=50),
      legend=list(orientation='h',xanchor="center",x=0.50,yanchor="top", y=-0.15))
  
  subplot<-plotly::subplot(style(energy,showlegend=F),nonenergy,shareX = T,nrows=2,titleX= T, 
                           titleY=T)%>%
    layout(annotations = list(
      list(x = 0.5 , y = 1.0, 
           text = "<b>(a) Energy Facilities</b>",
           showarrow = F, 
           xref='paper', yref='paper', xanchor='center',yanchor='bottom'),
      list(x = 0.5 , y = 0.50, 
           text = "<b>(b) Non-Energy Facilities</b>", 
           showarrow = F, xref='paper', yref='paper',xanchor='center',yanchor='top')))
  
  All_users<-Facility_Withdrawals[Facility_Withdrawals$Use.Type=="Energy",]%>%
    dplyr::group_by(Year)%>%
    dplyr::summarise(Total_Withdrawals=sum(Withdrawals_MGD,na.rm=T),
                     n_Facilities=n_distinct(as.character(VWUDS.Facility.ID)))
  
  Matched_users<-Matched_Facility_Withdrawals[Matched_Facility_Withdrawals$Use.Type=="Energy",]%>%
    dplyr::group_by(Year)%>%
    dplyr::summarise(Matched_Withdrawals=sum(as.numeric(Withdrawals_MGD), na.rm = T),
                     Matched_nFacilities=n_distinct(as.character(VWUDS.Facility.ID)))
  
  perc_total1<-merge(All_users,Matched_users,by=c("Year"))
  perc_total1$perc<-perc_total1$Matched_Withdrawals/perc_total1$Total_Withdrawals
  
  All_users<-Facility_Withdrawals[!Facility_Withdrawals$Use.Type=="Energy",]%>%
    dplyr::group_by(Year)%>%
    dplyr::summarise(Total_Withdrawals=sum(Withdrawals_MGD,na.rm=T),
                     n_Facilities=n_distinct(as.character(VWUDS.Facility.ID)))
  
  Matched_users<-Matched_Facility_Withdrawals[!Matched_Facility_Withdrawals$Use.Type=="Energy",]%>%
    dplyr::group_by(Year)%>%
    dplyr::summarise(Matched_Withdrawals=sum(as.numeric(Withdrawals_MGD), na.rm = T),
                     Matched_nFacilities=n_distinct(as.character(VWUDS.Facility.ID)))
  
  perc_total2<-merge(All_users,Matched_users,by=c("Year"))
  perc_total2$perc<-perc_total2$Matched_Withdrawals/perc_total2$Total_Withdrawals
  
  
  path="G:/My Drive/USGS_ConsumptiveUse/Spring, 2019/Statewide Analysis/Withdrawals/"
  file_name <- paste(path,"Matched_vs_Total_With", ".pdf", sep="")
  plotly_IMAGE(x=subplot,width=1000,height=800,format="pdf",out_file=file_name)
  
  return(list(subplot,perc_total1,perc_total2))
  
  
}
Statewide_Withdrawals_matchvstotal(100,20)

#------------------------------------------------------------------------------------#
#----Comparing Matched Water Users to Total Reported----#
Compare_Withdrawals<- function(All_Facilities,Full_Match,Sector,label,roundup){

  All_users<-All_Facilities%>%
  group_by(Date)%>%
  summarise(Withdrawals=sum(as.numeric(Withdrawals_MGD), na.rm = T),
            nFacilities=n_distinct(as.character(Facility)))
  
plot1<-Full_Match%>%
  dplyr::group_by(Date)%>%
  dplyr::summarise(Withdrawals=sum(as.numeric(Withdrawals_MGD), na.rm = T),
            nFacilities=n_distinct(as.character(VWUDS.Facility.ID)))%>%
  plot_ly(x = ~Date)%>%
  add_trace(y = ~Withdrawals, name="Matched Withdrawal",
            type = 'scatter', mode = 'lines',line=list(color='#67000d',width=4, dash="dot"),
            legendgroup='group1')%>%
  add_trace(x=All_users$Date,y=All_users$Withdrawals, name="Total Withdrawal", type='scatter',mode='lines',legendgroup='group1', line=list(color='#cb181d'))%>%
  add_trace(x=All_users$Date, y= All_users$nFacilities, name="All VWUDS Facilities", type='bar', yaxis='y2', opacity=0.25,
            marker=list(color='grey'),legendgroup='group2')%>%
  add_trace(y= ~nFacilities, name="Matched VWUDS Facilities", type='bar', yaxis='y2', opacity=0.60, marker=list(color='black'),legendgroup='group2')%>%
  layout(# title = "Statewide Mean Daily Withdrawals in Virginia (MGD)",
         yaxis = list(title="Withdrawal (MGD)",
                      tickfont=list(color="black"), range=c(0,roundup+ceiling(max(All_users$Withdrawals)))), 
         yaxis2 = list(tickfont=list(color="black"),
                     overlaying="y", side="right", title="Number of Reporting Facilities"),
         xaxis = list(title = "Date"),
         margin=list(r=50),
         legend=list(orientation='h',xanchor="center",x=0.50,yanchor="top", y=-0.15))

All_users<-Facility_Withdrawals%>%
  dplyr::group_by(Year)%>%
  dplyr::summarise(Total_Withdrawals=sum(Withdrawals_MGD,na.rm=T),
                   n_Facilities=n_distinct(as.character(VWUDS.Facility.ID)))

Matched_users<-Matched_Facility_Withdrawals%>%
  dplyr::group_by(Year)%>%
  dplyr::summarise(Matched_Withdrawals=sum(as.numeric(Withdrawals_MGD), na.rm = T),
            Matched_nFacilities=n_distinct(as.character(VWUDS.Facility.ID)))

perc_total1<-merge(All_users,Matched_users,by=c("Year"))
perc_total1$perc<-perc_total1$Matched_Withdrawals/perc_total1$Total_Withdrawals


All_sector<-subset(All_Facilities,All_Facilities$Use.Type==Sector)%>%
  group_by(Date)%>%
  summarise(Withdrawals=sum(as.numeric(Withdrawals_MGD), na.rm = T),
            nFacilities=n_distinct(as.character(Facility)))

plot2<-subset(Full_Match,Full_Match$Use.Type==Sector)%>%
  group_by(Date)%>%
  summarise(Withdrawals=sum(as.numeric(Withdrawals_MGD), na.rm = T),
            nFacilities=n_distinct(as.character(VWUDS.Facility.ID)))%>%
  plot_ly(x = ~Date)%>%
  add_trace(x=All_sector$Date,y=All_sector$Withdrawals, name="Total Withdrawal", type='scatter',mode='lines', line=list(color='#cb181d'))%>%
  add_trace(y = ~Withdrawals, name="Matched Withdrawal",type = 'scatter', mode = 'lines', line=list(color='#67000d',width=4,dash="dot"))%>%
  add_trace(y= ~nFacilities, name="Matched VWUDS Facilities", type='bar', yaxis='y2', opacity=0.60, marker=list(color='black'))%>%
  add_trace(x=All_sector$Date, y= All_sector$nFacilities, name="All VWUDS Facilities", type='bar', yaxis='y2', opacity=0.25,marker=list(color='grey'))%>%
  layout(# title = paste0("Statewide Mean Daily Withdrawals in Virginia (MGD): ",Sector," Sector"),
         yaxis = list(title="Withdrawal (MGD)",
                      tickfont=list(color="black"),
                      range=c(0,roundup+ceiling(max(All_sector$Withdrawals)))), 
         yaxis2 = list(tickfont=list(color="black"),
                       overlaying="y",
                       side="right",
                       title="Reporting Facilities"),
         xaxis = list(title = "Date"),
         margin=list(r=50),legend=list(orientation='h',xanchor="center",x=0.50,yanchor="top", y=-0.15))



All_users<-Facility_Withdrawals[Facility_Withdrawals$Use.Type==Sector,]%>%
  dplyr::group_by(Year)%>%
  dplyr::summarise(Total_Withdrawals=sum(Withdrawals_MGD,na.rm=T),
                   n_Facilities=n_distinct(as.character(VWUDS.Facility.ID)))

Matched_users<-Matched_Facility_Withdrawals[Matched_Facility_Withdrawals$Use.Type==Sector,]%>%
  dplyr::group_by(Year)%>%
  dplyr::summarise(Matched_Withdrawals=sum(as.numeric(Withdrawals_MGD), na.rm = T),
                   Matched_nFacilities=n_distinct(as.character(VWUDS.Facility.ID)))

perc_total2<-merge(All_users,Matched_users,by=c("Year"))
perc_total2$perc<-perc_total2$Matched_Withdrawals/perc_total2$Total_Withdrawals

path="G:/My Drive/USGS_ConsumptiveUse/Spring, 2019/Statewide Analysis/Withdrawals/"
file_name <- paste(path,"Matched_vs_Total_With_All_Sectors", ".pdf", sep="")
plotly_IMAGE(x=plot1,width=1000,height=500,format="pdf",out_file=file_name)

path="G:/My Drive/USGS_ConsumptiveUse/Spring, 2019/Statewide Analysis/Withdrawals/"
file_name <- paste(path,"Matched_vs_Total_With_",label, ".pdf", sep="")
plotly_IMAGE(x=plot2,width=1000,height=500,format="pdf",out_file=file_name)

return(list(plot2,perc_total1,perc_total2))

}
Compare_Withdrawals(VWUDS_2010_2017,full_match_2010_2017,"Energy","Energy",100)
Compare_Withdrawals(VWUDS_2010_2017,full_match_2010_2017,"Industrial","Industrial",50)
# Compare_Withdrawals(VWUDS_2010_2017,full_match_2010_2017,"Municipal","Municipal",10)
Compare_Withdrawals(VWUDS_2010_2017,full_match_2010_2017,"Commercial","Commercial",2)
Compare_Withdrawals(VWUDS_2010_2017,full_match_2010_2017,"Aquaculture","Aquaculture",2)

ag_Withdrawals<- function(All_Facilities,Sector,label,roundup){
  
  All_sector<-subset(All_Facilities,All_Facilities$Use.Type==Sector)%>%
    dplyr::group_by(Date)%>%
    dplyr::summarise(Withdrawals=sum(as.numeric(Withdrawals_MGD), na.rm = T),
              nFacilities=n_distinct(as.character(Facility)))
  
  All_users<-Facility_Withdrawals[Facility_Withdrawals$Use.Type==Sector,]%>%
    dplyr::group_by(Year)%>%
    dplyr::summarise(Total_Withdrawals=sum(Withdrawals_MGD,na.rm=T),
                     n_Facilities=n_distinct(as.character(VWUDS.Facility.ID)))
  
  plot1<-subset(All_Facilities,All_Facilities$Use.Type==Sector)%>%
    dplyr::group_by(Date)%>%
    dplyr::summarise(Withdrawals=sum(as.numeric(Withdrawals_MGD), na.rm = T),
              nFacilities=n_distinct(as.character(VWUDS.Facility.ID)))%>%
    plot_ly(x = ~Date)%>%
    add_trace(y = ~Withdrawals, name="Total Withdrawal",type = 'scatter', mode = 'lines', line=list(color='#cb181d'))%>%
    add_trace(y= ~nFacilities, name="All VWUDS Facilities", type='bar', yaxis='y2', opacity=0.25, marker=list(color='grey'))%>%
    layout(# title = paste0("Statewide Mean Daily Withdrawals in Virginia (MGD): ",Sector," Sector"),
      yaxis = list(title="Withdrawal (MGD)",
                   tickfont=list(color="black"),
                   range=c(0,roundup+ceiling(max(All_sector$Withdrawals)))), 
      yaxis2 = list(tickfont=list(color="black"),
                    overlaying="y",
                    side="right",
                    title="Reporting Facilities"),
      xaxis = list(title = "Date"),
      margin=list(r=50),legend=list(orientation='h',xanchor="center",x=0.50,yanchor="top", y=-0.15))
  
  path="G:/My Drive/USGS_ConsumptiveUse/Spring, 2019/Statewide Analysis/Withdrawals/"
  file_name <- paste(path,label,"_Withdrawals",".pdf", sep="")
  plotly_IMAGE(x=plot1,width=1000,height=500,format="pdf",out_file=file_name)
  
  
  return(list(plot1,All_users))
  
}
ag_Withdrawals(VWUDS_2010_2017,"Agriculture/Irrigation","Agriculture",2)

withdrawal_tables<- function(All_Facilities,Full_Match,Sector){
  table1<-All_Facilities[All_Facilities$Use.Type==Sector,]%>%
    dplyr::group_by(Year)%>%
    dplyr::summarise(no_Facilities=n_distinct(VWUDS.Facility.ID),
                     no_sources=sum(Sources), 
                     Sum_Withdrawals_MGD=sum(Withdrawals_MGD,na.rm=T))
  
  table2<-Full_Match[Full_Match$Use.Type==Sector,]%>%
    dplyr::group_by(Year)%>%
    dplyr::summarise(no_Facilities=n_distinct(VWUDS.Facility.ID),
                     Sum_Withdrawals_MGD=sum(Withdrawals_MGD,na.rm=T))
  
  return(list(table1,table2))
}
withdrawal_tables(Facility_Withdrawals,Matched_Facility_Withdrawals,"Aquaculture")
withdrawal_tables(Facility_Withdrawals,Matched_Facility_Withdrawals,"Commercial")

#------------------------------------------------------------------------------------#

#-----Sub-Plots of the figures produced above-------#

withdrawal_subplot<- function(All_Facilities,Full_Match,Sector,label,roundup,yaxis_2){
  
  All_sector<-subset(All_Facilities,All_Facilities$Use.Type==Sector)%>%
    group_by(Date)%>%
    summarise(Withdrawals=sum(as.numeric(Withdrawals_MGD), na.rm = T),
              nFacilities=n_distinct(as.character(Facility)))
  
  plot2<-subset(Full_Match,Full_Match$Use.Type==Sector)%>%
    group_by(Date)%>%
    summarise(Withdrawals=sum(as.numeric(Withdrawals_MGD), na.rm = T),
              nFacilities=n_distinct(as.character(VWUDS.Facility.ID)))%>%
    plot_ly(x = ~Date)%>%
    add_trace(x=All_sector$Date,y=All_sector$Withdrawals, name="Total Withdrawal", type='scatter',mode='lines', line=list(color='#cb181d'))%>%
    add_trace(y = ~Withdrawals, name="Matched Withdrawal",type = 'scatter', mode = 'lines', line=list(color='#67000d',width=4,dash="dot"))%>%
    add_trace(y= ~nFacilities, name="Matched VWUDS Facilities", type='bar', yaxis='y2', opacity=0.60, marker=list(color='black'))%>%
    add_trace(x=All_sector$Date, y= All_sector$nFacilities, name="All VWUDS Facilities", type='bar', yaxis='y2', opacity=0.25,marker=list(color='grey'))%>%
    layout(# title = paste0("Statewide Mean Daily Withdrawals in Virginia (MGD): ",Sector," Sector"),
      yaxis = list(title="Withdrawal (MGD)",
                   tickfont=list(color="black"),
                   range=c(0,roundup+ceiling(max(All_sector$Withdrawals)))), 
      yaxis2 = list(tickfont=list(color="black"),
                    overlaying=yaxis_2,
                    side="right",
                    title="Reporting Facilities"),
      xaxis = list(title = "Date"),
      legend=list(orientation='h',xanchor="center",yanchor="top",x=0.50, y=-0.10)
    )

  assign(paste0(label,"_with_plot"),plot2,envir = .GlobalEnv)
  
}
withdrawal_subplot(VWUDS_2010_2017,full_match_2010_2017,"Energy","Energy",50,"y") #y
withdrawal_subplot(VWUDS_2010_2017,full_match_2010_2017,"Industrial","Industrial",50,"y3")
withdrawal_subplot(VWUDS_2010_2017,full_match_2010_2017,"Commercial","Commercial",2,"y5") #y5
withdrawal_subplot(VWUDS_2010_2017,full_match_2010_2017,"Aquaculture","Aquaculture",2,"y7") #y7

other_Withdrawals<- function(All_Facilities,Sector,label,roundup,yaxis_2){
  
  All_sector<-subset(All_Facilities,All_Facilities$Use.Type==Sector)%>%
    group_by(Date)%>%
    summarise(Withdrawals=sum(as.numeric(Withdrawals_MGD), na.rm = T),
              nFacilities=n_distinct(as.character(Facility)))
  
  All_users<-Facility_Withdrawals[Facility_Withdrawals$Use.Type==Sector,]%>%
    dplyr::group_by(Year)%>%
    dplyr::summarise(Total_Withdrawals=sum(Withdrawals_MGD,na.rm=T),
                     n_Facilities=n_distinct(as.character(VWUDS.Facility.ID)))
  
  plot1<-subset(All_Facilities,All_Facilities$Use.Type==Sector)%>%
    group_by(Date)%>%
    summarise(Withdrawals=sum(as.numeric(Withdrawals_MGD), na.rm = T),
              nFacilities=n_distinct(as.character(VWUDS.Facility.ID)))%>%
    plot_ly(x = ~Date)%>%
    add_trace(y = ~Withdrawals, name="Total Withdrawal",type = 'scatter',mode = 'lines', line=list(color='#cb181d'))%>%
    add_trace(y= ~nFacilities, name="All VWUDS Facilities", type='bar', yaxis='y2', opacity=0.25, marker=list(color='grey'),showlegend=F)%>%
    layout(# title = paste0("Statewide Mean Daily Withdrawals in Virginia (MGD): ",Sector," Sector"),
      yaxis = list(title="Withdrawal (MGD)",
                   side="left",
                   tickfont=list(color="black"),
                   range=c(0,roundup+ceiling(max(All_sector$Withdrawals)))), 
      yaxis2 = list(tickfont=list(color="black"),
                    overlaying=yaxis_2,
                    side="right",
                    title="Reporting Facilities"),
      xaxis = list(title = "Date"),
      margin=list(r=50),legend=list(orientation='h',xanchor="center",x=0.50,yanchor="top", y=-0.15))


  assign(paste0(label,"_with_plot"),plot1,envir = .GlobalEnv)
  
}
other_Withdrawals(VWUDS_2010_2017,"Agriculture/Irrigation","Agriculture",2,"y9") #change to aquaculture y9
other_Withdrawals(VWUDS_2010_2017,"Municipal","Municipal",2,"y11") # y11

all_subplot<- function(industrial,commercial, aquaculture,energy,agriculture,municipal,label,path){
  subplot<-plotly::subplot(energy,style(industrial,showlegend=F),style(commercial,showlegend=F),
                           style(aquaculture,showlegend=F),style(agriculture,showlegend=F),
                           style(municipal,showlegend=F),shareX = T,
                           nrows=3,titleX= T, titleY=T,margin=0.07)%>%
    layout(annotations = list(
      list(x = 0.225 , y = 1.0, 
           text = "<b>(a) Energy</b>",
           showarrow = F, 
           xref='paper', yref='paper', xanchor='center',yanchor='bottom'),
      list(x = 0.775 , y = 1.0, 
           text = "<b>(b) Industrial</b>", 
           showarrow = F, xref='paper', yref='paper',xanchor='center',yanchor='bottom'),
      list(x = 0.225 , y = 0.60, 
           text = "<b>(c) Commercial</b>",
           showarrow = F, 
           xref='paper', yref='paper', xanchor='center',yanchor='bottom'),
      list(x = 0.775 , y = 0.60, 
           text = "<b>(d) Aquaculture</b>",
           showarrow = F, 
           xref='paper', yref='paper', xanchor='center',yanchor='bottom'),
      list(x = 0.225 , y = 0.25, 
           text = "<b>(e) Agriculture/Irrigation</b>",
           showarrow = F, 
           xref='paper', yref='paper', xanchor='center',yanchor='bottom'),
      list(x = 0.775 , y = 0.25, 
           text = "<b>(f) Municipal</b>",
           showarrow = F, 
           xref='paper', yref='paper', xanchor='center',yanchor='bottom')))
  
  file_name <- paste(path,"Matched_vs_Total_",label,".pdf", sep="")
  plotly_IMAGE(x=subplot,width=1000,height=1000,format="pdf",out_file=file_name)
}
all_subplot(Industrial_with_plot,Commercial_with_plot,Aquaculture_with_plot,Energy_with_plot,
            Agriculture_with_plot,Municipal_with_plot,"withdrawal",path="G:/My Drive/USGS_ConsumptiveUse/Spring, 2019/Statewide Analysis/Withdrawals/")

all_nonenergy_subplot<- function(industrial,commercial, aquaculture,energy,agriculture,municipal,label,path){
  subplot<-plotly::subplot(style(commercial,showlegend=F),
                           style(aquaculture,showlegend=F),style(agriculture,showlegend=F),
                           style(municipal,showlegend=F),energy,style(industrial,showlegend=F),shareX = T,
                           nrows=3,titleX= T, titleY=T,margin=0.07)%>%
    layout(annotations = list(
      list(x = 0.225 , y = 1.0, 
           text = "<b>Commercial </b>",
           showarrow = F, 
           xref='paper', yref='paper', xanchor='center',yanchor='bottom'),
      list(x = 0.775 , y = 1.0, 
           text = "<b>Aquaculture </b>", 
           showarrow = F, xref='paper', yref='paper',xanchor='center',yanchor='bottom'),
      list(x = 0.225 , y = 0.60, 
           text = "<b>Agriculture</b>",
           showarrow = F, 
           xref='paper', yref='paper', xanchor='center',yanchor='bottom'),
      list(x = 0.775 , y = 0.60, 
           text = "<b>Municipal</b>",
           showarrow = F, 
           xref='paper', yref='paper', xanchor='center',yanchor='bottom'),
      list(x = 0.225 , y = 0.25, 
           text = "<b>(a) Energy</b>",
           showarrow = F, 
           xref='paper', yref='paper', xanchor='center',yanchor='bottom'),
      list(x = 0.775 , y = 0.25, 
           text = "<b>(b) Non-Energy</b>",
           showarrow = F, 
           xref='paper', yref='paper', xanchor='center',yanchor='bottom')))
  
  file_name <- paste(path,"Matched_vs_Total_",label,".pdf", sep="")
  plotly_IMAGE(x=subplot,width=1000,height=1000,format="pdf",out_file=file_name)
}

#----------------------------------------------------------Discharges--------------------------------------------------------------------#
#-------Mean Daily Discharge MGD----------#
Statewide_Discharges<- function(Fac_Discharges,timeseries,label){
  
  #--For all sectors--#
Yearly_Discharge<-Fac_Discharges%>%
  dplyr::group_by(Year)%>%
  dplyr::summarise(Discharges_MGD=sum(Discharges_MGD),nFacilities=n_distinct(VPDES.Facility.ID))
Yearly_Discharge<-transform(Yearly_Discharge, Year=as.Date(as.character(Year),"%Y"))


#--Energy Facilities--#
energy_Yearly_Discharge<-Fac_Discharges[Fac_Discharges$Use.Type=='Energy',]%>%
  dplyr::group_by(Year)%>%
  dplyr::summarise(Discharges_MGD=sum(Discharges_MGD),nFacilities=n_distinct(VPDES.Facility.ID))

energy_Yearly_Discharge<-transform(energy_Yearly_Discharge, Year=as.Date(as.character(Year),"%Y"))

label1 <- list(
  xref = 'x', yref = 'y',
  x = energy_Yearly_Discharge$Year[1],
  y = energy_Yearly_Discharge$Discharges_MGD[1],
  xanchor = 'right',
  yanchor = 'middle',
  text = ~paste(round(energy_Yearly_Discharge$Discharges_MGD[1],digits=0), 'MGD'), font = list(family = 'Arial',size = 12),showarrow = FALSE)

label2 <- list(
  xref = 'x',
  yref = 'y',
  x = energy_Yearly_Discharge$Year[8],
  y = energy_Yearly_Discharge$Discharges_MGD[8],
  xanchor = 'left',
  yanchor = 'bottom',
  text = ~paste(round(energy_Yearly_Discharge$Discharges_MGD[8],digits=0), 'MGD'),font = list(family = 'Arial',size = 12,color = 'rgba(67,67,67,1)'),showarrow = FALSE)

energyMonthly<-timeseries[timeseries$Use.Type=='Energy',]%>%
  dplyr::group_by(Date)%>%
  dplyr::summarise(Discharges=sum(Discharges_MGD,na.rm=T))
  
energy<-timeseries[timeseries$Use.Type=='Energy',]%>%
  dplyr::group_by(Date)%>%
  dplyr::summarise(Discharges=sum(Discharges_MGD,na.rm=T),
            nFacilities=n_distinct(as.character(VPDES.Facility.ID)))%>%
  plot_ly(x = ~Date)%>%
  add_trace(y = ~Discharges, name="Monthly Discharge", type='scatter', mode = 'lines',line=list(color='#2171b5'))%>%
  add_trace(x=energy_Yearly_Discharge$Year, y=energy_Yearly_Discharge$Discharges_MGD, name="Yearly Discharge",type='scatter',
            mode = 'lines',line=list(color='black',dash="dash"))%>%
  layout(# title = paste0("Statewide Mean Daily Discharge (MGD) in Virginia: ",label),
         yaxis = list(title="Discharge (MGD)",
                      tickfont=list(color="black"),
                      range=c(0,100+max(energyMonthly$Discharges))),
         xaxis = list(title = "Date"),
         legend=list(orientation='h',xanchor="center",yanchor="top", x=0.50, y=-0.15))
         # annotations=label1)%>%
  # layout(annotations=label2)


#--Non-energy sectors--#

nonenergy_Yearly_Discharge<-Fac_Discharges[!Fac_Discharges$Use.Type=='Energy',]%>%
  dplyr::group_by(Year)%>%
  dplyr::summarise(Discharges_MGD=sum(Discharges_MGD),nFacilities=n_distinct(VPDES.Facility.ID))

nonenergy_Yearly_Discharge<-transform(nonenergy_Yearly_Discharge, Year=as.Date(as.character(Year),"%Y"))

label3 <- list(
  xref = 'x', yref = 'y',
  x = nonenergy_Yearly_Discharge$Year[1],
  y = nonenergy_Yearly_Discharge$Discharges_MGD[1],
  xanchor = 'right',
  yanchor = 'middle',
  text = ~paste(round(nonenergy_Yearly_Discharge$Discharges_MGD[1],digits=0), 'MGD'), font = list(family = 'Arial',size = 12),showarrow = FALSE)

label3 <- list(
  xref = 'x',
  yref = 'y',
  x = nonenergy_Yearly_Discharge$Year[8],
  y = nonenergy_Yearly_Discharge$Discharges_MGD[8],
  xanchor = 'left',
  yanchor = 'bottom',
  text = ~paste(round(nonenergy_Yearly_Discharge$Discharges_MGD[8],digits=0), 'MGD'),font = list(family = 'Arial',size = 12,color = 'rgba(67,67,67,1)'),showarrow = FALSE)

nonenergyMonthly<-timeseries[!timeseries$Use.Type=='Energy',]%>%
  dplyr::group_by(Date)%>%
  dplyr::summarise(Discharges=sum(Discharges_MGD,na.rm=T))

nonenergy<-timeseries[!timeseries$Use.Type=='Energy',]%>%
  dplyr::group_by(Date)%>%
  dplyr::summarise(Discharges=sum(Discharges_MGD,na.rm=T),
                   nFacilities=n_distinct(as.character(VPDES.Facility.ID)))%>%
  plot_ly(x = ~Date)%>%
  add_trace(y = ~Discharges, name="Monthly Discharge", type='scatter', mode = 'lines', line=list(color='#2171b5'))%>%
  add_trace(x=nonenergy_Yearly_Discharge$Year, y=nonenergy_Yearly_Discharge$Discharges_MGD, name="Yearly Discharge",type='scatter',
            mode = 'lines', line=list(color='black',dash="dash"))%>%
  layout(# title = paste0("Statewide Mean Daily Discharge (MGD) in Virginia: ",label),
    yaxis = list(title="Discharge (MGD)",
                 tickfont=list(color="black"),
                 range=c(0,50+max(nonenergyMonthly$Discharges))),
    xaxis = list(title = "Date"),
    legend=list(orientation='h', xanchor="center", x=0.50,yanchor="top", y=-0.15))
# annotations=label1)%>%
# layout(annotations=label2)

subplot<-plotly::subplot(style(energy,showlegend=F),nonenergy,shareX = T,nrows=2,titleX= T, 
                 titleY=T)%>%
  layout(annotations = list(
    list(x = 0.5 , y = 1.0, 
         text = "<b>(a) Energy Facilities</b>",
         showarrow = F, 
         xref='paper', yref='paper', xanchor='center',yanchor='bottom'),
    list(x = 0.5 , y = 0.50, 
         text = "<b>(b) Non-Energy Facilities</b>", 
         showarrow = F, xref='paper', yref='paper',xanchor='center',yanchor='top')))


path="G:/My Drive/USGS_ConsumptiveUse/Spring, 2019/Statewide Analysis/Discharges/"
file_name <- paste(path,"Statewide_Discharges_Energy",label, ".pdf", sep="")
plotly_IMAGE(x=energy,width=1000,height=500,format="pdf",out_file=file_name)

path="G:/My Drive/USGS_ConsumptiveUse/Spring, 2019/Statewide Analysis/Discharges/"
file_name <- paste(path,"Statewide_Discharges_NonEnergy",label, ".pdf", sep="")
plotly_IMAGE(x=nonenergy,width=1000,height=500,format="pdf",out_file=file_name)

path="G:/My Drive/USGS_ConsumptiveUse/Spring, 2019/Statewide Analysis/Discharges/"
file_name <- paste(path,"Statewide_Discharges_",label, ".pdf", sep="")
plotly_IMAGE(x=subplot,width=1000,height=800,format="pdf",out_file=file_name)

return(list(Yearly_Discharge,subplot,energy_Yearly_Discharge,nonenergy_Yearly_Discharge))
}
Statewide_Discharges(Facility_Discharges,ECHO_2010_2017,"All_Facilities_in_All_Sectors")
Statewide_Discharges(Matched_Facility_Discharges,full_match_2010_2017,"Matched_Facilities_in_All_Sectors")

Statewide_Discharges_matchvstotal<- function(roundup,roundup2){
  
  #--Energy Sector--#
  
  All_users<-ECHO_2010_2017[ECHO_2010_2017$Use.Type=="Energy",]%>%
    dplyr::group_by(Date)%>%
    dplyr::summarise(Discharges=sum(as.numeric(Discharges_MGD), na.rm = T))
  
  Matched_Yearly<-Matched_Facility_Discharges[Matched_Facility_Discharges$Use.Type=="Energy",]%>%
    dplyr::group_by(Year)%>%
    dplyr::summarise(Discharges=sum(as.numeric(Discharges_MGD), na.rm = T))
  
  energy<-full_match_2010_2017[full_match_2010_2017$Use.Type=="Energy",]%>%
    dplyr::group_by(Date)%>%
    dplyr::summarise(Discharges=sum(as.numeric(Discharges_MGD), na.rm = T))%>%
    plot_ly(x = ~Date)%>%
    add_trace(x=All_users$Date,y=All_users$Discharges, name="Total Discharge (MGD)", 
              type='scatter',mode='lines', line=list(color='#2171b5'))%>%
    add_trace(y = ~Discharges, name="Matched Discharge (MGD)",type = 'scatter', mode = 'lines',
              line=list(color='#08306b',width=4,dash="dot"))%>%
    # add_trace(x=Matched_Yearly$Year,y=Matched_Yearly$Discharges,name="Yearly Matched Discharge (MGD)",type='scatter',
              # mode = 'lines', line=list(color='black'))%>%
    layout(# title = "Statewide Mean Daily Discharges in Virginia (MGD)",
      yaxis = list(title="Discharge (MGD)",
                   tickfont=list(color="black"), range=c(0,roundup+ceiling(max(All_users$Discharges)))), 
      yaxis2 = list(tickfont=list(color="black"),
                    overlaying="y", side="right", title="Number of Reporting Facilities"),
      xaxis = list(title = "Date"),
      margin=list(r=50),
      legend=list(orientation='h',xanchor="center",x=0.50,yanchor="top", y=-0.15))
  
  #--Non-Energy Sectors--#
  #--Energy Sector--#
  
  All_users_non<-ECHO_2010_2017[!ECHO_2010_2017$Use.Type=="Energy",]%>%
    dplyr::group_by(Date)%>%
    dplyr::summarise(Discharges=sum(as.numeric(Discharges_MGD), na.rm = T))
  
  Matched_Yearly_non<-Matched_Facility_Discharges[!Matched_Facility_Discharges$Use.Type=="Energy",]%>%
    dplyr::group_by(Year)%>%
    dplyr::summarise(Discharges=sum(as.numeric(Discharges_MGD), na.rm = T))
  
  nonenergy<-full_match_2010_2017[!full_match_2010_2017$Use.Type=="Energy",]%>%
    dplyr::group_by(Date)%>%
    dplyr::summarise(Discharges=sum(as.numeric(Discharges_MGD), na.rm = T))%>%
    plot_ly(x = ~Date)%>%
    add_trace(y = ~Discharges, name="Matched Discharge",type = 'scatter', mode = 'lines',
              line=list(color='#08306b',width=4,dash="dot"))%>%
    add_trace(x=All_users_non$Date,y=All_users_non$Discharges, name="Total Discharge", 
              type='scatter',mode='lines', line=list(color='#2171b5'))%>%
    # add_trace(x=Matched_Yearly_non$Year,y=Matched_Yearly_non$Discharges,name="Yearly Matched Discharge (MGD)",type='scatter',
              # mode = 'lines+markers', marker=list(color='black'), line=list(color='black'))%>%
    layout(# title = "Statewide Mean Daily Discharges in Virginia (MGD)",
      yaxis = list(title="Discharge (MGD)",
                   tickfont=list(color="black"), range=c(0,roundup+ceiling(max(All_users_non$Discharges)))), 
      yaxis2 = list(tickfont=list(color="black"),
                    overlaying="y", side="right", title="Number of Reporting Facilities"),
      xaxis = list(title = "Date"),
      margin=list(r=50),
      legend=list(orientation='h',xanchor="center",x=0.50,yanchor="top", y=-0.15))
  
  subplot<-plotly::subplot(style(energy,showlegend=F),nonenergy,shareX = T,nrows=2,titleX= T, 
                           titleY=T)%>%
    layout(annotations = list(
      list(x = 0.5 , y = 1.0, 
           text = "<b>Energy Facilities</b>",
           showarrow = F, 
           xref='paper', yref='paper', xanchor='center',yanchor='bottom'),
      list(x = 0.5 , y = 0.50, 
           text = "<b>Non-Energy Facilities</b>", 
           showarrow = F, xref='paper', yref='paper',xanchor='center',yanchor='top')))
  
  #--Compare % of Total Reported Discharges--#
  All_users<-Facility_Discharges[Facility_Discharges$Use.Type=="Energy",]%>%
    dplyr::group_by(Year)%>%
    dplyr::summarise(Total_Discharges=sum(Discharges_MGD,na.rm=T),
                     n_Facilities=n_distinct(as.character(VPDES.Facility.ID)))
  
  Matched_users<-Matched_Facility_Discharges[Matched_Facility_Discharges$Use.Type=="Energy",]%>%
    dplyr::group_by(Year)%>%
    dplyr::summarise(Matched_Discharges=sum(as.numeric(Discharges_MGD), na.rm = T),
                     Matched_nFacilities=n_distinct(as.character(VPDES.Facility.ID)))
  
  perc_total1<-merge(All_users,Matched_users,by=c("Year"))
  perc_total1$perc<-perc_total1$Matched_Discharges/perc_total1$Total_Discharges
  
  All_users<-Facility_Discharges[!Facility_Discharges$Use.Type=="Energy",]%>%
    dplyr::group_by(Year)%>%
    dplyr::summarise(Total_Discharges=sum(Discharges_MGD,na.rm=T),
                     n_Facilities=n_distinct(as.character(VPDES.Facility.ID)))
  
  Matched_users<-Matched_Facility_Discharges[!Matched_Facility_Discharges$Use.Type=="Energy",]%>%
    dplyr::group_by(Year)%>%
    dplyr::summarise(Matched_Discharges=sum(as.numeric(Discharges_MGD), na.rm = T),
                     Matched_nFacilities=n_distinct(as.character(VPDES.Facility.ID)))
  
  perc_total2<-merge(All_users,Matched_users,by=c("Year"))
  perc_total2$perc<-perc_total2$Matched_Discharges/perc_total2$Total_Discharges
  
  path="G:/My Drive/USGS_ConsumptiveUse/Spring, 2019/Statewide Analysis/Discharges/"
  file_name <- paste(path,"Matched_vs_Total_Disc", ".pdf", sep="")
  plotly_IMAGE(x=subplot,width=1000,height=800,format="pdf",out_file=file_name)
  
  return(list(subplot,perc_total1,perc_total2))
  
  
}
Statewide_Discharges_matchvstotal(100,20)
#----Comparing Matched Water Users to Total Reported----#

Compare_Discharges<- function(All_Facilities,Full_Match,Sector,label,roundup){
  
  All_dis<-All_Facilities%>%
    group_by(Date)%>%
    summarise(Discharges=sum(as.numeric(Discharges_MGD), na.rm = T),
              nFacilities=n_distinct(as.character(VPDES.Facility.ID)))
  
  plot1<-Full_Match%>%
    group_by(Date)%>%
    summarise(Discharges=sum(as.numeric(Discharges_MGD), na.rm = T),
              nFacilities=n_distinct(as.character(VPDES.Facility.ID)))%>%
    plot_ly(x = ~Date)%>%
    add_trace(x=All_dis$Date,y=All_dis$Discharges, name="Total Discharge", type='scatter',
              mode='lines', line=list(color='#2171b5'))%>%
    add_trace(y = ~Discharges, name="Matched Discharge",type = 'scatter', mode = 'lines', 
              line=list(color='#08306b',width=4,dash="dot"))%>%
    add_trace(y= ~nFacilities, name="Matched VPDES Facilities", type='bar', yaxis='y2', opacity=1,
              marker=list(color='black'))%>%
    add_trace(x=All_dis$Date, y= All_dis$nFacilities, name="All VPDES Facilities", type='bar', yaxis='y2', opacity=0.25,
              marker=list(color='grey'))%>%
    layout(# title = "Statewide Mean Daily Discharges in Virginia (MGD)",
           yaxis = list(title="Discharge (MGD)",
                        tickfont=list(color="black"),
                        range=c(0,roundup+max(All_dis$Discharges))), #10500 all sectors
           yaxis2 = list(tickfont=list(color="black"),
                         overlaying="y",
                         side="right",
                         title="Reporting Facilities"),
           xaxis = list(title = "Date"),
           margin=list(r=50)
           ,legend=list(orientation='h',xanchor="center",x=0.50,yanchor="top", y=-0.15))

  
  #---Quick Summary Table of Total Discharges vs. Matched Discharges---#
  
  All_users<-Facility_Discharges%>%
    dplyr::group_by(Year)%>%
    dplyr::summarise(Total_Discharges=sum(Discharges_MGD,na.rm=T),
                     n_Facilities=n_distinct(as.character(VPDES.Facility.ID)))
  
  Matched_users<-Matched_Facility_Discharges%>%
    dplyr::group_by(Year)%>%
    dplyr::summarise(Matched_Discharges=sum(as.numeric(Discharges_MGD), na.rm = T),
                     Matched_nFacilities=n_distinct(as.character(VPDES.Facility.ID)))
  
  perc_total1<-merge(All_users,Matched_users,by=c("Year"))
  perc_total1$perc<-perc_total1$Matched_Discharges/perc_total1$Total_Discharges
  
  #------------------------------------------------------------------------------#
  
  All_sector<-subset(All_Facilities,All_Facilities$Use.Type==Sector)%>%
    group_by(Date)%>%
    summarise(Discharges=sum(as.numeric(Discharges_MGD), na.rm = T),
              nFacilities=n_distinct(as.character(VPDES.Facility.ID)))
  
  plot2<-subset(Full_Match,Full_Match$Use.Type==Sector)%>%
    group_by(Date)%>%
    summarise(Discharges=sum(as.numeric(Discharges_MGD), na.rm = T),
              nFacilities=n_distinct(as.character(VPDES.Facility.ID)))%>%
    plot_ly(x = ~Date)%>%
    add_trace(x=All_sector$Date,y=All_sector$Discharges, name="Total Discharge", type='scatter',
              mode='lines',line=list(color='#2171b5'))%>%
    add_trace(y = ~Discharges, name="Matched Discharge",type = 'scatter', mode = 'lines', 
              line=list(color='#08306b',width=4,dash="dot"))%>%
    add_trace(y= ~nFacilities, name="Matched VPDES Facilities", type='bar', yaxis='y2', opacity=0.60,
              marker=list(color='black'))%>%
    add_trace(x=All_sector$Date, y= All_sector$nFacilities, name="All VPDES Facilities", type='bar', yaxis='y2', opacity=0.25,
              marker=list(color='grey'))%>%
    layout(# title = paste0("Statewide Mean Daily Discharges in Virginia (MGD): ",Sector," Sector"),
           yaxis = list(title="Discharge (MGD)",
                        tickfont=list(color="black"),
                        range=c(0,roundup+max(All_sector$Discharges))), #10500 all sectors
           yaxis2 = list(tickfont=list(color="black"),
                         overlaying="y",
                         side="right",
                         title="Reporting Facilities"),
           xaxis = list(title = "Date"),
           margin=list(r=50),
           legend=list(orientation='h',xanchor="center",x=0.50,yanchor="top", y=-0.15))

  
  #---Quick Summary Table of Total Discharges vs. Matched Discharges---#
  
  All_users<-Facility_Discharges[Facility_Discharges$Use.Type==Sector,]%>%
    dplyr::group_by(Year)%>%
    dplyr::summarise(Total_Discharges=sum(Discharges_MGD,na.rm=T),
                     n_Facilities=n_distinct(as.character(VPDES.Facility.ID)))
  
  Matched_users<-Matched_Facility_Discharges[Matched_Facility_Discharges$Use.Type==Sector,]%>%
    dplyr::group_by(Year)%>%
    dplyr::summarise(Matched_Discharges=sum(as.numeric(Discharges_MGD), na.rm = T),
                     Matched_nFacilities=n_distinct(as.character(VPDES.Facility.ID)))
  
  perc_total2<-merge(All_users,Matched_users,by=c("Year"))
  perc_total2$perc<-perc_total2$Matched_Discharges/perc_total2$Total_Discharges
  
  
  
  path="G:/My Drive/USGS_ConsumptiveUse/Spring, 2019/Statewide Analysis/Discharges/"
  file_name <- paste(path,"Matched_vs_Total_Dis_All_Sectors", ".pdf", sep="")
  plotly_IMAGE(x=plot1,width=1000,height=500,format="pdf",out_file=file_name)
  
  path="G:/My Drive/USGS_ConsumptiveUse/Spring, 2019/Statewide Analysis/Discharges/"
  file_name <- paste(path,"Matched_vs_Total_Dis_",label, ".pdf", sep="")
  plotly_IMAGE(x=plot2,width=1000,height=500,format="pdf",out_file=file_name)
  
  return(list(plot1,plot2,perc_total1,perc_total2))
  
}
Compare_Discharges(ECHO_2010_2017,full_match_2010_2017,"Energy","Energy",100)
Compare_Discharges(ECHO_2010_2017,full_match_2010_2017,"Industrial","Industrial",20)
# Compare_Discharges(ECHO_2010_2017,full_match_2010_2017,"Municipal","Municipal",10)
Compare_Discharges(ECHO_2010_2017,full_match_2010_2017,"Commercial","Commercial",2)
Compare_Discharges(ECHO_2010_2017,full_match_2010_2017,"Aquaculture","Aquaculture",2)

#------------------------------------------------------------------------------------#
#-----Sub-Plots of the figures produced above-------#
ECHO_2010_2017$Date<-as.Date(ECHO_2010_2017$Date,format="%Y-%m-%d")

discharge_subplot<- function(All_Facilities,Full_Match,Sector,label,roundup,yaxis_2){
  
  All_sector<-subset(All_Facilities,All_Facilities$Use.Type==Sector)%>%
    group_by(Date)%>%
    summarise(Discharges=sum(as.numeric(Discharges_MGD), na.rm = T),
              nFacilities=n_distinct(as.character(VPDES.Facility.ID)))
  
  plot2<-subset(Full_Match,Full_Match$Use.Type==Sector)%>%
    group_by(Date)%>%
    summarise(Discharges=sum(as.numeric(Discharges_MGD), na.rm = T),
              nFacilities=n_distinct(as.character(VPDES.Facility.ID)))%>%
    plot_ly(x = ~Date)%>%
    add_trace(x=All_sector$Date,y=All_sector$Discharges, name="Total Discharge", type='scatter',
              mode='lines',line=list(color='#2171b5'))%>%
    add_trace(y = ~Discharges, name="Matched Discharge",type = 'scatter', mode = 'lines', 
              line=list(color='#08306b',width=4,dash="dot"))%>%
    add_trace(y= ~nFacilities, name="Matched VPDES Facilities", type='bar', yaxis='y2', opacity=0.60,
              marker=list(color='black'))%>%
    add_trace(x=All_sector$Date, y= All_sector$nFacilities, name="All VPDES Facilities", type='bar', yaxis='y2', opacity=0.25,
              marker=list(color='grey'))%>%
    layout(# title = paste0("Statewide Mean Daily Discharges in Virginia (MGD): ",Sector," Sector"),
      yaxis = list(title="Discharge (MGD)",
                   tickfont=list(color="black"),
                   range=c(0,roundup+max(All_sector$Discharges))), #10500 all sectors
      yaxis2 = list(tickfont=list(color="black"),
                    overlaying=yaxis_2,
                    side="right",
                    title="Reporting Facilities"),
      xaxis = list(title = "Date"),
      margin=list(r=50),
      legend=list(orientation='h',xanchor="center",x=0.5,yanchor="top",y=-0.10))
      
  assign(paste0(label,"_dis_plot"),plot2,envir = .GlobalEnv)
  
}
discharge_subplot(ECHO_2010_2017,full_match_2010_2017,"Energy","Energy",50,"y") #y
discharge_subplot(ECHO_2010_2017,full_match_2010_2017,"Industrial","Industrial",50,"y3")
discharge_subplot(ECHO_2010_2017,full_match_2010_2017,"Commercial","Commercial",2,"y5") #y5
discharge_subplot(ECHO_2010_2017,full_match_2010_2017,"Aquaculture","Aquaculture",2,"y7") #y7

other_discharges<- function(All_Facilities,Sector,label,roundup,yaxis_2){
  
  ECHO_2010_2017$Date<-as.Date(ECHO_2010_2017$Date,format="%Y-%m-%d")
  
  All_sector<-subset(All_Facilities,All_Facilities$Use.Type==Sector)%>%
    group_by(Date)%>%
    summarise(Discharges=sum(as.numeric(Discharges_MGD), na.rm = T),
              nFacilities=n_distinct(as.character(VPDES.Facility.ID)))
  
  All_users<-Facility_Discharges[Facility_Discharges$Use.Type==Sector,]%>%
    dplyr::group_by(Year)%>%
    dplyr::summarise(Total_Discharges=sum(Discharges_MGD,na.rm=T),
                     n_Facilities=n_distinct(as.character(VPDES.Facility.ID)))
  
  plot1<-subset(All_Facilities,All_Facilities$Use.Type==Sector)%>%
    group_by(Date)%>%
    summarise(Discharges=sum(as.numeric(Discharges_MGD), na.rm = T),
              nFacilities=n_distinct(as.character(VPDES.Facility.ID)))%>%
    plot_ly(x = ~Date)%>%
    add_trace(y = ~Discharges, name="All VPDES Facilities",type = 'scatter',mode = 'lines', line=list(color='#2171b5'))%>%
    add_trace(y= ~nFacilities, name="Reporting VPDES Facilities", type='bar', yaxis='y2', opacity=0.25, marker=list(color='grey'),showlegend=F)%>%
    layout(# title = paste0("Statewide Mean Daily Withdrawals in Virginia (MGD): ",Sector," Sector"),
      yaxis = list(title="Discharge (MGD)",
                   side="left",
                   tickfont=list(color="black"),
                   range=c(0,roundup+ceiling(max(All_sector$Discharges)))), 
      yaxis2 = list(tickfont=list(color="black"),
                    overlaying=yaxis_2,
                    side="right",
                    title="Reporting Facilities"),
      xaxis = list(title = "Date"),
      margin=list(r=50),legend=list(orientation='h',xanchor="center",x=0.50,yanchor="top", y=-0.15))
  
  
  assign(paste0(label,"_dis_plot"),plot1,envir = .GlobalEnv)
  
}
other_discharges(ECHO_2010_2017,"Municipal","Municipal",2,"y9") #y9

dis_subplot<- function(industrial,commercial, aquaculture,energy,municipal,label,path){
  subplot<-plotly::subplot(energy,style(industrial,showlegend=F),style(commercial,showlegend=F),
                           style(aquaculture,showlegend=F),
                           style(municipal,showlegend=F),shareX = T,
                           nrows=3,titleX= T, titleY=T,margin=0.07)%>%
    layout(annotations = list(
      list(x = 0.225 , y = 1.0, 
           text = "<b>(a) Energy</b>",
           showarrow = F, 
           xref='paper', yref='paper', xanchor='center',yanchor='bottom'),
      list(x = 0.775 , y = 1.0, 
           text = "<b>(b) Industrial</b>", 
           showarrow = F, xref='paper', yref='paper',xanchor='center',yanchor='bottom'),
      list(x = 0.225 , y = 0.60, 
           text = "<b>(c) Commercial</b>",
           showarrow = F, 
           xref='paper', yref='paper', xanchor='center',yanchor='bottom'),
      list(x = 0.775 , y = 0.60, 
           text = "<b>(d) Aquaculture</b>",
           showarrow = F, 
           xref='paper', yref='paper', xanchor='center',yanchor='bottom'),
      list(x = 0.225 , y = 0.25, 
           text = "<b>(e) Municipal</b>",
           showarrow = F, 
           xref='paper', yref='paper', xanchor='center',yanchor='bottom')))
  
  file_name <- paste(path,"Matched_vs_Total_",label,".pdf", sep="")
  plotly_IMAGE(x=subplot,width=1000,height=1000,format="pdf",out_file=file_name)
}

dis_subplot(Industrial_dis_plot,Commercial_dis_plot,Aquaculture_dis_plot,Energy_dis_plot,
            Municipal_dis_plot,"discharge",path="G:/My Drive/USGS_ConsumptiveUse/Spring, 2019/Statewide Analysis/Discharges/")

discharge_tables<- function(All_Facilities,Full_Match,Sector){
  table1<-All_Facilities[All_Facilities$Use.Type==Sector,]%>%
    dplyr::group_by(Year)%>%
    dplyr::summarise(no_Facilities=n_distinct(VPDES.Facility.ID),
                     no_sources=sum(Outfalls), 
                     Sum_Withdrawals_MGD=sum(Discharges_MGD,na.rm=T))
  
  table2<-Full_Match[Full_Match$Use.Type==Sector,]%>%
    dplyr::group_by(Year)%>%
    dplyr::summarise(no_Facilities=n_distinct(VPDES.Facility.ID),
                     Sum_Discharges_MGD=sum(Discharges_MGD,na.rm=T))
  
  return(list(table1,table2))
}
discharge_tables(Facility_Discharges,Matched_Facility_Discharges,"Aquaculture")
discharge_tables(Facility_Discharges,Matched_Facility_Discharges,"Commercial")

#-------------------------------------Monthly Withdrawals vs Discharges with Consumption Rates---------------------------#

# Facility Level Analysis

consumption.histograms<- function(){
  
  #----Energy Facilities----#
  energy_CU<-full_match_2010_2017[full_match_2010_2017$Use.Type=="Energy",]%>%
    dplyr::group_by(VWUDS.Facility.ID,Date)%>%
    dplyr::summarise(Withdrawals=sum(Withdrawals_MGD,na.rm=T),
                     Discharges=sum(Discharges_MGD,na.rm=T))
  
  energy_CU$CU<-(energy_CU$Withdrawals-energy_CU$Discharges)/energy_CU$Withdrawals
  
  outliers<-boxplot.stats(energy_CU$CU)$out
  energy_CU$CU<-ifelse(energy_CU$CU %in% outliers,NA,energy_CU$CU)
  
  # This commented out section look at the median annual consumption across facilities
  # energy_CU<-energy_CU%>%
  #   dplyr::group_by(VWUDS.Facility.ID,Year=substr(Date,1,4))%>%
  #   dplyr::summarise(CU=median(CU,na.rm=T))
  # 
  # energy_CU%>%
  #   dplyr::group_by(Year)%>%
  #   dplyr::summarise(CU=median(CU,na.rm=T))

  energy_CU<-energy_CU%>%
    dplyr::group_by(VWUDS.Facility.ID)%>%
    dplyr::summarise(CU=median(CU,na.rm=T))

  median(energy_CU$CU,na.rm=T)
  
  
  
  
  #----Nuclear Facilities----#
  nuclear_CU<-full_match_2010_2017[full_match_2010_2017$Fuel_Type=="Nuclear",]%>%
    dplyr::group_by(VWUDS.Facility.ID,Date)%>%
    dplyr::summarise(Withdrawals=sum(Withdrawals_MGD,na.rm=T),
                     Discharges=sum(Discharges_MGD,na.rm=T))
  
  nuclear_CU$CU<-(nuclear_CU$Withdrawals-nuclear_CU$Discharges)/nuclear_CU$Withdrawals
  
  outliers<-boxplot.stats(nuclear_CU$CU)$out
  nuclear_CU$CU<-ifelse(nuclear_CU$CU %in% outliers,NA,nuclear_CU$CU)
  
  #This commented out section look at the median annual consumption across facilities
  # nuclear_CU<-nuclear_CU%>%
  #   dplyr::group_by(VWUDS.Facility.ID,Year=substr(Date,1,4))%>%
  #   dplyr::summarise(CU=median(CU,na.rm=T))
  # 
  # nuclear_CU%>%
  #   dplyr::group_by(Year)%>%
  #   dplyr::summarise(CU=median(CU,na.rm=T))
  
  nuclear_CU<-nuclear_CU%>%
    dplyr::group_by(VWUDS.Facility.ID)%>%
    dplyr::summarise(CU=median(CU,na.rm=T))
  
  median(nuclear_CU$CU,na.rm=T)
  
  #----Coal Facilities----#
  coal_CU<-full_match_2010_2017[full_match_2010_2017$Fuel_Type=="Coal",]%>%
    dplyr::group_by(VWUDS.Facility.ID,Date)%>%
    dplyr::summarise(Withdrawals=sum(Withdrawals_MGD,na.rm=T),
                     Discharges=sum(Discharges_MGD,na.rm=T))
  
  coal_CU$CU<-(coal_CU$Withdrawals-coal_CU$Discharges)/coal_CU$Withdrawals
  
  outliers<-boxplot.stats(coal_CU$CU)$out
  coal_CU$CU<-ifelse(coal_CU$CU %in% outliers,NA,coal_CU$CU)
  
  # coal_CU<-coal_CU%>%
  #   dplyr::group_by(VWUDS.Facility.ID,Year=substr(Date,1,4))%>%
  #   dplyr::summarise(CU=median(CU,na.rm=T))
  # 
  # coal_CU%>%
  #   dplyr::group_by(Year)%>%
  #   dplyr::summarise(CU=median(CU,na.rm=T))
  
  coal_CU<-coal_CU%>%
    dplyr::group_by(VWUDS.Facility.ID)%>%
    dplyr::summarise(CU=median(CU,na.rm=T))
  
  median(coal_CU$CU,na.rm=T)
  
  #----Combo Facilities----#
  combo_CU<-full_match_2010_2017[full_match_2010_2017$Fuel_Type=="Combination Fossil",]%>%
    dplyr::group_by(VWUDS.Facility.ID,Date)%>%
    dplyr::summarise(Withdrawals=sum(Withdrawals_MGD,na.rm=T),
                     Discharges=sum(Discharges_MGD,na.rm=T))
  
  combo_CU$CU<-(combo_CU$Withdrawals-combo_CU$Discharges)/combo_CU$Withdrawals
  
  outliers<-boxplot.stats(combo_CU$CU)$out
  combo_CU$CU<-ifelse(combo_CU$CU %in% outliers,NA,combo_CU$CU)
  
  # combo_CU<-combo_CU%>%
  #   dplyr::group_by(VWUDS.Facility.ID,Year=substr(Date,1,4))%>%
  #   dplyr::summarise(CU=median(CU,na.rm=T))
  # 
  # combo_CU%>%
  #   dplyr::group_by(Year)%>%
  #   dplyr::summarise(CU=median(CU,na.rm=T))
  
  combo_CU<-combo_CU%>%
    dplyr::group_by(VWUDS.Facility.ID)%>%
    dplyr::summarise(CU=median(CU,na.rm=T))
  
  median(combo_CU$CU,na.rm=T)
  
  #----Biomass Facilities----#
  biomass_CU<-full_match_2010_2017[full_match_2010_2017$Fuel_Type=="Biomass",]%>%
    dplyr::group_by(VWUDS.Facility.ID,Date)%>%
    dplyr::summarise(Withdrawals=sum(Withdrawals_MGD,na.rm=T),
                     Discharges=sum(Discharges_MGD,na.rm=T))
  
  biomass_CU$CU<-(biomass_CU$Withdrawals-biomass_CU$Discharges)/biomass_CU$Withdrawals
  
  outliers<-boxplot.stats(biomass_CU$CU)$out
  biomass_CU$CU<-ifelse(biomass_CU$CU %in% outliers,NA,biomass_CU$CU)
  
  # biomass_CU<-biomass_CU%>%
  #   dplyr::group_by(VWUDS.Facility.ID,Year=substr(Date,1,4))%>%
  #   dplyr::summarise(CU=median(CU,na.rm=T))
  # 
  # biomass_CU%>%
  #   dplyr::group_by(Year)%>%
  #   dplyr::summarise(CU=median(CU,na.rm=T))
  
  biomass_CU<-biomass_CU%>%
    dplyr::group_by(VWUDS.Facility.ID)%>%
    dplyr::summarise(CU=median(CU,na.rm=T))
  
  median(biomass_CU$CU,na.rm=T)
  
  #----Industrial Facilities----#
  industrial_CU<-full_match_2010_2017[full_match_2010_2017$Use.Type=="Industrial",]%>%
    dplyr::group_by(VWUDS.Facility.ID,Date)%>%
    dplyr::summarise(Withdrawals=sum(Withdrawals_MGD,na.rm=T),
                     Discharges=sum(Discharges_MGD,na.rm=T))
  
  industrial_CU$CU<-(industrial_CU$Withdrawals-industrial_CU$Discharges)/industrial_CU$Withdrawals
  
  outliers<-boxplot.stats(industrial_CU$CU)$out
  industrial_CU$CU<-ifelse(industrial_CU$CU %in% outliers,NA,industrial_CU$CU)
  
  # industrial_CU<-industrial_CU%>%
  #   dplyr::group_by(VWUDS.Facility.ID,Year=substr(Date,1,4))%>%
  #   dplyr::summarise(CU=median(CU,na.rm=T))
  # 
  # industrial_CU%>%
  #   dplyr::group_by(Year)%>%
  #   dplyr::summarise(CU=median(CU,na.rm=T))
  
  industrial_CU<-industrial_CU%>%
    dplyr::group_by(VWUDS.Facility.ID)%>%
    dplyr::summarise(CU=median(CU,na.rm=T))
  
  median(industrial_CU$CU,na.rm=T)
  
  #----Commercial Facilities----#
  commercial_CU<-full_match_2010_2017[full_match_2010_2017$Use.Type=="Commercial",]%>%
    dplyr::group_by(VWUDS.Facility.ID,Date)%>%
    dplyr::summarise(Withdrawals=sum(Withdrawals_MGD,na.rm=T),
                     Discharges=sum(Discharges_MGD,na.rm=T))
  
  commercial_CU$CU<-(commercial_CU$Withdrawals-commercial_CU$Discharges)/commercial_CU$Withdrawals
  
  outliers<-boxplot.stats(commercial_CU$CU)$out
  commercial_CU$CU<-ifelse(commercial_CU$CU %in% outliers,NA,commercial_CU$CU)
  
  # commercial_CU<-commercial_CU%>%
  #   dplyr::group_by(VWUDS.Facility.ID,Year=substr(Date,1,4))%>%
  #   dplyr::summarise(CU=median(CU,na.rm=T))
  # 
  # commercial_CU%>%
  #   dplyr::group_by(Year)%>%
  #   dplyr::summarise(CU=median(CU,na.rm=T))
  
  commercial_CU<-commercial_CU%>%
    dplyr::group_by(VWUDS.Facility.ID)%>%
    dplyr::summarise(CU=median(CU,na.rm=T))
  
  median(commercial_CU$CU,na.rm=T)
  
  #----Aquaculture Facilities----#
  aquaculture_CU<-full_match_2010_2017[full_match_2010_2017$Use.Type=="Aquaculture",]%>%
    dplyr::group_by(VWUDS.Facility.ID,Date)%>%
    dplyr::summarise(Withdrawals=sum(Withdrawals_MGD,na.rm=T),
                     Discharges=sum(Discharges_MGD,na.rm=T))
  
  aquaculture_CU$CU<-(aquaculture_CU$Withdrawals-aquaculture_CU$Discharges)/aquaculture_CU$Withdrawals
  
  outliers<-boxplot.stats(aquaculture_CU$CU)$out
  aquaculture_CU$CU<-ifelse(aquaculture_CU$CU %in% outliers,NA,aquaculture_CU$CU)
  
  # aquaculture_CU<-aquaculture_CU%>%
  #   dplyr::group_by(VWUDS.Facility.ID,Year=substr(Date,1,4))%>%
  #   dplyr::summarise(CU=median(CU,na.rm=T))
  # 
  # aquaculture_CU%>%
  #   dplyr::group_by(Year)%>%
  #   dplyr::summarise(CU=median(CU,na.rm=T))
  
  aquaculture_CU<-aquaculture_CU%>%
    dplyr::group_by(VWUDS.Facility.ID)%>%
    dplyr::summarise(CU=median(CU,na.rm=T))
  
  
  #----Non-Energy Facilities----#
  nonenergy_CU<-full_match_2010_2017[!full_match_2010_2017$Use.Type=="Energy",]%>%
    dplyr::group_by(VWUDS.Facility.ID,Date)%>%
    dplyr::summarise(Withdrawals=sum(Withdrawals_MGD,na.rm=T),
                     Discharges=sum(Discharges_MGD,na.rm=T))
  
  nonenergy_CU$CU<-(nonenergy_CU$Withdrawals-nonenergy_CU$Discharges)/nonenergy_CU$Withdrawals
  
  outliers<-boxplot.stats(nonenergy_CU$CU)$out
  nonenergy_CU$CU<-ifelse(nonenergy_CU$CU %in% outliers,NA,nonenergy_CU$CU)
  boxplot.stats(nonenergy_CU$CU)$stats
  
  nonenergy_CU<-nonenergy_CU%>%
    dplyr::group_by(VWUDS.Facility.ID)%>%
    dplyr::summarise(CU=median(CU,na.rm=T))
  
  
  #---Compare---#
  
  energy_histo<-ggplot(energy_CU,aes(x=energy_CU$CU))+
    geom_histogram(fill=I(rgb(0.1,0.2,0.4,0.6)))+
    geom_vline(xintercept=quantile(energy_CU$CU,0.50,na.rm = T),color="red",linetype="dashed",lwd=2)+
    theme_minimal()+annotate("text", x = 0.5, y = 4, label = paste0("12 Matched","\n","Energy Facilities") , 
                             col="#00467a" , size=4,fontface =2)+
    xlab("Long Term Median Consumption")+
    ylab("Facilities")+
    ggtitle("(a) Energy")+
    xlim(min(energy_CU,na.rm=T)-0.05,1)
  
  industrial_histo<-ggplot(industrial_CU,aes(x=industrial_CU$CU))+
    geom_histogram(fill=I(rgb(0.1,0.2,0.4,0.6)))+
    geom_vline(xintercept=quantile(industrial_CU$CU,0.50,na.rm = T),color="red",linetype="dashed",lwd=2)+
    theme_minimal()+annotate("text", x = 0.0, y = 6, label = paste0("46 Matched","\n","Industrial Facilities") , 
                             col="#00467a" , size=4,fontface =2)+
    xlab("Long Term Median Consumption")+
    ylab("Facilities")+
    ggtitle("(b) Industrial")
  
  commercial_histo<-ggplot(commercial_CU,aes(x=commercial_CU$CU))+
    geom_histogram(fill=I(rgb(0.1,0.2,0.4,0.6)))+
    geom_vline(xintercept=quantile(commercial_CU$CU,0.50,na.rm = T),color="red",linetype="dashed",lwd=2)+
    theme_minimal()+annotate("text", x = -0.5, y = 3.5, label = paste0("48 Matched","\n","Commercial Facilities") , 
                             col="#00467a" , size=4,fontface =2)+
    xlab("Long Term Median Consumption")+
    ylab("Facilities")+
    ggtitle("(c) Commercial")
  
  aquaculture_histo<-ggplot(aquaculture_CU,aes(x=aquaculture_CU$CU))+
    geom_histogram(fill=I(rgb(0.1,0.2,0.4,0.6)))+
    geom_vline(xintercept=quantile(aquaculture_CU$CU,0.50,na.rm = T),color="red",linetype="dashed",lwd=2)+
    theme_minimal()+annotate("text", x = 0.35, y = 3, label = paste0("9 Matched","\n","Aquaculture Facilities") , 
                             col="#00467a" , size=4,fontface =2)+
    xlab("Long Term Median Consumption")+
    ylab("Facilities")+
    ggtitle("(d) Aquaculture")+
    xlim(min(aquaculture_CU,na.rm=T)-0.05,1)
  
library(ggpubr)
  
  subplot<-ggpubr::ggarrange(energy_histo,industrial_histo,commercial_histo,aquaculture_histo,
                    common.legend = T,
                    legend="bottom",
                    ncol=2,nrow=2)
  
  path="G:/My Drive/USGS_ConsumptiveUse/Spring, 2019/Facility Level/"
  
  ggpubr::ggexport(filename=paste0(path,"facility_histogram.pdf"), plot=subplot, width=12, height=6,units="in")
  
  
  nuclear_histo<-ggplot(nuclear_CU,aes(x=nuclear_CU$CU))+
    geom_histogram(fill=I(rgb(0.1,0.2,0.4,0.6)))+
    geom_vline(xintercept=quantile(nuclear_CU$CU,0.50,na.rm = T),color="red",linetype="dashed",lwd=2)+
    theme_minimal()+annotate("text", x = 0.5, y = 1, label = paste0("2 Matched","\n","Nuclear Facilities") , 
                             col="#00467a" , size=4,fontface =2)+
    xlab("Long Term Median Consumption")+
    ylab("Facilities")+
    ggtitle("(a) Nuclear")+
    xlim(min(energy_CU,na.rm=T)-0.05,1)
  
  coal_histo<-ggplot(coal_CU,aes(x=coal_CU$CU))+
    geom_histogram(fill=I(rgb(0.1,0.2,0.4,0.6)))+
    geom_vline(xintercept=quantile(coal_CU$CU,0.50,na.rm = T),color="red",linetype="dashed",lwd=2)+
    theme_minimal()+annotate("text", x = 0.25, y = 0.5, label = paste0("4 Matched","\n","Coal Facilities") , 
                             col="#00467a" , size=4,fontface =2)+
    xlab("Long Term Median Consumption")+
    ylab("Facilities")+
    ggtitle("(b) Coal")+
    xlim(min(coal_CU,na.rm=T)-0.05,1)
  
  combo_histo<-ggplot(combo_CU,aes(x=combo_CU$CU))+
    geom_histogram(fill=I(rgb(0.1,0.2,0.4,0.6)))+
    geom_vline(xintercept=quantile(combo_CU$CU,0.50,na.rm = T),color="red",linetype="dashed",lwd=2)+
    theme_minimal()+annotate("text", x = 0.40, y = 2, label = paste0("6 Matched","\n","Combination Fossil Fuel Facilities") , 
                             col="#00467a" , size=4,fontface =2)+
    xlab("Long Term Median Consumption")+
    ylab("Facilities")+
    ggtitle("(c) Combination Fossil Fuel")
  
  biomass_histo<-ggplot(biomass_CU,aes(x=biomass_CU$CU))+
    geom_histogram(fill=I(rgb(0.1,0.2,0.4,0.6)))+
    geom_vline(xintercept=quantile(biomass_CU$CU,0.50,na.rm = T),color="red",linetype="dashed",lwd=2)+
    theme_minimal()+annotate("text", x = 0.3, y = 0.5, label = paste0("1 Matched","\n","Biomass Facility") , 
                             col="#00467a" , size=4,fontface =2)+
    xlab("Long Term Median Consumption")+
    ylab("Facilities")+
    ggtitle("(d) Biomass")+
    xlim(0,1)
  
  subplot2<-ggpubr::ggarrange(nuclear_histo,coal_histo,combo_histo,biomass_histo,
                             common.legend = T,
                             legend="bottom",
                             ncol=2,nrow=2)
  
  path="G:/My Drive/USGS_ConsumptiveUse/Spring, 2019/Facility Level/"
  
  ggpubr::ggexport(filename=paste0(path,"energy_facility_histogram.pdf"), plot=subplot2, width=12, height=6,units="in")
  

  
  return(list(subplot,subplot2))
}
consumption.histograms()

#---Energy vs. Non-Energy---#
consumption.boxplots<- function(){
  full_match_2010_2017$Region<-ifelse(full_match_2010_2017$Fac.Long<(-77),"Non-Coastal","Coastal")
  
  energy_CU<-full_match_2010_2017[full_match_2010_2017$Use.Type=="Energy",]%>%
    dplyr::group_by(VWUDS.Facility.ID,Date)%>%
    dplyr::summarise(Withdrawals=sum(Withdrawals_MGD,na.rm=T),
                     Discharges=sum(Discharges_MGD,na.rm=T))
  
  energy_CU$CU<-(energy_CU$Withdrawals-energy_CU$Discharges)/energy_CU$Withdrawals
  outliers<-boxplot.stats(energy_CU$CU)$out
  energy_CU$CU<-ifelse(energy_CU$CU %in% outliers,NA,energy_CU$CU)
  boxplot(data=energy_CU,CU ~ Date,main="Facility Level Energy Consumption across Reporting Months")
  
  boxplot.stats(energy_CU$CU[substr(energy_CU$Date,1,4)=="2010"])$stats
  boxplot.stats(energy_CU$CU[substr(energy_CU$Date,1,4)=="2011"])$stats
  boxplot.stats(energy_CU$CU[substr(energy_CU$Date,1,4)=="2012"])$stats
  boxplot.stats(energy_CU$CU[substr(energy_CU$Date,1,4)=="2013"])$stats
  boxplot.stats(energy_CU$CU[substr(energy_CU$Date,1,4)=="2014"])$stats
  boxplot.stats(energy_CU$CU[substr(energy_CU$Date,1,4)=="2015"])$stats
  boxplot.stats(energy_CU$CU[substr(energy_CU$Date,1,4)=="2016"])$stats
  
  boxplot.stats(energy_CU$CU)$stats
  
  nonenergy_CU<-full_match_2010_2017[!full_match_2010_2017$Use.Type=="Energy",]%>%
    dplyr::group_by(VWUDS.Facility.ID,Date)%>%
    dplyr::summarise(Withdrawals=sum(Withdrawals_MGD,na.rm=T),
                     Discharges=sum(Discharges_MGD,na.rm=T),
                     CU=median(CU,na.rm=T))
  boxplot(data=nonenergy_CU,CU ~ Date,main="Facility Level Non-Energy Consumption across Reporting Months")
  outliers<-boxplot.stats(nonenergy_CU$CU)$out
  nonenergy_CU$CU<-ifelse(nonenergy_CU$CU %in% outliers,NA,nonenergy_CU$CU)
  boxplot.stats(nonenergy_CU$CU)$stats
  
  graphics::par(mfrow=c(1,2))
  
  boxplot(data=energy_CU,CU ~ Date,main="(a) Energy Facility Consumption", 
          ylab="Consumption Coefficient",xlab="Reporting Month")
  
  boxplot(data=nonenergy_CU,CU ~ Date,main="(b) Non-Energy Facility Consumption",
          ylab="Consumption Coefficient",xlab="Reporting Month")
  

  
  industrial<-full_match_2010_2017[full_match_2010_2017$Use.Type=="Industrial",]%>%
    dplyr::group_by(VWUDS.Facility.ID,Date)%>%
    dplyr::summarise(Withdrawals=sum(Withdrawals_MGD,na.rm=T),
                     Discharges=sum(Discharges_MGD,na.rm=T),
                     CU=median(CU,na.rm=T))
  industrial$CU<-ifelse(is.infinite(industrial$CU),NA,industrial$CU)
  industrial<-industrial[complete.cases(industrial),]
  outliers<-boxplot.stats(industrial$CU)$out
  industrial$CU<-ifelse(industrial$CU %in% outliers,NA,industrial$CU)
  boxplot.stats(industrial$CU[substr(industrial$Date,1,4)=="2010"])
  boxplot.stats(industrial$CU[substr(industrial$Date,1,4)=="2011"])
  boxplot.stats(industrial$CU[substr(industrial$Date,1,4)=="2012"])
  boxplot.stats(industrial$CU[substr(industrial$Date,1,4)=="2013"])
  boxplot.stats(industrial$CU[substr(industrial$Date,1,4)=="2014"])
  boxplot.stats(industrial$CU[substr(industrial$Date,1,4)=="2015"])
  boxplot.stats(industrial$CU[substr(industrial$Date,1,4)=="2016"])
  
  commercial<-full_match_2010_2017[full_match_2010_2017$Use.Type=="Commercial",]%>%
    dplyr::group_by(VWUDS.Facility.ID,Date)%>%
    dplyr::summarise(Withdrawals=sum(Withdrawals_MGD,na.rm=T),
                     Discharges=sum(Discharges_MGD,na.rm=T),
                     CU=median(CU,na.rm=T))
  commercial$CU<-ifelse(is.infinite(commercial$CU),NA,commercial$CU)
  commercial<-commercial[complete.cases(commercial),]
  outliers<-boxplot.stats(commercial$CU)$out
  commercial$CU<-ifelse(commercial$CU %in% outliers,NA,commercial$CU)
  boxplot.stats(commercial$CU[substr(commercial$Date,1,4)=="2010"])
  boxplot.stats(commercial$CU[substr(commercial$Date,1,4)=="2011"])
  boxplot.stats(commercial$CU[substr(commercial$Date,1,4)=="2012"])
  boxplot.stats(commercial$CU[substr(commercial$Date,1,4)=="2013"])
  boxplot.stats(commercial$CU[substr(commercial$Date,1,4)=="2014"])
  boxplot.stats(commercial$CU[substr(commercial$Date,1,4)=="2015"])
  boxplot.stats(commercial$CU[substr(commercial$Date,1,4)=="2016"])
  
  aquaculture<-full_match_2010_2017[full_match_2010_2017$Use.Type=="Aquaculture",]%>%
    dplyr::group_by(VWUDS.Facility.ID,Date)%>%
    dplyr::summarise(Withdrawals=sum(Withdrawals_MGD,na.rm=T),
                     Discharges=sum(Discharges_MGD,na.rm=T),
                     CU=median(CU,na.rm=T))
  aquaculture$CU<-ifelse(is.infinite(aquaculture$CU),NA,aquaculture$CU)
  aquaculture<-aquaculture[complete.cases(aquaculture),]
  outliers<-boxplot.stats(aquaculture$CU)$out
  aquaculture$CU<-ifelse(aquaculture$CU %in% outliers,NA,aquaculture$CU)
  boxplot.stats(aquaculture$CU[substr(aquaculture$Date,1,4)=="2015"])
  boxplot.stats(aquaculture$CU[substr(aquaculture$Date,1,4)=="2016"])
  
  graphics::par(mfrow=c(2,2))
  
  boxplot(data=energy_CU,CU ~ Date,main="(a) Energy Facility Consumption", 
          ylab="Consumption Coefficient",xlab="Reporting Month")

  boxplot(data=industrial,CU ~ Date,main="(b) Industrial Facility Consumption",
          ylab="Consumption Coefficient",xlab="Reporting Month")
  boxplot(data=commercial,CU ~ Date,main="(c) Commercial Facility Consumption",
          ylab="Consumption Coefficient",xlab="Reporting Month")
  boxplot(data=aquaculture,CU ~ Date,main="(d) Aquaculture Facility Consumption",
          ylab="Consumption Coefficient",xlab="Reporting Month")
  
  
  
  
  #---by power type---#
  
  nuclear<-full_match_2010_2017[full_match_2010_2017$Use.Type=="Energy"&full_match_2010_2017$Fuel_Type=="Nuclear",]%>%
    dplyr::group_by(VWUDS.Facility.ID,Date)%>%
    dplyr::summarise(Withdrawals=sum(Withdrawals_MGD,na.rm=T),
                     Discharges=sum(Discharges_MGD,na.rm=T),
                     CU=median(CU,na.rm=T))
  outliers<-boxplot.stats(nuclear$CU)$out
  nuclear$CU<-ifelse(nuclear$CU %in% outliers,NA,nuclear$CU)
  boxplot.stats(nuclear$CU[substr(nuclear$Date,1,4)=="2010"])
  boxplot.stats(nuclear$CU[substr(nuclear$Date,1,4)=="2011"])
  boxplot.stats(nuclear$CU[substr(nuclear$Date,1,4)=="2012"])
  boxplot.stats(nuclear$CU[substr(nuclear$Date,1,4)=="2013"])
  boxplot.stats(nuclear$CU[substr(nuclear$Date,1,4)=="2014"])
  boxplot.stats(nuclear$CU[substr(nuclear$Date,1,4)=="2015"])
  boxplot.stats(nuclear$CU[substr(nuclear$Date,1,4)=="2016"])

  boxplot.stats(nuclear$CU)
  
  coal<-full_match_2010_2017[full_match_2010_2017$Use.Type=="Energy"&full_match_2010_2017$Fuel_Type=="Coal",]%>%
    dplyr::group_by(VWUDS.Facility.ID,Date)%>%
    dplyr::summarise(Withdrawals=sum(Withdrawals_MGD,na.rm=T),
                     Discharges=sum(Discharges_MGD,na.rm=T),
                     CU=median(CU,na.rm=T))
  outliers<-boxplot.stats(coal$CU)$out
  
  coal$CU<-ifelse(coal$CU %in% outliers,NA,coal$CU)
  boxplot.stats(coal$CU[substr(coal$Date,1,4)=="2010"])
  boxplot.stats(coal$CU[substr(coal$Date,1,4)=="2011"])
  boxplot.stats(coal$CU[substr(coal$Date,1,4)=="2012"])
  boxplot.stats(coal$CU[substr(coal$Date,1,4)=="2013"])
  boxplot.stats(coal$CU[substr(coal$Date,1,4)=="2014"])
  boxplot.stats(coal$CU[substr(coal$Date,1,4)=="2015"])
  boxplot.stats(coal$CU[substr(coal$Date,1,4)=="2016"])
  boxplot.stats(coal$CU)
  
  
  combo<-full_match_2010_2017[full_match_2010_2017$Use.Type=="Energy"&full_match_2010_2017$Fuel_Type=="Combination Fossil",]%>%
    dplyr::group_by(VWUDS.Facility.ID,Date)%>%
    dplyr::summarise(Withdrawals=sum(Withdrawals_MGD,na.rm=T),
                     Discharges=sum(Discharges_MGD,na.rm=T),
                     CU=median(CU,na.rm=T))
  outliers<-boxplot.stats(combo$CU)$out
  combo$CU<-ifelse(combo$CU %in% outliers,NA,combo$CU)
  boxplot.stats(combo$CU[substr(combo$Date,1,4)=="2010"])
  boxplot.stats(combo$CU[substr(combo$Date,1,4)=="2011"])
  boxplot.stats(combo$CU[substr(combo$Date,1,4)=="2012"])
  boxplot.stats(combo$CU[substr(combo$Date,1,4)=="2013"])
  boxplot.stats(combo$CU[substr(combo$Date,1,4)=="2014"])
  boxplot.stats(combo$CU[substr(combo$Date,1,4)=="2015"])
  boxplot.stats(combo$CU[substr(combo$Date,1,4)=="2016"])
  boxplot.stats(combo$CU)
  
  
  biomass<-full_match_2010_2017[full_match_2010_2017$Use.Type=="Energy"&full_match_2010_2017$Fuel_Type=="Biomass",]%>%
    dplyr::group_by(VWUDS.Facility.ID,Date)%>%
    dplyr::summarise(Withdrawals=sum(Withdrawals_MGD,na.rm=T),
                     Discharges=sum(Discharges_MGD,na.rm=T),
                     CU=median(CU,na.rm=T))
  outliers<-boxplot.stats(biomass$CU)$out
  biomass$CU<-ifelse(biomass$CU %in% outliers,NA,biomass$CU)
  boxplot.stats(biomass$CU[substr(biomass$Date,1,4)=="2010"])
  boxplot.stats(biomass$CU[substr(biomass$Date,1,4)=="2011"])
  boxplot.stats(biomass$CU[substr(biomass$Date,1,4)=="2012"])
  boxplot.stats(biomass$CU[substr(biomass$Date,1,4)=="2013"])
  boxplot.stats(biomass$CU[substr(biomass$Date,1,4)=="2014"])
  boxplot.stats(biomass$CU[substr(biomass$Date,1,4)=="2015"])
  boxplot.stats(biomass$CU[substr(biomass$Date,1,4)=="2016"])
  boxplot.stats(biomass$CU)
  
  graphics::par(mfrow=c(2,2))
  
  boxplot(data=nuclear,CU ~ Date,main="(a) Nuclear", ylab="Consumption Coefficient",xlab="Reporting Month")
  boxplot(data=coal,CU ~ Date,main="(b) Coal", ylab="Consumption Coefficient",xlab="Reporting Month")
  boxplot(data=combo,CU ~ Date,main="(c) Combination Fossil Fuel", ylab="Consumption Coefficient",xlab="Reporting Month")
  boxplot(data=biomass,CU ~ Date,main="(d) Biomass", ylab="Consumption Coefficient",xlab="Reporting Month")
  
  #---Coastal vs. Non-Coastal--#
  noncoastal<-full_match_2010_2017[full_match_2010_2017$Use.Type=="Energy"&full_match_2010_2017$Region=="Non-Coastal",]%>%
    dplyr::group_by(VWUDS.Facility.ID,Date)%>%
    dplyr::summarise(Withdrawals=sum(Withdrawals_MGD,na.rm=T),
                     Discharges=sum(Discharges_MGD,na.rm=T),
                     CU=median(CU,na.rm=T))
  outliers<-boxplot.stats(noncoastal$CU)$out
  noncoastal$CU<-ifelse(noncoastal$CU %in% outliers,NA,noncoastal$CU)
  
  coastal<-full_match_2010_2017[full_match_2010_2017$Use.Type=="Energy"&full_match_2010_2017$Region=="Coastal",]%>%
    dplyr::group_by(VWUDS.Facility.ID,Date)%>%
    dplyr::summarise(Withdrawals=sum(Withdrawals_MGD,na.rm=T),
                     Discharges=sum(Discharges_MGD,na.rm=T),
                     CU=median(CU,na.rm=T))
  outliers<-boxplot.stats(coastal$CU)$out
  coastal$CU<-ifelse(coastal$CU %in% outliers,NA,coastal$CU)
  
  graphics::par(mfrow=c(1,2))
  boxplot(data=noncoastal,CU ~ Date,main="Non-Coastal")
  boxplot(data=coastal,CU ~ Date,main="Coastal")
  
  
  
  
  
  
}


#---All Facilities--#

All.Fac.Plots<- function(Sector,Title,label){
  
  Monthly_Withdrawal<-
    VWUDS_2010_2017%>%
    dplyr::group_by(Date)%>%
    dplyr::summarise(Withdrawals=sum(Withdrawals_MGD,na.rm=T),
                     nFacilities=n_distinct(as.character(VWUDS.Facility.ID)))
  
  Monthly_Discharge<-
    ECHO_2010_2017%>%
    dplyr::group_by(Date)%>%
    dplyr::summarise(Discharges=sum(as.numeric(Discharges_MGD),na.rm=T),
              nFacilities=n_distinct(as.character(VPDES.Facility.ID)))
  
  Monthly_Discharge$Date<-as.Date(Monthly_Discharge$Date,format="%Y-%m-%d")
  
  CU<-merge(Monthly_Withdrawal,Monthly_Discharge,by=c("Date"))
  
  CU$CU<-(CU$Withdrawals-CU$Discharges)/(CU$Withdrawals)
  
  Annual_CU1<-CU%>%
    dplyr::group_by(Year=substr(Date,1,4))%>%
    dplyr::summarise(CU=median(CU,na.rm=T))

plot1<-VWUDS_2010_2017%>%
  dplyr::group_by(Date)%>%
  dplyr::summarise(Withdrawals=sum(as.numeric(Withdrawals_MGD), na.rm = T),
            nFacilities=n_distinct(as.character(VWUDS.Facility.ID)))%>%
  plot_ly(x = ~Date)%>%
  add_trace(y = ~Withdrawals, name="Total Withdrawals",type = 'scatter', mode = 'lines', line=list(color='#cb181d'))%>%
  add_trace(x=Monthly_Discharge$Date, y=Monthly_Discharge$Discharges, name="Total Discharges", type="scatter", mode="lines", line=list(color='#2171b5'))%>%
  add_trace(y= ~nFacilities, name="VWUDS Facilities", type='bar', yaxis='y2', opacity=0.25,marker=list(color='black'))%>%
  add_trace(x=Monthly_Discharge$Date, y= Monthly_Discharge$nFacilities, name="VPDES Facilities", type='bar', yaxis='y2', opacity=1,marker=list(color='grey'))%>%
  layout(# title = "Statewide Mean Daily Withdrawals vs. Discharges (MGD) in Virginia: All Facilities",
         yaxis = list(title="Mean Daily Quantity (MGD)",
                      range=c(0,ifelse(max(Monthly_Withdrawal$Withdrawals)>max(Monthly_Discharge$Discharges),ceiling(max(Monthly_Withdrawal$Withdrawals)),ceiling(max(Monthly_Discharge$Discharges))))),
         yaxis2=list(tickfont=list(color="black"),
                     overlaying="y",
                     side="right",
                     title="Number of Reporting Facilities"),
         margin=list(r=50),
         xaxis = list(title = "Date"),
         legend=list(orientation='h',xanchor="center",x=0.50,yanchor="top", y=-0.15))
  
  plot2<-VWUDS_2010_2017%>%
    dplyr::group_by(Date)%>%
    dplyr::summarise(Withdrawals=sum(as.numeric(Withdrawals_MGD), na.rm = T),
              nFacilities=n_distinct(as.character(VWUDS.Facility.ID)))%>%
    plot_ly(x = ~Date)%>%
    add_trace(y = ~Withdrawals, name="Total Withdrawals",type = 'scatter', mode = 'lines', line=list(color='#cb181d'),opacity=0.33)%>%
    add_trace(x=Monthly_Discharge$Date, y=Monthly_Discharge$Discharges, name="Total Discharges", type="scatter", mode="lines",line=list(color='#2171b5'),opacity=0.33)%>%
    add_trace(x=CU$Date, y= CU$CU, name="Consumption", type='scatter', mode='lines', yaxis='y2',line=list(color='black',dash="dot",width=3))%>%
    layout(# title = "Statewide Mean Daily Withdrawals vs. Discharges (MGD) in Virginia: All Facilities",
           yaxis = list(title="Mean Daily Quantity (MGD)",
                        range=c(0,ifelse(max(Monthly_Withdrawal$Withdrawals)>max(Monthly_Discharge$Discharges),ceiling(max(Monthly_Withdrawal$Withdrawals)),ceiling(max(Monthly_Discharge$Discharges))))),
           yaxis2=list(tickfont=list(color="black"),
                       overlaying="y",
                       side="right",
                       range=c(ifelse(min(CU$CU)<0,min(CU$CU),0),1),
                       title="Consumption"),
           margin=list(r=50),
           xaxis = list(title = "Date"),
           legend=list(orientation='h', x=0.25, y=-0.25))
  
  
  Monthly_Withdrawal<-VWUDS_2010_2017[VWUDS_2010_2017$Use.Type==Sector,]%>%
    dplyr::group_by(Date)%>%
    dplyr::summarise(Withdrawals=sum(Withdrawals_MGD,na.rm=T),
                     nFacilities=n_distinct(as.character(VWUDS.Facility.ID)))
  
  Monthly_Discharge<-ECHO_2010_2017[ECHO_2010_2017$Use.Type==Sector,]%>%
    dplyr::group_by(Date)%>%
    dplyr::summarise(Discharges=sum(as.numeric(Discharges_MGD),na.rm=T),
                     nFacilities=n_distinct(as.character(VPDES.Facility.ID)))
  
  Monthly_Discharge$Date<-as.Date(Monthly_Discharge$Date,format="%Y-%m-%d")
  
  CU2<-merge(Monthly_Withdrawal,Monthly_Discharge,by=c("Date"))
  
  CU2$CU<-(CU2$Withdrawals-CU2$Discharges)/(CU2$Withdrawals)
  
  Annual_CU2<-CU2%>%
    dplyr::group_by(Year=substr(Date,1,4))%>%
    dplyr::summarise(CU=mean(CU,na.rm=T))
  
plot3<-subset(VWUDS_2010_2017,VWUDS_2010_2017$Use.Type==Sector)%>%
    dplyr::group_by(Date)%>%
    dplyr::summarise(Withdrawals=sum(as.numeric(Withdrawals_MGD), na.rm = T),
              nFacilities=n_distinct(as.character(VWUDS.Facility.ID)))%>%
    plot_ly(x = ~Date)%>%
    add_trace(y = ~Withdrawals, name="Total Withdrawals",type = 'scatter', mode = 'lines', line=list(color='#cb181d'))%>%
    add_trace(x=Monthly_Discharge$Date, y=Monthly_Discharge$Discharges, name="Total Discharges", type="scatter", mode="lines+markers", marker=list(color="#2171b5"), line=list(color='#3182bd'))%>%
    add_trace(y= ~nFacilities, name="VWUDS Facilities", type='bar', yaxis='y2', opacity=0.25,marker=list(color='black'))%>%
    add_trace(x=Monthly_Discharge$Date, y= Monthly_Discharge$nFacilities, name="VPDES Facilities", type='bar', yaxis='y2', opacity=1,marker=list(color='grey'))%>%
    layout(# title = paste0("Statewide Mean Daily Withdrawals vs. Discharges (MGD) in Virginia: ",Title),
           yaxis = list(title="Mean Daily Quantity (MGD)",
                        range=c(0,ifelse(max(Monthly_Withdrawal$Withdrawals)>max(Monthly_Discharge$Discharges),ceiling(max(Monthly_Withdrawal$Withdrawals)),ceiling(max(Monthly_Discharge$Discharges))))),
           yaxis2=list(tickfont=list(color="black"),
                       overlaying="y",
                       side="right",
                       title="Number of Reporting Facilities"),
           margin=list(r=50),
           xaxis = list(title = "Date"),
           legend=list(orientation='h',xanchor="center",x=0.50,yanchor="top", y=-0.15))

plot4<-subset(VWUDS_2010_2017,VWUDS_2010_2017$Use.Type==Sector)%>%
  dplyr::group_by(Date)%>%
  dplyr::summarise(Withdrawals=sum(as.numeric(Withdrawals_MGD), na.rm = T),
            nFacilities=n_distinct(as.character(VWUDS.Facility.ID)))%>%
  plot_ly(x = ~Date)%>%
  add_trace(y = ~Withdrawals, name="Total Withdrawals",type = 'scatter', mode = 'lines', line=list(color='#cb181d'),opacity=0.33)%>%
  add_trace(x=Monthly_Discharge$Date, y=Monthly_Discharge$Discharges, name="Total Discharges", type="scatter", mode='lines',line=list(color='#2171b5'),opacity=0.33)%>%
  add_trace(x=CU2$Date, y=CU2$CU, name="Consumption", type="scatter", yaxis="y2", mode='lines', line=list(color='black',width=3,dash="dot"))%>%
  layout(# title = paste0("Statewide Mean Daily Withdrawals vs. Discharges (MGD) in Virginia: ",Title),
         yaxis = list(title="Mean Daily Quantity (MGD)",
                      range=c(0,ifelse(max(Monthly_Withdrawal$Withdrawals)>max(Monthly_Discharge$Discharges),ceiling(max(Monthly_Withdrawal$Withdrawals)),ceiling(max(Monthly_Discharge$Discharges))))),
         yaxis2=list(tickfont=list(color="black"),
                     overlaying="y",
                     side="right",
                     title="Consumption",
                     range=c(ifelse(min(CU2$CU)<0,min(CU2$CU),0),1)),
         margin=list(r=50),
         xaxis = list(title = "Date"),
         legend=list(orientation='h', x=0.25, y=-0.25))

stats<-boxplot.stats(CU2$CU)

path="G:/My Drive/USGS_ConsumptiveUse/Spring, 2019/Statewide Analysis/Consumption_All_Facilities/"
file_name <- paste(path,"CU_All_Fac_All_Sectors", ".pdf", sep="")
plotly_IMAGE(x=plot2,width=1000,height=500,format="pdf",out_file=file_name)

file_name <- paste(path,"CU_All_Fac_",label, ".pdf", sep="")
plotly_IMAGE(x=plot4,width=1000,height=500,format="pdf",out_file=file_name)

return(list(plot4,Annual_CU1,Annual_CU2,stats))
}

# returns plots for all sector scenario, sector scenario, and annual CU for specified sector
All.Fac.Plots("Energy", "Energy Sector Facilities","Energy")
All.Fac.Plots("Industrial", "Industrial Sector Facilities","Industrial")
All.Fac.Plots("Aquaculture", "Aquaculture Sector Facilities","Aquaculture")
All.Fac.Plots("Municipal", "Municipal Sector Facilities","Municipal")
All.Fac.Plots("Commercial", "Municipal Sector Facilities","Commercial")

#---Matched Facilities---#

Full.Match.Fac.Plots<- function(Sector, Title,label){
  
  Full_Matched_Monthly_Discharge<-
    full_match_2010_2017%>%
    group_by(Date)%>%
    summarise(Discharges=sum(as.numeric(Discharges_MGD),na.rm=T),
              nFacilities=n_distinct(as.character(VPDES.Facility.ID)))
  
  Full_Matched_Monthly_Withdrawal<-
    full_match_2010_2017%>%
    dplyr::group_by(Date)%>%
    dplyr::summarise(Withdrawals=sum(Withdrawals_MGD,na.rm=T),
                     nFacilities=n_distinct(as.character(VWUDS.Facility.ID)))
  
  Full_Matched_CU<-data.frame(Date=Full_Matched_Monthly_Withdrawal$Date,
                              CU=(Full_Matched_Monthly_Withdrawal$Withdrawals-Full_Matched_Monthly_Discharge$Discharges)/
                                Full_Matched_Monthly_Withdrawal$Withdrawals,stringsAsFactors = F)
  
  Annual1<-Full_Matched_CU%>%
    dplyr::group_by(Year=substr(Date,1,4))%>%
    dplyr::summarise(Annual_CU=median(CU,na.rm=T))
  
  plot1<-full_match_2010_2017%>%
    group_by(Date)%>%
    summarise(Withdrawals=sum(as.numeric(Withdrawals_MGD), na.rm = T),
              nFacilities=n_distinct(as.character(VWUDS.Facility.ID)))%>%
    plot_ly(x = ~Date)%>%
    add_trace(y = ~Withdrawals, name="Matched Withdrawals",type = 'scatter', mode = 'lines', line=list(color='#cb181d'))%>%
    add_trace(x=Full_Matched_Monthly_Discharge$Date, y=Full_Matched_Monthly_Discharge$Discharges, name="Matched Discharges", type="scatter", mode="lines", line=list(color='#2171b5'))%>%
    add_trace(y= ~nFacilities, name="VWUDS Facilities", type='bar', yaxis='y2', opacity=0.25,marker=list(color='black'))%>%
    add_trace(x=Full_Matched_Monthly_Discharge$Date, y= Full_Matched_Monthly_Discharge$nFacilities, name="VPDES Facilities", type='bar', yaxis='y2', opacity=1.0,marker=list(color='grey'))%>%
    layout(# title = "Statewide Mean Daily Withdrawals vs. Discharges (MGD) in Virginia: All Sectors",
           yaxis = list(title="Mean Daily Quantity (MGD)",
                        range=c(0,ifelse(max(Full_Matched_Monthly_Withdrawal$Withdrawals)>max(Full_Matched_Monthly_Discharge$Discharges),ceiling(max(Full_Matched_Monthly_Withdrawal$Withdrawals)),ceiling(max(Full_Matched_Monthly_Discharge$Discharges))))),
           yaxis2=list(tickfont=list(color="black"),
                       overlaying="y",
                       side="right",
                       title="Number of Reporting Facilities"),
           margin=list(r=50),
           xaxis = list(title = "Date"),
           legend=list(orientation='h',xanchor="center",x=0.50,yanchor="top", y=-0.15))
  
  plot2<-full_match_2010_2017%>%
    group_by(Date)%>%
    summarise(Withdrawals=sum(as.numeric(Withdrawals_MGD), na.rm = T),
              nFacilities=n_distinct(as.character(VWUDS.Facility.ID)))%>%
    plot_ly(x = ~Date)%>%
    add_trace(y = ~Withdrawals, name="Matched Withdrawals",type = 'scatter', mode = 'lines', line=list(color='#cb181d'),opacity=0.33)%>%
    add_trace(x=Full_Matched_Monthly_Discharge$Date, y=Full_Matched_Monthly_Discharge$Discharges, name="Matched Discharges", type="scatter", mode="lines", line=list(color='#2171b5'),opacity=0.33)%>%
    add_trace(x=Full_Matched_CU$Date,y=Full_Matched_CU$CU, name="Consumption",yaxis='y2', type="scatter",mode='lines', line=list(color='black',width=3,dash="dot"))%>%
    layout(# title = "Statewide Mean Daily Withdrawals vs. Discharges (MGD) in Virginia: All Sectors",
           yaxis = list(title="Mean Daily Quantity (MGD)",
                        range=c(0,ifelse(max(Full_Matched_Monthly_Withdrawal$Withdrawals)>max(Full_Matched_Monthly_Discharge$Discharges),ceiling(max(Full_Matched_Monthly_Withdrawal$Withdrawals)),ceiling(max(Full_Matched_Monthly_Discharge$Discharges))))),
           yaxis2=list(tickfont=list(color="black"),
                       overlaying="y",
                       side="right",
                       title="Consumption",
                       range=c(ifelse(min(Full_Matched_CU$CU)<0,min(Full_Matched_CU$CU),0),1)),
           margin=list(r=50),xaxis = list(title = "Date"),legend=list(orientation='h',x=0.25, y=-0.25))
  
  Full_Matched_Monthly_Discharge<-
    subset(full_match_2010_2017,full_match_2010_2017$Use.Type==Sector)%>%
    group_by(Date)%>%
    summarise(Discharges=sum(as.numeric(Discharges_MGD),na.rm=T),
              nFacilities=n_distinct(as.character(VPDES.Facility.ID)))
  
  Full_Matched_Monthly_Withdrawal<-
    subset(full_match_2010_2017,full_match_2010_2017$Use.Type==Sector)%>%
    dplyr::group_by(Date)%>%
    dplyr::summarise(Withdrawals=sum(Withdrawals_MGD,na.rm=T),
                     nFacilities=n_distinct(as.character(VWUDS.Facility.ID)))
  
  Full_Matched_CU<-data.frame(Date=Full_Matched_Monthly_Withdrawal$Date,
                              CU=(Full_Matched_Monthly_Withdrawal$Withdrawals-Full_Matched_Monthly_Discharge$Discharges)/
                                Full_Matched_Monthly_Withdrawal$Withdrawals,stringsAsFactors = F)
  
  Annual2<-Full_Matched_CU%>%
    dplyr::group_by(Year=substr(Date,1,4))%>%
    dplyr::summarise(Annual_CU=median(CU,na.rm=T))
  
  plot3<-subset(full_match_2010_2017,full_match_2010_2017$Use.Type==Sector)%>%
    group_by(Date)%>%
    summarise(Withdrawals=sum(as.numeric(Withdrawals_MGD), na.rm = T),
              nFacilities=n_distinct(as.character(VWUDS.Facility.ID)))%>%
    plot_ly(x = ~Date)%>%
    add_trace(y = ~Withdrawals, name="Matched Withdrawals",type = 'scatter', mode = 'lines', line=list(color='#cb181d'))%>%
    add_trace(x=Full_Matched_Monthly_Discharge$Date, y=Full_Matched_Monthly_Discharge$Discharges, name="Matched Discharges", type="scatter", mode="lines", line=list(color='#2171b5'))%>%
    add_trace(y= ~nFacilities, name="VWUDS Facilities", type='bar', yaxis='y2', opacity=0.25,marker=list(color='black'))%>%
    add_trace(x=Full_Matched_Monthly_Discharge$Date, y= Full_Matched_Monthly_Discharge$nFacilities, name="VPDES Facilities", type='bar', yaxis='y2', opacity=1.0, marker=list(color='grey'))%>%
    layout(# title = paste0("Statewide Mean Daily Withdrawals vs. Discharges (MGD) in Virginia: ",Title),
           yaxis = list(title="Mean Daily Quantity (MGD)",
                        range=c(0,ifelse(max(Full_Matched_Monthly_Withdrawal$Withdrawals)>max(Full_Matched_Monthly_Discharge$Discharges),ceiling(max(Full_Matched_Monthly_Withdrawal$Withdrawals)),ceiling(max(Full_Matched_Monthly_Discharge$Discharges))))),
           yaxis2=list(tickfont=list(color="black"),
                       overlaying="y",
                       side="right",
                       title="Number of Reporting Facilities"),
           margin=list(r=50),
           xaxis = list(title = "Date"),
           legend=list(orientation='h',xanchor="center",x=0.50,yanchor="top", y=-0.15))
  
  plot4<-subset(full_match_2010_2017,full_match_2010_2017$Use.Type==Sector)%>%
    group_by(Date)%>%
    summarise(Withdrawals=sum(as.numeric(Withdrawals_MGD), na.rm = T))%>%
    plot_ly(x = ~Date)%>%
    add_trace(y = ~Withdrawals, name="Matched Withdrawal",type = 'scatter', mode = 'lines', line=list(color='#cb181d'),opacity=0.33)%>%
    add_trace(x=Full_Matched_Monthly_Discharge$Date, y=Full_Matched_Monthly_Discharge$Discharges, name="Matched Discharge", type="scatter", mode="lines", line=list(color='#2171b5'),opacity=0.33)%>%
    add_trace(x=Full_Matched_CU$Date,y=Full_Matched_CU$CU, name="Consumption",yaxis='y2', type="scatter",mode='lines', line=list(color='black',dash="dot",width=3))%>%
    layout(# title = paste0("Statewide Mean Daily Withdrawals vs. Discharges (MGD) in Virginia: ",Title),
           yaxis = list(title="Mean Daily Quantity (MGD)",
                        range=c(0,ifelse(max(Full_Matched_Monthly_Withdrawal$Withdrawals)>max(Full_Matched_Monthly_Discharge$Discharges),max(Full_Matched_Monthly_Withdrawal$Withdrawals),max(Full_Matched_Monthly_Discharge$Discharges)))),
           yaxis2=list(tickfont=list(color="black"),
                       overlaying="y",
                       side="right",
                       title="Consumption",
                       range=c(ifelse(min(Full_Matched_CU$CU)<0,min(Full_Matched_CU$CU),0),1)),
           margin=list(r=50),xaxis = list(title = "Date"),legend=list(orientation='h', x=0.25, y=-0.25))
  
  path="G:/My Drive/USGS_ConsumptiveUse/Spring, 2019/Statewide Analysis/Consumption_Matched_Facilities/"
  file_name <- paste(path,"CU_Match_Fac_All_Sectors", ".pdf", sep="")
  plotly_IMAGE(x=plot2,width=1000,height=500,format="pdf",out_file=file_name)
  
  file_name <- paste(path,"CU_Match_Fac_",label, ".pdf", sep="")
  plotly_IMAGE(x=plot4,width=1000,height=500,format="pdf",out_file=file_name)
  
  return(list(plot2,plot4,Annual1,Annual2))
  
}

Full.Match.Fac.Plots("Energy","Fully Matched Energy Facilities","Energy")
Full.Match.Fac.Plots("Industrial","Fully Matched Industrial Facilities","Industrial")
# Full.Match.Fac.Plots("Municipal","Fully Matched Municipal Facilities","Municipal")
# Full.Match.Fac.Plots("Agriculture/Irrigation","Fully Matched Agriculture/Irrigation Facilities","Agriculture")
Full.Match.Fac.Plots("Commercial","Fully Matched Commercial Facilities","Commercial")
Full.Match.Fac.Plots("Aquaculture","Fully Matched Commercial Facilities","Aquaculture")

#---All Reporting Facilities vs. Matched for Each Sector---#

EnergyvsNon_CU<- function(Withdrawal_set,Discharge_set,label){
  
  #---Energy Facilities
  
  energy_Monthly_Withdrawal<-
    Withdrawal_set[Withdrawal_set$Use.Type=="Energy",]%>%
    dplyr::group_by(Date)%>%
    dplyr::summarise(Withdrawals=sum(Withdrawals_MGD,na.rm=T),
                     nFacilities=n_distinct(as.character(VWUDS.Facility.ID)))
  
  energy_Monthly_Discharge<-
    Discharge_set[Discharge_set$Use.Type=="Energy",]%>%
    dplyr::group_by(Date)%>%
    dplyr::summarise(Discharges=sum(as.numeric(Discharges_MGD),na.rm=T),
                     nFacilities=n_distinct(as.character(VPDES.Facility.ID)))
  
  energy_Monthly_Discharge$Date<-as.Date(energy_Monthly_Discharge$Date,format="%Y-%m-%d")
  
  energy_CU<-merge(energy_Monthly_Withdrawal,energy_Monthly_Discharge,by=c("Date"))
  
  energy_CU$CU<-(energy_CU$Withdrawals-energy_CU$Discharges)/(energy_CU$Withdrawals)
  
  Annual_CU1<-energy_CU%>%
    dplyr::group_by(Year=substr(Date,1,4))%>%
    dplyr::summarise(CU=median(CU,na.rm=T))
  
  energy<-Withdrawal_set[Withdrawal_set$Use.Type=="Energy",]%>%
    dplyr::group_by(Date)%>%
    dplyr::summarise(Withdrawals=sum(as.numeric(Withdrawals_MGD), na.rm = T))%>%
    plot_ly(x = ~Date)%>%
    add_trace(y = ~Withdrawals, name="Withdrawal",yaxis="y",type = 'scatter', mode = 'lines',line=list(color='#cb181d'),opacity=0.33)%>%
    add_trace(x=energy_Monthly_Discharge$Date, y=energy_Monthly_Discharge$Discharges, yaxis="y",name="Discharge", 
              type="scatter", mode="lines", line=list(color='#2171b5'),opacity=0.5)%>%
    add_trace(x=energy_CU$Date, y= energy_CU$CU, name="Consumption", type='scatter', mode='lines', 
              yaxis='y2',line=list(color='black',dash="dot",width=3))%>%  
    layout(# title = "Statewide Mean Daily Withdrawals vs. Discharges (MGD) in Virginia: All Facilities",
      yaxis = list(title="Quantity (MGD)",
                   side="left",
                   range=c(0,ifelse(max(energy_Monthly_Withdrawal$Withdrawals)>max(energy_Monthly_Discharge$Discharges),ceiling(max(energy_Monthly_Withdrawal$Withdrawals)),ceiling(max(energy_Monthly_Discharge$Discharges))))),
      yaxis2=list(tickfont=list(color="black"),
                  overlaying="y",
                  side="right",
                  range=c(ifelse(min(energy_CU$CU)<0,min(energy_CU$CU),0),1),
                  title="Consumption"),
      margin=list(r=50),
      xaxis = list(title = "Date"),
      legend=list(orientation='h',xanchor="center",x=0.50,yanchor="top", y=-0.15))
  
  
  #---Non-Energy Sectors---#
  non_Monthly_Withdrawal<-Withdrawal_set[!Withdrawal_set$Use.Type=="Energy",]%>%
    dplyr::group_by(Date)%>%
    dplyr::summarise(Withdrawals=sum(Withdrawals_MGD,na.rm=T),
                     nFacilities=n_distinct(as.character(VWUDS.Facility.ID)))
  
  non_Monthly_Discharge<-Discharge_set[!Discharge_set$Use.Type=="Energy",]%>%
    dplyr::group_by(Date)%>%
    dplyr::summarise(Discharges=sum(as.numeric(Discharges_MGD),na.rm=T),
                     nFacilities=n_distinct(as.character(VPDES.Facility.ID)))
  
  non_Monthly_Discharge$Date<-as.Date(non_Monthly_Discharge$Date,format="%Y-%m-%d")
  
  CU2<-merge(non_Monthly_Withdrawal,non_Monthly_Discharge,by=c("Date"))
  
  CU2$CU<-(CU2$Withdrawals-CU2$Discharges)/(CU2$Withdrawals)
  
  Annual_CU2<-CU2%>%
    dplyr::group_by(Year=substr(Date,1,4))%>%
    dplyr::summarise(CU=median(CU,na.rm=T))
  
  nonenergy<-subset(Withdrawal_set,!Withdrawal_set$Use.Type=="Energy")%>%
    dplyr::group_by(Date)%>%
    dplyr::summarise(Withdrawals=sum(as.numeric(Withdrawals_MGD), na.rm = T),
                     nFacilities=n_distinct(as.character(VWUDS.Facility.ID)))%>%
    plot_ly(x = ~Date)%>%
    add_trace(y = ~Withdrawals, name="Withdrawal",type = 'scatter', mode = 'lines', yaxis="y",line=list(color='#cb181d'),opacity=0.33)%>%
    add_trace(x=non_Monthly_Discharge$Date, y=non_Monthly_Discharge$Discharges, yaxis="y",name="Discharge", 
              type="scatter", mode='lines',line=list(color='#2171b5'),opacity=0.5)%>%
    add_trace(x=CU2$Date, y=CU2$CU, name="Consumption", type="scatter", yaxis="y2", mode='lines', line=list(color='black',dash="dot",width=3))%>%
    layout(# title = paste0("Statewide Mean Daily Withdrawals vs. Discharges (MGD) in Virginia: ",Title),
      yaxis = list(title="Quantity (MGD)",
                   side="left",
                   range=c(0,ifelse(max(non_Monthly_Withdrawal$Withdrawals)>max(non_Monthly_Discharge$Discharges),ceiling(max(non_Monthly_Withdrawal$Withdrawals)),ceiling(max(non_Monthly_Discharge$Discharges))))),
      yaxis2=list(tickfont=list(color="black"),
                  overlaying="y3",
                  side="right",
                  title="Consumption",
                  range=c(ifelse(min(CU2$CU)<0,min(CU2$CU),0),1)),
      margin=list(r=50),
      xaxis = list(title = "Date"),
      legend=list(orientation='h',xanchor="center",x=0.50,yanchor="top", y=-0.15))
  
  subplot<-plotly::subplot(style(energy,showlegend=F),nonenergy,shareX = T,nrows=2,titleX= T, 
                           titleY=T)%>%
    layout(annotations = list(
      list(x = 0.5 , y = 1.0, 
           text = "<b>Energy Facilities</b>",
           showarrow = F, 
           xref='paper', yref='paper', xanchor='center',yanchor='bottom'),
      list(x = 0.5 , y = 0.50, 
           text = "<b>Non-Energy Facilities</b>", 
           showarrow = F, xref='paper', yref='paper',xanchor='center',yanchor='top')))
  
  path="G:/My Drive/USGS_ConsumptiveUse/Spring, 2019/Statewide Analysis/Consumption/"
  file_name <- paste(path,"EnergyvsNon_CU_",label, ".pdf", sep="")
  plotly_IMAGE(x=subplot,width=1000,height=700,format="pdf",out_file=file_name)
  
  
  return(list(subplot,Annual_CU1,Annual_CU2))
}
EnergyvsNon_CU(VWUDS_2010_2017,ECHO_2010_2017,"All")
EnergyvsNon_CU(full_match_2010_2017,full_match_2010_2017,"Matched")

compare_all_match_CU<- function(Sector,label){
  
  Monthly_Withdrawal<-VWUDS_2010_2017[VWUDS_2010_2017$Use.Type==Sector,]%>%
    dplyr::group_by(Date)%>%
    dplyr::summarise(Withdrawals=sum(Withdrawals_MGD,na.rm=T),
                     nFacilities=n_distinct(as.character(VWUDS.Facility.ID)))
  
  Monthly_Discharge<-ECHO_2010_2017[ECHO_2010_2017$Use.Type==Sector,]%>%
    dplyr::group_by(Date)%>%
    dplyr::summarise(Discharges=sum(as.numeric(Discharges_MGD),na.rm=T),
                     nFacilities=n_distinct(as.character(VPDES.Facility.ID)))
  
  Monthly_Discharge$Date<-as.Date(Monthly_Discharge$Date,format="%Y-%m-%d")
  
  CU2<-merge(Monthly_Withdrawal,Monthly_Discharge,by=c("Date"))
  
  CU2$CU<-(CU2$Withdrawals-CU2$Discharges)/(CU2$Withdrawals)
  CU2$CU_MGD<-(CU2$Withdrawals-CU2$Discharges)
  
  all<-subset(VWUDS_2010_2017,VWUDS_2010_2017$Use.Type==Sector)%>%
    dplyr::group_by(Date)%>%
    dplyr::summarise(Withdrawals=sum(as.numeric(Withdrawals_MGD), na.rm = T),
                     nFacilities=n_distinct(as.character(VWUDS.Facility.ID)))%>%
    plot_ly(x = ~Date)%>%
    add_trace(y = ~Withdrawals, name="Withdrawal",type = 'scatter', mode = 'lines', line=list(color='#cb181d'),opacity=0.33)%>%
    add_trace(x=Monthly_Discharge$Date, y=Monthly_Discharge$Discharges, name="Discharge", type="scatter", mode='lines',line=list(color='#2171b5'),opacity=0.33)%>%
    add_trace(x=CU2$Date, y=CU2$CU, name="Consumption", type="scatter", yaxis="y2", mode='lines', line=list(color='black',dash="dot",width=3))%>%
    layout(# title = paste0("Statewide Mean Daily Withdrawals vs. Discharges (MGD) in Virginia: ",Title),
      yaxis = list(title="Quantity (MGD)",
                   range=c(0,ifelse(max(Monthly_Withdrawal$Withdrawals)>max(Monthly_Discharge$Discharges),
                                    ceiling(max(Monthly_Withdrawal$Withdrawals)),ceiling(max(Monthly_Discharge$Discharges))))),
      yaxis2=list(tickfont=list(color="black"),
                  overlaying="y",
                  side="right",
                  title="Consumption",
                  range=c(ifelse(min(CU2$CU)<0,min(CU2$CU),0),1)),
      margin=list(r=50),
      font = list(color = '#252525', size = 16),
      xaxis = list(title = "Date"),
      legend=list(orientation='h',xanchor="center",x=0.50,yanchor="top", y=-0.15))
  
  #---Matched Data---#
  
  Full_Matched_Monthly_Discharge<-
    subset(full_match_2010_2017,full_match_2010_2017$Use.Type==Sector)%>%
    group_by(Date)%>%
    summarise(Discharges=sum(as.numeric(Discharges_MGD),na.rm=T),
              nFacilities=n_distinct(as.character(VPDES.Facility.ID)))
  
  Full_Matched_Monthly_Withdrawal<-
    subset(full_match_2010_2017,full_match_2010_2017$Use.Type==Sector)%>%
    dplyr::group_by(Date)%>%
    dplyr::summarise(Withdrawals=sum(Withdrawals_MGD,na.rm=T),
                     nFacilities=n_distinct(as.character(VWUDS.Facility.ID)))
  
  Full_Matched_CU<-data.frame(Date=Full_Matched_Monthly_Withdrawal$Date,
                              CU=(Full_Matched_Monthly_Withdrawal$Withdrawals-Full_Matched_Monthly_Discharge$Discharges)/
                                Full_Matched_Monthly_Withdrawal$Withdrawals,stringsAsFactors = F)
  
  Annual2<-Full_Matched_CU%>%
    dplyr::group_by(Year=substr(Date,1,4))%>%
    dplyr::summarise(Annual_CU=mean(CU,na.rm=T))
  
  Full_Matched_CU<-data.frame(Date=Full_Matched_Monthly_Withdrawal$Date,
                              CU=(Full_Matched_Monthly_Withdrawal$Withdrawals-Full_Matched_Monthly_Discharge$Discharges)/
                                Full_Matched_Monthly_Withdrawal$Withdrawals,
                              CU_MGD=(Full_Matched_Monthly_Withdrawal$Withdrawals-Full_Matched_Monthly_Discharge$Discharges),stringsAsFactors = F)
  
  
  Match<-subset(full_match_2010_2017,full_match_2010_2017$Use.Type==Sector)%>%
    group_by(Date)%>%
    summarise(Withdrawals=sum(as.numeric(Withdrawals_MGD), na.rm = T),nFacilities=n_distinct(as.character(VWUDS.Facility.ID)))%>%
    plot_ly(x = ~Date)%>%
    add_trace(y = ~Withdrawals, name="Matched Withdrawal",type = 'scatter', mode = 'lines', line=list(color='#de2d26'),opacity=0.33)%>%
    add_trace(x=Full_Matched_Monthly_Discharge$Date, y=Full_Matched_Monthly_Discharge$Discharges, name="Matched Discharge", type="scatter", mode="lines", 
              line=list(color='#3182bd'),opacity=0.33)%>%
    add_trace(x=Full_Matched_CU$Date,y=Full_Matched_CU$CU, name="Consumption",yaxis='y2', type="scatter",mode='lines', line=list(color='black',dash="dot",width=3))%>%
    layout(# title = paste0("Statewide Mean Daily Withdrawals vs. Discharges (MGD) in Virginia: ",Title),
      yaxis = list(title="Quantity (MGD)",
                   range=c(0,ifelse(max(Full_Matched_Monthly_Withdrawal$Withdrawals)>max(Full_Matched_Monthly_Discharge$Discharges),max(Full_Matched_Monthly_Withdrawal$Withdrawals),max(Full_Matched_Monthly_Discharge$Discharges)))),
      yaxis2=list(tickfont=list(color="black"),
                  overlaying="y3",
                  side="right",
                  title="Consumption",
                  range=c(ifelse(min(Full_Matched_CU$CU)<0,min(Full_Matched_CU$CU),0),1)),
      font = list(color = '#252525', size = 16),
      margin=list(r=50),xaxis = list(title = "Date"),legend=list(orientation='h',xanchor="center",x=0.50,yanchor="top", y=-0.15))
  
  
  subplot<-plotly::subplot(all,style(Match,showlegend=F),shareX = T,nrows=2,titleX= T, 
                           titleY=T,margin=0.03)%>%
    layout(annotations = list(
      list(x = 0.5 , y = 1.0, 
           text = "<b>(a) All Reporting Facilities</b>",
           size=16,
           showarrow = F, 
           xref='paper', yref='paper', xanchor='center',yanchor='bottom'),
      list(x = 0.5 , y = 0.50, 
           text = "<b>(b) Matched Facilities</b>", 
           size=16,
           showarrow = F, xref='paper', yref='paper',xanchor='center',yanchor='center')))
  
  
  stats1<-boxplot.stats(CU2$CU)
  stats2<-boxplot.stats(Full_Matched_CU$CU)
  
  stats3<-boxplot.stats(CU2$CU_MGD)
  stats4<-boxplot.stats(Full_Matched_CU$CU_MGD)
  
  path="G:/My Drive/USGS_ConsumptiveUse/Spring, 2019/Statewide Analysis/Consumption/"
  file_name <- paste(path,"Statewide_Compare_Consumption",label, ".pdf", sep="")
  plotly_IMAGE(x=subplot,width=1000,height=700,format="pdf",out_file=file_name)
  
  return(list(subplot,stats1,stats2,stats3,stats4))
  
}
compare_all_match_CU("Energy","Energy")
compare_all_match_CU("Industrial","Industrial")
compare_all_match_CU("Commercial","Commercial")
compare_all_match_CU("Aquaculture","Aquaculture")

compare_all_match_CU.nonenergy<- function(Sector,label){
  
  Monthly_Withdrawal<-VWUDS_2010_2017[!VWUDS_2010_2017$Use.Type==Sector,]%>%
    dplyr::group_by(Date)%>%
    dplyr::summarise(Withdrawals=sum(Withdrawals_MGD,na.rm=T),
                     nFacilities=n_distinct(as.character(VWUDS.Facility.ID)))
  
  Monthly_Discharge<-ECHO_2010_2017[!ECHO_2010_2017$Use.Type==Sector,]%>%
    dplyr::group_by(Date)%>%
    dplyr::summarise(Discharges=sum(as.numeric(Discharges_MGD),na.rm=T),
                     nFacilities=n_distinct(as.character(VPDES.Facility.ID)))
  
  Monthly_Discharge$Date<-as.Date(Monthly_Discharge$Date,format="%Y-%m-%d")
  
  CU2<-merge(Monthly_Withdrawal,Monthly_Discharge,by=c("Date"))
  
  CU2$CU<-(CU2$Withdrawals-CU2$Discharges)/(CU2$Withdrawals)
  
  all<-subset(VWUDS_2010_2017,!VWUDS_2010_2017$Use.Type==Sector)%>%
    dplyr::group_by(Date)%>%
    dplyr::summarise(Withdrawals=sum(as.numeric(Withdrawals_MGD), na.rm = T),
                     nFacilities=n_distinct(as.character(VWUDS.Facility.ID)))%>%
    plot_ly(x = ~Date)%>%
    add_trace(y = ~Withdrawals, name="Withdrawal",type = 'scatter', mode = 'lines', line=list(color='#cb181d'),opacity=0.33)%>%
    add_trace(x=Monthly_Discharge$Date, y=Monthly_Discharge$Discharges, name="Discharge", type="scatter", mode='lines',line=list(color='#2171b5'),opacity=0.33)%>%
    add_trace(x=CU2$Date, y=CU2$CU, name="Consumption", type="scatter", yaxis="y2", mode='lines', line=list(color='black',dash="dot",width=3))%>%
    layout(# title = paste0("Statewide Mean Daily Withdrawals vs. Discharges (MGD) in Virginia: ",Title),
      yaxis = list(title="Quantity (MGD)",
                   range=c(0,ifelse(max(Monthly_Withdrawal$Withdrawals)>max(Monthly_Discharge$Discharges),
                                    ceiling(max(Monthly_Withdrawal$Withdrawals)),ceiling(max(Monthly_Discharge$Discharges))))),
      yaxis2=list(tickfont=list(color="black"),
                  overlaying="y",
                  side="right",
                  title="Consumption",
                  range=c(ifelse(min(CU2$CU)<0,min(CU2$CU),0),1)),
      margin=list(r=50),
      xaxis = list(title = "Date"),
      font = list(color = '#252525', size = 16),
      legend=list(orientation='h',xanchor="center",x=0.50,yanchor="top", y=-0.15))
  
  #---Matched Data---#
  
  Full_Matched_Monthly_Discharge<-
    subset(full_match_2010_2017,!full_match_2010_2017$Use.Type==Sector)%>%
    group_by(Date)%>%
    summarise(Discharges=sum(as.numeric(Discharges_MGD),na.rm=T),
              nFacilities=n_distinct(as.character(VPDES.Facility.ID)))
  
  Full_Matched_Monthly_Withdrawal<-
    subset(full_match_2010_2017,!full_match_2010_2017$Use.Type==Sector)%>%
    dplyr::group_by(Date)%>%
    dplyr::summarise(Withdrawals=sum(Withdrawals_MGD,na.rm=T),
                     nFacilities=n_distinct(as.character(VWUDS.Facility.ID)))
  
  Full_Matched_CU<-data.frame(Date=Full_Matched_Monthly_Withdrawal$Date,
                              CU=(Full_Matched_Monthly_Withdrawal$Withdrawals-Full_Matched_Monthly_Discharge$Discharges)/
                                Full_Matched_Monthly_Withdrawal$Withdrawals,stringsAsFactors = F)
  
  Annual2<-Full_Matched_CU%>%
    dplyr::group_by(Year=substr(Date,1,4))%>%
    dplyr::summarise(Annual_CU=mean(CU,na.rm=T))
  
  Full_Matched_CU<-data.frame(Date=Full_Matched_Monthly_Withdrawal$Date,
                              CU=(Full_Matched_Monthly_Withdrawal$Withdrawals-Full_Matched_Monthly_Discharge$Discharges)/
                                Full_Matched_Monthly_Withdrawal$Withdrawals,stringsAsFactors = F)
  
  
  Match<-subset(full_match_2010_2017,!full_match_2010_2017$Use.Type==Sector)%>%
    group_by(Date)%>%
    summarise(Withdrawals=sum(as.numeric(Withdrawals_MGD), na.rm = T),nFacilities=n_distinct(as.character(VWUDS.Facility.ID)))%>%
    plot_ly(x = ~Date)%>%
    add_trace(y = ~Withdrawals, name="Matched Withdrawal",type = 'scatter', mode = 'lines', line=list(color='#de2d26'),opacity=0.33)%>%
    add_trace(x=Full_Matched_Monthly_Discharge$Date, y=Full_Matched_Monthly_Discharge$Discharges, name="Matched Discharge", type="scatter", mode="lines", 
              line=list(color='#3182bd'),opacity=0.33)%>%
    add_trace(x=Full_Matched_CU$Date,y=Full_Matched_CU$CU, name="Consumption",yaxis='y2', type="scatter",mode='lines', line=list(color='black',dash="dot",width=3))%>%
    layout(# title = paste0("Statewide Mean Daily Withdrawals vs. Discharges (MGD) in Virginia: ",Title),
      yaxis = list(title="Quantity (MGD)",
                   range=c(0,ifelse(max(Full_Matched_Monthly_Withdrawal$Withdrawals)>max(Full_Matched_Monthly_Discharge$Discharges),max(Full_Matched_Monthly_Withdrawal$Withdrawals),max(Full_Matched_Monthly_Discharge$Discharges)))),
      yaxis2=list(tickfont=list(color="black"),
                  overlaying="y3",
                  side="right",
                  title="Consumption",
                  range=c(ifelse(min(Full_Matched_CU$CU)<0,min(Full_Matched_CU$CU),0),1)),
      font = list(color = '#252525', size = 16),
      margin=list(r=50),xaxis = list(title = "Date"),legend=list(orientation='h',xanchor="center",x=0.50,yanchor="top", y=-0.15))
  
  
  subplot<-plotly::subplot(all,style(Match,showlegend=F),shareX = T,nrows=2,titleX= T, 
                           titleY=T,margin=0.03)%>%
    layout(annotations = list(
      list(x = 0.5 , y = 1.0, 
           text = "<b>(a) All Reporting Facilities</b>",
           size=16,
           showarrow = F, 
           xref='paper', yref='paper', xanchor='center',yanchor='bottom'),
      list(x = 0.5 , y = 0.50, 
           text = "<b>(b) Matched Facilities</b>", 
           size=16,
           showarrow = F, xref='paper', yref='paper',xanchor='center',yanchor='center')))
  
  
  stats1<-boxplot.stats(CU2$CU)
  stats2<-boxplot.stats(Full_Matched_CU$CU)
  
  path="G:/My Drive/USGS_ConsumptiveUse/Spring, 2019/Statewide Analysis/Consumption/"
  file_name <- paste(path,"Statewide_Compare_Consumption",label, ".pdf", sep="")
  plotly_IMAGE(x=subplot,width=1000,height=700,format="pdf",out_file=file_name)
  
  return(list(subplot,stats1,stats2))
  
}
compare_all_match_CU.nonenergy("Energy","Non-energy")

# We cannot compute municipal consumption on a facility level basis due to 
# differing customer base, unequal discharges and withdrawals, and the fact that
# the majority of reported discharge is process water

municipal_all_match_CU<- function(Sector,label){
  
  Monthly_Withdrawal<-VWUDS_2010_2017[VWUDS_2010_2017$Use.Type==Sector,]%>%
    dplyr::group_by(Date)%>%
    dplyr::summarise(Withdrawals=sum(Withdrawals_MGD,na.rm=T),
                     nFacilities=n_distinct(as.character(VWUDS.Facility.ID)))
  
  Monthly_Discharge<-ECHO_2010_2017[ECHO_2010_2017$Use.Type==Sector,]%>%
    dplyr::group_by(Date)%>%
    dplyr::summarise(Discharges=sum(as.numeric(Discharges_MGD),na.rm=T),
                     nFacilities=n_distinct(as.character(VPDES.Facility.ID)))
  
  Monthly_Discharge$Date<-as.Date(Monthly_Discharge$Date,format="%Y-%m-%d")
  
  CU2<-merge(Monthly_Withdrawal,Monthly_Discharge,by=c("Date"))
  
  CU2$CU<-(CU2$Withdrawals-CU2$Discharges)/(CU2$Withdrawals)
  
  all<-subset(VWUDS_2010_2017,VWUDS_2010_2017$Use.Type==Sector)%>%
    dplyr::group_by(Date)%>%
    dplyr::summarise(Withdrawals=sum(as.numeric(Withdrawals_MGD), na.rm = T),
                     nFacilities=n_distinct(as.character(VWUDS.Facility.ID)))%>%
    plot_ly(x = ~Date)%>%
    add_trace(y = ~Withdrawals, name="Withdrawal",type = 'scatter', mode = 'lines', line=list(color='#cb181d'),opacity=0.33)%>%
    add_trace(x=Monthly_Discharge$Date, y=Monthly_Discharge$Discharges, name="Discharge", type="scatter", mode='lines',line=list(color='#2171b5'),opacity=0.33)%>%
    add_trace(x=CU2$Date, y=CU2$CU, name="Consumption", type="scatter", yaxis="y2", mode='lines', line=list(color='black',dash="dot",width=3))%>%
    layout(# title = paste0("Statewide Mean Daily Withdrawals vs. Discharges (MGD) in Virginia: ",Title),
      yaxis = list(title="Quantity (MGD)",
                   range=c(0,ifelse(max(Monthly_Withdrawal$Withdrawals)>max(Monthly_Discharge$Discharges),
                                    ceiling(max(Monthly_Withdrawal$Withdrawals)),ceiling(max(Monthly_Discharge$Discharges))))),
      yaxis2=list(tickfont=list(color="black"),
                  overlaying="y",
                  side="right",
                  title="Consumption",
                  range=c(ifelse(min(CU2$CU)<0,min(CU2$CU),0),1)),
      margin=list(r=50),
      xaxis = list(title = "Date"),
      legend=list(orientation='h',xanchor="center",x=0.50,yanchor="top", y=-0.15))
  
  match<-plotly_empty()%>%
    layout(yaxis=list(showline=F,showticklabels = FALSE,title = "",side="left"),
           yaxis2=list(showline=F,showticklabels = FALSE,title = "",overlaying="y3",side="right"),
           xaxis=list(showline=T,showticklabels = T,title="Date"),
           margin=list(r=50))
  
  
  subplot<-plotly::subplot(all,match,nrows=2,titleX= T,shareX = T,shareY = F, titleY=T,margin=0.03)%>%
    layout(annotations = list(
      list(x = 0.5 , y = 1.0, 
           text = "<b>(a) All Reporting Facilities</b>",
           showarrow = F, 
           xref='paper', yref='paper', xanchor='center',yanchor='bottom'),
      list(x = 0.5 , y = 0.50, 
           text = "<b>(b) Matched Facilities</b>", 
           showarrow = F, xref='paper', yref='paper',xanchor='center',yanchor='center')))
  
  
  path="G:/My Drive/USGS_ConsumptiveUse/Spring, 2019/Statewide Analysis/Consumption/"
  file_name <- paste(path,"Statewide_Compare_Consumption",label, ".pdf", sep="")
  plotly_IMAGE(x=subplot,width=1000,height=700,format="pdf",out_file=file_name)
  
  return(list(subplot))
  
}
municipal_all_match_CU("Municipal","Municipal")

# Assume agirculture is 100% consumptive

agriculture_all_match_CU<- function(Sector,label){
  
  Monthly_Withdrawal<-VWUDS_2010_2017[VWUDS_2010_2017$Use.Type==Sector,]%>%
    dplyr::group_by(Date)%>%
    dplyr::summarise(Withdrawals=sum(Withdrawals_MGD,na.rm=T),
                     nFacilities=n_distinct(as.character(VWUDS.Facility.ID)))
  
  Monthly_Discharge<-data.frame(Date=Monthly_Withdrawal$Date,Discharges=0.0)
    
  Monthly_Discharge$Date<-as.Date(Monthly_Discharge$Date,format="%Y-%m-%d")
  
  CU2<-merge(Monthly_Withdrawal,Monthly_Discharge,by=c("Date"))
  
  CU2$CU<-(CU2$Withdrawals-CU2$Discharges)/(CU2$Withdrawals)
  
  all<-subset(VWUDS_2010_2017,VWUDS_2010_2017$Use.Type==Sector)%>%
    dplyr::group_by(Date)%>%
    dplyr::summarise(Withdrawals=sum(as.numeric(Withdrawals_MGD), na.rm = T),
                     nFacilities=n_distinct(as.character(VWUDS.Facility.ID)))%>%
    plot_ly(x = ~Date)%>%
    add_trace(y = ~Withdrawals, name="Withdrawal",type = 'scatter', mode = 'lines', line=list(color='#cb181d'),opacity=0.33)%>%
    add_trace(x=CU2$Date, y=CU2$CU, name="Consumption", type="scatter", yaxis="y2", mode='lines', line=list(color='black',dash="dot",width=3))%>%
    layout(# title = paste0("Statewide Mean Daily Withdrawals vs. Discharges (MGD) in Virginia: ",Title),
      yaxis = list(title="Quantity (MGD)",
                   range=c(0,ifelse(max(Monthly_Withdrawal$Withdrawals)>max(Monthly_Discharge$Discharges),
                                    ceiling(max(Monthly_Withdrawal$Withdrawals)),ceiling(max(Monthly_Discharge$Discharges))))),
      yaxis2=list(tickfont=list(color="black"),
                  overlaying="y",
                  side="right",
                  title="Consumption",
                  range=c(ifelse(min(CU2$CU)<0,min(CU2$CU),0),1)),
      margin=list(r=50),
      xaxis = list(title = "Date"),
      legend=list(orientation='h',xanchor="center",x=0.50,yanchor="top", y=-0.15))
  
  match<-plotly_empty()%>%
    layout(yaxis=list(showline=F,showticklabels = FALSE,title = "",side="left"),
           yaxis2=list(showline=F,showticklabels = FALSE,title = "",overlaying="y3",side="right"),
           xaxis=list(showline=T,showticklabels = T,title="Date"),
           margin=list(r=50))
  
  
  subplot<-plotly::subplot(all,match,nrows=2,titleX= T,shareX = T,shareY = F, titleY=T,margin=0.03)%>%
    layout(annotations = list(
      list(x = 0.5 , y = 1.0, 
           text = "<b>(a) All Reporting Facilities</b>",
           showarrow = F, 
           xref='paper', yref='paper', xanchor='center',yanchor='bottom'),
      list(x = 0.5 , y = 0.50, 
           text = "<b>(b) Matched Facilities</b>", 
           showarrow = F, xref='paper', yref='paper',xanchor='center',yanchor='center')))
  
  
  path="G:/My Drive/USGS_ConsumptiveUse/Spring, 2019/Statewide Analysis/Consumption/"
  file_name <- paste(path,"Statewide_Compare_Consumption",label, ".pdf", sep="")
  plotly_IMAGE(x=subplot,width=1000,height=700,format="pdf",out_file=file_name)
  
  return(list(subplot))
  
}
agriculture_all_match_CU("Agriculture/Irrigation","Agriculture")


#----Single Systems----#

# This function goes through each matched facility to observe gaps in reporting between withdrawals and discharges
case.study<- function(VPDESID,VWUDSID,FacilityName){
  Matched_Monthly_Discharge<-
    subset(Match_ECHO_2010_2017,Match_ECHO_2010_2017$VPDES.Facility.ID==VPDESID)%>%
    dplyr::group_by(Date)%>%
    dplyr::summarise(Discharges=sum(as.numeric(Discharges_MGD),na.rm=T),
                     nFacilities=n_distinct(as.character(VPDES.Facility.ID)))
  
  Matched_Monthly_Withdrawal<-
    subset(Match_VWUDS_2010_2017,Match_VWUDS_2010_2017$VWUDS.Facility.ID==VWUDSID)%>%
    dplyr::group_by(Date)%>%
    dplyr::summarise(Withdrawals=sum(Withdrawals_MGD,na.rm=T),
                     nFacilities=n_distinct(as.character(VWUDS.Facility.ID)))
  
  Matched_CU<-data.frame(Date=Matched_Monthly_Withdrawal$Date,
                         CU=(Matched_Monthly_Withdrawal$Withdrawals-Matched_Monthly_Discharge$Discharges)/
                           Matched_Monthly_Withdrawal$Withdrawals,stringsAsFactors = F)
  
  subset(Match_VWUDS_2010_2017,Match_VWUDS_2010_2017$VWUDS.Facility.ID==VWUDSID)%>%
    group_by(Date)%>%
    summarise(Withdrawals=sum(as.numeric(Withdrawals_MGD), na.rm = T),
              nFacilities=n_distinct(as.character(VWUDS.Facility.ID)))%>%
    plot_ly(x = ~Date)%>%
    add_trace(y = ~Withdrawals, name="Withdrawal",type = 'scatter', mode = 'lines+markers', marker=list(color='red'), line=list(color='red'))%>%
    add_trace(x=Matched_Monthly_Discharge$Date, y=Matched_Monthly_Discharge$Discharges, name="Discharge", type="scatter", mode="lines+markers", marker=list(color="blue"), line=list(color='blue'))%>%
    add_trace(y= ~nFacilities, name="VWUDS Facilities", type='bar', yaxis='y2', opacity=0.25,marker=list(color='black'))%>%
    add_trace(x=Matched_Monthly_Discharge$Date, y= Matched_Monthly_Discharge$nFacilities, name="VPDES Facilities", type='bar', yaxis='y2', opacity=0.25,marker=list(color='grey'))%>%
    layout(title = paste("Statewide Mean Daily Withdrawals vs. Discharges (MGD) in Virginia: ",FacilityName),
           yaxis = list(title="Mean Daily Quantity (MGD)",
                        range=c(0,max(Matched_Monthly_Withdrawal$Withdrawals))),
           yaxis2=list(tickfont=list(color="black"),
                       overlaying="y",
                       side="right",
                       title="Number of Reporting Facilities",
                       dtick=1,
                       ticklen=0.5),
           margin=list(r=125),
           xaxis = list(title = "Monitoring Period (Months)"),
           legend=list(orientation='h',xanchor="center",x=0.50,yanchor="top", y=-0.15))
}
for (i in 1:length(full_match_2010_2017_summary$VPDES.Facility.ID)){
  print(paste("Matched Facility ",i," of ", length(full_match_2010_2017_summary$VPDES.Facility.ID)))
  full_match_2010_2017_summary<-full_match_2010_2017_summary%>%arrange(desc(Ave_Withdrawal_mgd))
  case.study(full_match_2010_2017_summary$VPDES.Facility.ID[i],
                        full_match_2010_2017_summary$VWUDS.Facility.ID[i],
                        full_match_2010_2017_summary$VWUDS.Name[i])
  print(list(full_match_2010_2017_summary$VWUDS.Facility.ID[i],
             full_match_2010_2017_summary$Use.Type[i],
             full_match_2010_2017_summary$Waterbody[i],
             full_match_2010_2017_summary$VWUDS_perc[i],
             full_match_2010_2017_summary$VPDES_perc[i]))
}

#--Case Studies of Outfalls--#

# Plots all outfalls against withdrawals for each facility
outfall.compare<- function(VPDESID,VWUDSID){
  
  ECHO_2010_2017<-read.table("G:/My Drive/ECHO NPDES/USGS_Consumptive_Use_Updated/ECHO_2010_2017_QAQC.txt", sep="\t", header=T)
  ECHO_2010_2017<-as.data.table(ECHO_2010_2017)
  ECHO_2010_2017<-ECHO_2010_2017[!duplicated(ECHO_2010_2017, by=c("OutfallID","MP_End_Date")),]
  ECHO_2010_2017<-subset(ECHO_2010_2017,select=c(1:8,10,12,19,33,39,42,43,44))
  colnames(ECHO_2010_2017)<-c("OutfallID","Year","VPDES.Facility.ID","VPDES.Name","Fac.Lat","Fac.Long",
                              "Outfall.Lat","Outfall.Long","Measured_Effluent","Discharges_MGD","Date","County",
                              "Permit_Type","Waterbody","Use.Type","Mon_Reported")
  ECHO_2010_2017$Discharges_MGD<-as.numeric(ECHO_2010_2017$Discharges_MGD)
  ECHO_2010_2017$Date<-as.Date(ECHO_2010_2017$Date,format="%Y-%m-%d")
  load("G:/My Drive/ECHO NPDES/USGS_Consumptive_Use_Updated/Code/R Workspaces/VWUDS_2010_2017.RData")
  colnames(VWUDS_2010_2017)[3]<-"VWUDS.Facility.ID"
  colnames(VWUDS_2010_2017)[10]<-"Old.Use.Type"
  colnames(VWUDS_2010_2017)[20]<-"Use.Type"
  VWUDS_2010_2017<-as.data.table(VWUDS_2010_2017)
  
  Discharge<-
    subset(ECHO_2010_2017,ECHO_2010_2017$VPDES.Facility.ID==VPDESID)%>%dplyr::group_by(OutfallID,Date)%>%
    dplyr::summarise(Discharges=sum(as.numeric(Discharges_MGD),na.rm=T),
                     nFacilities=n_distinct(as.character(VPDES.Facility.ID)))
  
  Withdrawal<-
    subset(VWUDS_2010_2017,VWUDS_2010_2017$VWUDS.Facility.ID==VWUDSID)%>%dplyr::group_by(Date)%>%
    dplyr::summarise(Withdrawals=sum(as.numeric(Withdrawals_MGD), na.rm = T),nFacilities=n_distinct(as.character(VWUDS.Facility.ID)))
  
  plot1<-subset(VWUDS_2010_2017,VWUDS_2010_2017$VWUDS.Facility.ID==VWUDSID)%>%
    group_by(Date)%>%
    summarise(Withdrawals=sum(as.numeric(Withdrawals_MGD), na.rm = T),nFacilities=n_distinct(as.character(VWUDS.Facility.ID)))%>%
    plot_ly(x = ~Date)%>%
    add_trace(y = ~Withdrawals, name="Withdrawal",type = 'scatter', mode = 'lines+markers', marker=list(color='red'), line=list(color='red'))%>%
    layout(title = paste("Statewide Mean Daily Withdrawals vs. Discharges (MGD) in Virginia: ",unique(VWUDS_2010_2017$Facility[VWUDS_2010_2017$VWUDS.Facility.ID==VWUDSID])),
         yaxis = list(title="Mean Daily Quantity (MGD)", 
                      range=c(0,ifelse(max(Withdrawal$Withdrawals)>max(Discharge$Discharges),
                                       max(Withdrawal$Withdrawals),max(Discharge$Discharges)))),
         margin=list(r=125),
         xaxis = list(title = "Monitoring Period (Months)"),
         legend=list(orientation='h',xanchor="center",x=0.50,yanchor="top", y=-0.15))
  
    colfunc <- colorRampPalette(c("#08306b", "#9ecae1"))
    dis_cols<-colfunc(28)
    
    for (i in 1:length(unique(Discharge$OutfallID))){
      
      outfall<-subset(Discharge,Discharge$OutfallID==levels(factor(Discharge$OutfallID))[i])
      plot1<-add_trace(plot1,
                x=outfall$Date,y=outfall$Discharges,
                name=paste0("Outfall ",substr(levels(factor(Discharge$OutfallID))[i],10,13)),type='scatter',
                mode='lines+markers',
                marker=list(color=dis_cols[i]),
                line=list(color=dis_cols[i]))
    }
  
  # Reporting<-
    #subset(ECHO_2010_2017,ECHO_2010_2017$VPDES.Facility.ID==VPDESID)%>%dplyr::group_by(VPDES.Facility.ID)%>%
    #dplyr::summarise(Freq=first(Mon_Reported))
  plot1 #returns unique outfall IDs
  
}

# Use this to go through facilities one by one
full_match_2010_2017_summary<-full_match_2010_2017_summary%>%arrange(desc(Ave_Withdrawal_mgd))
outfall.compare(full_match_2010_2017_summary$VPDES.Facility.ID[i],full_match_2010_2017_summary$VWUDS.Facility.ID[i])

# This for loop goes through each facility to speed up getting results. Major water users are at top of list
plot_list=list()
for (i in 1:length(full_match_2010_2017_summary$VPDES.Facility.ID)){
  print(paste("Matched Facility ",i," of ", length(full_match_2010_2017_summary$VPDES.Facility.ID)))
  p= outfall.compare(full_match_2010_2017_summary$VPDES.Facility.ID[i],
                        full_match_2010_2017_summary$VWUDS.Facility.ID[i])
  
  plot_list[[i]] = p
}

path="G:/My Drive/USGS_ConsumptiveUse/Spring, 2019/Matched Facilities/Case Studies/Withdrawals_vs_Outfalls/"
# save plots to PNG. Makes a separate file for each plot
for (i in 1:length(full_match_2010_2017_summary$VPDES.Facility.ID)) {
  print(paste("Matched Facility ",i," of ", length(full_match_2010_2017_summary$VPDES.Facility.ID)))
  file_name <- paste(path,"Outfall_compare_", i, ".png", sep="")
  plotly_IMAGE(x=plot_list[[i]],width=1000,height=500,format="png",out_file=file_name)
}




#---Fully Matched: Case Studies---#
# This function goes through each matched facility and plots its withdrawals, discharges, and consumption over time.


Full.Match.case.study<- function(VPDESID,VWUDSID,FacilityName){
  full_match_2010_2017_summary<-full_match_2010_2017_summary%>%arrange(desc(Ave_Withdrawal_mgd))
  full_match_2010_2017_summary<-mutate_if(full_match_2010_2017_summary,is.factor,as.character)
  
  full_match_2010_2017_summary$VPDES.Name<-tolower(full_match_2010_2017_summary$VPDES.Name)
  full_match_2010_2017_summary$VPDES.Name<-tools::toTitleCase(as.character(full_match_2010_2017_summary$VPDES.Name))
  
  Full_Matched_Monthly_Discharge<-
    subset(full_match_2010_2017,full_match_2010_2017$VPDES.Facility.ID==VPDESID)%>%
    group_by(Date)%>%
    summarise(Discharges=sum(as.numeric(Discharges_MGD),na.rm=T),
              # OutfallID=first(OutfallID),
              nFacilities=n_distinct(as.character(VPDES.Facility.ID)))
  
  Full_Matched_Monthly_Withdrawal<-
    subset(full_match_2010_2017,full_match_2010_2017$VWUDS.Facility.ID==VWUDSID)%>%
    dplyr::group_by(Date)%>%
    dplyr::summarise(Withdrawals=sum(Withdrawals_MGD,na.rm=T),
                     nFacilities=n_distinct(as.character(VWUDS.Facility.ID)))
  
  Full_Matched_CU<-data.frame(Date=Full_Matched_Monthly_Withdrawal$Date,
                              CU=(Full_Matched_Monthly_Withdrawal$Withdrawals-Full_Matched_Monthly_Discharge$Discharges)/
                                Full_Matched_Monthly_Withdrawal$Withdrawals,stringsAsFactors = F)
  
  Yearly_CU<-Full_Matched_CU%>%dplyr::group_by(Year=substr(Date,1,4))%>%dplyr::summarise(Ave_CU=mean(CU,na.rm=T),Median_CU=median(CU,na.rm=T))
  
  plot1<-subset(full_match_2010_2017,full_match_2010_2017$VWUDS.Facility.ID==VWUDSID)%>%
    group_by(Date)%>%
    summarise(Withdrawals=sum(as.numeric(Withdrawals_MGD), na.rm = T),
              nFacilities=n_distinct(as.character(VWUDS.Facility.ID)))%>%
    plot_ly(x = ~Date)%>%
    add_trace(y = ~Withdrawals, name="Withdrawal",type = 'scatter', mode = 'lines', line=list(color='#de2d26'),opacity=0.33)%>%
    add_trace(x=Full_Matched_Monthly_Discharge$Date, y=Full_Matched_Monthly_Discharge$Discharges, name="Discharge", type="scatter", mode="lines", mode='lines',line=list(color='#2171b5'),opacity=0.33)%>%
    add_trace(y= ~nFacilities, name="VWUDS Facilities", type='bar', yaxis='y2', opacity=0.25,marker=list(color='black'))%>%
    add_trace(x=Full_Matched_Monthly_Discharge$Date, y= Full_Matched_Monthly_Discharge$nFacilities, name="VPDES Facilities", type='bar', yaxis='y2', opacity=0.25,marker=list(color='grey'))%>%
    layout(title = paste("Mean Daily Withdrawals vs. Discharges (MGD): ",FacilityName),
           yaxis = list(title="Mean Daily Quantity (MGD)",
                        range=c(0,ifelse(max(Full_Matched_Monthly_Withdrawal$Withdrawals)>max(Full_Matched_Monthly_Discharge$Discharges),max(Full_Matched_Monthly_Withdrawal$Withdrawals),max(Full_Matched_Monthly_Discharge$Discharges)))),
           yaxis2=list(tickfont=list(color="black"),
                       overlaying="y",
                       side="right",
                       title="Number of Reporting Facilities",
                       dtick=1,
                       ticklen=0.5),
           margin=list(r=125),
           xaxis = list(title = "Monitoring Period (Months)"),
           legend=list(orientation='h',xanchor="center",x=0.50,yanchor="top", y=-0.15))

  plot2<-subset(full_match_2010_2017,full_match_2010_2017$VWUDS.Facility.ID==VWUDSID)%>%
    group_by(Date)%>%
    summarise(Withdrawals=sum(as.numeric(Withdrawals_MGD), na.rm = T),
              nFacilities=n_distinct(as.character(VWUDS.Facility.ID)))%>%
    plot_ly(x = ~Date)%>%
    add_trace(y = ~Withdrawals, name="Withdrawal",type = 'scatter', mode = 'lines', line=list(color='#de2d26'),opacity=0.33)%>%
    add_trace(x=Full_Matched_Monthly_Discharge$Date, y=Full_Matched_Monthly_Discharge$Discharges, name="Discharge", type="scatter", mode="lines", mode='lines',line=list(color='#2171b5'),opacity=0.33)%>%
    add_trace(x=Full_Matched_CU$Date,y=Full_Matched_CU$CU, name="Consumption",yaxis='y2', type="scatter",mode='lines', line=list(color='black',dash="dot",width=3))%>%
    
    layout(title = paste0('<b>',FacilityName,'</b>'),
           xaxis = list(title = "Date", titlefont=list(size=15),tickfont=list(color="black",size=12)),
           yaxis = list(title="Quantity (MGD)", titlefont=list(size=15),tickfont=list(color="black",size=12),
                        range=c(0,ifelse(max(Full_Matched_Monthly_Withdrawal$Withdrawals)>max(Full_Matched_Monthly_Discharge$Discharges),round(max(Full_Matched_Monthly_Withdrawal$Withdrawals),digits=2),round(max(Full_Matched_Monthly_Discharge$Discharges),digits=2)))),
           yaxis2=list(tickfont=list(color="black",size=12), titlefont=list(size=15),
                       range=c(ifelse(min(Full_Matched_CU$CU)<0,min(Full_Matched_CU$CU),0),1),
                       overlaying="y",
                       side="right",
                       title="Consumption"),
                       margin=list(r=125),legend=list(orientation='h',xanchor="center",x=0.50,yanchor="top", y=-0.15))
  
  assign("full_match_2010_2017_summary",full_match_2010_2017_summary,envir=.GlobalEnv)
  plot2
}

# This for loop goes through each facility to speed up getting results. Major water users are at top of list
plot_list=list()

for (i in 1:length(full_match_2010_2017_summary$VPDES.Facility.ID)){
  print(paste("Matched Facility ",i," of ", length(full_match_2010_2017_summary$VPDES.Facility.ID)))
  p= Full.Match.case.study(full_match_2010_2017_summary$VPDES.Facility.ID[i],
                           full_match_2010_2017_summary$VWUDS.Facility.ID[i],
                           full_match_2010_2017_summary$VPDES.Name[i])
  
  plot_list[[i]] = p
  
}
for (i in 1:length(full_match_2010_2017_summary$VPDES.Facility.ID)){
  print(paste("Matched Facility ",i," of ", length(full_match_2010_2017_summary$VPDES.Facility.ID)))
  path="G:/My Drive/USGS_ConsumptiveUse/Spring, 2019/Facility Level/Case Studies/"
  file_name<-paste(path,full_match_2010_2017_summary$VPDES.Name[i], ".pdf", sep="")
  plotly_IMAGE(x=plot_list[[i]],width=1000,height=700,format="pdf",out_file=file_name)
}






case.studies.thesis<- function(VPDESID,VWUDSID,FacilityName,overlay_y){
  full_match_2010_2017_summary<-full_match_2010_2017_summary%>%arrange(desc(Ave_Withdrawal_mgd))
  full_match_2010_2017_summary<-mutate_if(full_match_2010_2017_summary,is.factor,as.character)
  
  full_match_2010_2017_summary$VPDES.Name<-tolower(full_match_2010_2017_summary$VPDES.Name)
  full_match_2010_2017_summary$VPDES.Name<-tools::toTitleCase(as.character(full_match_2010_2017_summary$VPDES.Name))
  
  Full_Matched_Monthly_Discharge<-
    subset(full_match_2010_2017,full_match_2010_2017$VPDES.Facility.ID==VPDESID)%>%
    group_by(Date)%>%
    summarise(Discharges=sum(as.numeric(Discharges_MGD),na.rm=T),
              # OutfallID=first(OutfallID),
              nFacilities=n_distinct(as.character(VPDES.Facility.ID)))
  
  Full_Matched_Monthly_Withdrawal<-
    subset(full_match_2010_2017,full_match_2010_2017$VWUDS.Facility.ID==VWUDSID)%>%
    dplyr::group_by(Date)%>%
    dplyr::summarise(Withdrawals=sum(Withdrawals_MGD,na.rm=T),
                     nFacilities=n_distinct(as.character(VWUDS.Facility.ID)))
  
  Full_Matched_CU<-data.frame(Date=Full_Matched_Monthly_Withdrawal$Date,
                              CU=(Full_Matched_Monthly_Withdrawal$Withdrawals-Full_Matched_Monthly_Discharge$Discharges)/
                                Full_Matched_Monthly_Withdrawal$Withdrawals,stringsAsFactors = F)
  
  Yearly_CU<-Full_Matched_CU%>%dplyr::group_by(Year=substr(Date,1,4))%>%dplyr::summarise(Ave_CU=mean(CU,na.rm=T),Median_CU=median(CU,na.rm=T))
  
  
  plot2<-subset(full_match_2010_2017,full_match_2010_2017$VWUDS.Facility.ID==VWUDSID)%>%
    group_by(Date)%>%
    summarise(Withdrawals=sum(as.numeric(Withdrawals_MGD), na.rm = T),
              nFacilities=n_distinct(as.character(VWUDS.Facility.ID)))%>%
    plot_ly(x = ~Date)%>%
    add_trace(y = ~Withdrawals, name="Withdrawal",type = 'scatter', mode = 'lines', line=list(color='#de2d26'),opacity=0.33)%>%
    add_trace(x=Full_Matched_Monthly_Discharge$Date, y=Full_Matched_Monthly_Discharge$Discharges, name="Discharge", type="scatter", mode="lines", mode='lines',line=list(color='#2171b5'),opacity=0.33)%>%
    add_trace(x=Full_Matched_CU$Date,y=Full_Matched_CU$CU, name="Consumption",yaxis='y2', type="scatter",mode='lines', line=list(color='black',dash="dot",width=3))%>%
    
    layout(# title = paste0('<b>',FacilityName,'</b>'),
      xaxis = list(title = "Date", titlefont=list(size=15),tickfont=list(color="black",size=12)),
      yaxis = list(title="Quantity (MGD)", titlefont=list(size=15),tickfont=list(color="black",size=12),
                   range=c(0,ifelse(max(Full_Matched_Monthly_Withdrawal$Withdrawals)>max(Full_Matched_Monthly_Discharge$Discharges),round(max(Full_Matched_Monthly_Withdrawal$Withdrawals),digits=2),round(max(Full_Matched_Monthly_Discharge$Discharges),digits=2)))),
      yaxis2=list(tickfont=list(color="black",size=12), titlefont=list(size=15),
                  range=c(ifelse(min(Full_Matched_CU$CU)<0,min(Full_Matched_CU$CU),0),1),
                  overlaying=overlay_y,
                  side="right",
                  title="Consumption"),
      margin=list(r=125),legend=list(orientation='h',xanchor="center",x=0.50,yanchor="top", y=-0.15))
  
  assign("full_match_2010_2017_summary",full_match_2010_2017_summary,envir=.GlobalEnv)
  plot2
}
case.studies.compile<- function(){
  
  
  subplot<-plotly::subplot(case.studies.thesis("VA0052451","72023","North Anna Nuclear Power Station","y"),
                  style(case.studies.thesis("VA0005291","72489","Advansix Resins & Chemicals LLC","y3"),showlegend=F),
                  style(case.studies.thesis("VA0028363","72561","Marine Corps Base Quantico Mainside STP","y5"),showlegend=F),
                  style(case.studies.thesis("VA0054381","71957","Marion Fish Hatchery","y7"),showlegend=F),
                  style(case.studies.thesis("VA0060844","73110","New River WTP","y9"),showlegend=F), # need to go back up to begining of script and include municipal facilities
                  shareX = T,nrows=3,titleX= T, titleY=T,margin=0.07)%>%
    layout(annotations = list(
      list(x = 0.225 , y = 1.0, 
           text = "<b>(a) Energy: North Anna Nuclear Power Station</b>",
           size=16,
           showarrow = F, 
           xref='paper', yref='paper', xanchor='center',yanchor='bottom'),
      list(x = 0.775 , y = 1.0, 
           text = "<b>(b) Industrial: Advansix Resins & Chemicals LLC</b>", 
           size=16,
           showarrow = F, xref='paper', yref='paper',xanchor='center',yanchor='bottom'),
      list(x = 0.225 , y = 0.60, 
           text = "<b>(c) Commercial: Marine Corps Base Quantico Mainside STP</b>",
           showarrow = F, 
           xref='paper', yref='paper', xanchor='center',yanchor='bottom'),
      list(x = 0.775 , y = 0.60, 
           text = "<b>(d) Aquaculture: Marion Fish Hatchery</b>",
           showarrow = F, 
           xref='paper', yref='paper', xanchor='center',yanchor='bottom'),
      list(x = 0.225 , y = 0.25, 
           text = "<b>(e) Municipal: New River WTP</b>",
           showarrow = F, 
           xref='paper', yref='paper', xanchor='center',yanchor='bottom')))
  
  path="G:/My Drive/USGS_ConsumptiveUse/Spring, 2019/Facility Level/"
  file_name <- paste(path,"Facility_Case_studies",".pdf", sep="")
  plotly_IMAGE(x=subplot,width=1000,height=1000,format="pdf",out_file=file_name)

}
case.studies.compile()

#----------------------------------------------------------------------------------------------------------------------------------------------#
#-----------------------------------------------------Top Systems------------------------------------------------------------------------------#

top.systems<- function(Match_Dis,Match_With,sector,range){
  
  Matched_top<-subset(Matched,Matched$Sector==sector,select=c("MatchID","VPDES.Hydrocode","VWUDS.HydroID","VPDES.Name",
                                                          "VWUDS.Name","Sector","VPDES...total","VWUDS...total"))
  Matched_top<-head(Matched_top,n=5)
  
  Match_Dis<-Match_Dis[Match_Dis$Use.Type==sector,]
  Match_Dis<-Match_Dis[Match_Dis$VPDES.Facility.ID %in% gsub("echo_","",Matched_top$VPDES.Hydrocode),]
  Match_Dis$MatchID<-Matched_top$MatchID[match(Match_Dis$VPDES.Facility.ID,gsub("echo_","",Matched_top$VPDES.Hydrocode))]
  Match_Dis$VPDES_perc<-Matched_top$VPDES...total[match(Match_Dis$VPDES.Facility.ID,gsub("echo_","",Matched_top$VPDES.Hydrocode))]
  
  Match_With<-Match_With[Match_With$Use.Type==sector,]
  Match_With<-Match_With[Match_With$VWUDS.Facility.ID %in% Matched_top$VWUDS.HydroID,]
  Match_With$MatchID<-Matched_top$MatchID[match(Match_With$VWUDS.Facility.ID,Matched_top$VWUDS.HydroID)]
  Match_With$VWUDS_perc<-Matched_top$VWUDS...total[match(Match_With$VWUDS.Facility.ID,Matched_top$VWUDS.HydroID)]
  
  CU_top.systems<-merge(Match_With,Match_Dis,by=c("MatchID","Year","Use.Type"),all.x=T)
  
  CU_Function<-function(x,y) (ifelse(is.na(x),0,x)-ifelse(is.na(y),0,y))/(ifelse(is.na(x),0,x))
  CU_MGD_Function<-function(x,y) (x-y)
  
  CU_top.systems$CU_MGD<-mapply(CU_MGD_Function, CU_top.systems[,"Withdrawals_MGD"],CU_top.systems[,"Discharges_MGD"])
  CU_top.systems$CU_perc<-mapply(CU_Function, CU_top.systems[,"Withdrawals_MGD"],CU_top.systems[,"Discharges_MGD"])
  
  CU_MGD<-CU_top.systems%>%dplyr::group_by(Facility_Name.x,Year)%>%
    dplyr::summarise(VPDES.Facility.ID=first(VPDES.Facility.ID),VWUDS.Facility.ID=first(VWUDS.Facility.ID), 
                     VWUDS_perc=first(VWUDS_perc), VPDES_perc=first(VPDES_perc), CU_MGD=first(CU_MGD))%>%tidyr::spread(Year,CU_MGD)
  
  CU_MGD$Ave_CU_MGD<-apply(CU_MGD[,6:range],1,median,na.rm=T)
  
  CU_perc<-CU_top.systems%>%dplyr::group_by(Facility_Name.x,Year)%>%
    dplyr::summarise(VPDES.Facility.ID=first(VPDES.Facility.ID),VWUDS.Facility.ID=first(VWUDS.Facility.ID), 
                     VWUDS_perc=first(VWUDS_perc), VPDES_perc=first(VPDES_perc), CU_perc=first(CU_perc))%>%tidyr::spread(Year,CU_perc)%>%arrange(desc(VWUDS_perc))
  
  CU_perc$Ave_CU_perc<-apply(CU_perc[,6:range],1,median,na.rm=T)
  CU_perc$Ave_CU_MGD<-CU_MGD$Ave_CU_MGD[match(CU_perc$VPDES.Facility.ID,CU_MGD$VPDES.Facility.ID)]
  
  # CU_perc$Fuel_Type<-full_match_2010_2017_summary$Fuel_Type[match(CU_perc$VPDES.Facility.ID,full_match_2010_2017_summary$VPDES.Facility.ID)]
  
  CU_summary_table<-CU_perc[,-c(2:3)]
  
  write.csv(CU_summary_table,file=paste0("G:/My Drive/USGS_ConsumptiveUse/Spring, 2019/Top Systems/",sector,".csv"))

  return(list(CU_summary_table))
  
}
top.systems(Matched_Facility_Discharges,Matched_Facility_Withdrawals,"Energy",12)
top.systems(Matched_Facility_Discharges,Matched_Facility_Withdrawals,"Industrial",12)
top.systems(Matched_Facility_Discharges,Matched_Facility_Withdrawals,"Aquaculture",7)
top.systems(Matched_Facility_Discharges,Matched_Facility_Withdrawals,"Commercial",7)
  
#----------------------------------------------------------------------------------------------------------------------------------------------#
#-----------------------------------------------------Use by Sector----------------------------------------------------------------------------#

# Looks at distribution of withdrawals and discharges before classification

BC_Use.by.Sector<- function(rotate1, rotate2, rotate3,label){
  
  ECHO_2010_2017<-read.table("G:/My Drive/ECHO NPDES/USGS_Consumptive_Use_Updated/ECHO_2010_2017_QAQC.txt", sep="\t", header=T)
  load("G:/My Drive/ECHO NPDES/USGS_Consumptive_Use_Updated/Code/R Workspaces/VWUDS_2010_2017.RData")
  
  #----Discharges----#
  EnergyvsNon_Dis<-ECHO_2010_2017%>%
    dplyr::group_by(Facility.ID,Year)%>%
    dplyr::summarise(Discharges_MGD=sum(Resolved_Measured_Effluent_Med, na.rm=T)/first(Mon_Reported),Use.Type=first(Use_Type))%>%
    dplyr::group_by(Year,Use.Type)%>%
    dplyr::summarise(Discharges_MGD=sum(Discharges_MGD,na.rm=T))
  
  EnergyvsNon_Dis$Use.Type<-ifelse(EnergyvsNon_Dis$Use.Type=="Commercial"|
                                     is.na(EnergyvsNon_Dis$Use.Type)|
                                     EnergyvsNon_Dis$Use.Type=="Industrial"|
                                     EnergyvsNon_Dis$Use.Type=="Municipal"|
                                     EnergyvsNon_Dis$Use.Type=="Agriculture/Irrigation"|
                                     EnergyvsNon_Dis$Use.Type=="Aquaculture"
                                     ,"Non-Energy","Energy")
  EnergyvsNon_Dis<-EnergyvsNon_Dis%>%dplyr::group_by(Year,Use.Type)%>%dplyr::summarise(Discharges_MGD=sum(Discharges_MGD,na.rm=T))
  EnergyvsNon_Dis<-EnergyvsNon_Dis%>%
    dplyr::group_by(Use.Type)%>%
    dplyr::summarise(Discharges_MGD=mean(Discharges_MGD,na.rm=T))%>%arrange(desc(Discharges_MGD))
  
  NonEnergy_Dis<-ECHO_2010_2017%>%
    dplyr::group_by(Facility.ID,Year)%>%
    dplyr::summarise(Discharges_MGD=sum(Resolved_Measured_Effluent_Med, na.rm=T)/first(Mon_Reported),Use.Type=first(Use_Type))%>%
    dplyr::group_by(Year,Use.Type)%>%
    dplyr::summarise(Discharges_MGD=sum(Discharges_MGD,na.rm=T))
  
  NonEnergy_Dis<-NonEnergy_Dis%>%
    dplyr::group_by(Use.Type)%>%
    dplyr::summarise(Discharges_MGD=mean(Discharges_MGD,na.rm=T))%>%arrange(desc(Discharges_MGD))
  NonEnergy_Dis<-mutate_if(NonEnergy_Dis,is.factor,as.character)
  
  #----Withdrawals----#
  EnergyvsNon_With<-VWUDS_2010_2017%>%
    dplyr::group_by(Facility.ID,Year)%>%
    dplyr::summarise(Withdrawals_MGD=sum(Withdrawals_MGD, na.rm=T)/first(Mon_Reported),Use.Type=first(Use.Type))%>%
    dplyr::group_by(Year,Use.Type)%>%
    dplyr::summarise(Withdrawals_MGD=sum(Withdrawals_MGD,na.rm=T))
  
  EnergyvsNon_With$Use.Type<-ifelse(EnergyvsNon_With$Use.Type=="commercial"|
                                      EnergyvsNon_With$Use.Type=="facility"|
                                      EnergyvsNon_With$Use.Type=="industrial"|
                                      EnergyvsNon_With$Use.Type=="manufacturing"|
                                      EnergyvsNon_With$Use.Type=="mining"|
                                      EnergyvsNon_With$Use.Type=="Municipal"|
                                      EnergyvsNon_With$Use.Type=="municipal"|
                                      EnergyvsNon_With$Use.Type=="non-municipal"|
                                      EnergyvsNon_With$Use.Type=="Agriculture"|
                                      EnergyvsNon_With$Use.Type=="agriculture"|
                                      EnergyvsNon_With$Use.Type=="irrigation"|
                                      EnergyvsNon_With$Use.Type=="other"|
                                      EnergyvsNon_With$Use.Type=="unknown"
                                      ,"Non-Energy","Energy")
  EnergyvsNon_With<-EnergyvsNon_With%>%dplyr::group_by(Year,Use.Type)%>%dplyr::summarise(Withdrawals_MGD=sum(Withdrawals_MGD,na.rm=T))
  EnergyvsNon_With<-EnergyvsNon_With%>%
    dplyr::group_by(Use.Type)%>%
    dplyr::summarise(Withdrawals_MGD=mean(Withdrawals_MGD,na.rm=T))%>%arrange(desc(Withdrawals_MGD))
  
  NonEnergy_With<-VWUDS_2010_2017%>%
    dplyr::group_by(Facility.ID,Year)%>%
    dplyr::summarise(Withdrawals_MGD=sum(Withdrawals_MGD, na.rm=T)/first(Mon_Reported),Use.Type=first(Use.Type))%>%
    dplyr::group_by(Year,Use.Type)%>%
    dplyr::summarise(Withdrawals_MGD=sum(Withdrawals_MGD,na.rm=T))
  
  NonEnergy_With<-subset(NonEnergy_With,NonEnergy_With$Use.Type=="commercial"|
                           NonEnergy_With$Use.Type=="facility"|
                           NonEnergy_With$Use.Type=="industrial"|
                           NonEnergy_With$Use.Type=="manufacturing"|
                           NonEnergy_With$Use.Type=="mining"|
                           NonEnergy_With$Use.Type=="Municipal"|
                           NonEnergy_With$Use.Type=="municipal"|
                           NonEnergy_With$Use.Type=="non-municipal"|
                           NonEnergy_With$Use.Type=="Agriculture"|
                           NonEnergy_With$Use.Type=="agriculture"|
                           NonEnergy_With$Use.Type=="irrigation"|
                           NonEnergy_With$Use.Type=="other"|
                           NonEnergy_With$Use.Type=="unknown")
  
  NonEnergy_With<-NonEnergy_With%>%
    dplyr::group_by(Use.Type)%>%
    dplyr::summarise(Withdrawals_MGD=mean(Withdrawals_MGD,na.rm=T))%>%arrange(desc(Withdrawals_MGD))
  NonEnergy_With<-mutate_if(NonEnergy_With,is.factor,as.character)
  
 
  
  non_dis<-list(
    x=0.50,
    y=0.95,
    text=paste0('<b>',"Discharge",'<b>'),
    showarrow=FALSE,
    font = list(color = '#252525', size = 17),
    ax=0,
    ay=0
  )
  
  energy_label<-list(
    x=0.15,
    y=1.0,
    text=paste0("All Sectors"),
    showarrow=FALSE,
    font = list(color = '#252525', size = 15),
    ax=0,
    ay=0
  )
  
  nonenergy_label<-list(
    x=0.9,
    y=1.0,
    text=paste0("Non-Energy Sectors"),
    showarrow=FALSE,
    font = list(color = '#252525', size = 15),
    ax=0,
    ay=0
  )
  
  non_with<-list(
    x=0.5,
    y=0.45,
    text=paste0('<b>',"Withdrawal",'<b>'),
    showarrow=FALSE,
    font = list(color = '#252525', size = 17),
    ax=0,
    ay=0
  )
  
  energy_lab<-list(
    x=0.15,
    y=0.5,
    text=paste0("All Sectors"),
    showarrow=FALSE,
    font = list(color = '#252525', size = 15),
    ax=0,
    ay=0
  )
  
  nonenergy_lab<-list(
    x=0.9,
    y=0.5,
    text=paste0("Non-Energy Sectors"),
    showarrow=FALSE,
    font = list(color = '#252525', size = 15),
    ax=0,
    ay=0
  )
  
  
  # with_colors<-colorspace::heat_hcl(12,c=c(80,30),l=c(30,90),power=c(1/5,1.5))
  with_colors<-brewer.pal(9,"Reds")
  with_colors<-colorRampPalette(with_colors)(30)
  with_colors<-rev(with_colors)
  with_colors<-with_colors[seq(1,length(with_colors),4)]
  withcolors2<-with_colors[2:12]

  dis_colors<-brewer.pal(9,"Blues")
  dis_colors<-colorRampPalette(dis_colors)(30)
  dis_colors<-rev(dis_colors)
  dis_colors<-dis_colors[seq(1,length(dis_colors),6)]
  discolors2<-dis_colors[2:11]
  
  m<-list(l=50,r=200,b=50,t=50)
  

  
  plot1<-plot_ly()%>%
    add_pie(data=EnergyvsNon_With,labels=~Use.Type, values=~Withdrawals_MGD, name="Energy vs. Non-Energy",
            domain=list(x=c(0,0.5),y=c(0,0.5)),
            textposition = 'auto',
            text= ~paste0('<b>',Use.Type,'</b>',"\n", '<b>', "~", round((Withdrawals_MGD/sum(Withdrawals_MGD))*100, 0), "%",'</b>'),
            textinfo='text',
            insidetextfont = list(color = '#FFFFFF', size=14),
            outsidetextfont = list(color='#252525',size=14),
            rotation = rotate1,
            marker = list(colors=with_colors,line=list(color = '#FFFFFF', width =3)))%>%
    add_pie(data=NonEnergy_With, labels=~Use.Type, values=~Withdrawals_MGD, name="Non-Energy Sectors",
            domain=list(x=c(0.5,1.0),y=c(0.0,0.5)),
            textposition = 'auto',
            text= ~paste0('<b>',Use.Type,'</b>',"\n", '<b>',"~",round((Withdrawals_MGD/sum(Withdrawals_MGD))*100, 0), "%",'</b>'),
            textinfo='text',
            insidetextfont = list(color = '#FFFFFF', size=14),
            outsidetextfont = list(color='#252525',size=14),
            rotation = rotate2,
            marker = list(colors=withcolors2,line=list(color = '#FFFFFF', width =3)))%>%
    add_pie(data=EnergyvsNon_Dis,labels=~Use.Type, values=~Discharges_MGD, name="Energy vs. Non-Energy",
            domain=list(x=c(0,0.5),y=c(0.5,1)),
            textposition = 'auto',
            text= ~paste0('<b>',Use.Type,'</b>',"\n", '<b>',"~", round((Discharges_MGD/sum(Discharges_MGD))*100, 0), "%",'</b>'),
            textinfo='text',
            insidetextfont = list(color = '#FFFFFF', size=14),
            outsidetextfont = list(color='#252525',size=14),
            rotation = rotate1,
            marker = list(colors=dis_colors[2],line=list(color = '#FFFFFF', width =3)))%>%
    add_pie(data=NonEnergy_Dis, labels=~Use.Type, values=~Discharges_MGD, name="Non-Energy Sectors",
            domain=list(x=c(0.5,1.0),y=c(0.5,1)),
            textposition = 'auto',
            text= ~paste0('<b>',Use.Type,'</b>',"\n", '<b>',"~", round((Discharges_MGD/sum(Discharges_MGD))*100, 0), "%",'</b>'),
            textinfo='text',
            insidetextfont = list(color = '#FFFFFF', size=14),
            outsidetextfont = list(color='#252525',size=14),
            rotation = rotate3,
            marker = list(colors=discolors2,line=list(color = '#FFFFFF', width =3)))%>%
    
    layout(showlegend=FALSE,
           xaxis = list(showgrid=F, zeroline=F, showticklabels=F),
           yaxis = list(showgrid=F, zeroline=F, showticklabels=F),
           autosize=T,margin=m)%>%
    layout(annotations=non_with)%>%
    layout(annotations=non_dis)%>%
    layout(annotations=energy_label)%>%
    layout(annotations=nonenergy_label)%>%
  layout(annotations=energy_lab)%>%
    layout(annotations=nonenergy_lab)
  
  
  path="G:/My Drive/USGS_ConsumptiveUse/Spring, 2019/Statewide Analysis/Pie Chart Sector/"
  file_name <- paste(path,"Use_Type_Pie_",label, ".pdf", sep="")
  plotly_IMAGE(x=plot1,width=800,height=800,format="pdf",out_file=file_name)
  
  return(list(plot1))
}
BC_Use.by.Sector(120,200,120,"Before_Classification")

# This function returns pie charts of withdrawals,discharges,and consumption per sector

Use.by.Sector<- function(Withdrawal,Discharge, rotate1, rotate2, rotate3,rotate4,label){
  
  #----Discharges----#
  Discharge<-Discharge[!is.na(Discharge$Use.Type),]
  EnergyvsNon_Dis<-Discharge%>%
    dplyr::group_by(VPDES.Facility.ID,Year)%>%
    dplyr::summarise(Discharges_MGD=sum(Discharges_MGD, na.rm=T),Use.Type=first(Use.Type))%>%
    dplyr::group_by(Year,Use.Type)%>%
    dplyr::summarise(Discharges_MGD=sum(Discharges_MGD,na.rm=T))
  
  EnergyvsNon_Dis$Use.Type<-ifelse(EnergyvsNon_Dis$Use.Type=="Commercial"|
                                     EnergyvsNon_Dis$Use.Type=="Industrial"|
                                     EnergyvsNon_Dis$Use.Type=="Municipal"|
                                     EnergyvsNon_Dis$Use.Type=="Agriculture/Irrigation"|
                                     EnergyvsNon_Dis$Use.Type=="Aquaculture","Non-Energy","Energy")
  
  EnergyvsNon_Dis<-EnergyvsNon_Dis%>%dplyr::group_by(Year,Use.Type)%>%
    dplyr::summarise(Discharges_MGD=sum(Discharges_MGD,na.rm=T))
  EnergyvsNon_Dis<-EnergyvsNon_Dis%>%
    dplyr::group_by(Use.Type)%>%
    dplyr::summarise(Discharges_MGD=mean(Discharges_MGD,na.rm=T))%>%
    arrange(desc(Discharges_MGD))
  
  NonEnergy_Dis<-Discharge%>%
    dplyr::group_by(VPDES.Facility.ID,Year)%>%
    dplyr::summarise(Discharges_MGD=sum(Discharges_MGD, na.rm=T),Use.Type=first(Use.Type))%>%
    dplyr::group_by(Year,Use.Type)%>%
    dplyr::summarise(Discharges_MGD=sum(Discharges_MGD,na.rm=T))
  
  NonEnergy_Dis<-subset(NonEnergy_Dis,NonEnergy_Dis$Use.Type!="Energy")
  NonEnergy_Dis<-NonEnergy_Dis%>%
    dplyr::group_by(Use.Type)%>%
    dplyr::summarise(Discharges_MGD=mean(Discharges_MGD,na.rm=T))%>%arrange(desc(Discharges_MGD))
  NonEnergy_Dis<-mutate_if(NonEnergy_Dis,is.factor,as.character)
  
  #----Withdrawals----#
  EnergyvsNon_With<-Withdrawal%>%
    dplyr::group_by(VWUDS.Facility.ID,Year)%>%
    dplyr::summarise(Withdrawals_MGD=sum(Withdrawals_MGD, na.rm=T),Use.Type=first(Use.Type))%>%
    dplyr::group_by(Year,Use.Type)%>%
    dplyr::summarise(Withdrawals_MGD=sum(Withdrawals_MGD,na.rm=T))
  
  EnergyvsNon_With$Use.Type<-ifelse(EnergyvsNon_With$Use.Type=="Commercial"|
                                      EnergyvsNon_With$Use.Type=="Industrial"|
                                      EnergyvsNon_With$Use.Type=="Municipal"|
                                      EnergyvsNon_With$Use.Type=="Agriculture/Irrigation"|
                                      EnergyvsNon_With$Use.Type=="Aquaculture","Non-Energy","Energy")
  EnergyvsNon_With<-EnergyvsNon_With%>%dplyr::group_by(Year,Use.Type)%>%
    dplyr::summarise(Withdrawals_MGD=sum(Withdrawals_MGD,na.rm=T))
  EnergyvsNon_With<-EnergyvsNon_With%>%
    dplyr::group_by(Use.Type)%>%
    dplyr::summarise(Withdrawals_MGD=mean(Withdrawals_MGD,na.rm=T))%>%arrange(desc(Withdrawals_MGD))
  
  NonEnergy_With<-Withdrawal%>%
    dplyr::group_by(VWUDS.Facility.ID,Year)%>%
    dplyr::summarise(Withdrawals_MGD=sum(Withdrawals_MGD, na.rm=T),Use.Type=first(Use.Type))%>%
    dplyr::group_by(Year,Use.Type)%>%
    dplyr::summarise(Withdrawals_MGD=sum(Withdrawals_MGD,na.rm=T))
  
  NonEnergy_With<-subset(NonEnergy_With,NonEnergy_With$Use.Type!="Energy")
  NonEnergy_With<-NonEnergy_With%>%
    dplyr::group_by(Use.Type)%>%
    dplyr::summarise(Withdrawals_MGD=mean(Withdrawals_MGD,na.rm=T))%>%arrange(desc(Withdrawals_MGD))
  NonEnergy_With<-mutate_if(NonEnergy_With,is.factor,as.character)
  
  # with_colors<-colorspace::heat_hcl(12,c=c(80,30),l=c(30,90),power=c(1/5,1.5))
  with_colors<-brewer.pal(9,"Reds")
  with_colors<-colorRampPalette(with_colors)(30)
  with_colors<-rev(with_colors)
  with_colors<-with_colors[seq(1,length(with_colors),4)]
  withcolors2<-with_colors[2:12]
  
  dis_colors<-brewer.pal(9,"Blues")
  dis_colors<-colorRampPalette(dis_colors)(30)
  dis_colors<-rev(dis_colors)
  dis_colors<-dis_colors[seq(1,length(dis_colors),6)]
  discolors2<-dis_colors[2:11]
  
  m<-list(l=50,r=200,b=50,t=50)

  
  non_dis<-list(
    x=0.50,
    y=0.95,
    text=paste0('<b>',"Discharge",'<b>'),
    showarrow=FALSE,
    font = list(color = '#252525', size = 17),
    ax=0,
    ay=0
  )
  
  energy_label<-list(
    x=0.15,
    y=1.0,
    text=paste0("All Sectors"),
    showarrow=FALSE,
    font = list(color = '#252525', size = 15),
    ax=0,
    ay=0
  )
  
  nonenergy_label<-list(
    x=0.90,
    y=1.0,
    text=paste0("Non-Energy Sectors"),
    showarrow=FALSE,
    font = list(color = '#252525', size = 15),
    ax=0,
    ay=0
  )
  
  non_with<-list(
    x=0.5,
    y=0.45,
    text=paste0('<b>',"Withdrawal",'<b>'),
    showarrow=FALSE,
    font = list(color = '#252525', size = 17),
    ax=0,
    ay=0
  )
  
  energy_lab<-list(
    x=0.2,
    y=0.5,
    text=paste0("All Sectors"),
    showarrow=FALSE,
    font = list(color = '#252525', size = 15),
    ax=0,
    ay=0
  )
  
  nonenergy_lab<-list(
    x=0.85,
    y=0.5,
    text=paste0("Non-Energy Sectors"),
    showarrow=FALSE,
    font = list(color = '#252525', size = 15),
    ax=0,
    ay=0
  )
  
  plot1<-plot_ly()%>%
    add_pie(data=EnergyvsNon_With,labels=~Use.Type, values=~Withdrawals_MGD, name="Energy vs. Non-Energy",
            domain=list(x=c(0,0.5),y=c(0,0.5)),
            textposition = 'auto',
            text= ~paste0('<b>',Use.Type,'</b>',"\n", '<b>', "~", round((Withdrawals_MGD/sum(Withdrawals_MGD))*100, 0), "%",'</b>'),
            textinfo='text',
            insidetextfont = list(color = '#FFFFFF', size=14),
            outsidetextfont = list(color='#252525',size=14),
            rotation = rotate1,
            marker = list(colors=with_colors,line=list(color = '#FFFFFF', width =3)))%>%
    add_pie(data=NonEnergy_With, labels=~Use.Type, values=~Withdrawals_MGD, name="Non-Energy Sectors",
            domain=list(x=c(0.5,1.0),y=c(0.0,0.5)),
            textposition = 'auto',
            text= ~paste0('<b>',Use.Type,'</b>',"\n", '<b>',"~",round((Withdrawals_MGD/sum(Withdrawals_MGD))*100, 0), "%",'</b>'),
            textinfo='text',
            insidetextfont = list(color = '#FFFFFF', size=14),
            outsidetextfont = list(color='#252525',size=14),
            rotation = rotate2,
            marker = list(colors=withcolors2,line=list(color = '#FFFFFF', width =3)))%>%
    add_pie(data=EnergyvsNon_Dis,labels=~Use.Type, values=~Discharges_MGD, name="Energy vs. Non-Energy",
            domain=list(x=c(0,0.5),y=c(0.5,1)),
            textposition = 'auto',
            text= ~paste0('<b>',Use.Type,'</b>',"\n", '<b>',"~", round((Discharges_MGD/sum(Discharges_MGD))*100, 0), "%",'</b>'),
            textinfo='text',
            insidetextfont = list(color = '#FFFFFF', size=14),
            outsidetextfont = list(color='#252525',size=14),
            rotation = rotate1,
            marker = list(colors=dis_colors,line=list(color = '#FFFFFF', width =3)))%>%
    add_pie(data=NonEnergy_Dis, labels=~Use.Type, values=~Discharges_MGD, name="Non-Energy Sectors",
            domain=list(x=c(0.5,1.0),y=c(0.5,1)),
            textposition = 'auto',
            text= ~paste0('<b>',Use.Type,'</b>',"\n", '<b>',"~", round((Discharges_MGD/sum(Discharges_MGD))*100, 0), "%",'</b>'),
            textinfo='text',
            insidetextfont = list(color = '#FFFFFF', size=14),
            outsidetextfont = list(color='#252525',size=14),
            rotation = rotate2,
            marker = list(colors=discolors2,line=list(color = '#FFFFFF', width =3)))%>%
    
    layout(showlegend=FALSE,
           xaxis = list(showgrid=F, zeroline=F, showticklabels=F),
           yaxis = list(showgrid=F, zeroline=F, showticklabels=F),
           autosize=T,margin=m)%>%
  layout(annotations=non_with)%>%
    layout(annotations=non_dis)%>%
    layout(annotations=energy_label)%>%
    layout(annotations=nonenergy_label)%>%
    layout(annotations=energy_lab)%>%
    layout(annotations=nonenergy_lab)
  
  #-----Consumption------#
  EnergyvsNon_Dis<-EnergyvsNon_Dis[!is.na(EnergyvsNon_Dis$Use.Type),]
   NonEnergy_Dis<-add_row(NonEnergy_Dis,Use.Type="Agriculture/Irrigation",Discharges_MGD=0.0)
  
  CU_EnergyvsNon<-data.frame(Use.Type=EnergyvsNon_Dis$Use.Type,
                             Discharges_MGD=EnergyvsNon_Dis$Discharges_MGD,
                             Withdrawals_MGD=EnergyvsNon_With$Withdrawals_MGD)
  
  CU_EnergyvsNon$CU<-(CU_EnergyvsNon$Withdrawals_MGD-CU_EnergyvsNon$Discharges_MGD)
  
  CU_NonEnergy<-data.frame(Use.Type=NonEnergy_With$Use.Type,Discharges_MGD=NonEnergy_Dis$Discharges_MGD,
                           Withdrawals_MGD=NonEnergy_With$Withdrawals_MGD)
  CU_NonEnergy$CU<-(CU_NonEnergy$Withdrawals_MGD-CU_NonEnergy$Discharges_MGD)
  
  
  l<-list(l=0,r=100,b=0,t=0)
  
  CU_colors<-colorspace::heat_hcl(12,c=c(80,30),l=c(30,90),power=c(1/5,1.5))
  
  CUcolors2<-with_colors[2:12]
  
  consump<-list(
    x=0.50,
    y=0.95,
    text=paste0('<b>',"Average Annual Consumption in MGD",'<b>'),
    showarrow=FALSE,
    font = list(color = '#252525', size = 18),
    ax=0,
    ay=0
  )
  
  energy_label2<-list(
    x=0.15,
    y=0.9,
    text=paste0("All Sectors"),
    showarrow=FALSE,
    font = list(color = '#252525', size = 17),
    ax=0,
    ay=0
  )
  
  nonenergy_label2<-list(
    x=0.9,
    y=0.9,
    text=paste0("Non-Energy Sectors"),
    showarrow=FALSE,
    font = list(color = '#252525', size = 17),
    ax=0,
    ay=0
  )
  
  plot3<-plot_ly()%>%
    add_pie(data=CU_EnergyvsNon,labels=~Use.Type, values=~CU, name="Energy vs. Non-Energy",
            domain=list(x=c(0,0.5),y=c(0.0,1)),
            textposition = 'auto',
            text= ~paste0('<b>',Use.Type,'</b>',"\n", '<b>', "~", round(CU, 0), " MGD",'</b>'),
            textinfo='text',
            insidetextfont = list(color = '#FFFFFF', size=20),
            outsidetextfont = list(color='#252525',size=16),
            rotation = rotate3,
            marker = list(colors=with_colors,line=list(color = '#FFFFFF', width =3)))%>%
    add_pie(data=CU_NonEnergy, labels=~Use.Type, values=~CU, name="Non-Energy Sectors",
            domain=list(x=c(0.5,1.0),y=c(0.0,1)),
            textposition = 'auto',
            text= ~paste0('<b>',Use.Type,'</b>',"\n", '<b>',"~",round(CU, 0), "MGD",'</b>'),
            textinfo='text',
            insidetextfont = list(color = '#FFFFFF', size=20),
            outsidetextfont = list(color='#252525',size=16),
            rotation = rotate4,
            marker = list(colors=withcolors2,line=list(color = '#FFFFFF', width =3)))%>%
    
    
    layout(showlegend=FALSE,
           xaxis = list(showgrid=F, zeroline=F, showticklabels=F),
           yaxis = list(showgrid=F, zeroline=F, showticklabels=F),
           autosize=T,margin=l)%>%
    layout(annotations=consump)%>%
    layout(annotations=energy_label2)%>%
    layout(annotations=nonenergy_label2)
  
  path="G:/My Drive/USGS_ConsumptiveUse/Spring, 2019/Statewide Analysis/Pie Chart Sector/"
  file_name <- paste(path,"Use_Type_Pie_",label, ".pdf", sep="")
  plotly_IMAGE(x=plot1,width=800,height=800,format="pdf",out_file=file_name)
  
  file_name <- paste(path,"CU_Use_Type_Pie_",label, ".pdf", sep="")
  plotly_IMAGE(x=plot3,width=1000,height=766,format="pdf",out_file=file_name)
  
  return(list(plot1,plot3))
  
  
}
Use.by.Sector(Facility_Withdrawals,Facility_Discharges,120,170,180,210,"All_Fac")
Use.by.Sector(Matched_Facility_Withdrawals,Matched_Facility_Discharges,90,90,180,50,"Matched_Fac")

#----------------------------------------------------------------------------------------------------------------------------------------------#
#-------------------------------------------------Use by Energy Type---------------------------------------------------------------------------#

#-----------------------#
#------Withdrawal-------#

fuel.type.withdrawal_subplot<- function(All_Facilities,Full_Match,fueltype,label,roundup,yaxis_2){
  
  Fuel_Types<-read.csv("G:/My Drive/USGS_ConsumptiveUse/Spring, 2019/Energy_Fuel_Types.csv",header=T)
  colnames(Fuel_Types)<-c("VPDES.Facility.ID","VWUDS.Facility.ID","Name","Gen_Cap_MW","Fuel_Type")
  Fuel_Types<-mutate_if(Fuel_Types,is.factor,as.character)
  All_Facilities<-mutate_if(All_Facilities,is.factor,as.character)
  Full_Match<-mutate_if(Full_Match,is.factor,as.character)
  
  All_Facilities<-merge(All_Facilities,Fuel_Types,by="VWUDS.Facility.ID")
  
  All_sector<-subset(All_Facilities,All_Facilities$Fuel_Type==fueltype)%>%
    dplyr::group_by(Date)%>%
    dplyr::summarise(Withdrawals=sum(as.numeric(Withdrawals_MGD), na.rm = T),
              nFacilities=n_distinct(as.character(Facility)))
  
  m<-list(l=0,r=50,b=0,t=20)
  plot2<-subset(Full_Match,Full_Match$Fuel_Type==fueltype)%>%
    group_by(Date)%>%
    summarise(Withdrawals=sum(as.numeric(Withdrawals_MGD), na.rm = T),
              nFacilities=n_distinct(as.character(VWUDS.Facility.ID)))%>%
    plot_ly(x = ~Date)%>%
    add_trace(x=All_sector$Date,y=All_sector$Withdrawals, name="Total Withdrawal", type='scatter',mode='lines', line=list(color='#cb181d'))%>%
    add_trace(y = ~Withdrawals, name="Matched Withdrawal",type = 'scatter', mode = 'lines', line=list(color='#67000d',width=4,dash="dot"))%>%
    add_trace(y= ~nFacilities, name="Matched VWUDS Facilities", type='bar', yaxis='y2', opacity=0.60, marker=list(color='black'))%>%
    add_trace(x=All_sector$Date, y= All_sector$nFacilities, name="All VWUDS Facilities", type='bar', yaxis='y2', opacity=0.25,marker=list(color='grey'))%>%
    layout(# title = paste0("Statewide Mean Daily Withdrawals in Virginia (MGD): ",Sector," Sector"),
      yaxis = list(title="Withdrawal (MGD)",
                   tickfont=list(color="black"),
                   range=c(0,roundup+ceiling(max(All_sector$Withdrawals)))), 
      yaxis2 = list(tickfont=list(color="black"),
                    overlaying=yaxis_2,
                    side="right",
                    title="Reporting Facilities"),
      xaxis = list(title = "Date"),
      margin=m,
      legend=list(orientation='h',xanchor="center",yanchor="top",x=0.50, y=-0.15)
    )
  
  assign(paste0(label,"_with_plot"),plot2,envir = .GlobalEnv)
  
}
fuel.type.withdrawal_subplot(VWUDS_2010_2017,full_match_2010_2017,"Nuclear","Nuclear",75,"y")
fuel.type.withdrawal_subplot(VWUDS_2010_2017,full_match_2010_2017,"Coal","Coal",75,"y3")
fuel.type.withdrawal_subplot(VWUDS_2010_2017,full_match_2010_2017,"Combination Fossil","Combo",50,"y5")
fuel.type.withdrawal_subplot(VWUDS_2010_2017,full_match_2010_2017,"Biomass","Biomass",0.005,"y7")


fuel_with_subplot<- function(nuclear,coal,combo,biomass,label,path){
  
  subplot<-plotly::subplot(nuclear,style(coal,showlegend=F), style(combo,showlegend=F),
                           style(biomass,showlegend=F),nrows=2,
                           shareX = T,titleX= T, 
                           titleY=T,margin=0.08)%>%
    layout(annotations = list(
      list(x = 0.225 , y = 1.0, 
           text = "<b>(a) Nuclear</b>",
           showarrow = F, 
           xref='paper', yref='paper', xanchor='center',yanchor='bottom'),
      list(x = 0.775 , y = 1.0, 
           text = "<b>(b) Coal</b>", 
           showarrow = F, xref='paper', yref='paper',xanchor='center',yanchor='bottom'),
      list(x = 0.225 , y = 0.5, 
           text = "<b>(c) Combination Fossil Fuel</b>",
           showarrow = F, 
           xref='paper', yref='paper', xanchor='center',yanchor='top'),
      list(x = 0.775 , y = 0.5, 
           text = "<b>(d) Biomass</b>",
           showarrow = F, 
           xref='paper', yref='paper', xanchor='center',yanchor='top')
    ))
  
  
  file_name <- paste(path,"Matched_vs_Total_Fuel",label,".pdf", sep="")
  plotly_IMAGE(x=subplot,width=1300,height=700,format="pdf",out_file=file_name)
  
  return(list(subplot))
}
fuel_with_subplot(Nuclear_with_plot,Coal_with_plot,Combo_with_plot,Biomass_with_plot,
"withdrawal",path="G:/My Drive/USGS_ConsumptiveUse/Spring, 2019/Statewide Analysis/Withdrawals/")

#-----------------------#
#------Discharge-------#

fuel.type.discharge_subplot<- function(All_Facilities,Full_Match,fueltype,label,roundup,yaxis_2){
  
  Fuel_Types<-read.csv("G:/My Drive/USGS_ConsumptiveUse/Spring, 2019/Energy_Fuel_Types.csv",header=T)
  colnames(Fuel_Types)<-c("VPDES.Facility.ID","VWUDS.Facility.ID","Name","Gen_Cap_MW","Fuel_Type")
  Fuel_Types<-mutate_if(Fuel_Types,is.factor,as.character)
  All_Facilities<-mutate_if(All_Facilities,is.factor,as.character)
  Full_Match<-mutate_if(Full_Match,is.factor,as.character)
  
  
  All_sector<-subset(All_Facilities,All_Facilities$Fuel_Type==fueltype)%>%
    dplyr::group_by(Date)%>%
    dplyr::summarise(Discharges=sum(as.numeric(Discharges_MGD), na.rm = T),
                     nFacilities=n_distinct(as.character(VPDES.Facility.ID)))
  
  plot2<-subset(Full_Match,Full_Match$Fuel_Type==fueltype)%>%
    group_by(Date)%>%
    summarise(Discharges=sum(as.numeric(Discharges_MGD), na.rm = T),
              nFacilities=n_distinct(as.character(VPDES.Facility.ID)))%>%
    plot_ly(x = ~Date)%>%
    add_trace(x=All_sector$Date,y=All_sector$Discharges, name="Total Discharge", type='scatter',
              mode='lines',line=list(color='#2171b5'))%>%
    add_trace(y = ~Discharges, name="Matched Discharge",type = 'scatter', mode = 'lines', 
              line=list(color='#08306b',width=4,dash="dot"))%>%
    add_trace(y= ~nFacilities, name="Matched VPDES Facilities", type='bar', yaxis='y2', opacity=0.60,
              marker=list(color='black'))%>%
    add_trace(x=All_sector$Date, y= All_sector$nFacilities, name="All VPDES Facilities", type='bar', yaxis='y2', opacity=0.25,
              marker=list(color='grey'))%>%
    layout(# title = paste0("Statewide Mean Daily Discharges in Virginia (MGD): ",Sector," Sector"),
      yaxis = list(title="Discharge (MGD)",
                   tickfont=list(color="black"),
                   range=c(0,roundup+max(All_sector$Discharges))), #10500 all sectors
      yaxis2 = list(tickfont=list(color="black"),
                    overlaying=yaxis_2,
                    side="right",
                    title="Reporting Facilities"),
      xaxis = list(title = "Date"),
      margin=list(r=50),
      legend=list(orientation='h',xanchor="center",x=0.5,yanchor="top",y=-0.10))
  
  
  assign(paste0(label,"_dis_plot"),plot2,envir = .GlobalEnv)
  
}
fuel.type.discharge_subplot(ECHO_2010_2017,full_match_2010_2017,"Nuclear","Nuclear",75,"y")
fuel.type.discharge_subplot(ECHO_2010_2017,full_match_2010_2017,"Coal","Coal",75,"y3")
fuel.type.discharge_subplot(ECHO_2010_2017,full_match_2010_2017,"Combination Fossil","Combo",50,"y5")
fuel.type.discharge_subplot(ECHO_2010_2017,full_match_2010_2017,"Biomass","Biomass",0.005,"y7")

fuel_with_subplot(Nuclear_dis_plot,Coal_dis_plot,Combo_dis_plot,Biomass_dis_plot,
                  "discharge",path="G:/My Drive/USGS_ConsumptiveUse/Spring, 2019/Statewide Analysis/Discharges/")


Use.by.Energy.Fuel<- function(Withdrawal,Discharge,ts_dis,ts_with,rotate1,rotate2,rotate3,label){
  
  Fuel_Types<-read.csv("G:/My Drive/USGS_ConsumptiveUse/Spring, 2019/Energy_Fuel_Types.csv",header=T)
  colnames(Fuel_Types)<-c("VPDES.Facility.ID","VWUDS.Facility.ID","Name","Gen_Cap_MW","Fuel_Type")
  
  Discharge<-merge(Discharge,Fuel_Types,by="VPDES.Facility.ID")
  Withdrawal<-merge(Withdrawal,Fuel_Types,by="VWUDS.Facility.ID")
  
  Fueltype_Dis<-Discharge%>%
    dplyr::group_by(VPDES.Facility.ID,Year)%>%
    dplyr::summarise(Discharges_MGD=sum(Discharges_MGD, na.rm=T),
                     Fuel_Type=first(Fuel_Type),Gen_Cap_MW=first(Gen_Cap_MW))%>%
    dplyr::group_by(Year,Fuel_Type)%>%
    dplyr::summarise(Discharges_MGD=sum(Discharges_MGD,na.rm=T),Gen_Cap_MW=mean(Gen_Cap_MW,na.rm=T))
  
  Fueltype_With<-Withdrawal%>%
    dplyr::group_by(VWUDS.Facility.ID,Year)%>%
    dplyr::summarise(Withdrawals_MGD=sum(Withdrawals_MGD, na.rm=T),
                     Fuel_Type=first(Fuel_Type),Gen_Cap_MW=first(Gen_Cap_MW))%>%
    dplyr::group_by(Year,Fuel_Type)%>%
    dplyr::summarise(Withdrawals_MGD=sum(Withdrawals_MGD,na.rm=T),Gen_Cap_MW=mean(Gen_Cap_MW,na.rm=T))
  
  Fueltype_table<-merge(Fueltype_Dis,Fueltype_With,by=c("Year","Fuel_Type","Gen_Cap_MW"))
  Fueltype_table$CU<-Fueltype_table$Withdrawals_MGD-Fueltype_table$Discharges_MGD
  Fueltype_table$CU_perc<-(Fueltype_table$Withdrawals_MGD-Fueltype_table$Discharges_MGD)/Fueltype_table$Withdrawals_MGD


  Fueltype_Dis<-Fueltype_Dis%>%
    dplyr::group_by(Fuel_Type)%>%
    dplyr::summarise(Discharges_MGD=mean(Discharges_MGD,na.rm=T),Gen_Cap_MW=mean(Gen_Cap_MW,na.rm=T))%>%
    arrange(desc(Discharges_MGD))
  
  Fueltype_With<-Fueltype_With%>%
    dplyr::group_by(Fuel_Type)%>%
    dplyr::summarise(Withdrawals_MGD=mean(Withdrawals_MGD,na.rm=T),Gen_Cap_MW=mean(Gen_Cap_MW,na.rm=T))%>%
    arrange(desc(Withdrawals_MGD))
  
  with_colors<-colorspace::heat_hcl(12,c=c(80,30),l=c(30,90),power=c(1/5,1.5))
  
  dis_colors<-colorspace::diverge_hcl(12,h=c(255,330),l=c(40,90))
  
  m<-list(l=0,r=0,b=0,t=0)
  
  dis<-list(
    x=0.15,
    y=0.1,
    text=paste0('<b>',"Discharge",'<b>'),
    showarrow=FALSE,
    font = list(color = '#252525', size = 17),
    ax=0,
    ay=0
  )
  
  with<-list(
    x=0.85,
    y=0.1,
    text=paste0('<b>',"Withdrawal",'<b>'),
    showarrow=FALSE,
    font = list(color = '#252525', size = 17),
    ax=0,
    ay=0
  )
  
  #---Plots of Discharge and Withdrawal---#
  plot1<-plot_ly()%>%
    add_pie(data=Fueltype_Dis,labels=~Fuel_Type, values=~Discharges_MGD,
            domain=list(x=c(0,0.5),y=c(0,1.0)),
            textposition = 'auto',
            text= ~paste0('<b>',Fuel_Type,'</b>',"\n", '<b>', "~", round((Discharges_MGD/sum(Discharges_MGD))*100, 0), "%",'</b>'),
            textinfo='text',
            insidetextfont = list(color = '#FFFFFF', size=14),
            outsidetextfont = list(color='#252525',size=14),
            rotation = rotate1,
            marker = list(colors=dis_colors,line=list(color = '#FFFFFF', width =3)))%>%
    add_pie(data=Fueltype_With, labels=~Fuel_Type, values=~Withdrawals_MGD,
            domain=list(x=c(0.5,1.0),y=c(0.0,1.0)),
            textposition = 'auto',
            text= ~paste0('<b>',Fuel_Type,'</b>',"\n", '<b>',"~",round((Withdrawals_MGD/sum(Withdrawals_MGD))*100, 0), "%",'</b>'),
            textinfo='text',
            insidetextfont = list(color = '#FFFFFF', size=14),
            outsidetextfont = list(color='#252525',size=14),
            rotation = rotate2,
            marker = list(colors=with_colors,line=list(color = '#FFFFFF', width =3)))%>%
    layout(showlegend=FALSE,
           xaxis = list(showgrid=F, zeroline=F, showticklabels=F),
           yaxis = list(showgrid=F, zeroline=F, showticklabels=F),
           autosize=T,margin=m)%>%
  layout(annotations=with)%>%
    layout(annotations=dis)
  
  path="G:/My Drive/USGS_ConsumptiveUse/Spring, 2019/Statewide Analysis/Fuel Type/"
  file_name <- paste(path,"Energy_fuel_dis_with",label, ".pdf", sep="")
  plotly_IMAGE(x=plot1,width=800,height=640,format="pdf",out_file=file_name)
  
  
  #---Consumption---#
  CU_FuelType<-merge(Fueltype_Dis,Fueltype_With,by=c("Fuel_Type","Gen_Cap_MW"))
  
  CU_FuelType$CU<-(CU_FuelType$Withdrawals_MGD-CU_FuelType$Discharges_MGD)
  
  l<-list(l=0,r=0,b=0,t=0)
  
  CU_colors<-colorspace::heat_hcl(12,c=c(80,30),l=c(30,90),power=c(1/5,1.5))
  
 

  plot2<-plot_ly()%>%
    add_pie(data=CU_FuelType,labels=~Fuel_Type, values=~CU, name="Energy vs. Non-Energy",
            domain=list(x=c(0,1.0),y=c(0.0,1)),
            textposition = 'auto',
            text= ~paste0('<b>',Fuel_Type,'</b>',"\n", '<b>', "~", round(CU, 0), " MGD",'</b>'),
            textinfo='text',
            rotation=rotate3,
            insidetextfont = list(color = '#FFFFFF', size=20),
            outsidetextfont = list(color='#252525',size=16),
            marker = list(colors=with_colors,line=list(color = '#FFFFFF', width =3)))%>%
    layout(showlegend=FALSE,
           xaxis = list(showgrid=F, zeroline=F, showticklabels=F),
           yaxis = list(showgrid=F, zeroline=F, showticklabels=F),
           autosize=T,margin=l)
  
  path="G:/My Drive/USGS_ConsumptiveUse/Spring, 2019/Statewide Analysis/Fuel Type/"
  file_name <- paste(path,"Energy_fuel_CU",label, ".pdf", sep="")
  plotly_IMAGE(x=plot2,width=800,height=640,format="pdf",out_file=file_name)
  

  #---Timeseries Plots---#
  
  
  #---Nuclear---#
  nuclear_dis<-ts_dis[ts_dis$Fuel_Type=="Nuclear",]%>%
    dplyr::group_by(Date)%>%
    dplyr::summarise(Discharges=sum(Discharges_MGD,na.rm=T),Gen_Cap_MW=mean(Gen_Cap_MW,na.rm=T))
  nuclear_with<-ts_with[ts_with$Fuel_Type=="Nuclear",]%>%
    dplyr::group_by(Date)%>%
    dplyr::summarise(Withdrawals=sum(Withdrawals_MGD,na.rm=T),Gen_Cap_MW=mean(Gen_Cap_MW,na.rm=T))
  nuclear_dis$Date<-as.Date(nuclear_dis$Date,format="%Y-%m-%d")
  nuclear_CU<-merge(nuclear_with,nuclear_dis,by=c("Date","Gen_Cap_MW"))
  nuclear_CU$CU<-(nuclear_CU$Withdrawals-nuclear_CU$Discharges)/nuclear_CU$Withdrawals
  nuclear_CU$CU_MGal<-(nuclear_CU$Withdrawals-nuclear_CU$Discharges)*monthDays(nuclear_CU$Date)
  nuclear_CU$MGal_per_MW<-nuclear_CU$CU_MGal/nuclear_CU$Gen_Cap_MW
  nuclear_CU$Gal_per_MW<-(nuclear_CU$CU_MGal*1000000)/nuclear_CU$Gen_Cap_MW
  
  
  nuclear<-ts_with[ts_with$Fuel_Type=="Nuclear",]%>%
    dplyr::group_by(Date)%>%
    dplyr::summarise(Withdrawals=sum(Withdrawals_MGD,na.rm=T),Gen_Cap_MW=mean(Gen_Cap_MW,na.rm=T))%>%
    plot_ly(x=~Date)%>%
    add_trace(y=~Withdrawals, name="Withdrawal",yaxis="y1",type="scatter",mode="lines",line=list(color='#cb181d'),opacity=0.33)%>%
    add_trace(x=nuclear_dis$Date, y=nuclear_dis$Discharges,yaxis="y1", name="Discharge", type="scatter", mode='lines',line=list(color='#2171b5'),opacity=0.33)%>%
    add_trace(x=nuclear_CU$Date, y=nuclear_CU$CU, name="Consumption", type="scatter", yaxis="y2", mode='lines', line=list(color='black',dash="dot",width=3))%>%
    layout(yaxis = list(title="Quantity (MGD)",
                        side="left",
                        range=c(0,ifelse(max(nuclear_with$Withdrawals)>max(nuclear_dis$Discharges),
                                         ceiling(max(nuclear_with$Withdrawals)),ceiling(max(nuclear_dis$Discharges))))),
           yaxis2=list(tickfont=list(color="black"),
                       overlaying="y1",
                       side="right",
                       title="Consumption",
                       range=c(ifelse(min(nuclear_CU$CU)<0,min(nuclear_CU$CU),0),1)),
           margin=list(r=50),
           xaxis = list(title = "Date"),
           legend=list(orientation='h',xanchor="center",x=0.50,yanchor="top", y=-0.15))
  
  
  nuclear2<-ts_with[ts_with$Fuel_Type=="Nuclear",]%>%
    dplyr::group_by(Date)%>%
    dplyr::summarise(Withdrawals=sum(Withdrawals_MGD,na.rm=T),Gen_Cap_MW=mean(Gen_Cap_MW,na.rm=T))%>%
    plot_ly(x=~Date)%>%
    add_trace(y=~Withdrawals, name="Withdrawal",yaxis="y1",type="scatter",mode="lines",line=list(color='#cb181d'),opacity=0.33)%>%
    add_trace(x=nuclear_dis$Date, y=nuclear_dis$Discharges,yaxis="y1", name="Discharge", type="scatter", mode='lines',line=list(color='#2171b5'),opacity=0.33)%>%
    add_trace(x=nuclear_CU$Date, y=nuclear_CU$MGal_per_MW, name="Consumption per Rated Capacity", type="scatter", yaxis="y2", mode='lines', line=list(color='black',dash="dot",width=3))%>%
    layout(yaxis = list(title="Quantity (MGD)",
                        side="left",
                        range=c(0,ifelse(max(nuclear_with$Withdrawals)>max(nuclear_dis$Discharges),
                                         ceiling(max(nuclear_with$Withdrawals)),ceiling(max(nuclear_dis$Discharges))))),
           yaxis2=list(tickfont=list(color="black"),
                       overlaying="y1",
                       side="right",
                       title="MGal Consumed per MW",
                       range=c(ifelse(min(nuclear_CU$MGal_per_MW)<0,min(nuclear_CU$MGal_per_MW),0),max(nuclear_CU$MGal_per_MW))),
           margin=list(r=50),
           xaxis = list(title = "Date"),
           legend=list(orientation='h',xanchor="center",x=0.50,yanchor="top", y=-0.15))
  
  
  #---Coal---#
  Coal_dis<-ts_dis[ts_dis$Fuel_Type=="Coal",]%>%
    dplyr::group_by(Date)%>%
    dplyr::summarise(Discharges=sum(Discharges_MGD,na.rm=T),Gen_Cap_MW=mean(Gen_Cap_MW,na.rm=T))
  Coal_with<-ts_with[ts_with$Fuel_Type=="Coal",]%>%
    dplyr::group_by(Date)%>%
    dplyr::summarise(Withdrawals=sum(Withdrawals_MGD,na.rm=T),Gen_Cap_MW=mean(Gen_Cap_MW,na.rm=T))
  Coal_dis$Date<-as.Date(Coal_dis$Date,format="%Y-%m-%d")
  Coal_CU<-merge(Coal_with,Coal_dis,by=c("Date","Gen_Cap_MW"))
  Coal_CU$CU<-(Coal_CU$Withdrawals-Coal_CU$Discharges)/Coal_CU$Withdrawals
  Coal_CU$CU_MGal<-(Coal_CU$Withdrawals-Coal_CU$Discharges)*monthDays(Coal_CU$Date)
  Coal_CU$MGal_per_MW<-Coal_CU$CU_MGal/Coal_CU$Gen_Cap_MW
  Coal_CU$Gal_per_MW<-(Coal_CU$CU_MGal*1000000)/Coal_CU$Gen_Cap_MW
  
  
  Coal<-ts_with[ts_with$Fuel_Type=="Coal",]%>%
    dplyr::group_by(Date)%>%
    dplyr::summarise(Withdrawals=sum(Withdrawals_MGD,na.rm=T),Gen_Cap_MW=mean(Gen_Cap_MW,na.rm=T))%>%
    plot_ly(x=~Date)%>%
    add_trace(y=~Withdrawals, name="Withdrawal",yaxis="y",xaxis="x",type="scatter",mode="lines",line=list(color='#cb181d'),opacity=0.33)%>%
    add_trace(x=Coal_dis$Date, y=Coal_dis$Discharges, yaxis="y",xaxis="x",name="Discharge", type="scatter", mode='lines',line=list(color='#2171b5'),opacity=0.33)%>%
    add_trace(x=Coal_CU$Date, y=Coal_CU$CU, name="Consumption", type="scatter", yaxis="y2", mode='lines', line=list(color='black',dash="dot",width=3))%>%
    layout(yaxis = list(title="Quantity (MGD)",
                        side="left",
                        range=c(0,ifelse(max(Coal_with$Withdrawals)>max(Coal_dis$Discharges),
                                         ceiling(max(Coal_with$Withdrawals)),ceiling(max(Coal_dis$Discharges))))),
           yaxis2=list(tickfont=list(color="black"),
                       overlaying="y3",
                       side="right",
                       title="Consumption",
                       range=c(ifelse(min(Coal_CU$CU)<0,min(Coal_CU$CU),0),1)),
           margin=list(r=50),
           xaxis = list(title = "Date"),
           legend=list(orientation='h',xanchor="center",x=0.50,yanchor="top", y=-0.15))
  
  Coal2<-ts_with[ts_with$Fuel_Type=="Coal",]%>%
    dplyr::group_by(Date)%>%
    dplyr::summarise(Withdrawals=sum(Withdrawals_MGD,na.rm=T),Gen_Cap_MW=mean(Gen_Cap_MW,na.rm=T))%>%
    plot_ly(x=~Date)%>%
    add_trace(y=~Withdrawals, name="Withdrawal",yaxis="y",xaxis="x",type="scatter",mode="lines",line=list(color='#cb181d'),opacity=0.33)%>%
    add_trace(x=Coal_dis$Date, y=Coal_dis$Discharges, yaxis="y",xaxis="x",name="Discharge", type="scatter", mode='lines',line=list(color='#2171b5'),opacity=0.33)%>%
    add_trace(x=Coal_CU$Date, y=Coal_CU$MGal_per_MW, name="Consumption per Rated Capacity", type="scatter", yaxis="y2", mode='lines', line=list(color='black',dash="dot",width=3))%>%
    layout(yaxis = list(title="Quantity (MGD)",
                        side="left",
                        range=c(0,ifelse(max(Coal_with$Withdrawals)>max(Coal_dis$Discharges),
                                         ceiling(max(Coal_with$Withdrawals)),ceiling(max(Coal_dis$Discharges))))),
           yaxis2=list(tickfont=list(color="black"),
                       overlaying="y3",
                       side="right",
                       title="MGal Consumed per MW",
                       range=c(ifelse(min(Coal_CU$MGal_per_MW)<0,min(Coal_CU$MGal_per_MW),0),max(Coal_CU$MGal_per_MW))),
           margin=list(r=50),
           xaxis = list(title = "Date"),
           legend=list(orientation='h', x=0.25, y=-0.15))
  
  
  #---Combination Fossil---#
  combo_dis<-ts_dis[ts_dis$Fuel_Type=="Combination Fossil",]%>%
    dplyr::group_by(Date)%>%
    dplyr::summarise(Discharges=sum(Discharges_MGD,na.rm=T),Gen_Cap_MW=mean(Gen_Cap_MW,na.rm=T))
  combo_with<-ts_with[ts_with$Fuel_Type=="Combination Fossil",]%>%
    dplyr::group_by(Date)%>%
    dplyr::summarise(Withdrawals=sum(Withdrawals_MGD,na.rm=T),Gen_Cap_MW=mean(Gen_Cap_MW,na.rm=T))
  combo_dis$Date<-as.Date(combo_dis$Date,format="%Y-%m-%d")
  combo_CU<-merge(combo_with,combo_dis,by=c("Date","Gen_Cap_MW"))
  combo_CU$CU<-(combo_CU$Withdrawals-combo_CU$Discharges)/combo_CU$Withdrawals
  combo_CU$CU_MGal<-(combo_CU$Withdrawals-combo_CU$Discharges)*monthDays(combo_CU$Date)
  combo_CU$MGal_per_MW<-combo_CU$CU_MGal/combo_CU$Gen_Cap_MW
  combo_CU$Gal_per_MW<-(combo_CU$CU_MGal*1000000)/combo_CU$Gen_Cap_MW
  
  combo<-ts_with[ts_with$Fuel_Type=="Combination Fossil",]%>%
    dplyr::group_by(Date)%>%
    dplyr::summarise(Withdrawals=sum(Withdrawals_MGD,na.rm=T),Gen_Cap_MW=mean(Gen_Cap_MW,na.rm=T))%>%
    plot_ly(x=~Date)%>%
    add_trace(y=~Withdrawals, name="Withdrawal",yaxis="y",xaxis="x",type="scatter",mode="lines",line=list(color='#cb181d'),opacity=0.33)%>%
    add_trace(x=combo_dis$Date, y=combo_dis$Discharges,yaxis="y",xaxis="x", name="Discharge", type="scatter", mode='lines',line=list(color='#2171b5'),opacity=0.33)%>%
    add_trace(x=combo_CU$Date, y=combo_CU$CU, name="Consumption", type="scatter", yaxis="y2", mode='lines', line=list(color='black',dash="dot",width=3))%>%
    layout(yaxis = list(title="Quantity (MGD)",
                        side="left",
                        range=c(0,ifelse(max(combo_with$Withdrawals)>max(combo_dis$Discharges),
                                         ceiling(max(combo_with$Withdrawals)),ceiling(max(combo_dis$Discharges))))),
           yaxis2=list(tickfont=list(color="black"),
                       overlaying="y5",
                       side="right",
                       title="Consumption",
                       range=c(ifelse(min(combo_CU$CU)<0,min(combo_CU$CU),0),1)),
           margin=list(r=50),
           xaxis = list(title = "Date"),
           legend=list(orientation='h',xanchor="center",x=0.50,yanchor="top", y=-0.15))
  
  combo2<-ts_with[ts_with$Fuel_Type=="Combination Fossil",]%>%
    dplyr::group_by(Date)%>%
    dplyr::summarise(Withdrawals=sum(Withdrawals_MGD,na.rm=T),Gen_Cap_MW=mean(Gen_Cap_MW,na.rm=T))%>%
    plot_ly(x=~Date)%>%
    add_trace(y=~Withdrawals, name="Withdrawal",yaxis="y",xaxis="x",type="scatter",mode="lines",line=list(color='#cb181d'),opacity=0.33)%>%
    add_trace(x=combo_dis$Date, y=combo_dis$Discharges,yaxis="y",xaxis="x", name="Discharge", type="scatter", mode='lines',line=list(color='#2171b5'),opacity=0.33)%>%
    add_trace(x=combo_CU$Date, y=combo_CU$MGal_per_MW, name="Consumption per Rated Capacity", type="scatter", yaxis="y2", mode='lines', line=list(color='black',dash="dot",width=3))%>%
    layout(yaxis = list(title="Quantity (MGD)",
                        side="left",
                        range=c(0,ifelse(max(combo_with$Withdrawals)>max(combo_dis$Discharges),
                                         ceiling(max(combo_with$Withdrawals)),ceiling(max(combo_dis$Discharges))))),
           yaxis2=list(tickfont=list(color="black"),
                       overlaying="y5",
                       side="right",
                       title="MGal Consumed per MW",
                       range=c(ifelse(min(combo_CU$CU)<0,min(combo_CU$CU),0),1)),
           margin=list(r=50),
           xaxis = list(title = "Date"),
           legend=list(orientation='h',xanchor="center",x=0.50,yanchor="top", y=-0.15))
  
  #---Biomass---#
  biomass_dis<-ts_dis[ts_dis$Fuel_Type=="Biomass",]%>%
    dplyr::group_by(Date)%>%
    dplyr::summarise(Discharges=sum(Discharges_MGD,na.rm=T),Gen_Cap_MW=mean(Gen_Cap_MW,na.rm=T))
  biomass_with<-ts_with[ts_with$Fuel_Type=="Biomass",]%>%
    dplyr::group_by(Date)%>%
    dplyr::summarise(Withdrawals=sum(Withdrawals_MGD,na.rm=T),Gen_Cap_MW=mean(Gen_Cap_MW,na.rm=T))
  biomass_dis$Date<-as.Date(biomass_dis$Date,format="%Y-%m-%d")
  biomass_CU<-merge(biomass_with,biomass_dis,by=c("Date","Gen_Cap_MW"))
  biomass_CU$CU<-(biomass_CU$Withdrawals-biomass_CU$Discharges)/biomass_CU$Withdrawals
  biomass_CU$CU_MGal<-(biomass_CU$Withdrawals-biomass_CU$Discharges)*monthDays(biomass_CU$Date)
  biomass_CU$MGal_per_MW<-biomass_CU$CU_MGal/biomass_CU$Gen_Cap_MW
  biomass_CU$Gal_per_MW<-(biomass_CU$CU_MGal*1000000)/biomass_CU$Gen_Cap_MW
  
  biomass<-ts_with[ts_with$Fuel_Type=="Biomass",]%>%
    dplyr::group_by(Date)%>%
    dplyr::summarise(Withdrawals=sum(Withdrawals_MGD,na.rm=T),Gen_Cap_MW=mean(Gen_Cap_MW,na.rm=T))%>%
    plot_ly(x=~Date)%>%
    add_trace(y=~Withdrawals, name="Withdrawal",yaxis="y",xaxis="x",type="scatter",mode="lines",line=list(color='#cb181d'),opacity=0.33)%>%
    add_trace(x=biomass_dis$Date, y=biomass_dis$Discharges,yaxis="y",xaxis="x", name="Discharge", type="scatter", mode='lines',line=list(color='#2171b5'),opacity=0.33)%>%
    add_trace(x=biomass_CU$Date, y=biomass_CU$CU, name="Consumption", type="scatter", yaxis="y2", mode='lines', line=list(color='black',dash="dot",width=3))%>%
    layout(yaxis = list(title="Quantity (MGD)",
                        side="left",
                        range=c(0,ifelse(max(biomass_with$Withdrawals)>max(biomass_dis$Discharges),
                                         ceiling(max(biomass_with$Withdrawals)),ceiling(max(biomass_dis$Discharges))))),
           yaxis2=list(tickfont=list(color="black"),
                       overlaying="y7",
                       side="right",
                       title="Consumption",
                       range=c(ifelse(min(biomass_CU$CU)<0,min(biomass_CU$CU),0),1)),
           margin=list(r=50),
           xaxis = list(title = "Date"),
           legend=list(orientation='h',xanchor="center",x=0.50,yanchor="top", y=-0.15))
  
  biomass2<-ts_with[ts_with$Fuel_Type=="Biomass",]%>%
    dplyr::group_by(Date)%>%
    dplyr::summarise(Withdrawals=sum(Withdrawals_MGD,na.rm=T),Gen_Cap_MW=mean(Gen_Cap_MW,na.rm=T))%>%
    plot_ly(x=~Date)%>%
    add_trace(y=~Withdrawals, name="Withdrawal",yaxis="y",xaxis="x",type="scatter",mode="lines",line=list(color='#cb181d'),opacity=0.33)%>%
    add_trace(x=biomass_dis$Date, y=biomass_dis$Discharges,yaxis="y",xaxis="x", name="Discharge", type="scatter", mode='lines',line=list(color='#2171b5'),opacity=0.33)%>%
    add_trace(x=biomass_CU$Date, y=biomass_CU$MGal_per_MW, name="Consumption per Rated Capacity", type="scatter", yaxis="y2", mode='lines', line=list(color='black',dash="dot",width=3))%>%
    layout(yaxis = list(title="Quantity (MGD)",
                        side="left",
                        range=c(0,ifelse(max(biomass_with$Withdrawals)>max(biomass_dis$Discharges),
                                         ceiling(max(biomass_with$Withdrawals)),ceiling(max(biomass_dis$Discharges))))),
           yaxis2=list(tickfont=list(color="black"),
                       overlaying="y7",
                       side="right",
                       title="MGal Consumed per MW",
                       range=c(ifelse(min(biomass_CU$CU)<0,min(biomass_CU$CU),0),1)),
           margin=list(r=50),
           xaxis = list(title = "Date"),
           legend=list(orientation='h',xanchor="center",x=0.50,yanchor="top", y=-0.15))
  
  fuel_subplot<-plotly::subplot(nuclear,style(Coal,showlegend=F), style(combo,showlegend=F),
                  style(biomass,showlegend=F),nrows=2,
                  shareX = T,titleX= T, 
                  titleY=T,margin=0.07)%>%
    layout(annotations = list(
      list(x = 0.225 , y = 1.0, 
           text = "<b>(a) Nuclear</b>",
           showarrow = F, 
           xref='paper', yref='paper', xanchor='center',yanchor='bottom'),
      list(x = 0.775 , y = 1.0, 
           text = "<b>(b) Coal</b>", 
           showarrow = F, xref='paper', yref='paper',xanchor='center',yanchor='bottom'),
      list(x = 0.225 , y = 0.5, 
           text = "<b>(c) Combination Fossil Fuel</b>",
           showarrow = F, 
           xref='paper', yref='paper', xanchor='center',yanchor='bottom'),
      list(x = 0.775 , y = 0.5, 
           text = "<b>(d) Biomass</b>",
           showarrow = F, 
           xref='paper', yref='paper', xanchor='center',yanchor='bottom')
    ))
  
  path="G:/My Drive/USGS_ConsumptiveUse/Spring, 2019/Statewide Analysis/Fuel Type/"
  file_name <- paste(path,"Energy_fuel_CU_timeseries",label, ".pdf", sep="")
  plotly_IMAGE(x=fuel_subplot,width=1300,height=700,format="pdf",out_file=file_name)
  
  
  assign("nuclear_CU",nuclear_CU,envir = .GlobalEnv)
  assign("biomass_CU",biomass_CU,envir = .GlobalEnv)
  assign("Coal_CU",Coal_CU,envir = .GlobalEnv)
  assign("combo_CU",combo_CU,envir = .GlobalEnv)
  
  fuel_subplot2<-plotly::subplot(nuclear2,style(Coal2,showlegend=F), style(combo2,showlegend=F),
                                style(biomass2,showlegend=F),nrows=2,
                                shareX = T,titleX= T, 
                                titleY=T,margin=0.07)%>%
    layout(annotations = list(
      list(x = 0.225 , y = 1.0, 
           text = "<b>(a) Nuclear</b>",
           showarrow = F, 
           xref='paper', yref='paper', xanchor='center',yanchor='bottom'),
      list(x = 0.775 , y = 1.0, 
           text = "<b>(b) Coal</b>", 
           showarrow = F, xref='paper', yref='paper',xanchor='center',yanchor='bottom'),
      list(x = 0.225 , y = 0.5, 
           text = "<b>(c) Combination Fossil Fuel</b>",
           showarrow = F, 
           xref='paper', yref='paper', xanchor='center',yanchor='bottom'),
      list(x = 0.775 , y = 0.5, 
           text = "<b>(d) Biomass</b>",
           showarrow = F, 
           xref='paper', yref='paper', xanchor='center',yanchor='bottom')
    ))
  
  path="G:/My Drive/USGS_ConsumptiveUse/Spring, 2019/Statewide Analysis/Fuel Type/"
  file_name <- paste(path,"Energy_fuel_MgalMW_timeseries",label, ".pdf", sep="")
  plotly_IMAGE(x=fuel_subplot2,width=1300,height=700,format="pdf",out_file=file_name)
  
  
  return(list(fuel_subplot,fuel_subplot2))
  

  }
Use.by.Energy.Fuel(Matched_Facility_Withdrawals,Matched_Facility_Discharges,full_match_2010_2017,full_match_2010_2017,rotate1=90,rotate2=90,rotate3=90,"_match")


#----------------------------------------------------------------------------------------------------------------------------------------------#
#------------------------------------------Consumption Coefficients per Sector per Year--------------------------------------------------------#

# This function returns the average consumption coefficient per year, per sector, and an overall average from 2010-2017

Consumption_Sector<- function(Discharge_fac,Withdrawal_fac,name){
  
  Sector_Discharge<-Discharge_fac%>%
    dplyr::group_by(Sector=Use.Type,Year)%>%
    dplyr::summarise(nFacilities=n_distinct(VPDES.Facility.ID),
                     Discharges_MGD=sum(Discharges_MGD,na.rm=T))
  
  Sector_Withdrawal<-Withdrawal_fac%>%
    dplyr::group_by(Sector=Use.Type,Year)%>%
    dplyr::summarise(nFacilities=n_distinct(VWUDS.Facility.ID),
                     Withdrawals_MGD=sum(Withdrawals_MGD,na.rm=T))
  
  Sector_CU<-data.frame("Sector"=unique(Sector_Withdrawal$Sector),stringsAsFactors = F)
  
  Sector_CU$Discharge_MGD2010<-ifelse(Sector_CU$Sector%in%Sector_Discharge$Sector[Sector_Discharge$Year=="2010"],Sector_Discharge$Discharges_MGD[Sector_Discharge$Year=="2010"][match(Sector_CU$Sector,Sector_Discharge$Sector[Sector_Discharge$Year=="2010"])],NA)
  Sector_CU$Discharge_MGD2011<-ifelse(Sector_CU$Sector%in%Sector_Discharge$Sector[Sector_Discharge$Year=="2011"],Sector_Discharge$Discharges_MGD[Sector_Discharge$Year=="2011"][match(Sector_CU$Sector,Sector_Discharge$Sector[Sector_Discharge$Year=="2011"])],NA)
  Sector_CU$Discharge_MGD2012<-ifelse(Sector_CU$Sector%in%Sector_Discharge$Sector[Sector_Discharge$Year=="2012"],Sector_Discharge$Discharges_MGD[Sector_Discharge$Year=="2012"][match(Sector_CU$Sector,Sector_Discharge$Sector[Sector_Discharge$Year=="2012"])],NA)
  Sector_CU$Discharge_MGD2013<-ifelse(Sector_CU$Sector%in%Sector_Discharge$Sector[Sector_Discharge$Year=="2013"],Sector_Discharge$Discharges_MGD[Sector_Discharge$Year=="2013"][match(Sector_CU$Sector,Sector_Discharge$Sector[Sector_Discharge$Year=="2013"])],NA)
  Sector_CU$Discharge_MGD2014<-ifelse(Sector_CU$Sector%in%Sector_Discharge$Sector[Sector_Discharge$Year=="2014"],Sector_Discharge$Discharges_MGD[Sector_Discharge$Year=="2014"][match(Sector_CU$Sector,Sector_Discharge$Sector[Sector_Discharge$Year=="2014"])],NA)
  Sector_CU$Discharge_MGD2015<-ifelse(Sector_CU$Sector%in%Sector_Discharge$Sector[Sector_Discharge$Year=="2015"],Sector_Discharge$Discharges_MGD[Sector_Discharge$Year=="2015"][match(Sector_CU$Sector,Sector_Discharge$Sector[Sector_Discharge$Year=="2015"])],NA)
  Sector_CU$Discharge_MGD2016<-ifelse(Sector_CU$Sector%in%Sector_Discharge$Sector[Sector_Discharge$Year=="2016"],Sector_Discharge$Discharges_MGD[Sector_Discharge$Year=="2016"][match(Sector_CU$Sector,Sector_Discharge$Sector[Sector_Discharge$Year=="2016"])],NA)
  Sector_CU$Discharge_MGD2017<-ifelse(Sector_CU$Sector%in%Sector_Discharge$Sector[Sector_Discharge$Year=="2017"],Sector_Discharge$Discharges_MGD[Sector_Discharge$Year=="2017"][match(Sector_CU$Sector,Sector_Discharge$Sector[Sector_Discharge$Year=="2017"])],NA)
  
  Sector_CU$Withdrawal_MGD2010<-ifelse(Sector_CU$Sector%in%Sector_Withdrawal$Sector[Sector_Withdrawal$Year=="2010"],Sector_Withdrawal$Withdrawals_MGD[Sector_Withdrawal$Year=="2010"][match(Sector_CU$Sector,Sector_Withdrawal$Sector[Sector_Withdrawal$Year=="2010"])],NA)
  Sector_CU$Withdrawal_MGD2011<-ifelse(Sector_CU$Sector%in%Sector_Withdrawal$Sector[Sector_Withdrawal$Year=="2011"],Sector_Withdrawal$Withdrawals_MGD[Sector_Withdrawal$Year=="2011"][match(Sector_CU$Sector,Sector_Withdrawal$Sector[Sector_Withdrawal$Year=="2011"])],NA)
  Sector_CU$Withdrawal_MGD2012<-ifelse(Sector_CU$Sector%in%Sector_Withdrawal$Sector[Sector_Withdrawal$Year=="2012"],Sector_Withdrawal$Withdrawals_MGD[Sector_Withdrawal$Year=="2012"][match(Sector_CU$Sector,Sector_Withdrawal$Sector[Sector_Withdrawal$Year=="2012"])],NA)
  Sector_CU$Withdrawal_MGD2013<-ifelse(Sector_CU$Sector%in%Sector_Withdrawal$Sector[Sector_Withdrawal$Year=="2013"],Sector_Withdrawal$Withdrawals_MGD[Sector_Withdrawal$Year=="2013"][match(Sector_CU$Sector,Sector_Withdrawal$Sector[Sector_Withdrawal$Year=="2013"])],NA)
  Sector_CU$Withdrawal_MGD2014<-ifelse(Sector_CU$Sector%in%Sector_Withdrawal$Sector[Sector_Withdrawal$Year=="2014"],Sector_Withdrawal$Withdrawals_MGD[Sector_Withdrawal$Year=="2014"][match(Sector_CU$Sector,Sector_Withdrawal$Sector[Sector_Withdrawal$Year=="2014"])],NA)
  Sector_CU$Withdrawal_MGD2015<-ifelse(Sector_CU$Sector%in%Sector_Withdrawal$Sector[Sector_Withdrawal$Year=="2015"],Sector_Withdrawal$Withdrawals_MGD[Sector_Withdrawal$Year=="2015"][match(Sector_CU$Sector,Sector_Withdrawal$Sector[Sector_Withdrawal$Year=="2015"])],NA)
  Sector_CU$Withdrawal_MGD2016<-ifelse(Sector_CU$Sector%in%Sector_Withdrawal$Sector[Sector_Withdrawal$Year=="2016"],Sector_Withdrawal$Withdrawals_MGD[Sector_Withdrawal$Year=="2016"][match(Sector_CU$Sector,Sector_Withdrawal$Sector[Sector_Withdrawal$Year=="2016"])],NA)
  Sector_CU$Withdrawal_MGD2017<-ifelse(Sector_CU$Sector%in%Sector_Withdrawal$Sector[Sector_Withdrawal$Year=="2017"],Sector_Withdrawal$Withdrawals_MGD[Sector_Withdrawal$Year=="2017"][match(Sector_CU$Sector,Sector_Withdrawal$Sector[Sector_Withdrawal$Year=="2017"])],NA)
  
  Sector_CU$CU_2010<-(ifelse(is.na(Sector_CU$Withdrawal_MGD2010)|is.nan(Sector_CU$Withdrawal_MGD2010),0,Sector_CU$Withdrawal_MGD2010)-
                        ifelse(is.na(Sector_CU$Discharge_MGD2010)|is.nan(Sector_CU$Discharge_MGD2010),0,Sector_CU$Discharge_MGD2010))/(ifelse(is.na(Sector_CU$Withdrawal_MGD2010)|is.nan(Sector_CU$Withdrawal_MGD2010),0,Sector_CU$Withdrawal_MGD2010))
  
  Sector_CU$CU_2011<-(ifelse(is.na(Sector_CU$Withdrawal_MGD2011)|is.nan(Sector_CU$Withdrawal_MGD2011),0,Sector_CU$Withdrawal_MGD2011)-
                        ifelse(is.na(Sector_CU$Discharge_MGD2011)|is.nan(Sector_CU$Discharge_MGD2011),0,Sector_CU$Discharge_MGD2011))/(ifelse(is.na(Sector_CU$Withdrawal_MGD2011)|is.nan(Sector_CU$Withdrawal_MGD2011),0,Sector_CU$Withdrawal_MGD2011))
  
  Sector_CU$CU_2012<-(ifelse(is.na(Sector_CU$Withdrawal_MGD2012)|is.nan(Sector_CU$Withdrawal_MGD2012),0,Sector_CU$Withdrawal_MGD2012)-
                        ifelse(is.na(Sector_CU$Discharge_MGD2012)|is.nan(Sector_CU$Discharge_MGD2012),0,Sector_CU$Discharge_MGD2012))/(ifelse(is.na(Sector_CU$Withdrawal_MGD2012)|is.nan(Sector_CU$Withdrawal_MGD2012),0,Sector_CU$Withdrawal_MGD2012))
  
  Sector_CU$CU_2013<-(ifelse(is.na(Sector_CU$Withdrawal_MGD2013)|is.nan(Sector_CU$Withdrawal_MGD2013),0,Sector_CU$Withdrawal_MGD2013)-
                        ifelse(is.na(Sector_CU$Discharge_MGD2013)|is.nan(Sector_CU$Discharge_MGD2013),0,Sector_CU$Discharge_MGD2013))/(ifelse(is.na(Sector_CU$Withdrawal_MGD2013)|is.nan(Sector_CU$Withdrawal_MGD2013),0,Sector_CU$Withdrawal_MGD2013))
  
  Sector_CU$CU_2014<-(ifelse(is.na(Sector_CU$Withdrawal_MGD2014)|is.nan(Sector_CU$Withdrawal_MGD2014),0,Sector_CU$Withdrawal_MGD2014)-
                        ifelse(is.na(Sector_CU$Discharge_MGD2014)|is.nan(Sector_CU$Discharge_MGD2014),0,Sector_CU$Discharge_MGD2014))/(ifelse(is.na(Sector_CU$Withdrawal_MGD2014)|is.nan(Sector_CU$Withdrawal_MGD2014),0,Sector_CU$Withdrawal_MGD2014))
  
  Sector_CU$CU_2015<-(ifelse(is.na(Sector_CU$Withdrawal_MGD2015)|is.nan(Sector_CU$Withdrawal_MGD2015),0,Sector_CU$Withdrawal_MGD2015)-
                        ifelse(is.na(Sector_CU$Discharge_MGD2015)|is.nan(Sector_CU$Discharge_MGD2015),0,Sector_CU$Discharge_MGD2015))/(ifelse(is.na(Sector_CU$Withdrawal_MGD2015)|is.nan(Sector_CU$Withdrawal_MGD2015),0,Sector_CU$Withdrawal_MGD2015))
  
  Sector_CU$CU_2016<-(ifelse(is.na(Sector_CU$Withdrawal_MGD2016)|is.nan(Sector_CU$Withdrawal_MGD2016),0,Sector_CU$Withdrawal_MGD2016)-
                        ifelse(is.na(Sector_CU$Discharge_MGD2016)|is.nan(Sector_CU$Discharge_MGD2016),0,Sector_CU$Discharge_MGD2016))/(ifelse(is.na(Sector_CU$Withdrawal_MGD2016)|is.nan(Sector_CU$Withdrawal_MGD2016),0,Sector_CU$Withdrawal_MGD2016))
  
  Sector_CU$CU_2017<-(ifelse(is.na(Sector_CU$Withdrawal_MGD2017)|is.nan(Sector_CU$Withdrawal_MGD2017),0,Sector_CU$Withdrawal_MGD2017)-
                        ifelse(is.na(Sector_CU$Discharge_MGD2017)|is.nan(Sector_CU$Discharge_MGD2017),0,Sector_CU$Discharge_MGD2017))/(ifelse(is.na(Sector_CU$Withdrawal_MGD2017)|is.nan(Sector_CU$Withdrawal_MGD2017),0,Sector_CU$Withdrawal_MGD2017))
  
  Sector_CU<-Sector_CU[-c(2:17)]
  
  is.nan.data.frame <- function(x)
    do.call(cbind, lapply(x, is.nan))
  
  Sector_CU[is.nan.data.frame(Sector_CU)]<-NA
  
  
  
  for (i in 1:length(Sector_CU$Sector)){
    Sector_CU$Sum[i]<-(ifelse(is.na(Sector_CU$CU_2010[i]),0,Sector_CU$CU_2010[i])+
                         ifelse(is.na(Sector_CU$CU_2011[i]),0,Sector_CU$CU_2011[i])+
                         ifelse(is.na(Sector_CU$CU_2012[i]),0,Sector_CU$CU_2012[i])+
                         ifelse(is.na(Sector_CU$CU_2013[i]),0,Sector_CU$CU_2013[i])+
                         ifelse(is.na(Sector_CU$CU_2014[i]),0,Sector_CU$CU_2014[i])+
                         ifelse(is.na(Sector_CU$CU_2015[i]),0,Sector_CU$CU_2015[i])+
                         ifelse(is.na(Sector_CU$CU_2016[i]),0,Sector_CU$CU_2016[i])+
                         ifelse(is.na(Sector_CU$CU_2017[i]),0,Sector_CU$CU_2017[i]))
  }

  Sector_CU$Ave_CU<-apply(Sector_CU[,4:10],1,median,na.rm=T)

  assign(name,Sector_CU,envir=.GlobalEnv)
  
  return(Sector_CU)
}

Consumption_Sector(Facility_Discharges,Facility_Withdrawals,"Sector_CU_All")
Consumption_Sector(Matched_Facility_Discharges,Matched_Facility_Withdrawals,"Sector_CU_Matched")

Compare.Studies<- function(){
  
  
  lit.ag<-data.frame(Sector="Agriculture/Irrigation",Consumption=c(1.00,.75,.80,1.00,1.00,1.00,1.00,1.00,1.00,.80,.70),Source="Literature")
  lit.com<-data.frame(Sector="Commercial",Consumption=c(.18,.096,.10,.046,.1,.1,0.08,.11),Source="Literature")
  lit.energy<-data.frame(Sector="Energy",Consumption=c(.01,.004,.02,.001,.04,.012,.005,.01,.01,.05),Source="Literature")
  lit.industrial<-data.frame(Sector="Industrial",Consumption=c(.04,.13,.079,.1,.328,.1,.06,.084,.081,.1,.04,.11,.10,.15,.20,.11),Source="Literature")
  lit.municipal<-data.frame(Sector="Municipal",Consumption=c(.20,.10,.20,.284,.15,.20,.37,.10,.15,.15,.24,.275,.20,.12),Source="Literature")
  
  
  n<-Sector_CU_Matched$Sector
  Sector_CU_Matched_t<-as.data.frame(t(Sector_CU_Matched[,-1]))
  colnames(Sector_CU_Matched_t)<-n
  Sector_CU_Matched_t<- Sector_CU_Matched_t[1:8,]
  
  match.aq<-data.frame(Sector=rep(paste0('Aquaculture'),length(Sector_CU_Matched_t$Aquaculture)),
                     Consumption=Sector_CU_Matched_t$Aquaculture,Source="Total Volume Analysis: Matched Facility Data")
  
  match.com<-data.frame(Sector=rep(paste0('Commercial'),length(Sector_CU_Matched_t$Commercial)),
                      Consumption=Sector_CU_Matched_t$Commercial,Source="Total Volume Analysis: Matched Facility Data")
  
  match.energy<-data.frame(Sector=rep(paste0('Energy'),length(Sector_CU_Matched_t$Energy)),
                         Consumption=Sector_CU_Matched_t$Energy,Source="Total Volume Analysis: Matched Facility Data")
  
  match.industrial<-data.frame(Sector=rep(paste0('Industrial'),length(Sector_CU_Matched_t$Industrial)),
                             Consumption=Sector_CU_Matched_t$Industrial,Source="Total Volume Analysis: Matched Facility Data")
  
  

  aquaculture<-full_match_2010_2017[full_match_2010_2017$Use.Type=="Aquaculture",]%>%
    dplyr::group_by(VWUDS.Facility.ID,Date)%>%
    dplyr::summarise(Withdrawals=sum(Withdrawals_MGD,na.rm=T),
                     Discharges=sum(Discharges_MGD,na.rm=T),
                     CU=median(CU,na.rm=T))
  aquaculture$CU<-ifelse(is.infinite(aquaculture$CU),NA,aquaculture$CU)
  aquaculture<-aquaculture[complete.cases(aquaculture),]
  outliers<-boxplot.stats(aquaculture$CU)$out
  
  commercial<-full_match_2010_2017[full_match_2010_2017$Use.Type=="Commercial",]%>%
    dplyr::group_by(VWUDS.Facility.ID,Date)%>%
    dplyr::summarise(Withdrawals=sum(Withdrawals_MGD,na.rm=T),
                     Discharges=sum(Discharges_MGD,na.rm=T),
                     CU=median(CU,na.rm=T))
  commercial$CU<-ifelse(is.infinite(commercial$CU),NA,commercial$CU)
  commercial<-commercial[complete.cases(commercial),]
  outliers<-boxplot.stats(commercial$CU)$out
  commercial$CU<-ifelse(commercial$CU %in% outliers,NA,commercial$CU)
  
  industrial<-full_match_2010_2017[full_match_2010_2017$Use.Type=="Industrial",]%>%
    dplyr::group_by(VWUDS.Facility.ID,Date)%>%
    dplyr::summarise(Withdrawals=sum(Withdrawals_MGD,na.rm=T),
                     Discharges=sum(Discharges_MGD,na.rm=T),
                     CU=median(CU,na.rm=T))
  industrial$CU<-ifelse(is.infinite(industrial$CU),NA,industrial$CU)
  industrial<-industrial[complete.cases(industrial),]
  industrial$CU<-ifelse(industrial$CU %in% outliers,NA,industrial$CU)
  outliers<-boxplot.stats(industrial$CU)$out
  
  energy_CU<-full_match_2010_2017[full_match_2010_2017$Use.Type=="Energy",]%>%
    dplyr::group_by(VWUDS.Facility.ID,Date)%>%
    dplyr::summarise(Withdrawals=sum(Withdrawals_MGD,na.rm=T),
                     Discharges=sum(Discharges_MGD,na.rm=T),
                     CU=median(CU,na.rm=T))
  outliers<-boxplot.stats(energy_CU$CU)$out
  energy_CU$CU<-ifelse(energy_CU$CU %in% outliers,NA,energy_CU$CU)
  
  aquaculture<-aquaculture%>%dplyr::group_by(substr(Date,1,4))%>%dplyr::summarise(CU=median(CU,na.rm=T))
  
  fac.aq<-data.frame(Sector=rep(paste0('Aquaculture'),length(aquaculture$CU)),
                       Consumption=aquaculture$CU,Source="Median Facility Analysis")
  
  
  commercial<-commercial%>%dplyr::group_by(substr(Date,1,4))%>%dplyr::summarise(CU=median(CU,na.rm=T))
  fac.com<-data.frame(Sector=rep(paste0('Commercial'),length(commercial$CU)),
                        Consumption=commercial$CU,Source="Median Facility Analysis")
  
  energy_CU<-energy_CU%>%dplyr::group_by(substr(Date,1,4))%>%dplyr::summarise(CU=median(CU,na.rm=T))
  fac.energy<-data.frame(Sector=rep(paste0('Energy'),length(energy_CU$CU)),
                           Consumption=energy_CU$CU,Source="Median Facility Analysis")
  
  industrial<-industrial%>%dplyr::group_by(substr(Date,1,4))%>%dplyr::summarise(CU=median(CU,na.rm=T))
  fac.industrial<-data.frame(Sector=rep(paste0('Industrial'),length(industrial$CU)),
                               Consumption=industrial$CU,Source="Median Facility Analysis")

  studies<-rbind(lit.ag,lit.com,lit.energy,lit.industrial,lit.municipal,
                 fac.energy,fac.industrial,fac.com,fac.aq,
                 match.aq,match.com,match.energy,match.industrial)
  
  compare_box<-plot_ly(studies, x = ~Sector, y = ~Consumption, color = ~Source, type = "box") %>%
    layout(boxmode = "group")%>%
    layout(legend=list(orientation='h',xanchor="center",x=0.50,yanchor="top", y=-0.15))
  
  path="G:/My Drive/USGS_ConsumptiveUse/Spring, 2019/Statewide Analysis/Lit Compare/"
  file_name <- paste(path,"CU_Compare_Literature", ".pdf", sep="")
  plotly_IMAGE(x=compare_box,width=1000,height=700,format="pdf",out_file=file_name)
  
  
  
   n<-Sector_CU_All$Sector
   Sector_CU_All_t<-as.data.frame(t(Sector_CU_All[,-1]))
   colnames(Sector_CU_All_t)<-n
   Sector_CU_All_t<- Sector_CU_All_t[1:8,]

   all.ag<-data.frame(Sector=rep(paste0('Agriculture/Irrigation'),length(Sector_CU_All_t$`Agriculture/Irrigation`)),
                      Consumption=Sector_CU_All_t$`Agriculture/Irrigation`,Source="Total Volume Analysis: All Available Data")
  
   all.aq<-data.frame(Sector=rep(paste0('Aquaculture'),length(Sector_CU_All_t$Aquaculture)),
                       Consumption=Sector_CU_All_t$Aquaculture,Source="Total Volume Analysis: All Available Data")
  
   all.com<-data.frame(Sector=rep(paste0('Commercial'),length(Sector_CU_All_t$Commercial)),
                      Consumption=Sector_CU_All_t$Commercial,Source="Total Volume Analysis: All Available Data")
  
   all.energy<-data.frame(Sector=rep(paste0('Energy'),length(Sector_CU_All_t$Energy)),
                       Consumption=Sector_CU_All_t$Energy,Source="Total Volume Analysis: All Available Data")
  
   all.industrial<-data.frame(Sector=rep(paste0('Industrial'),length(Sector_CU_All_t$Industrial)),
                          Consumption=Sector_CU_All_t$Industrial,Source="Total Volume Analysis: All Available Data")
  
   all.municipal<-data.frame(Sector=rep(paste0('Municipal'),length(Sector_CU_All_t$Municipal)),
                              Consumption=Sector_CU_All_t$Municipal,Source="Total Volume Analysis: All Available Data")

  
  studies_plus_all<-rbind(lit.ag,lit.com,lit.energy,lit.industrial,lit.municipal,
                          all.ag,all.aq,all.com,all.energy,all.industrial,all.municipal,
                          match.aq,match.com,match.energy,match.industrial,
                          fac.energy,fac.industrial,fac.com,fac.aq)
  
  compare_box_2<-plot_ly(studies_plus_all, x = ~Sector, y = ~Consumption, color = ~Source, type = "box") %>%
    layout(boxmode = "group")%>%
    layout(legend=list(orientation='h',xanchor="center",x=0.50,yanchor="top", y=-0.15))
  
    
  path="G:/My Drive/USGS_ConsumptiveUse/Spring, 2019/Statewide Analysis/Lit Compare/"
  file_name <- paste(path,"CU_Compare_Literature_with_all", ".pdf", sep="")
  plotly_IMAGE(x=compare_box_2,width=1000,height=700,format="pdf",out_file=file_name)
  
  
  defense<-rbind(lit.com,lit.energy,lit.industrial,lit.municipal,
                 match.energy,match.industrial,
                 fac.energy,fac.industrial,fac.com,match.com)
  
  compare_box_3<-plot_ly(defense, x = ~Sector, y = ~Consumption, color = ~Source, type = "box") %>%
    layout(boxmode = "group")%>%
    layout(legend=list(orientation='h',xanchor="center",x=0.50,yanchor="top", y=-0.15))
  
  
  
  defense2<-rbind(lit.com,lit.energy,lit.industrial,lit.municipal,
                 fac.energy,fac.industrial,fac.com,match.com,match.energy,
                 match.industrial,
                 all.municipal,all.energy,all.industrial,all.com)
  
  compare_box_4<-plot_ly(defense2, x = ~Sector, y = ~Consumption, color = ~Source, type = "box") %>%
    layout(boxmode = "group")%>%
    layout(legend=list(orientation='h',xanchor="center",x=0.50,yanchor="top", y=-0.15))
  
  
  path="G:/My Drive/USGS_ConsumptiveUse/Spring, 2019/Statewide Analysis/Lit Compare/"
  file_name <- paste(path,"CU_Compare_Literature_defense", ".pdf", sep="")
  plotly_IMAGE(x=compare_box_3,width=1000,height=700,format="pdf",out_file=file_name)
  
  path="G:/My Drive/USGS_ConsumptiveUse/Spring, 2019/Statewide Analysis/Lit Compare/"
  file_name <- paste(path,"CU_Compare_Literature_defense2", ".pdf", sep="")
  plotly_IMAGE(x=compare_box_4,width=1000,height=700,format="pdf",out_file=file_name)
  
  return(list(compare_box,compare_box_2,compare_box_3))
  
  
}
Compare.Studies()
#----------------------------------------------------------------------------------------------------------------------------------#
#------------------------------------------Consumption Coefficients Timeseries per Sector------------------------------------------#

TS_Sector_Consumption<- function(Discharge,Withdrawal,name,range){
  
  TS_Sector_Discharge<-Discharge%>%
    dplyr::group_by(Date,Sector=Use.Type)%>%
    dplyr::summarise(Discharge=sum(Discharges_MGD,na.rm=T))%>%
    tidyr::spread(Sector, Discharge)
  
  TS_Sector_Discharge<-TS_Sector_Discharge[-c(7)]
  TS_Sector_Discharge<-TS_Sector_Discharge%>%add_column(Agriculture=NA,.before = c("Aquaculture"))
  
  TS_Sector_Withdrawal<-Withdrawal%>%
    dplyr::group_by(Date,Sector=Use.Type)%>%
    dplyr::summarise(Withdrawal=sum(Withdrawals_MGD,na.rm=T))%>%
    tidyr::spread(Sector, Withdrawal)
  
  colnames(TS_Sector_Withdrawal)[2]<-c("Agriculture")
  
  CU_Function<-function(x,y) (ifelse(is.na(x),0,x)-ifelse(is.na(y),0,y))/(ifelse(is.na(x),0,x))
  
  df<-data.frame(Date=TS_Sector_Withdrawal$Date, mapply(CU_Function,TS_Sector_Withdrawal[2:range],TS_Sector_Discharge[2:range]),stringsAsFactors = F)
  
  
  is.nan.data.frame <- function(x)
    do.call(cbind, lapply(x, is.nan))
  
  df[is.nan.data.frame(df)]<-NA
  
  assign(name,df,envir=.GlobalEnv)

}
TS_Sector_Consumption(ECHO_2010_2017,VWUDS_2010_2017,"TS_Sector_CU",7)

TS_Sector_Consumption<- function(Discharge,Withdrawal,name,range){
  
  TS_Sector_Discharge<-Discharge%>%
    dplyr::group_by(Date,Sector=Use.Type)%>%
    dplyr::summarise(Discharge=sum(Discharges_MGD,na.rm=T))%>%
    tidyr::spread(Sector, Discharge)
  
  TS_Sector_Withdrawal<-Withdrawal%>%
    dplyr::group_by(Date,Sector=Use.Type)%>%
    dplyr::summarise(Withdrawal=sum(Withdrawals_MGD,na.rm=T))%>%
    tidyr::spread(Sector, Withdrawal)
  
  CU_Function<-function(x,y) (ifelse(is.na(x),0,x)-ifelse(is.na(y),0,y))/(ifelse(is.na(x),0,x))
  
  df<-data.frame(Date=TS_Sector_Withdrawal$Date, mapply(CU_Function,TS_Sector_Withdrawal[2:range],TS_Sector_Discharge[2:range]),stringsAsFactors = F)
  
  is.nan.data.frame <- function(x)
    do.call(cbind, lapply(x, is.nan))
  
  df[is.nan.data.frame(df)]<-NA
  
  assign(name,df,envir=.GlobalEnv)
  
}
TS_Sector_Consumption(full_match_2010_2017,full_match_2010_2017,"TS_Sector_CU_Match",5)

 save(TS_Sector_CU,file="G:/My Drive/ECHO NPDES/USGS_Consumptive_Use_Updated/Code/R Workspaces/TS_Sector_CU.RData")
 save(TS_Sector_CU_Match,file="G:/My Drive/ECHO NPDES/USGS_Consumptive_Use_Updated/Code/R Workspaces/TS_Sector_CU_Match.RData")
 
 TS_fueltype_Consumption<- function(Discharge,Withdrawal,name,range){
   
   TS_Sector_Discharge<-Discharge%>%
     dplyr::group_by(Date,Fuel_Type=Fuel_Type)%>%
     dplyr::summarise(Discharge=sum(Discharges_MGD,na.rm=T))%>%
     tidyr::spread(Fuel_Type, Discharge)
   
   TS_Sector_Withdrawal<-Withdrawal%>%
     dplyr::group_by(Date,Fuel_Type=Fuel_Type)%>%
     dplyr::summarise(Withdrawal=sum(Withdrawals_MGD,na.rm=T))%>%
     tidyr::spread(Fuel_Type, Withdrawal)
   
   CU_Function<-function(x,y) (ifelse(is.na(x),0,x)-ifelse(is.na(y),0,y))/(ifelse(is.na(x),0,x))
   
   df<-data.frame(Date=TS_Sector_Withdrawal$Date, mapply(CU_Function,TS_Sector_Withdrawal[2:range],TS_Sector_Discharge[2:range]),stringsAsFactors = F)
   
   is.nan.data.frame <- function(x)
     do.call(cbind, lapply(x, is.nan))
   
   df[is.nan.data.frame(df)]<-NA
   
   assign(name,df,envir=.GlobalEnv)
   
 }
 TS_fueltype_Consumption(full_match_2010_2017,full_match_2010_2017,"TS_Fuel_CU",5)
 
 save(TS_Fuel_CU,file="G:/My Drive/ECHO NPDES/USGS_Consumptive_Use_Updated/Code/R Workspaces/TS_Fuel_CU.RData")
 
 
 TS_Consumption_nonenergy<- function(Discharge,Withdrawal,name){
   
   TS_Discharge<-Discharge[!Discharge$Use.Type=="Energy",]%>%
     dplyr::group_by(Date)%>%
     dplyr::summarise(Discharge=sum(Discharges_MGD,na.rm=T))
   
   TS_Withdrawal<-Withdrawal[!Withdrawal$Use.Type=="Energy",]%>%
     dplyr::group_by(Date)%>%
     dplyr::summarise(Withdrawal=sum(Withdrawals_MGD,na.rm=T))
   
   TS_Discharge<-TS_Discharge[complete.cases(TS_Discharge),]
   TS_Withdrawal<-TS_Withdrawal[complete.cases(TS_Withdrawal),]
   
   CU_Function<-function(x,y) (ifelse(is.na(x),0,x)-ifelse(is.na(y),0,y))/(ifelse(is.na(x),0,x))
   
   df<-data.frame(Date=TS_Discharge$Date, mapply(CU_Function,TS_Withdrawal[2],TS_Discharge[2]),stringsAsFactors = F)
   
   colnames(df)<-c("Date","Consumption")
   
   assign(name,df,envir=.GlobalEnv)
   
   Ave_CU<-df%>%dplyr::group_by(Year=substr(Date,1,4))%>%dplyr::summarise(Med_CU=mean(Consumption,na.rm=T),Ave_CU=mean(Consumption,na.rm=T))
   Long_term_ave<-mean(Ave_CU$Med_CU)
   
   return(list(Ave_CU,Long_term_ave))
 }
 TS_Consumption_nonenergy(ECHO_2010_2017,VWUDS_2010_2017,"TS_nonenergy_all")
 TS_Consumption_nonenergy(full_match_2010_2017,full_match_2010_2017,"TS_nonenergy_match")
 
 save(TS_nonenergy_all,file="G:/My Drive/ECHO NPDES/USGS_Consumptive_Use_Updated/Code/R Workspaces/TS_nonenergy_all.RData")
 save(TS_nonenergy_match,file="G:/My Drive/ECHO NPDES/USGS_Consumptive_Use_Updated/Code/R Workspaces/TS_nonenergy_match.RData")
#----------------------------------------------------------------------------------------------------------------------------------#
#------------------------------------------Consumption Coefficients Timeseries-----------------------------------------------------#

#---------Statewide Level---------#

TS_Consumption<- function(Discharge,Withdrawal,name){
  
  TS_Discharge<-Discharge%>%
    dplyr::group_by(Date)%>%
    dplyr::summarise(Discharge=sum(Discharges_MGD,na.rm=T))
  
  TS_Withdrawal<-Withdrawal%>%
    dplyr::group_by(Date)%>%
    dplyr::summarise(Withdrawal=sum(Withdrawals_MGD,na.rm=T))
  
  CU_Function<-function(x,y) (ifelse(is.na(x),0,x)-ifelse(is.na(y),0,y))/(ifelse(is.na(x),0,x))
  
  df<-data.frame(Date=TS_Withdrawal$Date, mapply(CU_Function,TS_Withdrawal[2],TS_Discharge[2]),stringsAsFactors = F)
    
  colnames(df)<-c("Date","Consumption")
  
  assign(name,df,envir=.GlobalEnv)
  
  Ave_CU<-df%>%dplyr::group_by(Year=substr(Date,1,4))%>%dplyr::summarise(Med_CU=mean(Consumption,na.rm=T),Ave_CU=mean(Consumption,na.rm=T))
  Long_term_ave<-mean(Ave_CU$Med_CU)
  
  return(list(Ave_CU,Long_term_ave))
}
TS_Consumption(ECHO_2010_2017,VWUDS_2010_2017,"TS_CU")
TS_Consumption(full_match_2010_2017,full_match_2010_2017,"TS_CU_Match")

 save(TS_CU,file="G:/My Drive/ECHO NPDES/USGS_Consumptive_Use_Updated/Code/R Workspaces/TS_CU.RData")
 save(TS_CU_Match,file="G:/My Drive/ECHO NPDES/USGS_Consumptive_Use_Updated/Code/R Workspaces/TS_CU_Match.RData")
#-----------Facility Level------#

TS_CU_Match_Fac<-full_match_2010_2017%>%
  dplyr::group_by(VWUDS.Facility.ID,Date)%>%
  dplyr::summarise(VPDES.Facility.ID=first(VPDES.Facility.ID),Facility_Name=first(VWUDS.Name),
                   Use.Type=first(Use.Type),Withdrawals_MGD=first(Withdrawals_MGD),Discharges_MGD=first(Discharges_MGD),
                   CU=first(CU))

save(TS_CU_Match_Fac,file="G:/My Drive/ECHO NPDES/USGS_Consumptive_Use_Updated/Code/R Workspaces/TS_CU_Match_Fac.RData")

#----------------------------------------------------------------------------------------------------------------------------------------------#


