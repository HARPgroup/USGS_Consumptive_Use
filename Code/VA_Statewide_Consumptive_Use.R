###############################################################################################################################################
#########################################################State Level Analysis##################################################################

#Primary Author: Morgan McCarthy, M.S. Biological Systems Engineering, Virginia Tech

#-----------------------------------------------------------Purpose---------------------------------------------------------------------------#

# The purpose of this script is to compare withdrawals, discharges, and consumption over time on a state-wide level for the Commonwealth of
# Virginia. Discharge data is withdrawn from the EPA's ECHO system, using the ECHO_Timeseries.R script. This data is then cleaned in the 
# ECHO_QAQC.R script. Withdrawal data is obtained from the VDEQ's VA Hydro system, which is only available through collaboration. Please 
# contact the Office of Water Supply if you are interested in collaboration. Withdrawal data is cleaned in the VWUDS_QAQC.R script. Water
# sectors for each facility in both datasets are classified in the ECHO_QAQC.R and VWUDS_QAQC.R scripts. 

# Consumption, in this analysis, is defined as water that is permanently removed from a water resource system and not replaced. It is 
# calculated as a water balance, with water in being discharges and water out being withdrawals. 

##################################################Library Initilization########################################################################
rm(list=ls())

library(foreign) #allows for easy manipulation of *.dbf file types
library(rgdal) #extract files from file geodatabases-like in ArcMap
library(dplyr)#data manipulation package that speeds up grouping, summarizing, ordering. 
library(XML) #downloads and reads XML file types-used to access ECHORest Services to download facilities
library(RCurl) #downloads and interacts with web-based content
library(readxl) #reads excel files
library(jsonlite)
library(httr)
library(proj4)
library(data.table)
library(stringr)
library(plotly)
library(shiny)
library(lubridate)
library(RColorBrewer)
library(tibble)
library(tidyr)

options(scipen=999) #Disable scientific notation

################################################################Inputs########################################################################

#----------------------------------------------------Cleaned Discharge Data-----------------------------------------------------------------#
# This discharge data was generated by the ECHO_Timeseries.R script and cleaned in the VPDES_QAQC.R Script

#--Load Discharge Timeseries Data--#
ECHO_2010_2017<-read.table("G:/My Drive/ECHO NPDES/USGS_Consumptive_Use_Updated/ECHO_2010_2017_QAQC.txt", sep="\t", header=T)

#--Facilties that are represented with a different outfall rather than 001--#
North_Anna<-subset(ECHO_2010_2017,ECHO_2010_2017$Permit_Type=="NPDES Individual Permit"&ECHO_2010_2017$OutfallID=="VA0052451101") 
Mecklenburg<-subset(ECHO_2010_2017,ECHO_2010_2017$Permit_Type=="NPDES Individual Permit"&ECHO_2010_2017$OutfallID=="VA0084069101")
Clinch<-subset(ECHO_2010_2017,ECHO_2010_2017$Permit_Type=="NPDES Individual Permit"&ECHO_2010_2017$OutfallID=="VA0001015003")
Chesterfield<-subset(ECHO_2010_2017,ECHO_2010_2017$Permit_Type=="NPDES Individual Permit"&ECHO_2010_2017$OutfallID=="VA0004146003")
Yorktown<-subset(ECHO_2010_2017,ECHO_2010_2017$Permit_Type=="NPDES Individual Permit"&ECHO_2010_2017$OutfallID=="VA0004103002")
Glen_Lyn<-subset(ECHO_2010_2017,ECHO_2010_2017$Permit_Type=="NPDES Individual Permit"&ECHO_2010_2017$OutfallID=="VA0000370005")
Hopewell<-subset(ECHO_2010_2017,ECHO_2010_2017$Permit_Type=="NPDES Individual Permit"&ECHO_2010_2017$OutfallID=="VA0066630101")
Franklin<-subset(ECHO_2010_2017,ECHO_2010_2017$Permit_Type=="NPDES Individual Permit"&ECHO_2010_2017$OutfallID=="VA0004162103")
GP<-subset(ECHO_2010_2017,ECHO_2010_2017$Permit_Type=="NPDES Individual Permit"&ECHO_2010_2017$OutfallID=="VA0003026002")
AAT<-subset(ECHO_2010_2017,ECHO_2010_2017$Permit_Type=="NPDES Individual Permit"&ECHO_2010_2017$OutfallID=="VA0002160101")

ECHO_2010_2017<-subset(ECHO_2010_2017, subset=ECHO_2010_2017$Permit_Type=="NPDES Individual Permit"
                       &str_sub(ECHO_2010_2017$OutfallID, start=-3)=="001")
  
ECHO_2010_2017<-subset(ECHO_2010_2017, subset=ECHO_2010_2017$Permit_Type=="NPDES Individual Permit"
                       &str_sub(ECHO_2010_2017$OutfallID, start=-3)=="001"
                       &!ECHO_2010_2017$OutfallID=="VA0052451001"
                       &!ECHO_2010_2017$OutfallID=="VA0084069001"
                       &!ECHO_2010_2017$OutfallID=="VA0001015001"
                       &!ECHO_2010_2017$OutfallID=="VA0004146001"
                       &!ECHO_2010_2017$OutfallID=="VA0004103001"
                       &!ECHO_2010_2017$OutfallID=="VA0000370001"
                       &!ECHO_2010_2017$OutfallID=="VA0004162001"
                       &!ECHO_2010_2017$OutfallID=="VA0066630001"
                       &!ECHO_2010_2017$OutfallID=="VA0003026001"
                       &!ECHO_2010_2017$OutfallID=="VA0002160001")

ECHO_2010_2017<-rbind(ECHO_2010_2017,North_Anna,Mecklenburg,Clinch,Chesterfield,Yorktown,Glen_Lyn,Hopewell,Franklin,GP,AAT)
rm(Clinch, Mecklenburg, North_Anna,Chesterfield,Yorktown,Glen_Lyn,Franklin,Hopewell,GP,AAT)



#--Facilities with Matched Withdrawal Facility--#
Matched<-read.csv("G:/My Drive/USGS_ConsumptiveUse/Spring, 2019/Matched Facilities/Runninglist_Matches.csv")
Match_ECHO_2010_2017<-subset(ECHO_2010_2017,ECHO_2010_2017$Facility.ID%in%gsub("echo_","",Matched$VPDES.Hydrocode), select=c(1,3:8,12,19,33,42,43))
colnames(Match_ECHO_2010_2017)<-c("OutfallID","VPDES.Facility.ID","VPDES.Name","Fac.Lat","Fac.Long","VPDES.Outfall.Long",
                                  "VPDES.Outfall.Lat", "Discharges_MGD", "Date","County","Waterbody","Use.Type")
Match_ECHO_2010_2017$MatchID<-Matched$MatchID[match(Match_ECHO_2010_2017$VPDES.Facility.ID,gsub("echo_","",Matched$VPDES.Hydrocode))]
Match_ECHO_2010_2017$Date<-as.Date(Match_ECHO_2010_2017$Date,format="%Y-%m-%d")

ECHO_2010_2017<-subset(ECHO_2010_2017,select=c(1:8,10,12,19,33,39,42,43,44))
colnames(ECHO_2010_2017)<-c("OutfallID","Year","VPDES.Facility.ID","VPDES.Name","Fac.Lat","Fac.Long",
                            "Outfall.Lat","Outfall.Long","Measured_Effluent","Discharges_MGD","Date","County",
                            "Permit_Type","Waterbody","Use.Type","Mon_Reported")

write.table(ECHO_2010_2017,file="G:/My Drive/ECHO NPDES/USGS_Consumptive_Use_Updated/ECHO_2010_2017_QAQC_statewide.txt",sep="\t")

#------------------------------------------------------------------------------------------------------------------------------------------#
#-----------------------------------------------Cleaned Withdrawal Data--------------------------------------------------------------------#
# Withdrawal data was obtained through VDEQ's VA Hydro site, which can only be obtained through collaboration.
# Data was analyzed, coordinates were corrected, and water sectors were classified in VWUDS_QAQC.R Script. 

#--Load Withdrawal Timeseries Data--#
load("G:/My Drive/ECHO NPDES/USGS_Consumptive_Use_Updated/Code/R Workspaces/VWUDS_2010_2017.RData")

# load("G:/My Drive/ECHO NPDES/USGS_Consumptive_Use_Updated/Code/R Workspaces/VWUDS_Owners.RData")
# Owners<-read.csv("G:/My Drive/VWUDS Data/vwuds_monthly_wateruse.csv", sep=",", header=T)

VWUDS_2010_2017<-as.data.table(VWUDS_2010_2017)
VWUDS_2010_2017<-VWUDS_2010_2017[order(VWUDS_2010_2017[,1],VWUDS_2010_2017[,8],decreasing=F),]
colnames(VWUDS_2010_2017)[3]<-"VWUDS.Facility.ID"
colnames(VWUDS_2010_2017)[10]<-"Old.Use.Type"
colnames(VWUDS_2010_2017)[20]<-"Use.Type"

#--Facilities with Matched Discharge Facility--#
Match_VWUDS_2010_2017<-subset(VWUDS_2010_2017,VWUDS_2010_2017$VWUDS.Facility.ID%in%Matched$VWUDS.HydroID)
Match_VWUDS_2010_2017<-Match_VWUDS_2010_2017%>%
  dplyr::group_by(VWUDS.Facility.ID,Date)%>%
  dplyr::summarise(VWUDS.Name=first(Facility),Withdrawal_mgd=sum(Withdrawals_MGD,na.rm=T),VWUDS.Lat=mean(Corrected_Latitude,na.rm=T),VWUDS.Long=mean(Corrected_Longitude,na.rm=T),
                   VWUDS.Use.Type=first(Use.Type))

colnames(Match_VWUDS_2010_2017)<-c("VWUDS.Facility.ID","Date","VWUDS.Name","Withdrawals_MGD","VWUDS.Lat",
                                   "VWUDS.Long","VWUDS.Use.Type")
Match_VWUDS_2010_2017$MatchID<-Matched$MatchID[match(Match_VWUDS_2010_2017$VWUDS.Facility.ID,Matched$VWUDS.HydroID)]

#-----------------------------Matched Data----------------------------------#
# Look for "fully" matched results for each month. 

full_match_2010_2017<-merge(Match_VWUDS_2010_2017,Match_ECHO_2010_2017,by=c("MatchID","Date"))
full_match_2010_2017<-full_match_2010_2017[,c("VPDES.Facility.ID","OutfallID","VWUDS.Facility.ID","VWUDS.Name","VPDES.Name","Use.Type",
                      "Fac.Lat","Fac.Long","VWUDS.Lat","VWUDS.Long","Date","Withdrawals_MGD","Discharges_MGD","County","Waterbody")]

full_match_2010_2017<-full_match_2010_2017%>%add_column(CU=(full_match_2010_2017$Withdrawals_MGD-full_match_2010_2017$Discharges_MGD)/full_match_2010_2017$Withdrawals_MGD, .after="Discharges_MGD")

full_match_2010_2017_summary<-full_match_2010_2017%>%dplyr::group_by(VPDES.Facility.ID)%>%
  summarise(VWUDS.Facility.ID=first(VWUDS.Facility.ID),OutfallID=first(OutfallID),VWUDS.Name=first(VWUDS.Name),VPDES.Name=first(VPDES.Name),
            Use.Type=first(Use.Type), VPDES.Fac.Lat=first(Fac.Lat),VPDES.Fac.Long=first(Fac.Long),VWUDS.Fac.Lat=first(VWUDS.Lat),VWUDS.Fac.Long=first(VWUDS.Long),
            Ave_Withdrawal_mgd=mean(Withdrawals_MGD,na.rm=T),Ave_Discharge_mgd=mean(Discharges_MGD,na.rm=T),County=first(County),Waterbody=first(Waterbody))

full_match_2010_2017_summary$VPDES_perc<-Matched$VPDES...total[match(full_match_2010_2017_summary$VWUDS.Facility.ID,Matched$VWUDS.HydroID)]
full_match_2010_2017_summary$VWUDS_perc<-Matched$VWUDS...total[match(full_match_2010_2017_summary$VWUDS.Facility.ID,Matched$VWUDS.HydroID)]

# write.csv(full_match_2010_2017_summary,file="G:/My Drive/USGS_ConsumptiveUse/Spring, 2019/Statewide Analysis/fully_matched_summary.csv",row.names=F)

#############################################################Analysis########################################################################

#-------------------------------------------------Statewide Withdrawals vs. Discharges------------------------------------------------------#


#--------------------------------Cumulative Percentage of Total Water Withdrawn by each Facility------------------------------------------#

#--------------------Withdrawals------------------#
# Not all facilities report 12 months out of the year. Therefore, if we want to aggregate monthly withdrawals into yearly estimates for each
# facility, we must divide by the number of reporting months. 

W_Months<-
   full_match_2010_2017%>%
   dplyr::group_by(VWUDS.Facility.ID,Year=substring(Date,1,4))%>%
   dplyr::count(Month=substring(Date,6,7))%>%
   dplyr::summarise(Mon_Reported=sum(n))
 
full_match_2010_2017<-full_match_2010_2017%>%add_column(Year=substring(full_match_2010_2017$Date,1,4), .after="Date")
full_match_2010_2017<-merge(full_match_2010_2017,W_Months,by=c("VWUDS.Facility.ID","Year"),all.x=T)

#--------------------------------------------#

Facility_Withdrawals<-VWUDS_2010_2017%>%
  dplyr::group_by(VWUDS.Facility.ID,Year)%>%
  dplyr::summarise(Facility_Name=first(Facility),
                   Sources=n_distinct(DEQ.ID.of.Source),
                   Ave_Mon_Reported=mean(Mon_Reported),
                   Withdrawals_MGal=sum(Million.Gallons.Month,na.rm=T),
                   Withdrawals_MGD=sum(Withdrawals_MGD,na.rm=T)/first(Mon_Reported),
                   Sector=first(Use.Type))%>%arrange(desc(Withdrawals_MGD))

Matched_Facility_Withdrawals<-full_match_2010_2017%>%
  dplyr::group_by(VWUDS.Facility.ID,Year=substr(Date,1,4))%>%
  dplyr::summarise(Facility_Name=first(VWUDS.Name),
                   Withdrawals_MGD=sum(Withdrawals_MGD,na.rm=T)/first(Mon_Reported),
                   Sector=first(Use.Type))%>%arrange(desc(Withdrawals_MGD))

#--Aggregated withdrawals and % of total water withdrawn per year (on average)--#

Cum_Withdrawal<- function(Facility_Withdrawals,label){
  
  Withdrawal<-data.frame("VWUDS.Facility.ID"=unique(Facility_Withdrawals$VWUDS.Facility.ID))
  Withdrawal$Facility_Name<-ifelse(Withdrawal$VWUDS.Facility.ID%in%Facility_Withdrawals$VWUDS.Facility.ID,Facility_Withdrawals$Facility_Name[match(Withdrawal$VWUDS.Facility.ID,Facility_Withdrawals$VWUDS.Facility.ID)],NA)
  
  Withdrawal$MGD_2010<-ifelse(Withdrawal$VWUDS.Facility.ID%in%Facility_Withdrawals$VWUDS.Facility.ID[Facility_Withdrawals$Year=="2010"],Facility_Withdrawals$Withdrawals_MGD[Facility_Withdrawals$Year=="2010"][match(Withdrawal$VWUDS.Facility.ID,Facility_Withdrawals$VWUDS.Facility.ID[Facility_Withdrawals$Year=="2010"])],NA)
  Withdrawal$MGD_2011<-ifelse(Withdrawal$VWUDS.Facility.ID%in%Facility_Withdrawals$VWUDS.Facility.ID[Facility_Withdrawals$Year=="2011"],Facility_Withdrawals$Withdrawals_MGD[Facility_Withdrawals$Year=="2011"][match(Withdrawal$VWUDS.Facility.ID,Facility_Withdrawals$VWUDS.Facility.ID[Facility_Withdrawals$Year=="2011"])],NA)
  Withdrawal$MGD_2012<-ifelse(Withdrawal$VWUDS.Facility.ID%in%Facility_Withdrawals$VWUDS.Facility.ID[Facility_Withdrawals$Year=="2012"],Facility_Withdrawals$Withdrawals_MGD[Facility_Withdrawals$Year=="2012"][match(Withdrawal$VWUDS.Facility.ID,Facility_Withdrawals$VWUDS.Facility.ID[Facility_Withdrawals$Year=="2012"])],NA)
  Withdrawal$MGD_2013<-ifelse(Withdrawal$VWUDS.Facility.ID%in%Facility_Withdrawals$VWUDS.Facility.ID[Facility_Withdrawals$Year=="2013"],Facility_Withdrawals$Withdrawals_MGD[Facility_Withdrawals$Year=="2013"][match(Withdrawal$VWUDS.Facility.ID,Facility_Withdrawals$VWUDS.Facility.ID[Facility_Withdrawals$Year=="2013"])],NA)
  Withdrawal$MGD_2014<-ifelse(Withdrawal$VWUDS.Facility.ID%in%Facility_Withdrawals$VWUDS.Facility.ID[Facility_Withdrawals$Year=="2014"],Facility_Withdrawals$Withdrawals_MGD[Facility_Withdrawals$Year=="2014"][match(Withdrawal$VWUDS.Facility.ID,Facility_Withdrawals$VWUDS.Facility.ID[Facility_Withdrawals$Year=="2014"])],NA)
  Withdrawal$MGD_2015<-ifelse(Withdrawal$VWUDS.Facility.ID%in%Facility_Withdrawals$VWUDS.Facility.ID[Facility_Withdrawals$Year=="2015"],Facility_Withdrawals$Withdrawals_MGD[Facility_Withdrawals$Year=="2015"][match(Withdrawal$VWUDS.Facility.ID,Facility_Withdrawals$VWUDS.Facility.ID[Facility_Withdrawals$Year=="2015"])],NA)
  Withdrawal$MGD_2016<-ifelse(Withdrawal$VWUDS.Facility.ID%in%Facility_Withdrawals$VWUDS.Facility.ID[Facility_Withdrawals$Year=="2016"],Facility_Withdrawals$Withdrawals_MGD[Facility_Withdrawals$Year=="2016"][match(Withdrawal$VWUDS.Facility.ID,Facility_Withdrawals$VWUDS.Facility.ID[Facility_Withdrawals$Year=="2016"])],NA)
  Withdrawal$MGD_2017<-ifelse(Withdrawal$VWUDS.Facility.ID%in%Facility_Withdrawals$VWUDS.Facility.ID[Facility_Withdrawals$Year=="2017"],Facility_Withdrawals$Withdrawals_MGD[Facility_Withdrawals$Year=="2017"][match(Withdrawal$VWUDS.Facility.ID,Facility_Withdrawals$VWUDS.Facility.ID[Facility_Withdrawals$Year=="2017"])],NA)
  
  for (i in 1:length(Withdrawal$VWUDS.Facility.ID)){
    Withdrawal$Sum_2010_2017[i]<-(ifelse(is.na(Withdrawal$MGD_2010[i]),0,Withdrawal$MGD_2010[i])+
                                    ifelse(is.na(Withdrawal$MGD_2011[i]),0,Withdrawal$MGD_2011[i])+
                                    ifelse(is.na(Withdrawal$MGD_2012[i]),0,Withdrawal$MGD_2012[i])+
                                    ifelse(is.na(Withdrawal$MGD_2013[i]),0,Withdrawal$MGD_2013[i])+
                                    ifelse(is.na(Withdrawal$MGD_2014[i]),0,Withdrawal$MGD_2014[i])+
                                    ifelse(is.na(Withdrawal$MGD_2015[i]),0,Withdrawal$MGD_2015[i])+
                                    ifelse(is.na(Withdrawal$MGD_2016[i]),0,Withdrawal$MGD_2016[i])+
                                    ifelse(is.na(Withdrawal$MGD_2017[i]),0,Withdrawal$MGD_2017[i]))
  }
  Withdrawal$Ave_2010_2017<-Withdrawal$Sum_2010_2017/8
  
  Withdrawal_Sector<-Facility_Withdrawals%>%
    dplyr::group_by(VWUDS.Facility.ID)%>%
    dplyr::summarise(Sector=first(Sector))
  
  Withdrawal<-merge(Withdrawal,Withdrawal_Sector,by="VWUDS.Facility.ID",all.X=T)
  
  # Pecentage of total water withdrawn on average from 2010 to 2017 #
  Withdrawal$perc_total<-Withdrawal$Ave_2010_2017/sum(Withdrawal$Ave_2010_2017)
  Withdrawal<-Withdrawal%>%arrange(desc(perc_total))
  
  # cumulative percentage
  Withdrawal$cum_total<-cumsum(Withdrawal$perc_total)/sum(Withdrawal$perc_total)
  n<-count(Withdrawal,VWUDS.Facility.ID)
  Withdrawal$cum_fac<-cumsum(n$n)
  
  # Energy Sector
  Withdrawal_Energy<-subset(Withdrawal,subset=Withdrawal$Sector=="Energy")
  Withdrawal_Energy$cum_total<-cumsum(Withdrawal_Energy$perc_total)/sum(Withdrawal$perc_total) #total out of all withdrawals
  n<-count(Withdrawal_Energy,VWUDS.Facility.ID)
  Withdrawal_Energy$cum_fac<-cumsum(n$n)
  
  # Non-Energy Sectors
  Withdrawal_nonEnergy<-subset(Withdrawal,subset=!(Withdrawal$Sector=="Energy"))
  Withdrawal_nonEnergy$cum_total<-cumsum(Withdrawal_nonEnergy$perc_total)/sum(Withdrawal$perc_total) #total out of all withdrawals
  n<-count(Withdrawal_nonEnergy,VWUDS.Facility.ID)
  Withdrawal_nonEnergy$cum_fac<-cumsum(n$n)
  
  
  label1<-list(
    xref='x',
    yref='y',
    x=Withdrawal$cum_fac[1],
    y=Withdrawal$cum_total[1],
    xanchor='left',
    yanchor='middle',
    text= ~paste(round(Withdrawal$cum_total[1],digits=2)),
    font = list(family = 'helvetica', size = 12),
    showarrow = FALSE)
  
  label2<-list(
    xref='x',
    yref='y',
    x=Withdrawal_Energy$cum_fac[1],
    y=Withdrawal_Energy$cum_total[1],
    xanchor='left',
    yanchor='middle',
    text= ~paste(round(Withdrawal_Energy$cum_total[1],digits=2)),
    font = list(family = 'helvetica', size = 12),
    showarrow = F)
  
  label3<-list(
    xref='x',
    yref='y',
    x=Withdrawal_nonEnergy$cum_fac[1],
    y=Withdrawal_nonEnergy$cum_total[1],
    xanchor='left',
    yanchor='middle',
    text= ~paste(round(Withdrawal_nonEnergy$cum_total[1],digits=2)),
    font = list(family = 'helvetica', size = 12),
    showarrow = F)
  
  plot1<-Withdrawal%>%
    plot_ly(x= ~cum_fac)%>%
    add_trace(y = ~cum_total, name=paste0(label," Facilities"), type = 'scatter', mode = 'lines', line=list(color='red',width=6))%>%
    add_trace(x=Withdrawal_Energy$cum_fac,y=Withdrawal_Energy$cum_total, name=paste0(label, " Energy Facilities"), type='scatter', mode='lines',line=list(color='black', width=6,dash='dash'))%>%
    add_trace(x=Withdrawal_nonEnergy$cum_fac,y=Withdrawal_nonEnergy$cum_total, name=paste0(label, " Non-Energy Facilities"), type='scatter', mode='lines',line=list(color='black',width=6,dash='dot'))%>%
    layout(title = "Cumulative Distribution of % Water Withdrawn in Virginia",
           xaxis=list(title="Number of Reporting Facilities"),
           yaxis=list(title="Cumulative % of total Water Withdrawn",
                      range=c(0,1.1)),
           font = list(family= "helvetica", size= 12),
           annotations=label1)%>%
    layout(annotations=label2)%>%
    layout(annotations=label3)
  
  Withdrawal<<-Withdrawal
  
  Yearly_Withdrawal<-Facility_Withdrawals%>%
    dplyr::group_by(Year)%>%
    dplyr::summarise(Withdrawals_MGD=sum(Withdrawals_MGD),nFacilities=n_distinct(VWUDS.Facility.ID))
  
  return(list(Yearly_Withdrawal,plot1))
  
}
Cum_Withdrawal(Matched_Facility_Withdrawals,"Matched")
# Cum_Withdrawal(Facility_Withdrawals, "All")

#-----Major Withdrawers----#
# Major_With<-subset(Withdrawal,subset=Withdrawal$cum_total<=0.95)
# Major_VWUDS_2010_2017<-subset(VWUDS_2010_2017,subset=VWUDS_2010_2017$VWUDS.Facility.ID%in%Major_With$Facility.ID)
# Major_VWUDS_2010_2017%>%dplyr::group_by(VWUDS.Facility.ID)%>%summarise(Facility=first(Facility))
# 
# #-----Matched Withdrawers--#
# Match_With<-subset(Withdrawal,subset=Withdrawal$VWUDS.Facility.ID%in%full_match_2010_2017$VWUDS.Facility.ID)

#----------------------Discharges-------------------------#
Facility_Discharges<-ECHO_2010_2017%>%
  dplyr::group_by(VPDES.Facility.ID,Year)%>%
  dplyr::summarise(Facility_Name=first(VPDES.Name),
                   Outfalls=n_distinct(OutfallID),
                   Ave_Mon_Reported=mean(Mon_Reported),
                   Discharges_MGD=sum(Discharges_MGD, na.rm=T)/first(Mon_Reported),
                   Sector=first(Use.Type))%>%arrange(desc(Discharges_MGD))

Facility_Discharges$Facility_Name<-lapply(Facility_Discharges$Facility_Name,as.character)

Matched_Facility_Discharges<-full_match_2010_2017%>%
  dplyr::group_by(VPDES.Facility.ID,Year)%>%
  dplyr::summarise(Facility_Name=first(VPDES.Name),
                   Discharges_MGD=sum(Discharges_MGD, na.rm=T)/first(Mon_Reported),
                   Sector=first(Use.Type))%>%arrange(desc(Discharges_MGD))
Matched_Facility_Discharges$Facility_Name<-lapply(Matched_Facility_Discharges$Facility_Name,as.character)

#--Aggregated dischareges and % of total water discharged per year (on average)--#

Cum_Discharge<- function(Facility_Discharges,label){
  Discharge<-data.frame("VPDES.Facility.ID"=unique(Facility_Discharges$VPDES.Facility.ID),stringsAsFactors = F)
  Discharge$Facility_Name<-ifelse(Discharge$VPDES.Facility.ID%in%Facility_Discharges$VPDES.Facility.ID,Facility_Discharges$Facility_Name[match(Discharge$VPDES.Facility.ID,Facility_Discharges$VPDES.Facility.ID)],NA)
  
  Discharge$MGD_2010<-ifelse(Discharge$VPDES.Facility.ID%in%Facility_Discharges$VPDES.Facility.ID[Facility_Discharges$Year=="2010"],Facility_Discharges$Discharges_MGD[Facility_Discharges$Year=="2010"][match(Discharge$VPDES.Facility.ID,Facility_Discharges$VPDES.Facility.ID[Facility_Discharges$Year=="2010"])],NA)
  Discharge$MGD_2011<-ifelse(Discharge$VPDES.Facility.ID%in%Facility_Discharges$VPDES.Facility.ID[Facility_Discharges$Year=="2011"],Facility_Discharges$Discharges_MGD[Facility_Discharges$Year=="2011"][match(Discharge$VPDES.Facility.ID,Facility_Discharges$VPDES.Facility.ID[Facility_Discharges$Year=="2011"])],NA)
  Discharge$MGD_2012<-ifelse(Discharge$VPDES.Facility.ID%in%Facility_Discharges$VPDES.Facility.ID[Facility_Discharges$Year=="2012"],Facility_Discharges$Discharges_MGD[Facility_Discharges$Year=="2012"][match(Discharge$VPDES.Facility.ID,Facility_Discharges$VPDES.Facility.ID[Facility_Discharges$Year=="2012"])],NA)
  Discharge$MGD_2013<-ifelse(Discharge$VPDES.Facility.ID%in%Facility_Discharges$VPDES.Facility.ID[Facility_Discharges$Year=="2013"],Facility_Discharges$Discharges_MGD[Facility_Discharges$Year=="2013"][match(Discharge$VPDES.Facility.ID,Facility_Discharges$VPDES.Facility.ID[Facility_Discharges$Year=="2013"])],NA)
  Discharge$MGD_2014<-ifelse(Discharge$VPDES.Facility.ID%in%Facility_Discharges$VPDES.Facility.ID[Facility_Discharges$Year=="2014"],Facility_Discharges$Discharges_MGD[Facility_Discharges$Year=="2014"][match(Discharge$VPDES.Facility.ID,Facility_Discharges$VPDES.Facility.ID[Facility_Discharges$Year=="2014"])],NA)
  Discharge$MGD_2015<-ifelse(Discharge$VPDES.Facility.ID%in%Facility_Discharges$VPDES.Facility.ID[Facility_Discharges$Year=="2015"],Facility_Discharges$Discharges_MGD[Facility_Discharges$Year=="2015"][match(Discharge$VPDES.Facility.ID,Facility_Discharges$VPDES.Facility.ID[Facility_Discharges$Year=="2015"])],NA)
  Discharge$MGD_2016<-ifelse(Discharge$VPDES.Facility.ID%in%Facility_Discharges$VPDES.Facility.ID[Facility_Discharges$Year=="2016"],Facility_Discharges$Discharges_MGD[Facility_Discharges$Year=="2016"][match(Discharge$VPDES.Facility.ID,Facility_Discharges$VPDES.Facility.ID[Facility_Discharges$Year=="2016"])],NA)
  Discharge$MGD_2017<-ifelse(Discharge$VPDES.Facility.ID%in%Facility_Discharges$VPDES.Facility.ID[Facility_Discharges$Year=="2017"],Facility_Discharges$Discharges_MGD[Facility_Discharges$Year=="2017"][match(Discharge$VPDES.Facility.ID,Facility_Discharges$VPDES.Facility.ID[Facility_Discharges$Year=="2017"])],NA)
  
  for (i in 1:length(Discharge$VPDES.Facility.ID)){
    Discharge$Sum_2010_2017[i]<-(ifelse(is.na(Discharge$MGD_2010[i]),0,Discharge$MGD_2010[i])+
                                   ifelse(is.na(Discharge$MGD_2011[i]),0,Discharge$MGD_2011[i])+
                                   ifelse(is.na(Discharge$MGD_2012[i]),0,Discharge$MGD_2012[i])+
                                   ifelse(is.na(Discharge$MGD_2013[i]),0,Discharge$MGD_2013[i])+
                                   ifelse(is.na(Discharge$MGD_2014[i]),0,Discharge$MGD_2014[i])+
                                   ifelse(is.na(Discharge$MGD_2015[i]),0,Discharge$MGD_2015[i])+
                                   ifelse(is.na(Discharge$MGD_2016[i]),0,Discharge$MGD_2016[i])+
                                   ifelse(is.na(Discharge$MGD_2017[i]),0,Discharge$MGD_2017[i]))
  }
  Discharge$Ave_2010_2017<-Discharge$Sum_2010_2017/8
  
  Discharge_Sector<-Facility_Discharges%>%
    dplyr::group_by(VPDES.Facility.ID)%>%
    dplyr::summarise(Sector=first(Sector))
  
  Discharge<-merge(Discharge,Discharge_Sector,by="VPDES.Facility.ID",all.X=T)
  
  # Pecentage of total water withdrawn on average from 2010 to 2017 #
  Discharge$perc_total<-Discharge$Ave_2010_2017/sum(Discharge$Ave_2010_2017)
  Discharge<-Discharge%>%arrange(desc(perc_total))
  
  # cumulative percentage
  Discharge$cum_total<-cumsum(Discharge$perc_total)/sum(Discharge$perc_total)
  n<-count(Discharge,VPDES.Facility.ID)
  Discharge$cum_fac<-cumsum(n$n)
  
  # Energy Sector
  Discharge_Energy<-subset(Discharge,subset=Discharge$Sector=="Energy")
  Discharge_Energy$cum_total<-cumsum(Discharge_Energy$perc_total)/sum(Discharge$perc_total) #total out of all Discharges
  n<-count(Discharge_Energy,VPDES.Facility.ID)
  Discharge_Energy$cum_fac<-cumsum(n$n)
  
  # Energy Sector
  Discharge_nonEnergy<-subset(Discharge,subset=!(Discharge$Sector=="Energy"))
  Discharge_nonEnergy$cum_total<-cumsum(Discharge_nonEnergy$perc_total)/sum(Discharge$perc_total) #total out of all Discharges
  n<-count(Discharge_nonEnergy,VPDES.Facility.ID)
  Discharge_nonEnergy$cum_fac<-cumsum(n$n)
  
  
  label1<-list(
    xref='x',
    yref='y',
    x=Discharge$cum_fac[1],
    y=Discharge$cum_total[1],
    xanchor='left',
    yanchor='middle',
    text= ~paste(round(Discharge$cum_total[1],digits=2)),
    font = list(family = 'helvetica', size = 12),
    showarrow = FALSE)
  
  label2<-list(
    xref='x',
    yref='y',
    x=Discharge_Energy$cum_fac[1],
    y=Discharge_Energy$cum_total[1],
    xanchor='left',
    yanchor='middle',
    text= ~paste(round(Discharge_Energy$cum_total[1],digits=2)),
    font = list(family = 'helvetica', size = 12),
    showarrow = FALSE)
  
  label3<-list(
    xref='x',
    yref='y',
    x=Discharge_nonEnergy$cum_fac[1],
    y=Discharge_nonEnergy$cum_total[1],
    xanchor='left',
    yanchor='middle',
    text= ~paste(round(Discharge_nonEnergy$cum_total[1],digits=2)),
    font = list(family = 'helvetica', size = 12),
    showarrow = FALSE)
  
  plot1<-Discharge%>%
    plot_ly(x= ~cum_fac)%>%
    add_trace(y = ~cum_total, name=paste0(label," Facilities"), type = 'scatter', mode = 'lines', line=list(color='blue',width=6))%>%
    add_trace(x=Discharge_Energy$cum_fac,y=Discharge_Energy$cum_total, name=paste0(label," Energy Facilities"), type='scatter', mode='lines',line=list(color='black', width=6,dash='dash'))%>%
    add_trace(x=Discharge_nonEnergy$cum_fac,y=Discharge_nonEnergy$cum_total, name=paste0(label," Non-Energy Facilities"), type='scatter', mode='lines',line=list(color='black',width=6,dash='dot'))%>%
    layout(title = "Cumulative Distribution of % Water Discharged in Virginia",
           xaxis=list(title="Number of Reporting Facilities"),
           yaxis=list(title="Cumulative % of total Water Discharged",
                      range=c(0,1.1)),
           font = list(family= "helvetica", size= 12),
           annotations=label1)%>%
    layout(annotations=label2)%>%
    layout(annotations=label3)
  
  Discharge<<-Discharge
  
  Yearly_Discharge<-Facility_Discharges%>%dplyr::group_by(Year)%>%dplyr::summarise(Discharges_MGD=sum(Discharges_MGD,na.rm=T),nFacilities=n_distinct(VPDES.Facility.ID))
  Yearly_Discharge<-transform(Yearly_Discharge, Year=as.Date(as.character(Year),"%Y"))
  
  return(list(Yearly_Discharge,plot1))
}
Cum_Discharge(Matched_Facility_Discharges,"Matched")
# Cum_Discharge(Facility_Discharges,"All")

#-----Major Dischargers------#
# Major_dis<-subset(Discharge, subset=Discharge$cum_total<=.95)
# Major_ECHO_2010_2017<-subset(ECHO_2010_2017,subset=ECHO_2010_2017$VPDES.VPDES.Facility.ID%in%Major_dis$VPDES.Facility.ID)
# 
# #-----Matched Dischargers--#
# Match_dis<-subset(Discharge,subset=Discharge$VPDES.Facility.ID%in%gsub("echo_","",full_match_2010_2017$VPDES.Facility.ID))

#-------------------------------------------------------Timeseries of Withdrawals vs Discharges-------------------------------------------#

#----------------------------------------------------------Withdrawals--------------------------------------------------------------------#
#-------Mean Daily Withdrawal MGD----------#

Statewide_Withdrawals<- function(Facility_Withdrawals,timeseries,label){

Yearly_Withdrawal<-Facility_Withdrawals%>%dplyr::group_by(Year)%>%dplyr::summarise(Withdrawals_MGD=sum(Withdrawals_MGD),nFacilities=n_distinct(VWUDS.Facility.ID))

label1 <- list(xref = 'x',yref = 'y',
  x = Yearly_Withdrawal$Year[1],
  y = Yearly_Withdrawal$Withdrawals_MGD[1],
  xanchor = 'right',
  yanchor = 'middle',
  text = ~paste(round(Yearly_Withdrawal$Withdrawals_MGD[1],digits=0), 'MGD'),font = list(family = 'Arial', size = 12),showarrow = FALSE)

label2<- list(
  xref = 'x',
  yref = 'y',
  x = Yearly_Withdrawal$Year[8],
  y = Yearly_Withdrawal$Withdrawals_MGD[8],
  xanchor = 'left',
  yanchor = 'bottom',
  text = ~paste(round(Yearly_Withdrawal$Withdrawals_MGD[8],digits=0), 'MGD'),font = list(family = 'Arial', size = 12),showarrow = FALSE)

Monthly<-timeseries%>%
  group_by(Date)%>%
  summarise(Withdrawals=sum(as.numeric(Withdrawals_MGD), na.rm = T))
            
timeseries%>%
  group_by(Date)%>%
  summarise(Withdrawals=sum(as.numeric(Withdrawals_MGD), na.rm = T),
            nFacilities=n_distinct(as.character(VWUDS.Facility.ID)))%>%
  plot_ly(x = ~Date)%>%
  add_trace(y = ~Withdrawals, name="Monthly Withdrawal (MGD)",type = 'scatter', mode = 'lines+markers', 
            marker=list(color='red'), line=list(color='red'))%>%
  add_trace(x=Yearly_Withdrawal$Year, y=Yearly_Withdrawal$Withdrawals_MGD, 
            name="Yearly Withdrawal (MGD)",type='scatter',
            mode = 'lines+markers', marker=list(color='black'), line=list(color='black'))%>%
  layout(title = paste0("Statewide Mean Daily Withdrawal in Virginia (MGD): ",label),
         yaxis = list(title="Mean Daily Withdrawal (MGD)",
                      tickfont=list(color="black"),
                      range=c(0,50+max(Monthly$Withdrawals))), #10500 all sectors 
         xaxis = list(title = "Date"),
         margin=list(r=125),
         legend=list(x=0.75, y=0.1),
         annotations=label1)%>%
  layout(annotations=label2)

}
Statewide_Withdrawals(Facility_Withdrawals,VWUDS_2010_2017,"All Facilities in All Sectors")
Statewide_Withdrawals(Matched_Facility_Withdrawals,full_match_2010_2017, "Matched Facilities in All Sectors")

#----Comparing Matched Water Users to Total----#

Compare_Withdrawals<- function(All_Facilities,Full_Match,Sector){

  All_users<-All_Facilities%>%
  group_by(Date)%>%
  summarise(Withdrawals=sum(as.numeric(Withdrawals_MGD), na.rm = T),
            nFacilities=n_distinct(as.character(Facility)))
  
plot1<-Full_Match%>%
  group_by(Date)%>%
  summarise(Withdrawals=sum(as.numeric(Withdrawals_MGD), na.rm = T),
            nFacilities=n_distinct(as.character(VWUDS.Facility.ID)))%>%
  plot_ly(x = ~Date)%>%
  add_trace(y = ~Withdrawals, name="Matched Water Users",type = 'scatter', mode = 'lines+markers', 
            marker=list(color='#de2d26'), line=list(color='#de2d26'))%>%
  add_trace(x=All_users$Date,y=All_users$Withdrawals, name="All Water Users", type='scatter',mode='lines+markers',
            marker=list(color='#fc9272'), line=list(color='#fc9272'))%>%
  add_trace(y= ~nFacilities, name="Matched Facilities", type='bar', yaxis='y2', opacity=1,
            marker=list(color='black'))%>%
  add_trace(x=All_users$Date, y= All_users$nFacilities, name="All Facilities", type='bar', yaxis='y2', opacity=0.25,
            marker=list(color='grey'))%>%
  layout(title = "Statewide Mean Daily Withdrawals in Virginia (MGD)",
         yaxis = list(title="Mean Daily Withdrawal (MGD)",
                      tickfont=list(color="black"),
                      range=c(0,10+max(All_users$Withdrawals))), #10500 all sectors
         yaxis2 = list(tickfont=list(color="black"),
                     overlaying="y",
                     side="right",
                     title="Number of Reports"),
         xaxis = list(title = "Date"),
         margin=list(r=125),
         legend=list(x=0.75, y=0.1))

All_sector<-subset(All_Facilities,All_Facilities$Use.Type==Sector)%>%
  group_by(Date)%>%
  summarise(Withdrawals=sum(as.numeric(Withdrawals_MGD), na.rm = T),
            nFacilities=n_distinct(as.character(Facility)))

plot2<-subset(Full_Match,Full_Match$Use.Type==Sector)%>%
  group_by(Date)%>%
  summarise(Withdrawals=sum(as.numeric(Withdrawals_MGD), na.rm = T),
            nFacilities=n_distinct(as.character(VWUDS.Facility.ID)))%>%
  plot_ly(x = ~Date)%>%
  add_trace(y = ~Withdrawals, name="Matched Water Users",type = 'scatter', mode = 'lines+markers', 
            marker=list(color='#de2d26'), line=list(color='#de2d26'))%>%
  add_trace(x=All_sector$Date,y=All_sector$Withdrawals, name="All Water Users", type='scatter',mode='lines+markers',
            marker=list(color='#fc9272'), line=list(color='#fc9272'))%>%
  add_trace(y= ~nFacilities, name="Matched Facilities", type='bar', yaxis='y2', opacity=0.60,
            marker=list(color='black'))%>%
  add_trace(x=All_sector$Date, y= All_sector$nFacilities, name="All Facilities", type='bar', yaxis='y2', opacity=0.25,
            marker=list(color='grey'))%>%
  layout(title = paste0("Statewide Mean Daily Withdrawals in Virginia (MGD): ",Sector," Sector"),
         yaxis = list(title="Mean Daily Withdrawal (MGD)",
                      tickfont=list(color="black"),
                      range=c(0,10+max(All_sector$Withdrawals))), #10500 all sectors
         yaxis2 = list(tickfont=list(color="black"),
                       overlaying="y",
                       side="right",
                       title="Number of Reports"),
         xaxis = list(title = "Date"),
         margin=list(r=125),
         legend=list(x=0.75, y=0.1))

return(list(plot1,plot2))
}
Compare_Withdrawals(VWUDS_2010_2017,full_match_2010_2017,"Energy")
Compare_Withdrawals(VWUDS_2010_2017,full_match_2010_2017,"Industrial")
Compare_Withdrawals(VWUDS_2010_2017,full_match_2010_2017,"Municipal")
Compare_Withdrawals(VWUDS_2010_2017,full_match_2010_2017,"Commercial")
Compare_Withdrawals(VWUDS_2010_2017,full_match_2010_2017,"Agriculture/Irrigation")

#----------------------------------------------------------Discharges--------------------------------------------------------------------#
#-------Mean Daily Discharge MGD----------#

Statewide_Discharges<- function(Facility_Discharges,timeseries,label){
Yearly_Discharge<-Facility_Discharges%>%dplyr::group_by(Year)%>%dplyr::summarise(Discharges_MGD=sum(Discharges_MGD),nFacilities=n_distinct(VPDES.Facility.ID))
Yearly_Discharge<-transform(Yearly_Discharge, Year=as.Date(as.character(Year),"%Y"))

label1 <- list(
  xref = 'x',
  yref = 'y',
  x = Yearly_Discharge$Year[1],
  y = Yearly_Discharge$Discharges_MGD[1],
  xanchor = 'right',
  yanchor = 'middle',
  text = ~paste(round(Yearly_Discharge$Discharges_MGD[1],digits=0), 'MGD'),
  font = list(family = 'Arial',size = 12),showarrow = FALSE)

label2 <- list(
  xref = 'x',
  yref = 'y',
  x = Yearly_Discharge$Year[8],
  y = Yearly_Discharge$Discharges_MGD[8],
  xanchor = 'left',
  yanchor = 'bottom',
  text = ~paste(round(Yearly_Discharge$Discharges_MGD[8],digits=0), 'MGD'),
  font = list(family = 'Arial',size = 12,color = 'rgba(67,67,67,1)'),showarrow = FALSE)

Monthly<-timeseries%>%
  group_by(Date)%>%
  summarise(Discharges=sum(Discharges_MGD,na.rm=T))
  
timeseries%>%
  group_by(Date)%>%
  summarise(Discharges=sum(Discharges_MGD,na.rm=T),
            nFacilities=n_distinct(as.character(VPDES.Facility.ID)))%>%
  plot_ly(x = ~Date)%>%
  add_trace(y = ~Discharges, name="Monthly Discharge (MGD)", type='scatter', mode = 'lines+markers', marker=list(color='blue'), line=list(color='blue'))%>%
  add_trace(x=Yearly_Discharge$Year, y=Yearly_Discharge$Discharges_MGD, name="Yearly Discharge (MGD)",type='scatter',
            mode = 'lines+markers', marker=list(color='black'), line=list(color='black'))%>%
  layout(title = paste0("Statewide Mean Daily Discharge (MGD) in Virginia: ",label),
         yaxis = list(title="Mean Daily Withdrawal (MGD)",
                      tickfont=list(color="blue"),
                      range=c(0,max(Monthly$Discharges))),
         xaxis = list(title = "Date"),
         margin=list(r=125),
         legend=list(x=0.75, y=0.1),
         annotations=label1)%>%
  layout(annotations=label2)
}
Statewide_Discharges(Facility_Discharges,ECHO_2010_2017,"All Facilities in All Sectors")
Statewide_Discharges(Matched_Facility_Discharges,full_match_2010_2017,"Matched Facilities in All Sectors")

#----Comparing Matched Water Users to Total----#

Compare_Discharges<- function(All_Facilities,Full_Match,Sector){
  
  All_dis<-All_Facilities%>%
    group_by(Date)%>%
    summarise(Discharges=sum(as.numeric(Discharges_MGD), na.rm = T),
              nFacilities=n_distinct(as.character(VPDES.Facility.ID)))
  
  plot1<-Full_Match%>%
    group_by(Date)%>%
    summarise(Discharges=sum(as.numeric(Discharges_MGD), na.rm = T),
              nFacilities=n_distinct(as.character(VPDES.Facility.ID)))%>%
    plot_ly(x = ~Date)%>%
    add_trace(y = ~Discharges, name="Matched Dischargers",type = 'scatter', mode = 'lines+markers', 
              marker=list(color='#3182bd'), line=list(color='#3182bd'))%>%
    add_trace(x=All_dis$Date,y=All_dis$Discharges, name="All Discharges", type='scatter',mode='lines+markers',
              marker=list(color='#9ecae1'), line=list(color='#9ecae1'))%>%
    add_trace(y= ~nFacilities, name="Matched Facilities", type='bar', yaxis='y2', opacity=1,
              marker=list(color='black'))%>%
    add_trace(x=All_dis$Date, y= All_dis$nFacilities, name="All Facilities", type='bar', yaxis='y2', opacity=0.25,
              marker=list(color='grey'))%>%
    layout(title = "Statewide Mean Daily Discharges in Virginia (MGD)",
           yaxis = list(title="Mean Daily Discharge (MGD)",
                        tickfont=list(color="black"),
                        range=c(0,max(All_dis$Discharges))), #10500 all sectors
           yaxis2 = list(tickfont=list(color="black"),
                         overlaying="y",
                         side="right",
                         title="Number of Reports"),
           xaxis = list(title = "Date"),
           margin=list(r=125),
           legend=list(x=0.75, y=0.1))
  
  All_sector<-subset(All_Facilities,All_Facilities$Use.Type==Sector)%>%
    group_by(Date)%>%
    summarise(Discharges=sum(as.numeric(Discharges_MGD), na.rm = T),
              nFacilities=n_distinct(as.character(VPDES.Facility.ID)))
  
  plot2<-subset(Full_Match,Full_Match$Use.Type==Sector)%>%
    group_by(Date)%>%
    summarise(Discharges=sum(as.numeric(Discharges_MGD), na.rm = T),
              nFacilities=n_distinct(as.character(VPDES.Facility.ID)))%>%
    plot_ly(x = ~Date)%>%
    add_trace(y = ~Discharges, name="Matched Dischargers",type = 'scatter', mode = 'lines+markers', 
              marker=list(color='#3182bd'), line=list(color='#3182bd'))%>%
    add_trace(x=All_sector$Date,y=All_sector$Discharges, name="All Discharges", type='scatter',mode='lines+markers',
              marker=list(color='#9ecae1'), line=list(color='#9ecae1'))%>%
    add_trace(y= ~nFacilities, name="Matched Facilities", type='bar', yaxis='y2', opacity=0.60,
              marker=list(color='black'))%>%
    add_trace(x=All_sector$Date, y= All_sector$nFacilities, name="All Facilities", type='bar', yaxis='y2', opacity=0.25,
              marker=list(color='grey'))%>%
    layout(title = paste0("Statewide Mean Daily Discharges in Virginia (MGD): ",Sector," Sector"),
           yaxis = list(title="Mean Daily Discharge (MGD)",
                        tickfont=list(color="black"),
                        range=c(0,max(All_sector$Discharges))), #10500 all sectors
           yaxis2 = list(tickfont=list(color="black"),
                         overlaying="y",
                         side="right",
                         title="Number of Reports"),
           xaxis = list(title = "Date"),
           margin=list(r=125),
           legend=list(x=0.75, y=0.1))
  return(list(plot1,plot2))
  
}
Compare_Discharges(ECHO_2010_2017,full_match_2010_2017,"Energy")
Compare_Discharges(ECHO_2010_2017,full_match_2010_2017,"Industrial")
Compare_Discharges(ECHO_2010_2017,full_match_2010_2017,"Municipal")
Compare_Discharges(ECHO_2010_2017,full_match_2010_2017,"Commercial")
Compare_Discharges(ECHO_2010_2017,full_match_2010_2017,"Agriculture/Irrigation")

#-----Monthly Withdrawals vs Discharges with Consumption lines-------#

#---All Facilities--#

All.Fac.Plots<- function(Sector,Title){
  
  Monthly_Withdrawal<-
    VWUDS_2010_2017%>%
    dplyr::group_by(Date)%>%
    dplyr::summarise(Withdrawals=sum(Withdrawals_MGD,na.rm=T),
                     nFacilities=n_distinct(as.character(VWUDS.Facility.ID)))
  
  Monthly_Discharge<-
    ECHO_2010_2017%>%
    dplyr::group_by(Date)%>%
    dplyr::summarise(Discharges=sum(as.numeric(Discharges_MGD),na.rm=T),
              nFacilities=n_distinct(as.character(VPDES.Facility.ID)))
  
  CU<-data.frame(Date=Monthly_Withdrawal$Date,
                 CU=(Monthly_Withdrawal$Withdrawals-Monthly_Discharge$Discharges)/
                   Monthly_Withdrawal$Withdrawals,stringsAsFactors = F)

plot1<-VWUDS_2010_2017%>%
  dplyr::group_by(Date)%>%
  dplyr::summarise(Withdrawals=sum(as.numeric(Withdrawals_MGD), na.rm = T),
            nFacilities=n_distinct(as.character(VWUDS.Facility.ID)))%>%
  plot_ly(x = ~Date)%>%
  add_trace(y = ~Withdrawals, name="Withdrawal",type = 'scatter', mode = 'lines+markers', marker=list(color='red'), line=list(color='red'))%>%
  add_trace(x=Monthly_Discharge$Date, y=Monthly_Discharge$Discharges, name="Discharge", type="scatter", mode="lines+markers", marker=list(color="blue"), line=list(color='blue'))%>%
  add_trace(y= ~nFacilities, name="VWUDS Facilities", type='bar', yaxis='y2', opacity=0.25,marker=list(color='black'))%>%
  add_trace(x=Monthly_Discharge$Date, y= Monthly_Discharge$nFacilities, name="VPDES Facilities", type='bar', yaxis='y2', opacity=0.25,marker=list(color='grey'))%>%
  layout(title = "Statewide Mean Daily Withdrawals vs. Discharges (MGD) in Virginia: All Facilities",
         yaxis = list(title="Mean Daily Quantity (MGD)",
                      range=c(0,ifelse(max(Monthly_Withdrawal$Withdrawals)>max(Monthly_Discharge$Discharges),10+max(Monthly_Withdrawal$Withdrawals),10+max(Monthly_Discharge$Discharges)))),
         yaxis2=list(tickfont=list(color="black"),
                     overlaying="y",
                     side="right",
                     title="Consumption"),
         margin=list(r=125),
         xaxis = list(title = "Monitoring Period (Months)"),
         legend=list(x=0.8, y=-0.2))
  
  plot2<-VWUDS_2010_2017%>%
    dplyr::group_by(Date)%>%
    dplyr::summarise(Withdrawals=sum(as.numeric(Withdrawals_MGD), na.rm = T),
              nFacilities=n_distinct(as.character(VWUDS.Facility.ID)))%>%
    plot_ly(x = ~Date)%>%
    add_trace(y = ~Withdrawals, name="Withdrawal",type = 'scatter', mode = 'lines+markers', marker=list(color='red'), line=list(color='red'))%>%
    add_trace(x=Monthly_Discharge$Date, y=Monthly_Discharge$Discharges, name="Discharge", type="scatter", mode="lines+markers", marker=list(color="blue"), line=list(color='blue'))%>%
    add_trace(x=CU$Date, y= CU$CU, name="Consumption", type='scatter', mode='lines+markers', yaxis='y2',marker=list(color='#969696'),line=list(color='#969696'))%>%
    layout(title = "Statewide Mean Daily Withdrawals vs. Discharges (MGD) in Virginia: All Facilities",
           yaxis = list(title="Mean Daily Quantity (MGD)",
                        range=c(0,ifelse(max(Monthly_Withdrawal$Withdrawals)>max(Monthly_Discharge$Discharges),10+max(Monthly_Withdrawal$Withdrawals),10+max(Monthly_Discharge$Discharges)))),
           yaxis2=list(tickfont=list(color="black"),
                       overlaying="y",
                       side="right",
                       title="Number of Reporting Facilities"),
           margin=list(r=125),
           xaxis = list(title = "Monitoring Period (Months)"),
           legend=list(x=0.8, y=-0.2))
  
  Monthly_Withdrawal<-
    subset(VWUDS_2010_2017,VWUDS_2010_2017$Use.Type==Sector)%>%
    dplyr::group_by(Date)%>%
    dplyr::summarise(Withdrawals=sum(Withdrawals_MGD,na.rm=T),
                     nFacilities=n_distinct(as.character(VWUDS.Facility.ID)))
  
  Monthly_Discharge<-
    subset(ECHO_2010_2017,ECHO_2010_2017$Use.Type==Sector)%>%
    dplyr::group_by(Date)%>%
    dplyr::summarise(Discharges=sum(as.numeric(Discharges_MGD),na.rm=T),
              nFacilities=n_distinct(as.character(VPDES.Facility.ID)))
  
  CU<-data.frame(Date=Monthly_Withdrawal$Date,
                 CU=(Monthly_Withdrawal$Withdrawals-Monthly_Discharge$Discharges)/
                   Monthly_Withdrawal$Withdrawals,stringsAsFactors = F)
  
  Annual_CU<-CU%>%dplyr::group_by(Year=substr(Date,1,4))%>%dplyr::summarise(CU=mean(CU,na.rm=T))
  
plot3<-subset(VWUDS_2010_2017,VWUDS_2010_2017$Use.Type==Sector)%>%
    dplyr::group_by(Date)%>%
    dplyr::summarise(Withdrawals=sum(as.numeric(Withdrawals_MGD), na.rm = T),
              nFacilities=n_distinct(as.character(VWUDS.Facility.ID)))%>%
    plot_ly(x = ~Date)%>%
    add_trace(y = ~Withdrawals, name="Withdrawal",type = 'scatter', mode = 'lines+markers', marker=list(color='red'), line=list(color='red'))%>%
    add_trace(x=Monthly_Discharge$Date, y=Monthly_Discharge$Discharges, name="Discharge", type="scatter", mode="lines+markers", marker=list(color="blue"), line=list(color='blue'))%>%
    add_trace(y= ~nFacilities, name="VWUDS Facilities", type='bar', yaxis='y2', opacity=0.25,marker=list(color='black'))%>%
    add_trace(x=Monthly_Discharge$Date, y= Monthly_Discharge$nFacilities, name="VPDES Facilities", type='bar', yaxis='y2', opacity=0.25,marker=list(color='grey'))%>%
    layout(title = paste0("Statewide Mean Daily Withdrawals vs. Discharges (MGD) in Virginia: ",Title),
           yaxis = list(title="Mean Daily Quantity (MGD)",
                        range=c(0,ifelse(max(Monthly_Withdrawal$Withdrawals)>max(Monthly_Discharge$Discharges),10+max(Monthly_Withdrawal$Withdrawals),10+max(Monthly_Discharge$Discharges)))),
           yaxis2=list(tickfont=list(color="black"),
                       overlaying="y",
                       side="right",
                       title="Consumption"),
           margin=list(r=125),
           xaxis = list(title = "Monitoring Period (Months)"),
           legend=list(x=0.8, y=-0.2))

plot4<-subset(VWUDS_2010_2017,VWUDS_2010_2017$Use.Type==Sector)%>%
  dplyr::group_by(Date)%>%
  dplyr::summarise(Withdrawals=sum(as.numeric(Withdrawals_MGD), na.rm = T),
            nFacilities=n_distinct(as.character(VWUDS.Facility.ID)))%>%
  plot_ly(x = ~Date)%>%
  add_trace(y = ~Withdrawals, name="Withdrawal",type = 'scatter', mode = 'lines+markers', marker=list(color='red'), line=list(color='red'))%>%
  add_trace(x=Monthly_Discharge$Date, y=Monthly_Discharge$Discharges, name="Discharge", type="scatter", mode='lines+markers',marker=list(color='blue'), line=list(color='blue'))%>%
  add_trace(x=CU$Date, y=CU$CU, name="Consumption", type="scatter", yaxis="y2", mode='lines+markers', marker=list(color='#969696'),line=list(color='#969696'))%>%
  layout(title = paste0("Statewide Mean Daily Withdrawals vs. Discharges (MGD) in Virginia: ",Title),
         yaxis = list(title="Mean Daily Quantity (MGD)",
                      range=c(0,10+max(Monthly_Withdrawal$Withdrawals))),
         yaxis2=list(tickfont=list(color="black"),
                     overlaying="y",
                     side="right",
                     title="Consumptive Coefficient",
                     range=c(-0.2,1)),
         margin=list(r=125),
         xaxis = list(title = "Monitoring Period (Months)"),
         legend=list(x=0.8, y=-0.2))

return(list(plot1,plot2,plot3,plot4,Annual_CU))
}

# returns plots for all sector scenario, sector scenario, and annual CU for specified sector
All.Fac.Plots("Energy", "Energy Sector Facilities")
All.Fac.Plots("Industrial", "Industrial Sector Facilities")
All.Fac.Plots("Agriculture/Irrigation", "Agriculture/Irrigation Sector Facilities")
All.Fac.Plots("Municipal", "Municipal Sector Facilities")
All.Fac.Plots("Commercial", "Municipal Sector Facilities")


#---Matched Facilities---#

Match.Fac.Plots<- function(Sector, Title){

  # By Sector
Matched_Monthly_Discharge<-subset(Match_ECHO_2010_2017,Match_ECHO_2010_2017$Use.Type==Sector)%>%
  dplyr::group_by(Date)%>%
  dplyr::summarise(Discharges=sum(as.numeric(Discharges_MGD),na.rm=T),
            nFacilities=n_distinct(as.character(VPDES.Facility.ID)))

Matched_Monthly_Withdrawal<-
  subset(Match_VWUDS_2010_2017,Match_VWUDS_2010_2017$VWUDS.Use.Type==Sector)%>%
  dplyr::group_by(Date)%>%
  dplyr::summarise(Withdrawals=sum(Withdrawals_MGD,na.rm=T),
                   nFacilities=n_distinct(as.character(VWUDS.Facility.ID)))

Matched_CU<-data.frame(Date=Matched_Monthly_Withdrawal$Date,
                       CU=(Matched_Monthly_Withdrawal$Withdrawals-Matched_Monthly_Discharge$Discharges)/
                         Matched_Monthly_Withdrawal$Withdrawals,stringsAsFactors = F)

plot1<-subset(Match_VWUDS_2010_2017,Match_VWUDS_2010_2017$VWUDS.Use.Type==Sector)%>%
  group_by(Date)%>%
  summarise(Withdrawals=sum(as.numeric(Withdrawals_MGD), na.rm = T),
            nFacilities=n_distinct(as.character(VWUDS.Facility.ID)))%>%
  plot_ly(x = ~Date)%>%
  add_trace(y = ~Withdrawals, name="Withdrawal",type = 'scatter', mode = 'lines+markers', marker=list(color='red'), line=list(color='red'))%>%
  add_trace(x=Matched_Monthly_Discharge$Date, y=Matched_Monthly_Discharge$Discharges, name="Discharge", type="scatter", mode="lines+markers", marker=list(color="blue"), line=list(color='blue'))%>%
  add_trace(y= ~nFacilities, name="VWUDS Facilities", type='bar', yaxis='y2', opacity=0.25,marker=list(color='black'))%>%
  add_trace(x=Matched_Monthly_Discharge$Date, y= Matched_Monthly_Discharge$nFacilities, name="VPDES Facilities", type='bar', yaxis='y2', opacity=0.25,marker=list(color='grey'))%>%
  layout(title = paste0("Statewide Mean Daily Withdrawals vs. Discharges (MGD) in Virginia: ",Title),
         yaxis = list(title="Mean Daily Quantity (MGD)",
                      range=c(0,ifelse(max(Matched_Monthly_Withdrawal$Withdrawals)>max(Matched_Monthly_Discharge$Discharges),10+max(Matched_Monthly_Withdrawal$Withdrawals),10+max(Matched_Monthly_Discharge$Discharges)))),
         yaxis2=list(tickfont=list(color="black"),
                     overlaying="y",
                     side="right",
                     title="Number of Reporting Facilities"),
         margin=list(r=125),
         xaxis = list(title = "Monitoring Period (Months)"),
         legend=list(x=0.8, y=-0.2))

plot2<-subset(Match_VWUDS_2010_2017,Match_VWUDS_2010_2017$VWUDS.Use.Type==Sector)%>%
  group_by(Date)%>%
  summarise(Withdrawals=sum(as.numeric(Withdrawals_MGD), na.rm = T),
            nFacilities=n_distinct(as.character(VWUDS.Facility.ID)))%>%
  plot_ly(x = ~Date)%>%
  add_trace(y = ~Withdrawals, name="Withdrawal",type = 'scatter', mode = 'lines+markers', marker=list(color='red'), line=list(color='red'))%>%
  add_trace(x=Matched_Monthly_Discharge$Date, y=Matched_Monthly_Discharge$Discharges, name="Discharge", type="scatter", mode="lines+markers", marker=list(color="blue"), line=list(color='blue'))%>%
  add_trace(x=Matched_CU$Date,y=Matched_CU$CU, name="Consumption",yaxis='y2', type="scatter",mode='lines+markers', marker=list(color='#969696'),line=list(color='#969696'))%>%
  layout(title = paste0("Statewide Mean Daily Withdrawals vs. Discharges (MGD) in Virginia: ",Title),
         yaxis = list(title="Mean Daily Quantity (MGD)",
                      range=c(0,ifelse(max(Matched_Monthly_Withdrawal$Withdrawals)>max(Matched_Monthly_Discharge$Discharges),10+max(Matched_Monthly_Withdrawal$Withdrawals),10+max(Matched_Monthly_Discharge$Discharges)))),
         yaxis2=list(tickfont=list(color="black"),
                     overlaying="y",
                     side="right",
                     title="Consumptive Coefficient",
                     range=c(-0.2,1)),
         margin=list(r=125),
         xaxis = list(title = "Monitoring Period (Months)"),
         legend=list(x=0.8, y=-0.2))

Matched_Monthly_Discharge<-
  Match_ECHO_2010_2017%>%
  dplyr::group_by(Date)%>%
  dplyr::summarise(Discharges=sum(as.numeric(Discharges_MGD),na.rm=T),
                   nFacilities=n_distinct(as.character(VPDES.Facility.ID)))

Matched_Monthly_Withdrawal<-
  Match_VWUDS_2010_2017%>%
  dplyr::group_by(Date)%>%
  dplyr::summarise(Withdrawals=sum(Withdrawals_MGD,na.rm=T),
                   nFacilities=n_distinct(as.character(VWUDS.Facility.ID)))

Matched_CU<-data.frame(Date=Matched_Monthly_Withdrawal$Date,
                       CU=(Matched_Monthly_Withdrawal$Withdrawals-Matched_Monthly_Discharge$Discharges)/
                         Matched_Monthly_Withdrawal$Withdrawals,stringsAsFactors = F)

plot3<-Match_VWUDS_2010_2017%>%
  group_by(Date)%>%
  summarise(Withdrawals=sum(as.numeric(Withdrawals_MGD), na.rm = T),
            nFacilities=n_distinct(as.character(VWUDS.Facility.ID)))%>%
  plot_ly(x = ~Date)%>%
  add_trace(y = ~Withdrawals, name="Withdrawal",type = 'scatter', mode = 'lines+markers', marker=list(color='red'), line=list(color='red'))%>%
  add_trace(x=Matched_Monthly_Discharge$Date, y=Matched_Monthly_Discharge$Discharges, name="Discharge", type="scatter", mode="lines+markers", marker=list(color="blue"), line=list(color='blue'))%>%
  add_trace(y= ~nFacilities, name="VWUDS Facilities", type='bar', yaxis='y2', opacity=0.25,marker=list(color='black'))%>%
  add_trace(x=Matched_Monthly_Discharge$Date, y= Matched_Monthly_Discharge$nFacilities, name="VPDES Facilities", type='bar', yaxis='y2', opacity=0.25,marker=list(color='grey'))%>%
  layout(title = "Statewide Mean Daily Withdrawals vs. Discharges (MGD) in Virginia: All Matched Facilities",
         yaxis = list(title="Mean Daily Quantity (MGD)",
                      range=c(0,ifelse(max(Matched_Monthly_Withdrawal$Withdrawals)>max(Matched_Monthly_Discharge$Discharges),10+max(Matched_Monthly_Withdrawal$Withdrawals),10+max(Matched_Monthly_Discharge$Discharges)))),
         yaxis2=list(tickfont=list(color="black"),
                     overlaying="y",
                     side="right",
                     title="Number of Reporting Facilities"),
         margin=list(r=125),
         xaxis = list(title = "Monitoring Period (Months)"),
         legend=list(x=0.8, y=-0.2))

plot4<-Match_VWUDS_2010_2017%>%
  group_by(Date)%>%
  summarise(Withdrawals=sum(as.numeric(Withdrawals_MGD), na.rm = T),
            nFacilities=n_distinct(as.character(VWUDS.Facility.ID)))%>%
  plot_ly(x = ~Date)%>%
  add_trace(y = ~Withdrawals, name="Withdrawal",type = 'scatter', mode = 'lines+markers', marker=list(color='red'), line=list(color='red'))%>%
  add_trace(x=Matched_Monthly_Discharge$Date, y=Matched_Monthly_Discharge$Discharges, name="Discharge", type="scatter", mode="lines+markers", marker=list(color="blue"), line=list(color='blue'))%>%
  add_trace(x=Matched_CU$Date,y=Matched_CU$CU, name="Consumption",yaxis='y2', type="scatter",mode='lines+markers', marker=list(color='#969696'),line=list(color='#969696'))%>%
  layout(title = "Statewide Mean Daily Withdrawals vs. Discharges (MGD) in Virginia: All Matched Facilities",
         yaxis = list(title="Mean Daily Quantity (MGD)",
                      range=c(0,ifelse(max(Matched_Monthly_Withdrawal$Withdrawals)>max(Matched_Monthly_Discharge$Discharges),10+max(Matched_Monthly_Withdrawal$Withdrawals),10+max(Matched_Monthly_Discharge$Discharges)))),
         yaxis2=list(tickfont=list(color="black"),
                     overlaying="y",
                     side="right",
                     title="Consumptive Coefficient",
                     range=c(-0.2,1)),
         margin=list(r=125),
         xaxis = list(title = "Monitoring Period (Months)"),
         legend=list(x=0.8, y=-0.2))

return(list(plot3,plot4,plot1,plot2))

}

Match.Fac.Plots("Energy","Matched Energy Facilities")
Match.Fac.Plots("Industrial","Matched Industrial Facilities")
Match.Fac.Plots("Commercial","Matched Commercial Facilities")
Match.Fac.Plots("Agriculture/Irrigation","Matched Agriculture/Irrigation Facilities")
Match.Fac.Plots("Municipal","Matched Municipal Facilities")

#---Fully Matched---#

Full.Match.Fac.Plots<- function(Sector, Title){
  
  Full_Matched_Monthly_Discharge<-
    full_match_2010_2017%>%
    group_by(Date)%>%
    summarise(Discharges=sum(as.numeric(Discharges_MGD),na.rm=T),
              nFacilities=n_distinct(as.character(VPDES.Facility.ID)))
  
  Full_Matched_Monthly_Withdrawal<-
    full_match_2010_2017%>%
    dplyr::group_by(Date)%>%
    dplyr::summarise(Withdrawals=sum(Withdrawals_MGD,na.rm=T),
                     nFacilities=n_distinct(as.character(VWUDS.Facility.ID)))
  
  Full_Matched_CU<-data.frame(Date=Full_Matched_Monthly_Withdrawal$Date,
                              CU=(Full_Matched_Monthly_Withdrawal$Withdrawals-Full_Matched_Monthly_Discharge$Discharges)/
                                Full_Matched_Monthly_Withdrawal$Withdrawals,stringsAsFactors = F)
  plot1<-full_match_2010_2017%>%
    group_by(Date)%>%
    summarise(Withdrawals=sum(as.numeric(Withdrawals_MGD), na.rm = T),
              nFacilities=n_distinct(as.character(VWUDS.Facility.ID)))%>%
    plot_ly(x = ~Date)%>%
    add_trace(y = ~Withdrawals, name="Withdrawal",type = 'scatter', mode = 'lines+markers', marker=list(color='red'), line=list(color='red'))%>%
    add_trace(x=Full_Matched_Monthly_Discharge$Date, y=Full_Matched_Monthly_Discharge$Discharges, name="Discharge", type="scatter", mode="lines+markers", marker=list(color="blue"), line=list(color='blue'))%>%
    add_trace(y= ~nFacilities, name="VWUDS Facilities", type='bar', yaxis='y2', opacity=0.25,
              marker=list(color='black'))%>%
    add_trace(x=Full_Matched_Monthly_Discharge$Date, y= Full_Matched_Monthly_Discharge$nFacilities, name="VPDES Facilities", type='bar', yaxis='y2', opacity=0.25,
              marker=list(color='grey'))%>%
    layout(title = "Statewide Mean Daily Withdrawals vs. Discharges (MGD) in Virginia: All Sectors",
           yaxis = list(title="Mean Daily Quantity (MGD)",
                        range=c(0,ifelse(max(Full_Matched_Monthly_Withdrawal$Withdrawals)>max(Full_Matched_Monthly_Discharge$Discharges),max(Full_Matched_Monthly_Withdrawal$Withdrawals),max(Full_Matched_Monthly_Discharge$Discharges)))),
           yaxis2=list(tickfont=list(color="black"),
                       overlaying="y",
                       side="right",
                       title="Number of Reporting Facilities"),
           margin=list(r=125),
           xaxis = list(title = "Monitoring Period (Months)"),
           legend=list(x=0.8, y=-0.2))
  
  plot2<-full_match_2010_2017%>%
    group_by(Date)%>%
    summarise(Withdrawals=sum(as.numeric(Withdrawals_MGD), na.rm = T),
              nFacilities=n_distinct(as.character(VWUDS.Facility.ID)))%>%
    plot_ly(x = ~Date)%>%
    add_trace(y = ~Withdrawals, name="Withdrawal",type = 'scatter', mode = 'lines+markers', marker=list(color='red'), line=list(color='red'))%>%
    add_trace(x=Full_Matched_Monthly_Discharge$Date, y=Full_Matched_Monthly_Discharge$Discharges, name="Discharge", type="scatter", mode="lines+markers", marker=list(color="blue"), line=list(color='blue'))%>%
    add_trace(x=Full_Matched_CU$Date,y=Full_Matched_CU$CU, name="Consumption",yaxis='y2', type="scatter",mode='lines+markers', marker=list(color='#969696'),line=list(color='#969696'))%>%
    layout(title = "Statewide Mean Daily Withdrawals vs. Discharges (MGD) in Virginia: All Sectors",
           yaxis = list(title="Mean Daily Quantity (MGD)",
                        range=c(0,ifelse(max(Full_Matched_Monthly_Withdrawal$Withdrawals)>max(Full_Matched_Monthly_Discharge$Discharges),max(Full_Matched_Monthly_Withdrawal$Withdrawals),max(Full_Matched_Monthly_Discharge$Discharges)))),
           yaxis2=list(tickfont=list(color="black"),
                       overlaying="y",
                       side="right",
                       title="Consumptive Coefficient",
                       range=c(-0.2,1)),margin=list(r=125),xaxis = list(title = "Monitoring Period (Months)"),legend=list(x=0.8, y=-0.2))
  
  Full_Matched_Monthly_Discharge<-
    subset(full_match_2010_2017,full_match_2010_2017$Use.Type==Sector)%>%
    group_by(Date)%>%
    summarise(Discharges=sum(as.numeric(Discharges_MGD),na.rm=T),
              nFacilities=n_distinct(as.character(VPDES.Facility.ID)))
  
  Full_Matched_Monthly_Withdrawal<-
    subset(full_match_2010_2017,full_match_2010_2017$Use.Type==Sector)%>%
    dplyr::group_by(Date)%>%
    dplyr::summarise(Withdrawals=sum(Withdrawals_MGD,na.rm=T),
                     nFacilities=n_distinct(as.character(VWUDS.Facility.ID)))
  
  Full_Matched_CU<-data.frame(Date=Full_Matched_Monthly_Withdrawal$Date,
                              CU=(Full_Matched_Monthly_Withdrawal$Withdrawals-Full_Matched_Monthly_Discharge$Discharges)/
                                Full_Matched_Monthly_Withdrawal$Withdrawals,stringsAsFactors = F)
  
  
  plot3<-subset(full_match_2010_2017,full_match_2010_2017$Use.Type==Sector)%>%
    group_by(Date)%>%
    summarise(Withdrawals=sum(as.numeric(Withdrawals_MGD), na.rm = T),
              nFacilities=n_distinct(as.character(VWUDS.Facility.ID)))%>%
    plot_ly(x = ~Date)%>%
    add_trace(y = ~Withdrawals, name="Withdrawal",type = 'scatter', mode = 'lines+markers', marker=list(color='red'), line=list(color='red'))%>%
    add_trace(x=Full_Matched_Monthly_Discharge$Date, y=Full_Matched_Monthly_Discharge$Discharges, name="Discharge", type="scatter", mode="lines+markers", marker=list(color="blue"), line=list(color='blue'))%>%
    add_trace(y= ~nFacilities, name="VWUDS Facilities", type='bar', yaxis='y2', opacity=0.25,
              marker=list(color='black'))%>%
    add_trace(x=Full_Matched_Monthly_Discharge$Date, y= Full_Matched_Monthly_Discharge$nFacilities, name="VPDES Facilities", type='bar', yaxis='y2', opacity=0.25,
              marker=list(color='grey'))%>%
    layout(title = paste0("Statewide Mean Daily Withdrawals vs. Discharges (MGD) in Virginia: ",Title),
           yaxis = list(title="Mean Daily Quantity (MGD)",
                        range=c(0,ifelse(max(Full_Matched_Monthly_Withdrawal$Withdrawals)>max(Full_Matched_Monthly_Discharge$Discharges),max(Full_Matched_Monthly_Withdrawal$Withdrawals),max(Full_Matched_Monthly_Discharge$Discharges)))),
           yaxis2=list(tickfont=list(color="black"),
                       overlaying="y",
                       side="right",
                       title="Number of Reporting Facilities"),
           margin=list(r=125),
           xaxis = list(title = "Monitoring Period (Months)"),
           legend=list(x=0.8, y=-0.2))
  
  plot4<-subset(full_match_2010_2017,full_match_2010_2017$Use.Type==Sector)%>%
    group_by(Date)%>%
    summarise(Withdrawals=sum(as.numeric(Withdrawals_MGD), na.rm = T),
              nFacilities=n_distinct(as.character(VWUDS.Facility.ID)))%>%
    plot_ly(x = ~Date)%>%
    add_trace(y = ~Withdrawals, name="Withdrawal",type = 'scatter', mode = 'lines+markers', marker=list(color='red'), line=list(color='red'))%>%
    add_trace(x=Full_Matched_Monthly_Discharge$Date, y=Full_Matched_Monthly_Discharge$Discharges, name="Discharge", type="scatter", mode="lines+markers", marker=list(color="blue"), line=list(color='blue'))%>%
    add_trace(x=Full_Matched_CU$Date,y=Full_Matched_CU$CU, name="Consumption",yaxis='y2', type="scatter",mode='lines+markers', marker=list(color='#969696'),line=list(color='#969696'))%>%
    layout(title = paste0("Statewide Mean Daily Withdrawals vs. Discharges (MGD) in Virginia: ",Title),
           yaxis = list(title="Mean Daily Quantity (MGD)",
                        range=c(0,ifelse(max(Full_Matched_Monthly_Withdrawal$Withdrawals)>max(Full_Matched_Monthly_Discharge$Discharges),max(Full_Matched_Monthly_Withdrawal$Withdrawals),max(Full_Matched_Monthly_Discharge$Discharges)))),
           yaxis2=list(tickfont=list(color="black"),
                       overlaying="y",
                       side="right",
                       title="Consumptive Coefficient",
                       range=c(-0.2,1)),margin=list(r=125),xaxis = list(title = "Monitoring Period (Months)"),legend=list(x=0.8, y=-0.2))
  
  
  return(list(plot1,plot2,plot3,plot4))
  
}

Full.Match.Fac.Plots("Energy","Fully Matched Energy Facilities")
Full.Match.Fac.Plots("Industrial","Fully Matched Industrial Facilities")
Full.Match.Fac.Plots("Municipal","Fully Matched Municipal Facilities")
Full.Match.Fac.Plots("Agriculture/Irrigation","Fully Matched Agriculture/Irrigation Facilities")
Full.Match.Fac.Plots("Commercial","Fully Matched Commercial Facilities")
Full.Match.Fac.Plots("Energy","Fully Matched Non-Energy Facilities")

#----Single Systems----#

case.study<- function(VPDESID,VWUDSID,FacilityName){
  Matched_Monthly_Discharge<-
    subset(Match_ECHO_2010_2017,Match_ECHO_2010_2017$VPDES.Facility.ID==VPDESID)%>%
    dplyr::group_by(Date)%>%
    dplyr::summarise(Discharges=sum(as.numeric(Discharges_MGD),na.rm=T),
                     nFacilities=n_distinct(as.character(VPDES.Facility.ID)))
  
  Matched_Monthly_Withdrawal<-
    subset(Match_VWUDS_2010_2017,Match_VWUDS_2010_2017$VWUDS.Facility.ID==VWUDSID)%>%
    dplyr::group_by(Date)%>%
    dplyr::summarise(Withdrawals=sum(Withdrawals_MGD,na.rm=T),
                     nFacilities=n_distinct(as.character(VWUDS.Facility.ID)))
  
  Matched_CU<-data.frame(Date=Matched_Monthly_Withdrawal$Date,
                         CU=(Matched_Monthly_Withdrawal$Withdrawals-Matched_Monthly_Discharge$Discharges)/
                           Matched_Monthly_Withdrawal$Withdrawals,stringsAsFactors = F)
  
  subset(Match_VWUDS_2010_2017,Match_VWUDS_2010_2017$VWUDS.Facility.ID==VWUDSID)%>%
    group_by(Date)%>%
    summarise(Withdrawals=sum(as.numeric(Withdrawals_MGD), na.rm = T),
              nFacilities=n_distinct(as.character(VWUDS.Facility.ID)))%>%
    plot_ly(x = ~Date)%>%
    add_trace(y = ~Withdrawals, name="Withdrawal",type = 'scatter', mode = 'lines+markers', marker=list(color='red'), line=list(color='red'))%>%
    add_trace(x=Matched_Monthly_Discharge$Date, y=Matched_Monthly_Discharge$Discharges, name="Discharge", type="scatter", mode="lines+markers", marker=list(color="blue"), line=list(color='blue'))%>%
    add_trace(y= ~nFacilities, name="VWUDS Facilities", type='bar', yaxis='y2', opacity=0.25,marker=list(color='black'))%>%
    add_trace(x=Matched_Monthly_Discharge$Date, y= Matched_Monthly_Discharge$nFacilities, name="VPDES Facilities", type='bar', yaxis='y2', opacity=0.25,marker=list(color='grey'))%>%
    layout(title = paste("Statewide Mean Daily Withdrawals vs. Discharges (MGD) in Virginia: ",FacilityName),
           yaxis = list(title="Mean Daily Quantity (MGD)",
                        range=c(0,max(Matched_Monthly_Withdrawal$Withdrawals))),
           yaxis2=list(tickfont=list(color="black"),
                       overlaying="y",
                       side="right",
                       title="Number of Reporting Facilities",
                       dtick=1,
                       ticklen=0.5),
           margin=list(r=125),
           xaxis = list(title = "Monitoring Period (Months)"),
           legend=list(x=0.8, y=-0.2))
}

case.study("VA0052451","72023","North Anna Power Station")
case.study("VA0004090","67224","Surry Power Station")
case.study("VA0004146","73183","Chesterfield Power Station")
case.study("VA0004103","72566","Yorktown Fossil Power Plant")
case.study("VA0002071","73170","Possum Point Power Station")
case.study("VA0005291","72489","Advansix Resins & Chemicals LLC")
case.study("VA0004138","73872","Bremo Bluff Power Plant")
case.study("VA0000370","72173","Glen Lyn Power Plant")
case.study("VA0063177","73032","Richmond (City) WTP")
case.study("DC0022004","74082","Potomac River Generation Station")
case.study("VA0004669","72744","Spruance Plant")
case.study("VA0066630","72251","Hopewell District")
case.study("VA0003115","67052","West Point Mill Water System")
case.study("VA0050181","72460","Manassas Service Area")
case.study("VA0004162","67380","Franklin Virginia")
case.study("VA0001015","72546","Clinch River Plant")
case.study("VA0084069","73042","Mecklenburg Power Station")
case.study("VA0087645","67174","Birchwood Power Facility")
case.study("VA0083402","74466","Altavista Power Station")
case.study("VA0087033","73049","Gordonsville Power Station")

#--Case Studies of Outfalls--#

# Plots all outfalls against withdrawals for each facility
outfall.compare<- function(VPDESID,VWUDSID){
  
  ECHO_2010_2017<-read.table("G:/My Drive/ECHO NPDES/USGS_Consumptive_Use_Updated/ECHO_2010_2017_QAQC.txt", sep="\t", header=T)
  ECHO_2010_2017<-as.data.table(ECHO_2010_2017)
  ECHO_2010_2017<-ECHO_2010_2017[!duplicated(ECHO_2010_2017, by=c("OutfallID","MP_End_Date")),]
  ECHO_2010_2017<-subset(ECHO_2010_2017,select=c(1:8,10,12,19,33,39,42,43,44))
  colnames(ECHO_2010_2017)<-c("OutfallID","Year","VPDES.Facility.ID","VPDES.Name","Fac.Lat","Fac.Long",
                              "Outfall.Lat","Outfall.Long","Measured_Effluent","Discharges_MGD","Date","County",
                              "Permit_Type","Waterbody","Use.Type","Mon_Reported")
  ECHO_2010_2017$Discharges_MGD<-as.numeric(ECHO_2010_2017$Discharges_MGD)
  ECHO_2010_2017$Date<-as.Date(ECHO_2010_2017$Date,format="%Y-%m-%d")
  load("G:/My Drive/ECHO NPDES/USGS_Consumptive_Use_Updated/Code/R Workspaces/VWUDS_2010_2017.RData")
  colnames(VWUDS_2010_2017)[3]<-"VWUDS.Facility.ID"
  colnames(VWUDS_2010_2017)[10]<-"Old.Use.Type"
  colnames(VWUDS_2010_2017)[20]<-"Use.Type"
  VWUDS_2010_2017<-as.data.table(VWUDS_2010_2017)
  
  Discharge<-
    subset(ECHO_2010_2017,ECHO_2010_2017$VPDES.Facility.ID==VPDESID)%>%dplyr::group_by(OutfallID,Date)%>%
    dplyr::summarise(Discharges=sum(as.numeric(Discharges_MGD),na.rm=T),
                     nFacilities=n_distinct(as.character(VPDES.Facility.ID)))
  
  Withdrawal<-
    subset(VWUDS_2010_2017,VWUDS_2010_2017$VWUDS.Facility.ID==VWUDSID)%>%dplyr::group_by(Date)%>%
    dplyr::summarise(Withdrawals=sum(as.numeric(Withdrawals_MGD), na.rm = T),nFacilities=n_distinct(as.character(VWUDS.Facility.ID)))
  
  plot1<-subset(VWUDS_2010_2017,VWUDS_2010_2017$VWUDS.Facility.ID==VWUDSID)%>%
    group_by(Date)%>%
    summarise(Withdrawals=sum(as.numeric(Withdrawals_MGD), na.rm = T),nFacilities=n_distinct(as.character(VWUDS.Facility.ID)))%>%
    plot_ly(x = ~Date)%>%
    add_trace(y = ~Withdrawals, name="Withdrawal",type = 'scatter', mode = 'lines+markers', marker=list(color='red'), line=list(color='red'))%>%
  
    layout(title = paste("Statewide Mean Daily Withdrawals vs. Discharges (MGD) in Virginia: ",unique(VWUDS_2010_2017$Facility[VWUDS_2010_2017$VWUDS.Facility.ID==VWUDSID])),
         yaxis = list(title="Mean Daily Quantity (MGD)", 
                      range=c(0,ifelse(max(Withdrawal$Withdrawals)>max(Discharge$Discharges),
                                       max(Withdrawal$Withdrawals),max(Discharge$Discharges)))),
         margin=list(r=125),
         xaxis = list(title = "Monitoring Period (Months)"),
         legend=list(x=0.8, y=-0.2))
  
    for (i in 1:length(unique(Discharge$OutfallID))){
      plot1<-add_trace(plot1,x=Discharge$Date[Discharge$OutfallID==unique(Discharge$OutfallID[i])],
                y=Discharge$Discharges[Discharge$OutfallID==unique(Discharge$OutfallID[i])],
                name=paste0("Outfall ",substr(Discharge$OutfallID[i],10,13)),type='scatter',mode='lines+markers')
    }
  
  Reporting<-
    subset(ECHO_2010_2017,ECHO_2010_2017$VPDES.Facility.ID==VPDESID)%>%dplyr::group_by(VPDES.Facility.ID)%>%
    dplyr::summarise(Freq=first(Mon_Reported))
  
  return(list(substr(unique(Discharge$OutfallID),10,nchar(as.character(Discharge$OutfallID))),plot1,Reporting)) #returns unique outfall IDs
  
}

outfall.compare("VA0004090","67224") #Surry Power Station
outfall.compare("VA0052451","72023") #North Anna Power Plant
outfall.compare("VA0004146","73183") #Chesterfield Power Station
outfall.compare("VA0004103","72566") #Yorktown Fossil Power Plant
outfall.compare("VA0002071","73170") #Possum Point Power Station
outfall.compare("VA0005291","72489") #Advansix Resins & Chemicals LLC
outfall.compare("VA0004138","73872","Bremo Bluff Power Plant","001","002")
outfall.compare("VA0000370","72173","Glen Lyn Power Plant","001","003")
outfall.compare("VA0063177","73032","Richmond (City) WTP","001","001")
outfall.compare("DC0022004","74082","Potomac River Generation Station","001","102")
outfall.compare("VA0004669","72744","Spruance Plant","001","101")
outfall.compare("VA0066630","72251","Hopewell District","001","101")
outfall.compare("VA0003115","67052","West Point Mill Water System","001","101")
outfall.compare("VA0005312","74320","Advansix Resins & Chemicals LLC: Chesterfield","001","202")
outfall.compare("VA0003026","73182","Georgia Pacific Big Island LLC","001","002")
outfall.compare("VA0004642","72326","Westrock CP LLC - Hopewell","001","002")
outfall.compare("VA0050181","72460","Manassas Service Area","001","902")
outfall.compare("VA0004162","67380","Franklin Virginia","001","103")
outfall.compare("VA0001015","72546","Clinch River Plant","003","D03")
outfall.compare("VA0083097","71807","Clover Plant","001","101")
outfall.compare("VA0089460","71931","Motts Run WTP","001","101")
outfall.compare("VA0002674","73159","Harrisonburg WTP","001","101")
outfall.compare("VA0003018","72031","Yorktown Terminal","001","102")
outfall.compare("VA0084069","73042","Mecklenburg Power Station","101","102")
outfall.compare("VA0087645","67174","Birchwood Power Facility","001","002")
outfall.compare("VA0083402","74466","Altavista Power Station","001","002")
outfall.compare("VA0087033","73049","Gordonsville Power Station","001","101")
outfall.compare("VA0000523","73306","Kimballton Plant","001","002")
outfall.compare("VA0006408","73406","Riverville Plant","001","301")
outfall.compare("VA0002160","73133","Apparel & Advanced Textiles LLC - Waynesboro","001","101")
outfall.compare("VA0054780","73395","Radford WTP","001","101")
outfall.compare("VA0085901","72482","IBM Contamination Wells","001","004")
outfall.compare("VA0050351","71661","Coke Ovens","001","003")

#---Fully Matched: Case Studies---#

Full.Match.case.study<- function(VPDESID,VWUDSID,FacilityName){
  
  Full_Matched_Monthly_Discharge<-
    subset(full_match_2010_2017,full_match_2010_2017$VPDES.Facility.ID==VPDESID)%>%
    group_by(Date)%>%
    summarise(Discharges=sum(as.numeric(Discharges_MGD),na.rm=T),
              OutfallID=first(OutfallID),
              nFacilities=n_distinct(as.character(VPDES.Facility.ID)))
  
  Full_Matched_Monthly_Withdrawal<-
    subset(full_match_2010_2017,full_match_2010_2017$VWUDS.Facility.ID==VWUDSID)%>%
    dplyr::group_by(Date)%>%
    dplyr::summarise(Withdrawals=sum(Withdrawals_MGD,na.rm=T),
                     nFacilities=n_distinct(as.character(VWUDS.Facility.ID)))
  
  Full_Matched_CU<-data.frame(Date=Full_Matched_Monthly_Withdrawal$Date,
                              CU=(Full_Matched_Monthly_Withdrawal$Withdrawals-Full_Matched_Monthly_Discharge$Discharges)/
                                Full_Matched_Monthly_Withdrawal$Withdrawals,stringsAsFactors = F)
  
  Yearly_CU<-Full_Matched_CU%>%dplyr::group_by(Year=substr(Date,1,4))%>%dplyr::summarise(Ave_CU=mean(CU,na.rm=T))
  
  plot1<-subset(full_match_2010_2017,full_match_2010_2017$VWUDS.Facility.ID==VWUDSID)%>%
    group_by(Date)%>%
    summarise(Withdrawals=sum(as.numeric(Withdrawals_MGD), na.rm = T),
              nFacilities=n_distinct(as.character(VWUDS.Facility.ID)))%>%
    plot_ly(x = ~Date)%>%
    add_trace(y = ~Withdrawals, name="Withdrawal",type = 'scatter', mode = 'lines+markers', marker=list(color='red'), line=list(color='red'))%>%
    add_trace(x=Full_Matched_Monthly_Discharge$Date, y=Full_Matched_Monthly_Discharge$Discharges, name="Discharge", type="scatter", mode="lines+markers", marker=list(color="blue"), line=list(color='blue'))%>%
    add_trace(y= ~nFacilities, name="VWUDS Facilities", type='bar', yaxis='y2', opacity=0.25,marker=list(color='black'))%>%
    add_trace(x=Full_Matched_Monthly_Discharge$Date, y= Full_Matched_Monthly_Discharge$nFacilities, name="VPDES Facilities", type='bar', yaxis='y2', opacity=0.25,marker=list(color='grey'))%>%
    layout(title = paste("Statewide Mean Daily Withdrawals vs. Discharges (MGD) in Virginia: ",FacilityName),
           yaxis = list(title="Mean Daily Quantity (MGD)",
                        range=c(0,ifelse(max(Full_Matched_Monthly_Withdrawal$Withdrawals)>max(Full_Matched_Monthly_Discharge$Discharges),max(Full_Matched_Monthly_Withdrawal$Withdrawals),max(Full_Matched_Monthly_Discharge$Discharges)))),
           yaxis2=list(tickfont=list(color="black"),
                       overlaying="y",
                       side="right",
                       title="Number of Reporting Facilities",
                       dtick=1,
                       ticklen=0.5),
           margin=list(r=125),
           xaxis = list(title = "Monitoring Period (Months)"),
           legend=list(x=0.8, y=-0.2))
  

  
  plot2<-subset(full_match_2010_2017,full_match_2010_2017$VWUDS.Facility.ID==VWUDSID)%>%
    group_by(Date)%>%
    summarise(Withdrawals=sum(as.numeric(Withdrawals_MGD), na.rm = T),
              nFacilities=n_distinct(as.character(VWUDS.Facility.ID)))%>%
    plot_ly(x = ~Date)%>%
    add_trace(y = ~Withdrawals, name="Withdrawal",type = 'scatter', mode = 'lines+markers', marker=list(color='red'), line=list(color='red'))%>%
    add_trace(x=Full_Matched_Monthly_Discharge$Date, y=Full_Matched_Monthly_Discharge$Discharges, name=paste0("Discharge: Outfall ", str_sub(Full_Matched_Monthly_Discharge$OutfallID,10,nchar(as.character(Full_Matched_Monthly_Discharge$OutfallID)))), type="scatter", mode="lines+markers", marker=list(color="blue"), line=list(color='blue'))%>%
    add_trace(x=Full_Matched_CU$Date,y=Full_Matched_CU$CU, name="Consumption",yaxis='y2', type="scatter",mode='lines+markers', marker=list(color='#969696'),line=list(color='#969696'))%>%
    layout(title = paste0('<b>',"Statewide Mean Daily Withdrawals vs. Discharges (MGD): ", FacilityName,'</b>'),
           xaxis = list(title = "Monitoring Period (Months)", titlefont=list(size=15),tickfont=list(color="black",size=12)),
           yaxis = list(title="Mean Daily Quantity (MGD)", titlefont=list(size=15),tickfont=list(color="black",size=12),
                        range=c(0,ifelse(max(Full_Matched_Monthly_Withdrawal$Withdrawals)>max(Full_Matched_Monthly_Discharge$Discharges),ceiling(max(Full_Matched_Monthly_Withdrawal$Withdrawals)),ceiling(max(Full_Matched_Monthly_Discharge$Discharges))))),
           yaxis2=list(tickfont=list(color="black",size=12), titlefont=list(size=15),
                       range=c(ifelse(min(Full_Matched_CU$CU)<0,min(Full_Matched_CU$CU),0),1),
                       overlaying="y",
                       side="right",
                       title="Consumptive Coefficient"),
                       margin=list(r=125),legend=list(x=0.8, y=-0.2))
  
  return(list(plot2,Yearly_CU))
}


for (i in 1:length(full_match_2010_2017_summary$VPDES.Facility.ID)){
  print(paste("Matched Facility ",i," of ", length(full_match_2010_2017_summary$VPDES.Facility.ID)))
  full_match_2010_2017_summary<-full_match_2010_2017_summary%>%arrange(desc(Ave_Withdrawal_mgd))
  Full.Match.case.study(full_match_2010_2017_summary$VPDES.Facility.ID[i],
                        full_match_2010_2017_summary$VWUDS.Facility.ID[i],
                        full_match_2010_2017_summary$VWUDS.Name[i])
  print(list(full_match_2010_2017_summary$VWUDS.Facility.ID[i],
        full_match_2010_2017_summary$Use.Type[i],
        full_match_2010_2017_summary$Waterbody[i],
        full_match_2010_2017_summary$VWUDS_perc[i],
        full_match_2010_2017_summary$VPDES_perc[i]))
}

#----------------------------------------------------------------------------------------------------------------------------------------------#
#-----------------------------------------------------Use by Sector----------------------------------------------------------------------------#

# This function returns pie charts of withdrawals,discharges,and consumption per sector

Use.by.Sector<- function(Withdrawal,Discharge, rotate1, rotate2, rotate3,rotate4){
  
#----Discharges----#
EnergyvsNon_Dis<-Discharge%>%
    dplyr::group_by(VPDES.Facility.ID,Year)%>%
    dplyr::summarise(Discharges_MGD=sum(Discharges_MGD, na.rm=T)/first(Mon_Reported),Use.Type=first(Use.Type))%>%
    dplyr::group_by(Year,Use.Type)%>%
    dplyr::summarise(Discharges_MGD=sum(Discharges_MGD,na.rm=T))
  
EnergyvsNon_Dis$Use.Type<-ifelse(EnergyvsNon_Dis$Use.Type=="Commercial"|EnergyvsNon_Dis$Use.Type=="Industrial"|EnergyvsNon_Dis$Use.Type=="Municipal"|EnergyvsNon_Dis$Use.Type=="Agriculture/Irrigation","Non-Energy","Energy")
  EnergyvsNon_Dis<-EnergyvsNon_Dis%>%dplyr::group_by(Year,Use.Type)%>%dplyr::summarise(Discharges_MGD=sum(Discharges_MGD,na.rm=T))
  EnergyvsNon_Dis<-EnergyvsNon_Dis%>%
    dplyr::group_by(Use.Type)%>%
    dplyr::summarise(Discharges_MGD=median(Discharges_MGD,na.rm=T))%>%arrange(desc(Discharges_MGD))
  
  NonEnergy_Dis<-Discharge%>%
    dplyr::group_by(VPDES.Facility.ID,Year)%>%
    dplyr::summarise(Discharges_MGD=sum(Discharges_MGD, na.rm=T)/first(Mon_Reported),Use.Type=first(Use.Type))%>%
    dplyr::group_by(Year,Use.Type)%>%
    dplyr::summarise(Discharges_MGD=sum(Discharges_MGD,na.rm=T))
  
  NonEnergy_Dis<-subset(NonEnergy_Dis,NonEnergy_Dis$Use.Type!="Energy")
  NonEnergy_Dis<-NonEnergy_Dis%>%
    dplyr::group_by(Use.Type)%>%
    dplyr::summarise(Discharges_MGD=median(Discharges_MGD,na.rm=T))%>%arrange(desc(Discharges_MGD))
  NonEnergy_Dis<-mutate_if(NonEnergy_Dis,is.factor,as.character)
  
  dis_colors<-colorspace::diverge_hcl(12,h=c(255,330),l=c(40,90))
  
  discolors2<-dis_colors[2:11]
  
  m<-list(l=50,r=50,b=50,t=50)

  plot1<-plot_ly()%>%
    add_pie(data=EnergyvsNon_Dis,labels=~Use.Type, values=~Discharges_MGD, name="Energy vs. Non-Energy",
            domain=list(x=c(0,0.4),y=c(0.4,1)),
            textposition = 'auto',
            text= ~paste0('<b>',Use.Type,'</b>',"\n", '<b>',"~", round((Discharges_MGD/sum(Discharges_MGD))*100, 0), "%",'</b>'),
            textinfo='text',
            insidetextfont = list(color = '#FFFFFF', size=14),
            outsidetextfont = list(color='#252525',size=14),
            rotation = rotate1,
            marker = list(colors=dis_colors,line=list(color = '#FFFFFF', width =3)))%>%
    add_pie(data=NonEnergy_Dis, labels=~Use.Type, values=~Discharges_MGD, name="Non-Energy Sectors",
            domain=list(x=c(0.5,0.9),y=c(0.4,1)),
            textposition = 'auto',
            text= ~paste0('<b>',Use.Type,'</b>',"\n", '<b>',"~", round((Discharges_MGD/sum(Discharges_MGD))*100, 0), "%",'</b>'),
            textinfo='text',
            insidetextfont = list(color = '#FFFFFF', size=14),
            outsidetextfont = list(color='#252525',size=14),
            rotation = rotate2,
            marker = list(colors=discolors2,line=list(color = '#FFFFFF', width =3)))%>%
    layout(showlegend=FALSE,
           xaxis = list(showgrid=F, zeroline=F, showticklabels=F),
           yaxis = list(showgrid=F, zeroline=F, showticklabels=F),
           autosize=T,margin=m)
  
#----Withdrawals----#
EnergyvsNon_With<-Withdrawal%>%
    dplyr::group_by(VWUDS.Facility.ID,Year)%>%
    dplyr::summarise(Withdrawals_MGD=sum(Withdrawals_MGD, na.rm=T)/first(Mon_Reported),Use.Type=first(Use.Type))%>%
    dplyr::group_by(Year,Use.Type)%>%
    dplyr::summarise(Withdrawals_MGD=sum(Withdrawals_MGD,na.rm=T))
  
EnergyvsNon_With$Use.Type<-ifelse(EnergyvsNon_With$Use.Type=="Commercial"|EnergyvsNon_With$Use.Type=="Industrial"|EnergyvsNon_With$Use.Type=="Municipal"|EnergyvsNon_With$Use.Type=="Agriculture/Irrigation","Non-Energy","Energy")
  EnergyvsNon_With<-EnergyvsNon_With%>%dplyr::group_by(Year,Use.Type)%>%dplyr::summarise(Withdrawals_MGD=sum(Withdrawals_MGD,na.rm=T))
  EnergyvsNon_With<-EnergyvsNon_With%>%
    dplyr::group_by(Use.Type)%>%
    dplyr::summarise(Withdrawals_MGD=median(Withdrawals_MGD,na.rm=T))%>%arrange(desc(Withdrawals_MGD))
  
NonEnergy_With<-Withdrawal%>%
    dplyr::group_by(VWUDS.Facility.ID,Year)%>%
    dplyr::summarise(Withdrawals_MGD=sum(Withdrawals_MGD, na.rm=T)/first(Mon_Reported),Use.Type=first(Use.Type))%>%
    dplyr::group_by(Year,Use.Type)%>%
    dplyr::summarise(Withdrawals_MGD=sum(Withdrawals_MGD,na.rm=T))
  
NonEnergy_With<-subset(NonEnergy_With,NonEnergy_With$Use.Type!="Energy")
  NonEnergy_With<-NonEnergy_With%>%
    dplyr::group_by(Use.Type)%>%
    dplyr::summarise(Withdrawals_MGD=median(Withdrawals_MGD,na.rm=T))%>%arrange(desc(Withdrawals_MGD))
  NonEnergy_With<-mutate_if(NonEnergy_With,is.factor,as.character)
  
  with_colors<-colorspace::heat_hcl(12,c=c(80,30),l=c(30,90),power=c(1/5,1.5))
  
  withcolors2<-with_colors[2:12]
  
  plot2<-plot_ly()%>%
    add_pie(data=EnergyvsNon_With,labels=~Use.Type, values=~Withdrawals_MGD, name="Energy vs. Non-Energy",
            domain=list(x=c(0,0.4),y=c(0.4,1)),
            textposition = 'auto',
            text= ~paste0('<b>',Use.Type,'</b>',"\n", '<b>', "~", round((Withdrawals_MGD/sum(Withdrawals_MGD))*100, 0), "%",'</b>'),
            textinfo='text',
            insidetextfont = list(color = '#FFFFFF', size=14),
            outsidetextfont = list(color='#252525',size=14),
            rotation = rotate1,
            marker = list(colors=with_colors,line=list(color = '#FFFFFF', width =3)))%>%
    add_pie(data=NonEnergy_With, labels=~Use.Type, values=~Withdrawals_MGD, name="Non-Energy Sectors",
            domain=list(x=c(0.5,0.9),y=c(0.4,1)),
            textposition = 'auto',
            text= ~paste0('<b>',Use.Type,'</b>',"\n", '<b>',"~",round((Withdrawals_MGD/sum(Withdrawals_MGD))*100, 0), "%",'</b>'),
            textinfo='text',
            insidetextfont = list(color = '#FFFFFF', size=14),
            outsidetextfont = list(color='#252525',size=14),
            rotation = rotate2,
            marker = list(colors=withcolors2,line=list(color = '#FFFFFF', width =3)))%>%
    layout(showlegend=FALSE,
           xaxis = list(showgrid=F, zeroline=F, showticklabels=F),
           yaxis = list(showgrid=F, zeroline=F, showticklabels=F),
           autosize=T,margin=m)
  
#-----Consumption------#
  
  
  
  CU_EnergyvsNon<-data.frame(Use.Type=EnergyvsNon_Dis$Use.Type,
                                Discharges_MGD=EnergyvsNon_Dis$Discharges_MGD,Withdrawals_MGD=EnergyvsNon_With$Withdrawals_MGD)
  CU_EnergyvsNon$CU<-(CU_EnergyvsNon$Withdrawals_MGD-CU_EnergyvsNon$Discharges_MGD)/CU_EnergyvsNon$Withdrawals_MGD
  
  CU_NonEnergy<-data.frame(Use.Type=NonEnergy_With$Use.Type,Discharges_MGD=NonEnergy_Dis$Discharges_MGD,Withdrawals_MGD=NonEnergy_With$Withdrawals_MGD)
  CU_NonEnergy$CU<-(CU_NonEnergy$Withdrawals_MGD-CU_NonEnergy$Discharges_MGD)/CU_NonEnergy$Withdrawals_MGD
  
  CU_colors<-colorspace::heat_hcl(12,c=c(80,30),l=c(30,90),power=c(1/5,1.5))
  CUcolors2<-with_colors[2:12]
  plot3<-plot_ly()%>%
    add_pie(data=CU_EnergyvsNon,labels=~Use.Type, values=~CU, name="Energy vs. Non-Energy",
            domain=list(x=c(0,0.4),y=c(0.4,1)),
            textposition = 'auto',
            text= ~paste0('<b>',Use.Type,'</b>',"\n", '<b>', "~", round((CU/sum(CU))*100, 0), "%",'</b>'),
            textinfo='text',
            insidetextfont = list(color = '#FFFFFF', size=14),
            outsidetextfont = list(color='#252525',size=14),
            rotation = rotate3,
            marker = list(colors=with_colors,line=list(color = '#FFFFFF', width =3)))%>%
    add_pie(data=CU_NonEnergy, labels=~Use.Type, values=~CU, name="Non-Energy Sectors",
            domain=list(x=c(0.5,0.9),y=c(0.4,1)),
            textposition = 'auto',
            text= ~paste0('<b>',Use.Type,'</b>',"\n", '<b>',"~",round((CU/sum(CU))*100, 0), "%",'</b>'),
            textinfo='text',
            insidetextfont = list(color = '#FFFFFF', size=14),
            outsidetextfont = list(color='#252525',size=14),
            rotation = rotate4,
            marker = list(colors=withcolors2,line=list(color = '#FFFFFF', width =3)))%>%
    layout(showlegend=FALSE,
           xaxis = list(showgrid=F, zeroline=F, showticklabels=F),
           yaxis = list(showgrid=F, zeroline=F, showticklabels=F),
           autosize=T,margin=m)
  
  return(list(plot1,plot2,plot3))
  
  
}

Use.by.Sector(VWUDS_2010_2017,ECHO_2010_2017,120,120,315,0) #All Facilities
Use.by.Sector(full_match_2010_2017,full_match_2010_2017,90,90,315,290)

#----------------------------------------------------------------------------------------------------------------------------------------------#
#------------------------------------------Consumption Coefficients per Sector per Year--------------------------------------------------------#

# This function returns the average consumption coefficient per year, per sector, and an overall average from 2010-2017

Consumption_Sector<- function(Discharge,Withdrawal,name){
  
  Sector_Discharge<-Discharge%>%
    dplyr::group_by(Sector,Year)%>%
    dplyr::summarise(nFacilities=n_distinct(VPDES.Facility.ID),
                     Discharges_MGD=sum(Discharges_MGD,na.rm=T))
  
  Sector_Withdrawal<-Withdrawal%>%
    dplyr::group_by(Sector,Year)%>%
    dplyr::summarise(nFacilities=n_distinct(VWUDS.Facility.ID),
                     Withdrawals_MGD=sum(Withdrawals_MGD,na.rm=T))
  
  Sector_CU<-data.frame("Sector"=unique(Sector_Withdrawal$Sector),stringsAsFactors = F)
  
  Sector_CU$Discharge_MGD2010<-ifelse(Sector_CU$Sector%in%Sector_Discharge$Sector[Sector_Discharge$Year=="2010"],Sector_Discharge$Discharges_MGD[Sector_Discharge$Year=="2010"][match(Sector_CU$Sector,Sector_Discharge$Sector[Sector_Discharge$Year=="2010"])],NA)
  Sector_CU$Discharge_MGD2011<-ifelse(Sector_CU$Sector%in%Sector_Discharge$Sector[Sector_Discharge$Year=="2011"],Sector_Discharge$Discharges_MGD[Sector_Discharge$Year=="2011"][match(Sector_CU$Sector,Sector_Discharge$Sector[Sector_Discharge$Year=="2011"])],NA)
  Sector_CU$Discharge_MGD2012<-ifelse(Sector_CU$Sector%in%Sector_Discharge$Sector[Sector_Discharge$Year=="2012"],Sector_Discharge$Discharges_MGD[Sector_Discharge$Year=="2012"][match(Sector_CU$Sector,Sector_Discharge$Sector[Sector_Discharge$Year=="2012"])],NA)
  Sector_CU$Discharge_MGD2013<-ifelse(Sector_CU$Sector%in%Sector_Discharge$Sector[Sector_Discharge$Year=="2013"],Sector_Discharge$Discharges_MGD[Sector_Discharge$Year=="2013"][match(Sector_CU$Sector,Sector_Discharge$Sector[Sector_Discharge$Year=="2013"])],NA)
  Sector_CU$Discharge_MGD2014<-ifelse(Sector_CU$Sector%in%Sector_Discharge$Sector[Sector_Discharge$Year=="2014"],Sector_Discharge$Discharges_MGD[Sector_Discharge$Year=="2014"][match(Sector_CU$Sector,Sector_Discharge$Sector[Sector_Discharge$Year=="2014"])],NA)
  Sector_CU$Discharge_MGD2015<-ifelse(Sector_CU$Sector%in%Sector_Discharge$Sector[Sector_Discharge$Year=="2015"],Sector_Discharge$Discharges_MGD[Sector_Discharge$Year=="2015"][match(Sector_CU$Sector,Sector_Discharge$Sector[Sector_Discharge$Year=="2015"])],NA)
  Sector_CU$Discharge_MGD2016<-ifelse(Sector_CU$Sector%in%Sector_Discharge$Sector[Sector_Discharge$Year=="2016"],Sector_Discharge$Discharges_MGD[Sector_Discharge$Year=="2016"][match(Sector_CU$Sector,Sector_Discharge$Sector[Sector_Discharge$Year=="2016"])],NA)
  Sector_CU$Discharge_MGD2017<-ifelse(Sector_CU$Sector%in%Sector_Discharge$Sector[Sector_Discharge$Year=="2017"],Sector_Discharge$Discharges_MGD[Sector_Discharge$Year=="2017"][match(Sector_CU$Sector,Sector_Discharge$Sector[Sector_Discharge$Year=="2017"])],NA)
  
  Sector_CU$Withdrawal_MGD2010<-ifelse(Sector_CU$Sector%in%Sector_Withdrawal$Sector[Sector_Withdrawal$Year=="2010"],Sector_Withdrawal$Withdrawals_MGD[Sector_Withdrawal$Year=="2010"][match(Sector_CU$Sector,Sector_Withdrawal$Sector[Sector_Withdrawal$Year=="2010"])],NA)
  Sector_CU$Withdrawal_MGD2011<-ifelse(Sector_CU$Sector%in%Sector_Withdrawal$Sector[Sector_Withdrawal$Year=="2011"],Sector_Withdrawal$Withdrawals_MGD[Sector_Withdrawal$Year=="2011"][match(Sector_CU$Sector,Sector_Withdrawal$Sector[Sector_Withdrawal$Year=="2011"])],NA)
  Sector_CU$Withdrawal_MGD2012<-ifelse(Sector_CU$Sector%in%Sector_Withdrawal$Sector[Sector_Withdrawal$Year=="2012"],Sector_Withdrawal$Withdrawals_MGD[Sector_Withdrawal$Year=="2012"][match(Sector_CU$Sector,Sector_Withdrawal$Sector[Sector_Withdrawal$Year=="2012"])],NA)
  Sector_CU$Withdrawal_MGD2013<-ifelse(Sector_CU$Sector%in%Sector_Withdrawal$Sector[Sector_Withdrawal$Year=="2013"],Sector_Withdrawal$Withdrawals_MGD[Sector_Withdrawal$Year=="2013"][match(Sector_CU$Sector,Sector_Withdrawal$Sector[Sector_Withdrawal$Year=="2013"])],NA)
  Sector_CU$Withdrawal_MGD2014<-ifelse(Sector_CU$Sector%in%Sector_Withdrawal$Sector[Sector_Withdrawal$Year=="2014"],Sector_Withdrawal$Withdrawals_MGD[Sector_Withdrawal$Year=="2014"][match(Sector_CU$Sector,Sector_Withdrawal$Sector[Sector_Withdrawal$Year=="2014"])],NA)
  Sector_CU$Withdrawal_MGD2015<-ifelse(Sector_CU$Sector%in%Sector_Withdrawal$Sector[Sector_Withdrawal$Year=="2015"],Sector_Withdrawal$Withdrawals_MGD[Sector_Withdrawal$Year=="2015"][match(Sector_CU$Sector,Sector_Withdrawal$Sector[Sector_Withdrawal$Year=="2015"])],NA)
  Sector_CU$Withdrawal_MGD2016<-ifelse(Sector_CU$Sector%in%Sector_Withdrawal$Sector[Sector_Withdrawal$Year=="2016"],Sector_Withdrawal$Withdrawals_MGD[Sector_Withdrawal$Year=="2016"][match(Sector_CU$Sector,Sector_Withdrawal$Sector[Sector_Withdrawal$Year=="2016"])],NA)
  Sector_CU$Withdrawal_MGD2017<-ifelse(Sector_CU$Sector%in%Sector_Withdrawal$Sector[Sector_Withdrawal$Year=="2017"],Sector_Withdrawal$Withdrawals_MGD[Sector_Withdrawal$Year=="2017"][match(Sector_CU$Sector,Sector_Withdrawal$Sector[Sector_Withdrawal$Year=="2017"])],NA)
  
  Sector_CU$CU_2010<-(ifelse(is.na(Sector_CU$Withdrawal_MGD2010)|is.nan(Sector_CU$Withdrawal_MGD2010),0,Sector_CU$Withdrawal_MGD2010)-
                        ifelse(is.na(Sector_CU$Discharge_MGD2010)|is.nan(Sector_CU$Discharge_MGD2010),0,Sector_CU$Discharge_MGD2010))/(ifelse(is.na(Sector_CU$Withdrawal_MGD2010)|is.nan(Sector_CU$Withdrawal_MGD2010),0,Sector_CU$Withdrawal_MGD2010))
  
  Sector_CU$CU_2011<-(ifelse(is.na(Sector_CU$Withdrawal_MGD2011)|is.nan(Sector_CU$Withdrawal_MGD2011),0,Sector_CU$Withdrawal_MGD2011)-
                        ifelse(is.na(Sector_CU$Discharge_MGD2011)|is.nan(Sector_CU$Discharge_MGD2011),0,Sector_CU$Discharge_MGD2011))/(ifelse(is.na(Sector_CU$Withdrawal_MGD2011)|is.nan(Sector_CU$Withdrawal_MGD2011),0,Sector_CU$Withdrawal_MGD2011))
  
  Sector_CU$CU_2012<-(ifelse(is.na(Sector_CU$Withdrawal_MGD2012)|is.nan(Sector_CU$Withdrawal_MGD2012),0,Sector_CU$Withdrawal_MGD2012)-
                        ifelse(is.na(Sector_CU$Discharge_MGD2012)|is.nan(Sector_CU$Discharge_MGD2012),0,Sector_CU$Discharge_MGD2012))/(ifelse(is.na(Sector_CU$Withdrawal_MGD2012)|is.nan(Sector_CU$Withdrawal_MGD2012),0,Sector_CU$Withdrawal_MGD2012))
  
  Sector_CU$CU_2013<-(ifelse(is.na(Sector_CU$Withdrawal_MGD2013)|is.nan(Sector_CU$Withdrawal_MGD2013),0,Sector_CU$Withdrawal_MGD2013)-
                        ifelse(is.na(Sector_CU$Discharge_MGD2013)|is.nan(Sector_CU$Discharge_MGD2013),0,Sector_CU$Discharge_MGD2013))/(ifelse(is.na(Sector_CU$Withdrawal_MGD2013)|is.nan(Sector_CU$Withdrawal_MGD2013),0,Sector_CU$Withdrawal_MGD2013))
  
  Sector_CU$CU_2014<-(ifelse(is.na(Sector_CU$Withdrawal_MGD2014)|is.nan(Sector_CU$Withdrawal_MGD2014),0,Sector_CU$Withdrawal_MGD2014)-
                        ifelse(is.na(Sector_CU$Discharge_MGD2014)|is.nan(Sector_CU$Discharge_MGD2014),0,Sector_CU$Discharge_MGD2014))/(ifelse(is.na(Sector_CU$Withdrawal_MGD2014)|is.nan(Sector_CU$Withdrawal_MGD2014),0,Sector_CU$Withdrawal_MGD2014))
  
  Sector_CU$CU_2015<-(ifelse(is.na(Sector_CU$Withdrawal_MGD2015)|is.nan(Sector_CU$Withdrawal_MGD2015),0,Sector_CU$Withdrawal_MGD2015)-
                        ifelse(is.na(Sector_CU$Discharge_MGD2015)|is.nan(Sector_CU$Discharge_MGD2015),0,Sector_CU$Discharge_MGD2015))/(ifelse(is.na(Sector_CU$Withdrawal_MGD2015)|is.nan(Sector_CU$Withdrawal_MGD2015),0,Sector_CU$Withdrawal_MGD2015))
  
  Sector_CU$CU_2016<-(ifelse(is.na(Sector_CU$Withdrawal_MGD2016)|is.nan(Sector_CU$Withdrawal_MGD2016),0,Sector_CU$Withdrawal_MGD2016)-
                        ifelse(is.na(Sector_CU$Discharge_MGD2016)|is.nan(Sector_CU$Discharge_MGD2016),0,Sector_CU$Discharge_MGD2016))/(ifelse(is.na(Sector_CU$Withdrawal_MGD2016)|is.nan(Sector_CU$Withdrawal_MGD2016),0,Sector_CU$Withdrawal_MGD2016))
  
  Sector_CU$CU_2017<-(ifelse(is.na(Sector_CU$Withdrawal_MGD2017)|is.nan(Sector_CU$Withdrawal_MGD2017),0,Sector_CU$Withdrawal_MGD2017)-
                        ifelse(is.na(Sector_CU$Discharge_MGD2017)|is.nan(Sector_CU$Discharge_MGD2017),0,Sector_CU$Discharge_MGD2017))/(ifelse(is.na(Sector_CU$Withdrawal_MGD2017)|is.nan(Sector_CU$Withdrawal_MGD2017),0,Sector_CU$Withdrawal_MGD2017))
  
  Sector_CU<-Sector_CU[-c(2:17)]
  
  is.nan.data.frame <- function(x)
    do.call(cbind, lapply(x, is.nan))
  
  Sector_CU[is.nan.data.frame(Sector_CU)]<-NA
  
  
  
  for (i in 1:length(Sector_CU$Sector)){
    Sector_CU$Sum[i]<-(ifelse(is.na(Sector_CU$CU_2010[i]),0,Sector_CU$CU_2010[i])+
                         ifelse(is.na(Sector_CU$CU_2011[i]),0,Sector_CU$CU_2011[i])+
                         ifelse(is.na(Sector_CU$CU_2012[i]),0,Sector_CU$CU_2012[i])+
                         ifelse(is.na(Sector_CU$CU_2013[i]),0,Sector_CU$CU_2013[i])+
                         ifelse(is.na(Sector_CU$CU_2014[i]),0,Sector_CU$CU_2014[i])+
                         ifelse(is.na(Sector_CU$CU_2015[i]),0,Sector_CU$CU_2015[i])+
                         ifelse(is.na(Sector_CU$CU_2016[i]),0,Sector_CU$CU_2016[i])+
                         ifelse(is.na(Sector_CU$CU_2017[i]),0,Sector_CU$CU_2017[i]))
  }

  for (i in 1:nrow(Sector_CU)){
  Sector_CU$Ave[i]<-Sector_CU$Sum[i]/length(which(!is.na(Sector_CU[i,2:9])))
  }

  assign(name,Sector_CU,envir=.GlobalEnv)
  
  return(Sector_CU)
}

Consumption_Sector(Facility_Discharges,Facility_Withdrawals,"Sector_CU_All")
Consumption_Sector(Matched_Facility_Discharges,Matched_Facility_Withdrawals,"Sector_CU_Matched")


#----------------------------------------------------------------------------------------------------------------------------------#
#------------------------------------------Consumption Coefficients Timeseries per Sector------------------------------------------#

TS_Sector_Consumption<- function(Discharge,Withdrawal,name){
  
  TS_Sector_Discharge<-Discharge%>%
    dplyr::group_by(Date,Sector=Use.Type)%>%
    dplyr::summarise(Discharge=sum(Discharges_MGD,na.rm=T))%>%
    tidyr::spread(Sector, Discharge)
  
  TS_Sector_Withdrawal<-Withdrawal%>%
    dplyr::group_by(Date,Sector=Use.Type)%>%
    dplyr::summarise(Withdrawal=sum(Withdrawals_MGD,na.rm=T))%>%
    tidyr::spread(Sector, Withdrawal)
  
  CU_Function<-function(x,y) (ifelse(is.na(x),0,x)-ifelse(is.na(y),0,y))/(ifelse(is.na(x),0,x))
  
  df<-data.frame(Date=TS_Sector_Withdrawal$Date, mapply(CU_Function,TS_Sector_Withdrawal[2:6],TS_Sector_Discharge[2:6]),stringsAsFactors = F)
  
  is.nan.data.frame <- function(x)
    do.call(cbind, lapply(x, is.nan))
  
  df[is.nan.data.frame(df)]<-NA
  
  assign(name,df,envir=.GlobalEnv)

}
TS_Sector_Consumption(ECHO_2010_2017,VWUDS_2010_2017,"TS_Sector_CU")
TS_Sector_Consumption(full_match_2010_2017,full_match_2010_2017,"TS_Sector_CU_Match")

 save(TS_Sector_CU,file="G:/My Drive/ECHO NPDES/USGS_Consumptive_Use_Updated/Code/R Workspaces/TS_Sector_CU.RData")
 save(TS_Sector_CU_Match,file="G:/My Drive/ECHO NPDES/USGS_Consumptive_Use_Updated/Code/R Workspaces/TS_Sector_CU_Match.RData")
#----------------------------------------------------------------------------------------------------------------------------------#
#------------------------------------------Consumption Coefficients Timeseries-----------------------------------------------------#

#---------Statewide Level---------#

TS_Consumption<- function(Discharge,Withdrawal,name){
  
  TS_Discharge<-Discharge%>%
    dplyr::group_by(Date)%>%
    dplyr::summarise(Discharge=sum(Discharges_MGD,na.rm=T))
  
  TS_Withdrawal<-Withdrawal%>%
    dplyr::group_by(Date)%>%
    dplyr::summarise(Withdrawal=sum(Withdrawals_MGD,na.rm=T))
  
  CU_Function<-function(x,y) (ifelse(is.na(x),0,x)-ifelse(is.na(y),0,y))/(ifelse(is.na(x),0,x))
  
  df<-data.frame(Date=TS_Withdrawal$Date, mapply(CU_Function,TS_Withdrawal[2],TS_Discharge[2]),stringsAsFactors = F)
  
  colnames(df)<-c("Date","Consumption")
  assign(name,df,envir=.GlobalEnv)
}
TS_Consumption(ECHO_2010_2017,VWUDS_2010_2017,"TS_CU")
TS_Consumption(full_match_2010_2017,full_match_2010_2017,"TS_CU_Match")

 save(TS_CU,file="G:/My Drive/ECHO NPDES/USGS_Consumptive_Use_Updated/Code/R Workspaces/TS_CU.RData")
 save(TS_CU_Match,file="G:/My Drive/ECHO NPDES/USGS_Consumptive_Use_Updated/Code/R Workspaces/TS_CU_Match.RData")
#-----------Facility Level------#

TS_CU_Match_Fac<-full_match_2010_2017%>%
  dplyr::group_by(VWUDS.Facility.ID,Date)%>%
  dplyr::summarise(VPDES.Facility.ID=first(VPDES.Facility.ID),Facility_Name=first(VWUDS.Name),
                   Use.Type=first(Use.Type),Withdrawals_MGD=first(Withdrawals_MGD),Discharges_MGD=first(Discharges_MGD),
                   CU=first(CU))

 save(TS_CU_Match_Fac,file="G:/My Drive/ECHO NPDES/USGS_Consumptive_Use_Updated/Code/R Workspaces/TS_CU_Match_Fac.RData")

#----------------------------------------------------------------------------------------------------------------------------------------------#


